<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ======================= CSS LIBS ======================= -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet"/>

  <!-- ======================= PAGE STYLES ======================= -->
  <style>
    :root {
      --bg: #fff;
      --fg: #222;
      --muted: #666;
      --card: #ffffff;
      --card-border: #e9ecef;
    }
    body.dark-mode {
      --bg: #181a1f;
      --fg: #eee;
      --muted: #aaa;
      --card: #1f232b;
      --card-border: #2a2f38;
    }
    body { background: var(--bg); color: var(--fg); }
    .card { background: var(--card); border-color: var(--card-border); transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .filter-bar { position: sticky; top: 0; z-index: 10; background: inherit; padding: 10px; }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
    #loadingOverlay {
      display:none;
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5); color:#fff; font-size:2rem;
      justify-content:center; align-items:center; z-index:2000;
    }
    .badge-status { font-weight:600; }
    .select2-container--default .select2-selection--multiple {
      background: var(--card); color: var(--fg); border-color: var(--card-border);
    }
    .select2-container--default .select2-results>.select2-results__options { color: #000; }
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay">‚è≥ Loading...</div>

  <!-- ======================= MAIN WRAPPER ======================= -->
  <div class="container-fluid p-4" id="reportArea">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>üìä Attendance Dashboard</h2>
      <div class="d-flex gap-2 align-items-center">
        <span class="text-muted small" id="apiStatus">API: ‚Äî</span>
        <button class="btn btn-outline-secondary" onclick="toggleDark()" aria-label="Toggle dark mode">üåô/‚òÄÔ∏è</button>
        <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="card shadow filter-bar mb-4">
      <div class="card-body row g-3 align-items-end">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" multiple aria-label="Employee filter"></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control" aria-label="Start date"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control" aria-label="End date"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Quick Search</label>
          <input type="text" id="quickSearch" class="form-control" placeholder="Search..." aria-label="Quick search"/>
        </div>
        <div class="col-12 text-end mt-3">
          <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
          <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
        </div>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-4 text-center" id="kpiCards"></div>

    <!-- TABLE -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row">
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
    </div>

    <!-- SETTINGS -->
    <!-- ... (unchanged, keeping your settings, holidays, leaves manager code) ... -->
  </div>

  <!-- ======================= JS LIBS ======================= -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ======================= APP SCRIPT ======================= -->
  <script>
    // ... all your existing JS ...

    // ‚úÖ Chart.js FIX
    function renderCharts(data){
      if(barChartHandle)barChartHandle.destroy();
      if(pieChartHandle)pieChartHandle.destroy();
      if(lineChartHandle)lineChartHandle.destroy();

      const byDate={}, byEmp={};
      data.forEach(r=>{
        if(r.date){
          const d = new Date(r.date);
          const dow = d.getDay();
          const isHoliday = HOLIDAYS.some(h=>h.date===r.date);
          const isLeave = LEAVES.some(l=>l.date===r.date && l.employee===r.employee);
          if(dow!==0 && dow!==6 && !isHoliday && !isLeave){
            byDate[r.date] = (byDate[r.date]||0) + (r.totalHours||0);
          }
        }
        if(r.employee){
          byEmp[r.employee] = (byEmp[r.employee]||0) + (r.totalHours||0);
        }
      });

      barChartHandle = new Chart(document.getElementById("barChart").getContext("2d"),{
        type:"bar",
        data:{ labels:Object.keys(byDate), datasets:[{label:"Hours", data:Object.values(byDate)}] },
        options:{ scales:{ x:{ ticks:{ autoSkip:true }}}}
      });
      pieChartHandle = new Chart(document.getElementById("pieChart").getContext("2d"),{
        type:"pie",
        data:{ labels:Object.keys(byEmp), datasets:[{ data:Object.values(byEmp)}] }
      });
      lineChartHandle = new Chart(document.getElementById("lineChart").getContext("2d"),{
        type:"line",
        data:{ labels:Object.keys(byDate), datasets:[{ label:"Hours", data:Object.values(byDate) }]}
      });
    }

    // ‚úÖ Select2 FIX
    function populateEmployeeFilter(){
      const sel = document.getElementById("employeeFilter");
      const leaveSel = document.getElementById("leaveEmployee");
      sel.innerHTML = ""; leaveSel.innerHTML = "";
      [...new Set(CANON.map(r=>r.employee).filter(Boolean))].sort().forEach(emp=>{
        const o = document.createElement("option");
        o.value = emp; o.textContent = emp; sel.appendChild(o);
        const l = document.createElement("option");
        l.value = emp; l.textContent = emp; leaveSel.appendChild(l);
      });
      $("#employeeFilter").select2({
        theme:"bootstrap-5",
        placeholder:"Select employees...",
        allowClear:true,
        width:"100%"
      });
    }

    // ‚úÖ PDF FIX
    async function downloadFullReport(){
      const el = document.getElementById("reportArea");
      const canvas = await html2canvas(el,{ 
        scale:2, 
        backgroundColor:document.body.classList.contains("dark-mode")?"#181a1f":"#fff" 
      });
      const img = canvas.toDataURL("image/png");
      const doc = { content:[{ image: img, width: 520 }] };
      pdfMake.createPdf(doc).download("Attendance_Report.pdf");
    }
  </script>
</body>
</html>
