<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      margin-top: 40px;
      color: #444;
    }
    .section {
      margin-bottom: 50px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f2f2f2;
    }
    tr:nth-child(even) {
      background: #fdfdfd;
    }
    .error {
      color: red;
    }
    .filters {
      margin-bottom: 10px;
    }
    .filters label {
      margin-right: 10px;
    }
    input, select {
      padding: 5px;
      font-size: 14px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Attendance Dashboard</h1>

  <!-- Attendance Section -->
  <div class="section">
    <h2>Attendance</h2>
    <div class="filters">
      <label>
        Month:
        <select id="monthFilter"></select>
      </label>
      <label>
        Employee:
        <input type="text" id="employeeFilter" placeholder="Search by name">
      </label>
      <button onclick="applyFilters()">Apply</button>
      <button onclick="resetFilters()">Reset</button>
    </div>
    <div id="attendance"></div>
  </div>

  <!-- Holidays Section -->
  <div class="section">
    <h2>Holidays</h2>
    <div id="holidays"></div>
  </div>

  <!-- Leaves Section -->
  <div class="section">
    <h2>Leaves</h2>
    <div id="leaves"></div>
  </div>

  <!-- Balances Section -->
  <div class="section">
    <h2>Balances</h2>
    <div id="balances"></div>
  </div>

  <!-- Settings Section -->
  <div class="section">
    <h2>Settings</h2>
    <div id="settings"></div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwyjG0ZS22iohHqM8N78KELf8xWYM2ARBdcGN-vn448eewSbuCSYoyI4MC3adEDcSiVkA/exec";

    let attendanceData = [];

    // Fetch data from API
    async function fetchData(sheet) {
      try {
        const res = await fetch(`${API_BASE}?sheet=${sheet}`);
        const json = await res.json();
        console.log(`${sheet} API Response`, json);
        if (!json.ok) throw new Error(json.error);
        return json;
      } catch (err) {
        console.error(`Error loading ${sheet}:`, err);
        return { ok: false, error: err.message };
      }
    }

    // Render table
    function renderTable(data) {
      if (!data || data.length === 0) return "<p>No data available</p>";
      let headers = Object.keys(data[0]);
      let html = "<table><thead><tr>";
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";
      data.forEach(row => {
        html += "<tr>";
        headers.forEach(h => html += `<td>${row[h] ?? ""}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      return html;
    }

    // Load all sheets
    async function loadData() {
      const [attendance, holidays, leaves, balances, settings] = await Promise.all([
        fetchData("attendance"),
        fetchData("holidays"),
        fetchData("leaves"),
        fetchData("balances"),
        fetchData("settings")
      ]);

      if (attendance.ok) {
        attendanceData = attendance.data;
        document.getElementById("attendance").innerHTML = renderTable(attendance.data);
        populateFilters(attendance.data);
      } else {
        document.getElementById("attendance").innerHTML = `<p class="error">${attendance.error}</p>`;
      }

      document.getElementById("holidays").innerHTML =
        holidays.ok ? renderTable(holidays.data) : `<p class="error">${holidays.error}</p>`;

      document.getElementById("leaves").innerHTML =
        leaves.ok ? renderTable(leaves.data) : `<p class="error">${leaves.error}</p>`;

      document.getElementById("balances").innerHTML =
        balances.ok ? renderTable(balances.data) : `<p class="error">${balances.error}</p>`;

      document.getElementById("settings").innerHTML =
        settings.ok ? renderTable(settings.data) : `<p class="error">${settings.error}</p>`;
    }

    // Populate month filter dropdown
    function populateFilters(data) {
      const months = [...new Set(data.map(r => r.month))];
      const monthSelect = document.getElementById("monthFilter");
      monthSelect.innerHTML = `<option value="">All</option>`;
      months.forEach(m => {
        monthSelect.innerHTML += `<option value="${m}">${m}</option>`;
      });
    }

    // Apply filters
    function applyFilters() {
      const month = document.getElementById("monthFilter").value;
      const employee = document.getElementById("employeeFilter").value.toLowerCase();

      let filtered = attendanceData;
      if (month) filtered = filtered.filter(r => r.month === month);
      if (employee) filtered = filtered.filter(r => r.employee.toLowerCase().includes(employee));

      document.getElementById("attendance").innerHTML = renderTable(filtered);
    }

    // Reset filters
    function resetFilters() {
      document.getElementById("monthFilter").value = "";
      document.getElementById("employeeFilter").value = "";
      document.getElementById("attendance").innerHTML = renderTable(attendanceData);
    }

    loadData();
  </script>
</body>
</html>
