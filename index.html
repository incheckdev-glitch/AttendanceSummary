<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>InCheck 360 â€” Company Chat Pro</title>
<style>
:root {
  --primary:#0a84ff;--primary-dark:#005bb5;
  --bg:#0f1115;--panel:#171a21;--text:#f1f5f9;--muted:#94a3b8;
  --sent:#0a84ff;--recv:#2e3440;--success:#22c55e;
}
body.light {--bg:#f4f6fb;--panel:#fff;--text:#111;--muted:#475569;--recv:#eef2f7;}
*{box-sizing:border-box;}
body{margin:0;font-family:Segoe UI,system-ui;background:var(--bg);color:var(--text);}
.app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:64px 1fr 70px;
grid-template-areas:"sidebar header" "sidebar chat" "sidebar composer";
height:100vh;width:100vw;}
.sidebar{grid-area:sidebar;background:var(--panel);border-right:1px solid #222;
display:flex;flex-direction:column;}
.header{grid-area:header;display:flex;align-items:center;justify-content:space-between;
padding:10px 16px;background:var(--panel);border-bottom:1px solid #222;}
.chat{grid-area:chat;overflow-y:auto;display:flex;flex-direction:column;
padding:16px;scroll-behavior:smooth;}
.composer{grid-area:composer;display:flex;align-items:center;gap:10px;padding:10px 16px;
background:var(--panel);border-top:1px solid #222;}
input,select,button{font-family:inherit;}
select,input[type=text]{background:#222;border:none;border-radius:6px;color:var(--text);
padding:8px 10px;}
button{cursor:pointer;border:none;background:var(--primary);color:#fff;
padding:8px 12px;border-radius:6px;}
button:hover{background:var(--primary-dark);}
.person{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;
cursor:pointer;margin:4px;}
.person:hover{background:#222;}
.person.active{background:rgba(10,132,255,0.2);}
.status-dot{width:8px;height:8px;border-radius:50%;margin-left:auto;}
.online{background:#22c55e;}
.message{margin:6px 0;display:flex;}
.mine{justify-content:flex-end;}
.mine .bubble{background:var(--sent);color:#fff;border-radius:12px 12px 2px 12px;}
.theirs .bubble{background:var(--recv);color:var(--text);border-radius:12px 12px 12px 2px;}
.bubble{max-width:70%;padding:10px;word-wrap:break-word;}
.meta{font-size:12px;color:var(--muted);text-align:right;margin-top:2px;}
.search-bar{padding:10px;border-bottom:1px solid #222;}
.search-bar input{width:100%;}
.file-upload{position:relative;overflow:hidden;display:inline-block;}
.file-upload input[type=file]{position:absolute;opacity:0;left:0;top:0;width:100%;height:100%;cursor:pointer;}
@media(max-width:900px){.app{grid-template-columns:1fr;grid-template-areas:"header" "chat" "composer";}
.sidebar{display:none;}}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar" id="sidebar">
    <div style="padding:10px;border-bottom:1px solid #222;">
      <strong>You:</strong>
      <select id="meSelect" style="width:100%;margin-top:4px;"></select>
    </div>
    <div style="padding:10px;border-bottom:1px solid #222;">
      <button id="themeBtn">ðŸŒ“ Theme</button>
      <button id="roomsBtn">ðŸ’¬ Rooms</button>
    </div>
    <div class="search-bar">
      <input id="searchUsers" type="text" placeholder="Search users...">
    </div>
    <div id="peopleList" style="overflow:auto;flex:1;"></div>
  </div>

  <div class="header">
    <div><button id="toggleSidebar" style="display:none;">â˜°</button>
      <strong id="chatTitle">Select a chat</strong></div>
    <div>
      <input id="searchMessages" type="text" placeholder="Search messages..." style="width:180px;">
    </div>
  </div>

  <div class="chat" id="chatBox">
    <p style="color:var(--muted);text-align:center;">Select someone to start chatting</p>
  </div>

  <div class="composer">
    <div class="file-upload">
      <button>ðŸ“Ž</button>
      <input type="file" id="fileInput">
    </div>
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // replace with your own
let me="",peer="",room="",users=[],rooms=[],lastMsgId=null;

// ---- DOM shortcuts
const $=id=>document.getElementById(id);
const meSelect=$("meSelect"),peopleList=$("peopleList"),chatBox=$("chatBox");
const messageInput=$("messageInput"),sendBtn=$("sendBtn"),fileInput=$("fileInput");
const chatTitle=$("chatTitle"),themeBtn=$("themeBtn"),searchUsers=$("searchUsers");
const searchMessages=$("searchMessages");

// ---- Theme toggle
if(localStorage.theme==="light")document.body.classList.add("light");
themeBtn.onclick=()=>{document.body.classList.toggle("light");
localStorage.theme=document.body.classList.contains("light")?"light":"dark";};

// ---- API helpers
const get=async q=>(await fetch(`${API_URL}?${q}`)).json();
const post=async b=>(await fetch(API_URL,{method:"POST",body:JSON.stringify(b)})).json();

// ---- Load users and rooms
async function loadUsers(){
 const res=await get("action=getUsers");users=res;
 meSelect.innerHTML='<option value="">Select you</option>'+users.map(u=>`<option value="${u.user_id}">${u.name} (${u.status})</option>`).join("");
 if(me)meSelect.value=me;renderUsers();
}
async function loadRooms(){rooms=await get("action=getRooms");}

// ---- Render user list
function renderUsers(filter=""){
 const f=filter.toLowerCase();
 peopleList.innerHTML="";
 users.filter(u=>u.name.toLowerCase().includes(f)&&u.user_id!=me).forEach(u=>{
  const div=document.createElement("div");
  div.className="person";div.dataset.id=u.user_id;
  div.innerHTML=`<div>${u.name}</div><span class="status-dot ${u.status==='online'?'online':''}"></span>`;
  div.onclick=()=>openChat(u.user_id);
  peopleList.appendChild(div);
 });
}

// ---- Open chat
async function openChat(id){
 peer=id;room="";
 chatTitle.textContent=(users.find(u=>u.user_id==id)||{}).name||"Chat";
 await loadMessages(false);
}

// ---- Open room
async function openRoom(id){
 room=id;peer="";
 chatTitle.textContent=(rooms.find(r=>r.room_id==id)||{}).room_name||"Room";
 await loadMessages(false);
}

// ---- Load messages
async function loadMessages(notify=true){
 if(!me)return;
 const params=room?`action=getMessages&room_id=${room}`:`action=getMessages&user1=${me}&user2=${peer}`;
 const res=await get(params);
 chatBox.innerHTML="";
 res.forEach(m=>{
  const mine=m.sender_id==me;
  const div=document.createElement("div");
  div.className="message "+(mine?"mine":"theirs");
  div.innerHTML=`<div class="bubble">${m.message}${m.file_link?`<br><a href="${m.file_link}" target="_blank">ðŸ“Ž File</a>`:""}</div>
  <div class="meta">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${mine?(m.read_status=="read"?"âœ“âœ“":"âœ“"):""}</div>`;
  chatBox.appendChild(div);
 });
 chatBox.scrollTop=chatBox.scrollHeight;
 if(res.length){
  const last=res[res.length-1];
  if(last.msg_id!=lastMsgId && last.sender_id!=me && notify){playBeep();}
  lastMsgId=last.msg_id;
 }
}

// ---- Send message
async function sendMessage(){
 const text=messageInput.value.trim();
 if(!text&&!fileInput.files.length)return;
 const payload={action:"sendMessage",sender_id:me,message:text};
 if(peer)payload.receiver_id=peer; if(room)payload.room_id=room;
 if(fileInput.files.length){
   const file=fileInput.files[0];
   const base64=await toBase64(file);
   const up=await post({action:"uploadFile",file_name:file.name,mimeType:file.type,file_base64:base64.split(",")[1]});
   if(up.success)payload.file_link=up.file_url;
   fileInput.value="";
 }
 const res=await post(payload);
 if(res.success){messageInput.value="";loadMessages(false);}
}

// ---- Helpers
function playBeep(){new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play().catch(()=>{});}
function toBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});}

// ---- Heartbeat (presence)
setInterval(()=>{if(me)post({action:"heartbeat",user_id:me});},60000);

// ---- Poll messages
setInterval(()=>loadMessages(true),3000);

// ---- Search
searchUsers.oninput=()=>renderUsers(searchUsers.value);
searchMessages.onkeypress=async e=>{
 if(e.key==="Enter"){const q=searchMessages.value.trim();if(!q)return;
 const res=await get(`action=searchMessages&query=${encodeURIComponent(q)}`);
 chatBox.innerHTML=res.map(m=>`<div><b>${m.message}</b><div class="meta">${m.timestamp}</div></div>`).join("");
 }
};

// ---- Events
sendBtn.onclick=sendMessage;
messageInput.onkeypress=e=>{if(e.key==="Enter")sendMessage();};
meSelect.onchange=()=>{me=meSelect.value;localStorage.setItem("chat_me",me);renderUsers();};
$("roomsBtn").onclick=async()=>{await loadRooms();chatBox.innerHTML=rooms.map(r=>`<div class='person' onclick='openRoom("${r.room_id}")'>${r.room_name}</div>`).join("");};

// ---- Init
(async()=>{me=localStorage.getItem("chat_me")||"";await loadUsers();})();
</script>
</body>
</html>
