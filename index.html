<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>InCheck Pro â€“ Issues Â· Ops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="styles.css" />

    <!-- Chart.js (for the 4 charts) -->
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
    ></script>

    <!-- FullCalendar (calendar tab) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  </head>

  <body>
    <!-- Header -->
    <header>
      <div class="brand">
        <div class="logo">IC</div>
        <div class="brand-text">
          <span>InCheck Pro</span>
          <span>Issues Â· Ops</span>
        </div>
      </div>

      <div style="flex: 1; max-width: 420px; margin-left: 10px">
        <input
          id="searchInput"
          class="input"
          type="search"
          placeholder="Search issues (ID, title, descriptor)â€¦"
        />
      </div>

      <!-- keep global date filters for JS if needed, but hidden so no duplicate -->
      <div style="display: none">
        <input type="date" id="globalStartDate" />
        <input type="date" id="globalEndDate" />
      </div>

      <div class="toolbar">
        <select id="themeToggle" class="select sm">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark" selected>Dark</option>
        </select>

        <button id="refreshButton" class="btn sm">
          â†» <span>Refresh</span>
        </button>

        <button id="exportCsvButton" class="btn sm">
          â‡© <span>Export CSV</span>
        </button>

        <span id="onlineStatusChip">Online</span>
      </div>
    </header>

    <div class="wrap">
      <!-- Sidebar filters -->
      <aside class="sidebar" id="sidebar">
        <h3>Filters</h3>

        <div class="filter-group">
          <div class="filter-row">
            <label for="moduleFilter">Module</label>
            <select id="moduleFilter" class="select">
              <option value="">All</option>
            </select>
          </div>

          <div class="filter-row">
            <label for="priorityFilter">Priority</label>
            <select id="priorityFilter" class="select">
              <option value="">All</option>
              <option>High</option>
              <option>Medium</option>
              <option>Low</option>
            </select>
          </div>

          <div class="filter-row">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" class="select">
              <option value="">All</option>
            </select>
          </div>

          <div class="divider"></div>

          <div class="filter-row">
            <label for="startDateFilter">Start Date</label>
            <input
              type="date"
              id="startDateFilter"
              class="input"
              placeholder="dd-----yyyy"
            />
          </div>

          <div class="filter-row">
            <label for="endDateFilter">End Date</label>
            <input
              type="date"
              id="endDateFilter"
              class="input"
              placeholder="dd-----yyyy"
            />
          </div>

          <div class="filter-row">
            <button id="resetFiltersBtn" class="btn sm" style="width: 100%">
              Reset filters
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="filter-group">
          <h3>Dataset</h3>
          <div class="filter-row">
            <label class="muted">Sources</label>
            <div class="filter-chips">
              <button
                type="button"
                id="issuesDatasetChip"
                class="filter-chip"
              >
                <span class="dot ok"></span> Issues: <span id="issuesDatasetTs">â€“</span>
              </button>
              <button
                type="button"
                id="eventsDatasetChip"
                class="filter-chip"
              >
                <span class="dot ok"></span> Events: <span id="eventsDatasetTs">â€“</span>
              </button>
            </div>
          </div>

          <div class="filter-row">
            <label class="muted">Keyboard</label>
            <div style="font-size: 11px; color: var(--muted)">
              <div>1 = Issues, 2 = Calendar</div>
              <div>/ = Search</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="content">
        <!-- top controls for view switching -->
        <div style="display: flex; align-items: center; gap: 10px">
          <div class="view-tabs">
            <button id="issuesTab" class="view-tab active">
              <span class="icon">#</span>
              <span>Issues</span>
            </button>
            <button id="calendarTab" class="view-tab">
              <span class="icon">ðŸ“…</span>
              <span>Calendar</span>
            </button>
          </div>
        </div>

        <!-- ISSUES VIEW -->
        <section id="issuesView" class="view active">
          <!-- Overview bar -->
          <div class="card summary-bar">
            <div>
              <div style="font-size: 13px; margin-bottom: 2px">
                <strong id="issuesOverviewLine">
                  0 issues Â· 0 open Â· 0 high-risk
                </strong>
              </div>
              <div class="muted" style="font-size: 11px">
                Last updated: <span id="issuesLastUpdated">â€“</span>
              </div>
            </div>

            <div class="statusline">
              <span class="dot ok"></span>
              <span id="datasetStatusText">Datasets healthy</span>
            </div>

            <div style="display: flex; gap: 6px">
              <button id="newTicketButton" class="btn primary sm">
                + New ticket
              </button>
              <button id="refreshDataButton" class="btn sm">
                â†» Refresh data
              </button>
              <button id="exportCsvButton2" class="btn sm">
                â‡© Export CSV
              </button>
            </div>
          </div>

          <!-- KPIs 4-across -->
          <div class="grid cols-4">
            <div class="card kpi" data-status-filter="">
              <div class="label">Total issues</div>
              <div class="value" id="kpiTotalIssues">0</div>
              <div class="sub" id="kpiTotalIssuesSub">100%</div>
            </div>

            <div class="card kpi" data-status-filter="Rejected">
              <div class="label">Rejected</div>
              <div class="value" id="kpiRejected">0</div>
              <div class="sub" id="kpiRejectedPct">0%</div>
            </div>

            <div class="card kpi" data-status-filter="Resolved">
              <div class="label">Resolved</div>
              <div class="value" id="kpiResolved">0</div>
              <div class="sub" id="kpiResolvedPct">0%</div>
            </div>

            <div class="card kpi" data-status-filter="On Stage">
              <div class="label">On Stage</div>
              <div class="value" id="kpiOnStage">0</div>
              <div class="sub" id="kpiOnStagePct">0%</div>
            </div>

            <div class="card kpi" data-status-filter="Tested on Staging">
              <div class="label">Tested on Staging</div>
              <div class="value" id="kpiOnStaging">0</div>
              <div class="sub" id="kpiOnStagingPct">0%</div>
            </div>

            <div class="card kpi" data-status-filter="Under Development">
              <div class="label">Under Development</div>
              <div class="value" id="kpiUnderDev">0</div>
              <div class="sub" id="kpiUnderDevPct">0%</div>
            </div>

            <div class="card kpi" data-status-filter="On Hold">
              <div class="label">On Hold</div>
              <div class="value" id="kpiOnHold">0</div>
              <div class="sub" id="kpiOnHoldPct">0%</div>
            </div>

            <div class="card kpi" data-status-filter="In Progress">
              <div class="label">In Progress</div>
              <div class="value" id="kpiInProgress">0</div>
              <div class="sub" id="kpiInProgressPct">0%</div>
            </div>
          </div>

          <!-- 4 charts: 2 on first row, 2 below (all separate cards) -->
          <div class="charts">
            <div class="card">
              <div style="font-size: 13px; margin-bottom: 6px">
                <strong>Issues by module</strong>
              </div>
              <canvas id="issuesByModuleChart"></canvas>
            </div>

            <div class="card">
              <div style="font-size: 13px; margin-bottom: 6px">
                <strong>Issues by priority</strong>
              </div>
              <canvas id="issuesByPriorityChart"></canvas>
            </div>

            <div class="card">
              <div style="font-size: 13px; margin-bottom: 6px">
                <strong>Issues by status</strong>
              </div>
              <canvas id="issuesByStatusChart"></canvas>
            </div>

            <div class="card">
              <div style="font-size: 13px; margin-bottom: 6px">
                <strong>Issues by type</strong>
              </div>
              <canvas id="issuesByTypeChart"></canvas>
            </div>
          </div>

          <!-- Issues table -->
          <div class="card" style="margin-top: 6px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
              "
            >
              <div>
                <div style="font-size: 13px">
                  <strong>Issues</strong>
                </div>
                <div class="muted" style="font-size: 11px">
                  Live feed from InCheck issues sheet.
                </div>
              </div>

              <div class="table-actions">
                <div class="muted">
                  Showing <span id="issuesVisibleCount">0</span> of
                  <span id="issuesTotalCount">0</span>
                </div>
              </div>
            </div>

            <div class="table-wrap">
              <table id="issuesTable">
                <thead>
                  <tr>
                    <th class="sortable" data-sort-key="id">ID</th>
                    <th class="sortable" data-sort-key="module">Module</th>
                    <th class="sortable" data-sort-key="title">Title</th>
                    <th class="sortable" data-sort-key="priority">Priority</th>
                    <th class="sortable" data-sort-key="status">Status</th>
                    <th class="sortable" data-sort-key="owner">Owner</th>
                    <th class="sortable" data-sort-key="dueDate">Due</th>
                    <th class="sortable" data-sort-key="age">Age (days)</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CALENDAR VIEW -->
        <section id="calendarView" class="view">
          <!-- top bar for calendar + controls -->
          <div class="card summary-bar">
            <div>
              <div style="font-size: 13px; margin-bottom: 2px">
                <strong>Calendar &amp; Releases</strong>
              </div>
              <div class="muted" style="font-size: 11px">
                Times shown in: <span id="calendarTimezoneLabel">â€“</span>
              </div>
            </div>

            <div class="filter-chips">
              <label class="muted" style="margin-right: 4px">Event types:</label>
              <label class="chip">
                <input
                  type="checkbox"
                  id="filterTypeDeployment"
                  checked
                  style="margin-right: 4px"
                />Deployment
              </label>
              <label class="chip">
                <input
                  type="checkbox"
                  id="filterTypeMaintenance"
                  checked
                  style="margin-right: 4px"
                />Maintenance
              </label>
              <label class="chip">
                <input
                  type="checkbox"
                  id="filterTypeRelease"
                  checked
                  style="margin-right: 4px"
                />Release
              </label>
              <label class="chip">
                <input
                  type="checkbox"
                  id="filterTypeOther"
                  checked
                  style="margin-right: 4px"
                />Other
              </label>
            </div>

            <div style="display: flex; gap: 6px; align-items: center">
              <button id="todayButton" class="btn sm">Today</button>
              <button id="addEventButton" class="btn primary sm">
                + Add event
              </button>
            </div>
          </div>

          <!-- calendar itself -->
          <div class="card">
            <div id="calendar"></div>
            <div
              id="calendarError"
              class="muted"
              style="font-size: 12px; margin-top: 8px; display: none"
            >
              Calendar library failed to load.
            </div>
          </div>

          <!-- release planner under the calendar -->
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                gap: 10px;
                align-items: center;
              "
            >
              <div>
                <div style="font-size: 13px">
                  <strong>Release planner â€“ F&amp;B Middle East</strong>
                </div>
                <div class="muted" style="font-size: 11px">
                  Suggest safer release windows based on rush hours, holidays and
                  bug pressure.
                </div>
              </div>

              <button id="suggestSlotsButton" class="btn sm">
                Suggest slots
              </button>
            </div>

            <div class="planner-grid" style="margin-top: 10px">
              <div class="field">
                <label for="plannerRegion">Region profile</label>
                <select id="plannerRegion" class="select">
                  <option>Gulf (KSA / UAE / Qatar)</option>
                  <option>Levant</option>
                  <option>North Africa</option>
                  <option>Custom</option>
                </select>
              </div>

              <div class="field">
                <label for="plannerEnvironment">Environment</label>
                <select id="plannerEnvironment" class="select">
                  <option value="Prod">Prod</option>
                  <option value="Staging">Staging</option>
                  <option value="Dev">Dev</option>
                </select>
              </div>

              <div class="field">
                <label for="plannerReleaseType">Release type</label>
                <select id="plannerReleaseType" class="select">
                  <option value="Feature">Feature</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Hotfix">Hotfix</option>
                </select>
              </div>

              <div class="field">
                <label for="plannerHorizon">Horizon (days)</label>
                <input
                  type="number"
                  id="plannerHorizon"
                  class="input"
                  min="1"
                  max="30"
                  value="7"
                />
              </div>

              <div class="field">
                <label for="plannerSlotsPerDay">Slots per day (max)</label>
                <input
                  type="number"
                  id="plannerSlotsPerDay"
                  class="input"
                  min="1"
                  max="8"
                  value="4"
                />
              </div>

              <div class="field">
                <label for="plannerModules">Modules / areas</label>
                <input
                  type="text"
                  id="plannerModules"
                  class="input"
                  placeholder="e.g. POS, kitchen, delivery"
                />
              </div>
            </div>

            <div id="suggestedSlotsContainer" style="margin-top: 10px"></div>
          </div>
        </section>
      </main>
    </div>

    <!-- Add Event modal -->
    <div class="modal" id="addEventModal">
      <div class="modal-content">
        <div class="header">
          <h3>Add Event</h3>
          <button class="modal-close" id="closeAddEvent">&times;</button>
        </div>

        <form id="addEventForm">
          <div class="planner-grid">
            <div class="field">
              <label for="eventTitle">Title</label>
              <input
                id="eventTitle"
                name="title"
                class="input"
                required
                placeholder="Release name / change summary"
              />
            </div>

            <div class="field">
              <label for="eventType">Type</label>
              <select id="eventType" name="type" class="select" required>
                <option value="Deployment">Deployment</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Release">Release</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="field">
              <label for="eventEnvironment">Environment</label>
              <select
                id="eventEnvironment"
                name="environment"
                class="select"
                required
              >
                <option value="Prod">Prod</option>
                <option value="Staging">Staging</option>
                <option value="Dev">Dev</option>
              </select>
            </div>

            <div class="field">
              <label for="eventChangeStatus">Change status</label>
              <select
                id="eventChangeStatus"
                name="changeStatus"
                class="select"
              >
                <option value="Planned">Planned</option>
                <option value="Tentative">Tentative</option>
                <option value="Confirmed">Confirmed</option>
              </select>
            </div>

            <div class="field">
              <label for="eventOwner">Owner</label>
              <input
                id="eventOwner"
                name="owner"
                class="input"
                placeholder="Change owner / squad"
              />
            </div>

            <div class="field">
              <label for="eventImpact">Impact</label>
              <input
                id="eventImpact"
                name="impact"
                class="input"
                placeholder="No downtime expected"
              />
            </div>

            <div class="field">
              <label for="eventModules">Modules</label>
              <input
                id="eventModules"
                name="modules"
                class="input"
                placeholder="Comma-separated modules"
              />
            </div>

            <div class="field">
              <label for="eventLinkedTickets">Linked ticket ID(s)</label>
              <input
                id="eventLinkedTickets"
                name="linkedTickets"
                class="input"
                placeholder="e.g. INC-123, INC-456"
              />
            </div>

            <div class="field">
              <label for="eventStart">Start</label>
              <input
                type="datetime-local"
                id="eventStart"
                name="start"
                class="input"
                required
              />
            </div>

            <div class="field">
              <label for="eventEnd">End</label>
              <input
                type="datetime-local"
                id="eventEnd"
                name="end"
                class="input"
                required
              />
            </div>

            <div class="field">
              <label class="muted">All day</label>
              <label
                style="
                  display: inline-flex;
                  align-items: center;
                  gap: 6px;
                  margin-top: 6px;
                  font-size: 13px;
                "
              >
                <input type="checkbox" id="eventAllDay" name="allDay" />
                Mark as all-day
              </label>
            </div>
          </div>

          <div class="field" style="margin-top: 10px">
            <label for="eventDescription">Description</label>
            <textarea
              id="eventDescription"
              name="description"
              class="input"
              placeholder="Release / maintenance details, expected impact, comms notesâ€¦"
            ></textarea>
          </div>

          <div
            class="actions"
            style="margin-top: 12px; justify-content: flex-end"
          >
            <button type="button" id="cancelAddEvent" class="btn ghost sm">
              Cancel
            </button>
            <button type="submit" class="btn primary sm">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- global loading + toast -->
    <div class="spinner" id="globalSpinner">
      <div class="ring"></div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- App logic -->
    <script src="script.js"></script>
  </body>
</html>
