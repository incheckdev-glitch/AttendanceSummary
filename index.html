function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    const secret = body.secret;
    const sheetName = body.sheet;
    const action = body.action;
    const payload = body.payload;

    if (secret !== "a9fj32klsdfj0932LKJSDF90wef9") {
      return jsonResponse({ ok: false, error: "unauthorized" });
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      return jsonResponse({ ok: false, error: "sheet not found" });
    }

    // ---------------- HOLIDAYS ----------------
    if (sheetName === "Holidays") {
      if (action === "add") {
        sheet.appendRow([payload.date, payload.name || ""]);
        return success();
      }
      if (action === "remove") {
        return removeRow(sheet, payload.date, 0);
      }
      if (action === "list") {
        return jsonResponse({ ok: true, data: sheet.getDataRange().getValues() });
      }
    }

    // ---------------- LEAVES ----------------
    if (sheetName === "Leaves") {
      if (action === "add") {
        sheet.appendRow([payload.date, payload.employee, payload.type, "Pending"]);
        return success();
      }
      if (action === "approve" || action === "reject") {
        const values = sheet.getDataRange().getValues();
        for (let i = 1; i < values.length; i++) {
          if (values[i][0] === payload.date && values[i][1] === payload.employee) {
            sheet.getRange(i + 1, 4).setValue(action === "approve" ? "Approved" : "Rejected");
            return success();
          }
        }
      }
      if (action === "remove") {
        return removeRow(sheet, payload.date + payload.employee, [0, 1]);
      }
      if (action === "list") {
        return jsonResponse({ ok: true, data: sheet.getDataRange().getValues() });
      }
    }

    // ---------------- BALANCES ----------------
    if (sheetName === "Balances") {
      if (action === "update") {
        const values = sheet.getDataRange().getValues();
        let updated = false;
        for (let i = 1; i < values.length; i++) {
          if (values[i][0] === payload.employee) {
            sheet.getRange(i + 1, 2, 1, 3).setValues([[payload.annual, payload.sick, payload.unpaid]]);
            updated = true;
            break;
          }
        }
        if (!updated) {
          sheet.appendRow([payload.employee, payload.annual, payload.sick, payload.unpaid]);
        }
        return success();
      }
      if (action === "remove") {
        return removeRow(sheet, payload.employee, 0);
      }
      if (action === "list") {
        return jsonResponse({ ok: true, data: sheet.getDataRange().getValues() });
      }
    }

    // ---------------- SIGN IN / SIGN OUT ----------------
    if (sheetName === "SignIn" || sheetName === "SignOut") {
      if (action === "add") {
        sheet.appendRow([payload.date, payload.employee, payload.time]);
        return success();
      }
      if (action === "remove") {
        return removeRow(sheet, payload.date + payload.employee, [0, 1]);
      }
      if (action === "list") {
        return jsonResponse({ ok: true, data: sheet.getDataRange().getValues() });
      }
    }

    return jsonResponse({ ok: false, error: "unknown action" });

  } catch (err) {
    return jsonResponse({ ok: false, error: err.message });
  }
}

function success() {
  return jsonResponse({ ok: true });
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(
    JSON.stringify(obj)
  ).setMimeType(ContentService.MimeType.JSON);
}

function removeRow(sheet, match, cols) {
  const values = sheet.getDataRange().getValues();
  for (let i = 1; i < values.length; i++) {
    if (Array.isArray(cols)) {
      let key = cols.map(c => values[i][c]).join("");
      if (key === match) {
        sheet.deleteRow(i + 1);
        return success();
      }
    } else {
      if (values[i][cols] === match) {
        sheet.deleteRow(i + 1);
        return success();
      }
    }
  }
  return jsonResponse({ ok: false, error: "not found" });
}
