<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- JS Libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { background: #f8f9fa; }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
  </style>
</head>

<body>
  <div class="container-fluid p-4" id="reportArea">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>ðŸ“Š Attendance Dashboard</h2>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
    </div>

    <!-- KPIs -->
    <div class="row mb-4 text-center">
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Total Hours</h5><h3 id="totalHours">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Avg Hours</h5><h3 id="avgHours">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Days Count</h5><h3 id="daysCount">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Late Count</h5><h3 id="lateCount">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Early Leaves</h5><h3 id="earlyCount">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h5>Absent</h5><h3 id="absentCount">0</h3></div></div></div>
    </div>

    <!-- Table -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
      </div>
    </div>

    <!-- Charts -->
    <div class="row">
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
    </div>
  </div>

  <script>
    const ATTENDANCE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
    const LEAVES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=33718844&single=true&output=csv";

    let CANON = [];
    let leaves = [];
    let holidays = []; // later you can load holiday sheet

    // Convert to minutes
    function toMinutes(hhmm) { const [h,m]=hhmm.split(":").map(Number); return h*60+m; }

    function mapRow(r) {
      const row = {}; Object.keys(r).forEach(k => row[k.trim().toLowerCase()] = r[k]);
      return {
        month: row["month"] || "",
        date: row["date"] || "",
        employee: row["employee name"] || row["employee"] || "",
        signIn: row["sign in time"] || "",
        signOut: row["sign out time"] || "",
        totalHours: parseFloat(row["total hours"]||"0")||0
      };
    }

    function computeStatus(row) {
      const d=new Date(row.date); const day=d.getDay();
      // Leaves
      const lv=leaves.find(l => l.date===row.date && l.employee===row.employee);
      if (lv) return [lv.type]; // AL/SL/UL
      // Holiday
      if (holidays.some(h=>h.date===row.date)) return ["Holiday"];
      // Weekend
      if (day===0 || day===6) return ["Weekend"];
      // Absent
      if (!row.signIn && !row.signOut) return ["Absent"];
      // Needs correction
      if ((row.signIn && !row.signOut)||(!row.signIn && row.signOut)) return ["Needs Correction"];
      // Work hours rules
      const settings={late:"08:15",early:"16:30",half:4,over:9};
      const status=[];
      const inMin=row.signIn?toMinutes(row.signIn):null;
      const outMin=row.signOut?toMinutes(row.signOut):null;
      if(inMin && inMin>toMinutes(settings.late)) status.push("Late");
      if(outMin && outMin<toMinutes(settings.early)) status.push("Early Leave");
      if(row.totalHours>0 && row.totalHours<settings.half) status.push("Half-day");
      if(row.totalHours>=settings.over) status.push("Overtime");
      if(!status.length) status.push("On Time");
      return status;
    }

    function badge(label){
      let cls="bg-secondary";
      if(label==="Late") cls="bg-danger";
      else if(label==="Early Leave") cls="bg-warning text-dark";
      else if(label==="On Time") cls="bg-success";
      else if(label==="Absent") cls="bg-dark";
      else if(label==="Needs Correction") cls="bg-danger text-white";
      else if(label==="Half-day") cls="bg-info text-dark";
      else if(label==="Overtime") cls="bg-primary";
      else if(label==="Holiday") cls="bg-orange text-dark";
      else if(label==="Weekend") cls="bg-light text-dark";
      else if(label==="AL") cls="bg-warning";
      else if(label==="SL") cls="bg-info";
      else if(label==="UL") cls="bg-secondary";
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function renderTable(data){
      const rows=data.map(r=>{
        const st=computeStatus(r).map(badge).join(" ");
        return [r.month,r.date,r.employee,r.signIn,r.signOut,r.totalHours.toFixed(2),st];
      });
      if(!$.fn.DataTable.isDataTable("#attendanceTable")){
        $("#attendanceTable").DataTable({
          data:rows,
          columns:[
            {title:"Month"},{title:"Date"},{title:"Employee"},
            {title:"Sign In"},{title:"Sign Out"},{title:"Total Hours"},{title:"Status"}
          ],
          dom:"Bfrtip",buttons:["csv","excel","pdf","print"],
          pageLength:10
        });
      } else {
        const dt=$("#attendanceTable").DataTable();
        dt.clear().rows.add(rows).draw();
      }
      updateKPIs(data);
    }

    function updateKPIs(data){
      let sum=0,days=new Set(),late=0,early=0,absent=0;
      data.forEach(r=>{
        const st=computeStatus(r);
        if(st.includes("Late")) late++;
        if(st.includes("Early Leave")) early++;
        if(st.includes("Absent")) absent++;
        if(r.totalHours) sum+=r.totalHours;
        if(r.date) days.add(r.date);
      });
      document.getElementById("totalHours").textContent=sum.toFixed(2);
      document.getElementById("avgHours").textContent=(days.size?sum/days.size:0).toFixed(2);
      document.getElementById("daysCount").textContent=days.size;
      document.getElementById("lateCount").textContent=late;
      document.getElementById("earlyCount").textContent=early;
      document.getElementById("absentCount").textContent=absent;
    }

    async function loadData(){
      // Load attendance
      const res=await fetch(ATTENDANCE_CSV); const csv=await res.text();
      const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
      const baseRows=parsed.data.map(mapRow).filter(r=>r.employee && r.date);
      // Load leaves
      const resL=await fetch(LEAVES_CSV); const csvL=await resL.text();
      const parsedL=Papa.parse(csvL,{header:true,skipEmptyLines:true});
      leaves=parsedL.data.map(r=>({
        date:r["Date"]||r["date"],employee:r["Employee"]||r["employee"],type:r["Type"]||r["type"]
      }));
      CANON=baseRows;
      renderTable(CANON);
    }

    async function downloadFullReport(){
      const el=document.getElementById("reportArea");
      const canvas=await html2canvas(el,{scale:2,backgroundColor:"#fff"});
      const img=canvas.toDataURL("image/png");
      pdfMake.createPdf({content:[{image:img,width:500}]}).download("Attendance_Report.pdf");
    }

    loadData();
  </script>
</body>
</html>
