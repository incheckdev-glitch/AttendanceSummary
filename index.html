<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>InCheck 360 Chat</title>
<style>
:root{
  --primary:#0078d7;--primary-dark:#005bb5;
  --bg-dark:#1e1f24;--text-light:#fff;
  --sent-bg:var(--primary);--received-bg:#3a3b3f;--radius:18px;
}
body{
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  background:linear-gradient(135deg,var(--primary-dark),var(--primary));
  margin:0;display:flex;justify-content:center;align-items:center;height:100vh;color:var(--text-light);
}
.chat-container{
  width:420px;height:600px;background:var(--bg-dark);border-radius:20px;
  box-shadow:0 4px 20px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;
}
.chat-header{
  background:rgba(0,0,0,.2);text-align:center;padding:15px 10px;font-size:1.2em;font-weight:bold;
}
.user-select{
  display:flex;justify-content:space-between;padding:8px 15px;background:rgba(255,255,255,.05);
}
.user-select select{
  width:48%;padding:6px;border-radius:6px;border:none;outline:none;
  background:rgba(255,255,255,.1);color:#fff;
}
.chat-box{
  flex-grow:1;padding:15px;overflow-y:auto;background:var(--bg-dark);
  display:flex;flex-direction:column;scroll-behavior:smooth;
}
.message{display:flex;align-items:flex-end;margin:10px 0;opacity:0;animation:fadeIn .3s ease forwards;}
.message .bubble{
  padding:10px 14px;border-radius:var(--radius);max-width:75%;
  font-size:.95em;line-height:1.4;word-wrap:break-word;
}
.sent{justify-content:flex-end;}
.sent .bubble{background:var(--sent-bg);color:#fff;border-bottom-right-radius:4px;}
.received{justify-content:flex-start;}
.received .bubble{background:var(--received-bg);color:#fff;border-bottom-left-radius:4px;}
.timestamp{font-size:.7em;color:#aaa;margin-top:2px;text-align:right;}
.message-input{
  display:flex;align-items:center;border-top:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);padding:10px;
}
.message-input input{
  flex:1;padding:10px;border:none;border-radius:20px;background:rgba(255,255,255,.1);
  color:#fff;outline:none;
}
.message-input button{
  margin-left:10px;border:none;background:var(--primary);color:#fff;
  padding:10px 12px;border-radius:50%;cursor:pointer;transition:.3s;
}
.message-input button:hover{background:var(--primary-dark);}
@keyframes fadeIn{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@media(max-width:500px){.chat-container{width:100%;height:100%;border-radius:0;}}
</style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">ðŸ’¬ InCheck 360 Chat (Pro + Smart Polling)</div>
  <div class="user-select">
    <select id="senderSelect"><option value="">You</option></select>
    <select id="receiverSelect"><option value="">Chat With</option></select>
  </div>
  <div id="chatBox" class="chat-box">
    <p style="color:#888;text-align:center;margin-top:20px;">Select users to start chatting...</p>
  </div>
  <div class="message-input">
    <input id="messageInput" type="text" placeholder="Type a message...">
    <button id="sendBtn">âž¤</button>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzKpLMouySKF0CvWay77649xDXWLzKcrbJcrc88SKXBIBKhHBoONTkmZT1-jxvm7h04Qw/exec";
const senderSelect=document.getElementById("senderSelect");
const receiverSelect=document.getElementById("receiverSelect");
const chatBox=document.getElementById("chatBox");
const messageInput=document.getElementById("messageInput");
const sendBtn=document.getElementById("sendBtn");

let lastMessageId=0;

async function loadUsers(){
  try{
    const res=await fetch(`${API_URL}?action=getUsers`);
    const users=await res.json();
    users.forEach(u=>{
      const opt1=new Option(u.name,u.user_id);
      const opt2=new Option(u.name,u.user_id);
      senderSelect.add(opt1);receiverSelect.add(opt2);
    });
  }catch(e){console.error(e);}
}

async function loadMessages(showNotify=true){
  const s=senderSelect.value,r=receiverSelect.value;
  if(!s||!r)return;
  try{
    const res=await fetch(`${API_URL}?action=getMessages&user1=${s}&user2=${r}`);
    const msgs=await res.json();
    if(msgs.length===0){chatBox.innerHTML="<p style='color:#777;text-align:center;'>No messages yet...</p>";return;}
    const newest=msgs[msgs.length-1].msg_id;
    const isNew=newest!==lastMessageId;
    const lastSender=msgs[msgs.length-1].sender_id;
    lastMessageId=newest;

    chatBox.innerHTML="";
    msgs.forEach(m=>{
      const div=document.createElement("div");
      div.classList.add("message",m.sender_id==s?"sent":"received");
      div.innerHTML=`<div class="bubble">${m.message}<div class="timestamp">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div>`;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop=chatBox.scrollHeight;

    if(isNew&&lastSender!=s&&showNotify){
      playSound();
      flashTitle();
    }
  }catch(e){console.error("loadMessages error",e);}
}

function playSound(){
  const audio=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  audio.play().catch(()=>{});
}
function flashTitle(){
  const old=document.title;
  document.title="ðŸ”” New message!";
  setTimeout(()=>{document.title=old;},2000);
}

async function sendMessage(){
  const s=senderSelect.value,r=receiverSelect.value,msg=messageInput.value.trim();
  if(!s||!r)return alert("Select both users first.");
  if(!msg)return;
  const payload={action:"sendMessage",sender_id:s,receiver_id:r,message:msg};
  const res=await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
  const data=await res.json();
  if(data.success){messageInput.value="";loadMessages(false);}else alert("Send error:"+data.error);
}

sendBtn.addEventListener("click",sendMessage);
messageInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMessage();});
receiverSelect.addEventListener("change",()=>loadMessages(false));
setInterval(()=>loadMessages(true),3000);
loadUsers();
</script>
</body>
</html>
