<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Unified Operations & Attendance Dashboard</title>

<!-- External Libraries -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

<style>
/* ======= RESET & THEME ======= */
:root {
  --bg: #0f172a;
  --fg: #f1f5f9;
  --accent: #3b82f6;
  --card: #1e293b;
  --border: #334155;
}
body.light {
  --bg: #f8fafc;
  --fg: #0f172a;
  --accent: #2563eb;
  --card: #ffffff;
  --border: #cbd5e1;
}
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--fg);
  transition: background 0.3s, color 0.3s;
}
h1,h2,h3 { margin: 0; font-weight: 600; }

/* ======= LAYOUT GRID ======= */
.dashboard {
  display: grid;
  grid-template-columns: 1fr 380px;
  grid-template-rows: auto 1fr;
  height: 100vh;
  overflow: hidden;
}
header {
  grid-column: 1 / -1;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 0.8rem 1.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
main {
  display: flex;
  height: 100%;
}
section#calendar-area {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}
aside#attendance-panel {
  width: 380px;
  background: var(--card);
  padding: 1rem;
  overflow-y: auto;
}

/* ======= COMPONENT STYLES ======= */
button, input, select {
  background: var(--card);
  color: var(--fg);
  border: 1px solid var(--border);
  border-radius: 0.4rem;
  padding: 0.4rem 0.6rem;
}
button:hover { background: var(--accent); color: #fff; cursor: pointer; }

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

/* ======= CALENDAR ======= */
#calendar {
  background: var(--card);
  border-radius: 1rem;
  padding: 0.6rem;
}

/* ======= ATTENDANCE PANEL ======= */
#attendance-panel h2 { margin-bottom: 0.5rem; }
.attendance-summary {
  display: flex;
  justify-content: space-around;
  margin-bottom: 1rem;
}
.attendance-summary div {
  text-align: center;
}
canvas {
  width: 100% !important;
  height: 250px !important;
}

/* ======= TOGGLE ======= */
.theme-toggle {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
</style>
</head>
<body class="dark">
<div class="dashboard">
  <header>
    <h1>InCheck + Attendance Dashboard</h1>
    <div class="theme-toggle">
      <label for="themeSwitch">üåô / ‚òÄÔ∏è</label>
      <input type="checkbox" id="themeSwitch" />
    </div>
  </header>

  <main>
    <section id="calendar-area">
      <div id="calendar"></div>
    </section>

    <aside id="attendance-panel">
      <h2>Attendance Intelligence</h2>
      <div class="attendance-summary">
        <div><h3 id="presentCount">0</h3><p>Present</p></div>
        <div><h3 id="absentCount">0</h3><p>Absent</p></div>
        <div><h3 id="lateCount">0</h3><p>Late</p></div>
      </div>
      <canvas id="attendanceChart"></canvas>
      <div class="card">
        <h3>Performance Notes</h3>
        <ul id="performanceList"></ul>
      </div>
    </aside>
  </main>
</div>
<script>
// =================== THEME TOGGLE ===================
const themeSwitch = document.getElementById("themeSwitch");
themeSwitch.addEventListener("change", () => {
  document.body.classList.toggle("light", themeSwitch.checked);
});

// =================== INCHECK DASHBOARD LOGIC ===================

// Example Google Sheet URL for events/tasks
const SHEET_URL_ISSUES = "https://docs.google.com/spreadsheets/d/your_incheck_sheet_id_here/gviz/tq?tqx=out:json";

// We'll maintain a global array for events
let eventsData = [];

// Fetch events from Google Sheets (InCheck tasks)
async function fetchInCheckEvents() {
  try {
    const res = await fetch(SHEET_URL_ISSUES);
    const text = await res.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;

    eventsData = rows.map(r => ({
      title: r.c[0]?.v || "Untitled",
      start: r.c[1]?.v ? new Date(r.c[1].v).toISOString().split("T")[0] : null,
      end: r.c[2]?.v ? new Date(r.c[2].v).toISOString().split("T")[0] : null,
      priority: r.c[3]?.v || "Medium",
      status: r.c[4]?.v || "Open",
      description: r.c[5]?.v || "",
    }));

    initCalendar(eventsData);
  } catch (e) {
    console.error("Error loading InCheck data:", e);
    initCalendar([]); // fallback empty
  }
}

// =================== FULLCALENDAR INITIALIZATION ===================
function initCalendar(events) {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    aspectRatio: 1.4,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events: events.map(e => ({
      title: e.title,
      start: e.start,
      end: e.end,
      extendedProps: { priority: e.priority, status: e.status, description: e.description }
    })),
    eventDidMount: function(info) {
      const priorityColor = {
        "High": "#ef4444",
        "Medium": "#f59e0b",
        "Low": "#10b981"
      }[info.event.extendedProps.priority] || "#3b82f6";
      info.el.style.backgroundColor = priorityColor;
      info.el.style.borderColor = priorityColor;
    },
    eventClick: function(info) {
      const e = info.event.extendedProps;
      alert(
        `üìã ${info.event.title}\n\nStatus: ${e.status}\nPriority: ${e.priority}\n\nDescription:\n${e.description}`
      );
    }
  });
  calendar.render();
}

// Start calendar loading
fetchInCheckEvents();
</script>
<script>
// =================== ATTENDANCE INTELLIGENCE ===================

// Separate Google Sheet for attendance data
const SHEET_URL_ATTENDANCE = "https://docs.google.com/spreadsheets/d/your_attendance_sheet_id_here/gviz/tq?tqx=out:json";

async function fetchAttendanceData() {
  try {
    const res = await fetch(SHEET_URL_ATTENDANCE);
    const text = await res.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;

    const attendance = rows.map(r => ({
      name: r.c[0]?.v || "Unknown",
      date: r.c[1]?.v || "",
      status: r.c[2]?.v || "Absent",
      note: r.c[3]?.v || ""
    }));

    updateAttendanceDashboard(attendance);
  } catch (e) {
    console.error("Error loading Attendance data:", e);
  }
}

function updateAttendanceDashboard(data) {
  const present = data.filter(d => d.status.toLowerCase() === "present").length;
  const absent = data.filter(d => d.status.toLowerCase() === "absent").length;
  const late = data.filter(d => d.status.toLowerCase() === "late").length;

  document.getElementById("presentCount").textContent = present;
  document.getElementById("absentCount").textContent = absent;
  document.getElementById("lateCount").textContent = late;

  const ctx = document.getElementById("attendanceChart").getContext("2d");
  if (window.attendanceChart) window.attendanceChart.destroy(); // reset chart

  window.attendanceChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["Present", "Absent", "Late"],
      datasets: [{
        data: [present, absent, late],
        backgroundColor: ["#10b981", "#ef4444", "#f59e0b"],
        borderWidth: 1,
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: getComputedStyle(document.body).getPropertyValue('--fg') }
        }
      }
    }
  });

  // Performance notes section
  const perfList = document.getElementById("performanceList");
  perfList.innerHTML = "";
  const notes = data
    .filter(d => d.note)
    .slice(0, 5);
  if (notes.length === 0) {
    perfList.innerHTML = "<li>No performance notes available</li>";
  } else {
    notes.forEach(n => {
      const li = document.createElement("li");
      li.textContent = `${n.name}: ${n.note}`;
      perfList.appendChild(li);
    });
  }
}

// Start Attendance system
fetchAttendanceData();
</script>
<script>
// =================== AUTO REFRESH SYSTEM ===================

// Refresh both dashboards every 5 minutes (300,000 ms)
setInterval(() => {
  console.log("‚è≥ Auto-refreshing dashboard data...");
  fetchInCheckEvents();
  fetchAttendanceData();
}, 300000); // 5 minutes

// Optional: manual refresh button
const header = document.querySelector("header");
const refreshBtn = document.createElement("button");
refreshBtn.textContent = "üîÑ Refresh Now";
refreshBtn.style.marginLeft = "1rem";
refreshBtn.onclick = () => {
  fetchInCheckEvents();
  fetchAttendanceData();
};
header.appendChild(refreshBtn);

// =================== RESPONSIVE DESIGN TWEAKS ===================
window.addEventListener("resize", adjustLayout);
function adjustLayout() {
  const isMobile = window.innerWidth < 900;
  const main = document.querySelector("main");
  const attendancePanel = document.getElementById("attendance-panel");
  if (isMobile) {
    main.style.flexDirection = "column";
    attendancePanel.style.width = "100%";
    attendancePanel.style.borderTop = "1px solid var(--border)";
  } else {
    main.style.flexDirection = "row";
    attendancePanel.style.width = "380px";
    attendancePanel.style.borderTop = "none";
  }
}
adjustLayout();

// =================== THEME SYNC ON REFRESH ===================
function syncChartTheme() {
  if (window.attendanceChart) {
    const labelsColor = getComputedStyle(document.body).getPropertyValue('--fg');
    window.attendanceChart.options.plugins.legend.labels.color = labelsColor;
    window.attendanceChart.update();
  }
}
themeSwitch.addEventListener("change", syncChartTheme);
</script>

</body>
</html>
