/**
 * Attendance Dashboard Backend with CORS
 * Sheets required: Attendance, Holidays, Leaves, Settings
 * Supports: GET, ADD, REMOVE, UPDATE
 */

// === Utility: JSON output with CORS ===
function corsResponse(obj) {
  const output = ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);

  // Add CORS headers
  const response = HtmlService.createHtmlOutput();
  response.append(JSON.stringify(obj));
  // Google Apps Script does not let us set headers on ContentService directly
  // so we return JSON normally, but allow OPTIONS preflight.
  return output;
}

// === Entry Points ===
function doGet(e) {
  try {
    const sheet = e.parameter.sheet;
    if (!sheet) return corsResponse({ ok: false, error: "Missing sheet parameter" });

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const ws = ss.getSheetByName(capitalize(sheet));
    if (!ws) return corsResponse({ ok: false, error: "Sheet not found: " + sheet });

    // Read all rows
    const data = ws.getDataRange().getValues();
    const headers = data.shift();
    const rows = data.map(r => {
      const obj = {};
      headers.forEach((h, i) => { obj[h] = r[i]; });
      return obj;
    });

    return corsResponse({ ok: true, data: rows });
  } catch (err) {
    return corsResponse({ ok: false, error: err.message });
  }
}

function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    const { sheet, action, payload } = body;

    if (!sheet) return corsResponse({ ok: false, error: "Missing sheet" });
    if (!action) return corsResponse({ ok: false, error: "Missing action" });

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const ws = ss.getSheetByName(capitalize(sheet));
    if (!ws) return corsResponse({ ok: false, error: "Sheet not found: " + sheet });

    // === SETTINGS SPECIAL HANDLING ===
    if (sheet.toLowerCase() === "settings") {
      if (action === "get") {
        const row = ws.getRange(2, 1, 1, 4).getValues()[0];
        return corsResponse({
          ok: true,
          data: {
            late: row[0] || "08:15",
            early: row[1] || "16:30",
            half: row[2] || 4,
            over: row[3] || 9
          }
        });
      }

      if (action === "update") {
        if (ws.getLastRow() < 2) {
          ws.clear();
          ws.appendRow(["Late", "Early", "Half", "Over"]);
          ws.appendRow([
            payload.late || "08:15",
            payload.early || "16:30",
            payload.half || 4,
            payload.over || 9
          ]);
        } else {
          ws.getRange(2, 1, 1, 4).setValues([[ 
            payload.late || "08:15",
            payload.early || "16:30",
            payload.half || 4,
            payload.over || 9
          ]]);
        }
        return corsResponse({ ok: true, saved: true });
      }
    }

    // === GENERIC SHEETS (Attendance, Holidays, Leaves) ===
    if (action === "add") {
      const headers = ws.getRange(1, 1, 1, ws.getLastColumn()).getValues()[0];
      const row = headers.map(h => payload[h] || "");
      ws.appendRow(row);
      return corsResponse({ ok: true, added: true });
    }

    if (action === "remove") {
      const data = ws.getDataRange().getValues();
      const headers = data.shift();
      let removed = 0;

      for (let i = data.length - 1; i >= 0; i--) {
        const row = data[i];
        let match = true;
        for (const k in payload) {
          const idx = headers.indexOf(k);
          if (idx === -1) continue;
          if (String(row[idx]) !== String(payload[k])) {
            match = false;
            break;
          }
        }
        if (match) {
          ws.deleteRow(i + 2); // account for header row
          removed++;
        }
      }
      return corsResponse({ ok: true, removed });
    }

    if (action === "update") {
      const data = ws.getDataRange().getValues();
      const headers = data.shift();
      let updated = 0;

      for (let i = 0; i < data.length; i++) {
        let match = true;
        for (const k in payload.where) {
          const idx = headers.indexOf(k);
          if (idx === -1) continue;
          if (String(data[i][idx]) !== String(payload.where[k])) {
            match = false;
            break;
          }
        }
        if (match) {
          for (const k in payload.set) {
            const idx = headers.indexOf(k);
            if (idx !== -1) {
              ws.getRange(i + 2, idx + 1).setValue(payload.set[k]);
            }
          }
          updated++;
        }
      }
      return corsResponse({ ok: true, updated });
    }

    return corsResponse({ ok: false, error: "Unknown action: " + action });
  } catch (err) {
    return corsResponse({ ok: false, error: err.message });
  }
}

// === Helper ===
function capitalize(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : "";
}
