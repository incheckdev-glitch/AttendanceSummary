<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS LIBS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

  <style>
    :root {
      --bg: #fff; --fg: #222; --muted: #666;
      --card: #ffffff; --card-border: #e9ecef;
    }
    body.dark-mode {
      --bg: #181a1f; --fg: #eee; --muted: #aaa;
      --card: #1f232b; --card-border: #2a2f38;
    }
    body { background: var(--bg); color: var(--fg); }
    .card { background: var(--card); border-color: var(--card-border); transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .filter-bar { position: sticky; top: 0; z-index: 10; background: inherit; padding: 10px; }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
    #loadingOverlay {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5); color:#fff; font-size:2rem;
      display:flex; justify-content:center; align-items:center; z-index:2000;
    }
    .badge-status { font-weight:600; }
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay">‚è≥ Loading...</div>

  <div class="container-fluid p-4" id="reportArea">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>üìä Attendance Dashboard</h2>
      <div class="d-flex gap-2 align-items-center">
        <span class="text-muted small" id="apiStatus">API: ‚Äî</span>
        <button class="btn btn-outline-secondary" onclick="toggleDark()">üåô/‚òÄÔ∏è</button>
        <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="card shadow filter-bar mb-4">
      <div class="card-body row g-3 align-items-end">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" multiple></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Quick Search</label>
          <input type="text" id="quickSearch" class="form-control" placeholder="Search..."/>
        </div>
        <div class="col-12 text-end mt-3">
          <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
          <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
        </div>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-4 text-center" id="kpiCards"></div>

    <!-- ATTENDANCE TABLE -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row">
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
    </div>
  </div>

  <!-- JS LIBS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // === CONFIG ===
    const API_BASE = "https://script.google.com/macros/s/AKfycbwyjG0ZS22iohHqM8N78KELf8xWYM2ARBdcGN-vn448eewSbuCSYoyI4MC3adEDcSiVkA/exec";

    // === STATE ===
    let RAW_ATTENDANCE = [], CANON = [], SETTINGS = { late:"08:15", early:"16:30", half:4, over:9 };
    let DT=null, barChartHandle, pieChartHandle, lineChartHandle;

    // === Header map for normalization ===
    const HEADER_MAP = {
      month:["month"], date:["date","day"], employee:["employee","employee name","name"],
      signIn:["sign in","signin","in"], signOut:["sign out","signout","out"],
      totalHours:["total hours","hours"], status:["status"]
    };
    function getField(obj, field){
      const keys = Object.keys(obj);
      const lower = keys.reduce((acc,k)=>{acc[k.toLowerCase()]=k; return acc;}, {});
      const aliases = HEADER_MAP[field]||[];
      for(const alias of aliases){
        const match = lower[alias.toLowerCase()];
        if(match!==undefined) return obj[match];
      }
      return undefined;
    }

    function toggleDark(){ document.body.classList.toggle("dark-mode"); }
    function pad(n){ return String(n).padStart(2,"0"); }
    function normalizeDate(str){ if(!str) return ""; const s=String(str).trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; if(s.includes("/")){ const [dd,mm,yy]=s.split("/"); const yyyy=yy.length===2?(yy>70?"19"+yy:"20"+yy):yy; return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;} return s; }
    function parsePunchWithDate(dateISO,hhmm){ if(!dateISO||!hhmm) return null; const s=String(hhmm).trim(); if(!s||s=="-") return null; if(/^\d{1,2}:\d{2}$/.test(s)){ const t=s.length===4?"0"+s:s; const dt=new Date(`${dateISO}T${t}:00`); return isNaN(dt)?null:dt;} const dt=new Date(s); return isNaN(dt)?null:dt; }

    async function apiGet(sheet){ const url=`${API_BASE}?sheet=${encodeURIComponent(sheet)}`; const res=await fetch(url); const json=await res.json(); if(!json.ok) throw new Error(json.error||"API error"); return json.data||[]; }

    function mapAttendanceRow(obj){ 
      const dateISO=normalizeDate(getField(obj,"date")); 
      const employee=String(getField(obj,"employee")||"").trim(); 
      const siRaw=getField(obj,"signIn"); 
      const soRaw=getField(obj,"signOut"); 
      const siDT=dateISO?parsePunchWithDate(dateISO,siRaw):null; 
      const soDT=dateISO?parsePunchWithDate(dateISO,soRaw):null; 
      let total=Number(getField(obj,"totalHours")); 
      if(!Number.isFinite(total)&&siDT&&soDT) total=(soDT-siDT)/36e5; 
      const month=dateISO?dateISO.slice(0,7):(String(getField(obj,"month")||"").trim()); 
      return {month,date:dateISO,employee,signIn:siRaw||"",signOut:soRaw||"",signInDT:siDT,signOutDT:soDT,totalHours:Number.isFinite(total)?total:0}; 
    }

    function computeStatus(r){
      if(!r.signInDT && !r.signOutDT) return "Absent";
      if(r.signInDT && !r.signOutDT) return "Needs Correction";
      const [lh,lm]=SETTINGS.late.split(":").map(Number);
      const [eh,em]=SETTINGS.early.split(":").map(Number);
      const inMin=r.signInDT?r.signInDT.getHours()*60+r.signInDT.getMinutes():null;
      const outMin=r.signOutDT?r.signOutDT.getHours()*60+r.signOutDT.getMinutes():null;
      const tags=[];
      if(inMin && inMin>(lh*60+lm)) tags.push("Late");
      if(outMin && outMin<(eh*60+em)) tags.push("Early Leave");
      if(r.totalHours && r.totalHours<SETTINGS.half) tags.push("Half-day");
      if(r.totalHours && r.totalHours>=SETTINGS.over) tags.push("Overtime");
      return tags.length?tags.join(", "):"On Time";
    }

    function badgeForStatus(status){
      let c="bg-secondary";
      if(status.includes("Late")) c="bg-danger";
      if(status.includes("Early Leave")) c="bg-warning text-dark";
      if(status.includes("On Time")) c="bg-success";
      if(status.includes("Absent")) c="bg-dark";
      if(status.includes("Overtime")) c="bg-primary";
      if(status.includes("Half-day")) c="bg-info text-dark";
      return `<span class="badge badge-status ${c}">${status}</span>`;
    }

    function renderTable(data){
      const rows=data.map(r=>[r.month,r.date,r.employee,r.signIn,r.signOut,r.totalHours.toFixed(2)||"",badgeForStatus(computeStatus(r))]); 
      if(!DT){ 
        DT=$("#attendanceTable").DataTable({data:rows,columns:[{title:"Month"},{title:"Date"},{title:"Employee"},{title:"Sign In"},{title:"Sign Out"},{title:"Total Hours"},{title:"Status"}],dom:"Bfrtip",buttons:["csv","excel","pdf","print","colvis"],pageLength:10}); 
      } else { 
        DT.clear().rows.add(rows).draw(); 
      }
    }

    async function loadData(){ document.getElementById("loadingOverlay").style.display="flex"; try{ const attendanceRows=await apiGet("attendance"); RAW_ATTENDANCE=(attendanceRows||[]).map(mapAttendanceRow).filter(r=>r.employee&&r.date); CANON=RAW_ATTENDANCE; renderTable(CANON); document.getElementById("apiStatus").textContent="API: connected ‚úÖ"; } catch(e){ console.error(e); document.getElementById("apiStatus").textContent="API: error ‚ùå"; } finally{ document.getElementById("loadingOverlay").style.display="none"; } }

    loadData();
  </script>
</body>
</html>
