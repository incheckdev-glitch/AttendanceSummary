<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>InCheck Pro Dashboard â€” Issues Â· Ops Â· AI Copilot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- If you embed in a Google Apps Script / portal, this helps links open correctly -->
  <base target="_top" />

  <link rel="stylesheet" href="styles.css" />
  <!-- FullCalendar CSS (kept separate for clearer platform CSP config) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css"
  />
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">IC</div>
      <div class="brand-text">
        <span>InCheck Pro</span>
        <span>Issues Â· Ops Â· AI Copilot</span>
      </div>
    </div>

    <button
      id="drawerBtn"
      class="btn ghost sm drawer-toggle"
      aria-label="Toggle filters"
      aria-expanded="false"
    >
      <span class="icon">â˜°</span>
    </button>

    <input
      id="searchInput"
      class="input"
      type="search"
      placeholder="Search tickets or type queries (e.g. risk>=10 module:payments)â€¦"
      aria-label="Search issues"
    />

    <select id="themeSelect" class="select sm" aria-label="Theme">
      <option value="system">System</option>
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>

    <input
      type="color"
      id="accentColor"
      title="Accent color"
      aria-label="Accent color"
    />

    <div class="toolbar">
      <div class="statusline">
        <span class="dot ok" id="syncIssuesDot"></span>
        <span class="chip" id="syncIssuesText">Issues: â€”</span>

        <span class="dot ok" id="syncEventsDot"></span>
        <span class="chip" id="syncEventsText">Events: â€”</span>

        <span class="chip online" id="onlineStatusChip">Online</span>

        <button
          type="button"
          id="shortcutsHelp"
          class="btn ghost sm"
          aria-label="Keyboard shortcuts help"
        >
          <span class="icon">âŒ¨</span>
          <span>Shortcuts</span>
        </button>

        <span class="shortcut-chip" id="loadingStatus"></span>
      </div>

      <button type="button" id="refreshNow" class="btn sm">
        <span class="icon">âŸ³</span>
        <span>Refresh</span>
      </button>

      <button type="button" id="exportCsv" class="btn sm">
        <span class="icon">â‡©</span>
        <span>Export CSV</span>
      </button>

      <button type="button" id="createTicketBtn" class="btn primary sm">
        <span class="icon">ï¼‹</span>
        <span>New ticket</span>
      </button>
    </div>
  </header>

  <main class="wrap">
    <!-- Sidebar / Filters -->
    <aside class="sidebar" id="sidebar" aria-label="Filters">
      <h3>Filters</h3>
      <div class="filter-group">
        <div class="filter-row">
          <span class="muted">Module</span>
          <select id="moduleFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <span class="muted">Priority</span>
          <select id="priorityFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <span class="muted">Status</span>
          <select id="statusFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <span class="muted">Date range</span>
          <input
            type="date"
            id="startDateFilter"
            class="input sm"
            aria-label="Start date"
          />
          <input
            type="date"
            id="endDateFilter"
            class="input sm"
            aria-label="End date"
          />
        </div>
        <div class="filter-row">
          <button type="button" id="resetBtn" class="btn sm">
            Reset filters
          </button>
        </div>
      </div>

      <div class="divider"></div>

      <h3>Calendar layers</h3>
      <div class="filter-group">
        <div class="filter-row">
          <label class="muted">
            <input type="checkbox" id="eventFilterDeployment" checked />
            Deployments
          </label>
          <label class="muted">
            <input type="checkbox" id="eventFilterMaintenance" checked />
            Maintenance
          </label>
          <label class="muted">
            <input type="checkbox" id="eventFilterRelease" checked />
            Releases
          </label>
          <label class="muted">
            <input type="checkbox" id="eventFilterOther" checked />
            Other
          </label>
        </div>
        <div class="filter-row">
          <span class="muted" id="calendarTz"></span>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <section class="content">
      <!-- Tabs -->
      <div class="view-tabs" role="tablist" aria-label="Main views">
        <button
          type="button"
          id="issuesTab"
          class="view-tab active"
          data-view="issues"
          role="tab"
          aria-selected="true"
        >
          <span class="icon">ðŸ“‹</span>
          <span>Issues</span>
        </button>
        <button
          type="button"
          id="calendarTab"
          class="view-tab"
          data-view="calendar"
          role="tab"
          aria-selected="false"
        >
          <span class="icon">ðŸ“…</span>
          <span>Calendar</span>
        </button>
        <button
          type="button"
          id="insightsTab"
          class="view-tab"
          data-view="insights"
          role="tab"
          aria-selected="false"
        >
          <span class="icon">ðŸ¤–</span>
          <span>AI & Ops</span>
        </button>
      </div>

      <!-- Issues view -->
      <section
        id="issuesView"
        class="view active"
        role="tabpanel"
        aria-labelledby="issuesTab"
      >
        <!-- Summary card -->
        <div class="card">
          <div class="summary-bar">
            <div>
              <div class="muted" id="issuesSummaryText">
                Loading issuesâ€¦
              </div>
              <div
                id="activeFiltersChips"
                class="filter-chips"
                aria-label="Active filters"
              ></div>
            </div>
            <div class="table-actions">
              <div id="rowCount" class="muted">â€”</div>
              <div class="pagination">
                <button
                  type="button"
                  id="firstPage"
                  class="chip-btn"
                  aria-label="First page"
                >
                  Â«
                </button>
                <button
                  type="button"
                  id="prevPage"
                  class="chip-btn"
                  aria-label="Previous page"
                >
                  â€¹
                </button>
                <span class="muted" id="pageInfo">Page 1 / 1</span>
                <button
                  type="button"
                  id="nextPage"
                  class="chip-btn"
                  aria-label="Next page"
                >
                  â€º
                </button>
                <button
                  type="button"
                  id="lastPage"
                  class="chip-btn"
                  aria-label="Last page"
                >
                  Â»
                </button>
                <select
                  id="pageSize"
                  class="select sm"
                  aria-label="Rows per page"
                >
                  <option value="10">10</option>
                  <option value="20" selected>20</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- KPIs + charts -->
        <div class="grid cols-4">
          <div class="card" id="kpis"></div>

          <div class="card">
            <div class="label muted">By module</div>
            <div style="height:220px;">
              <canvas id="byModule" aria-label="Issues by module"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="label muted">By priority</div>
            <div style="height:220px;">
              <canvas id="byPriority" aria-label="Issues by priority"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="label muted">By status / type</div>
            <div class="charts">
              <div style="height:220px;">
                <canvas id="byStatus" aria-label="Issues by status"></canvas>
              </div>
              <div style="height:220px;">
                <canvas id="byType" aria-label="Issues by type"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Issues table -->
        <div class="card">
          <div class="table-wrap">
            <table id="issuesTable">
              <thead>
                <tr>
                  <th
                    scope="col"
                    class="sortable"
                    data-key="id"
                    aria-sort="none"
                  >
                    ID
                  </th>
                  <th
                    scope="col"
                    class="sortable"
                    data-key="module"
                    aria-sort="none"
                  >
                    Module
                  </th>
                  <th
                    scope="col"
                    class="sortable"
                    data-key="title"
                    aria-sort="none"
                  >
                    Title
                  </th>
                  <th
                    scope="col"
                    class="sortable"
                    data-key="priority"
                    aria-sort="none"
                  >
                    Priority
                  </th>
                  <th
                    scope="col"
                    class="sortable"
                    data-key="status"
                    aria-sort="none"
                  >
                    Status
                  </th>
                  <th
                    scope="col"
                    class="sortable"
                    data-key="date"
                    aria-sort="none"
                  >
                    Date
                  </th>
                  <th scope="col">Log</th>
                  <th scope="col">Link</th>
                </tr>
              </thead>
              <tbody id="tbodySkeleton">
                <tr>
                  <td colspan="8">
                    <div class="skeleton" style="height:220px;"></div>
                  </td>
                </tr>
              </tbody>
              <tbody id="issuesTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Release Planner â€“ F&B Middle East -->
        <div class="card" id="releasePlannerCard">
          <div class="summary-bar">
            <div>
              <div class="label">Release Planner â€” F&amp;B Middle East</div>
              <div class="muted" style="font-size:13px;">
                Choose safe windows for F&amp;B clients in Gulf / Levant / North Africa,
                taking into account service rush, holidays, bug history and existing
                change calendar. Use the current issue filters to scope risk.
              </div>
            </div>
            <button type="button" id="plannerRun" class="btn primary sm">
              Run planner
            </button>
          </div>

          <div class="planner-grid" style="margin-top:8px;">
            <div>
              <div class="muted">Region profile</div>
              <select id="plannerRegion" class="select sm">
                <option value="gulf">Gulf (KSA / UAE / Qatar)</option>
                <option value="levant">Levant</option>
                <option value="northafrica">North Africa</option>
              </select>
            </div>
            <div>
              <div class="muted">Environment</div>
              <select id="plannerEnv" class="select sm">
                <option value="Prod" selected>Production</option>
                <option value="Staging">Staging</option>
                <option value="Dev">Dev / QA</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <div class="muted">Modules (comma-separated)</div>
              <input
                id="plannerModules"
                class="input sm"
                type="text"
                placeholder="Payments, Orderingâ€¦ (optional)"
              />
            </div>
            <div>
              <div class="muted">Horizon (days)</div>
              <select id="plannerHorizon" class="select sm">
                <option value="3">3</option>
                <option value="7" selected>7</option>
                <option value="14">14</option>
              </select>
            </div>
            <div>
              <div class="muted">Release type</div>
              <select id="plannerReleaseType" class="select sm">
                <option value="minor">Minor</option>
                <option value="feature" selected>Feature</option>
                <option value="major">Major</option>
              </select>
            </div>
            <div>
              <div class="muted">Slots per day</div>
              <select id="plannerSlotsPerDay" class="select sm">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="filter-group">
            <div class="filter-row">
              <span class="muted">Tickets (scoped by current filters)</span>
              <select
                id="plannerTickets"
                class="select"
                multiple
                size="6"
                aria-label="Tickets to include in this release plan"
              >
                <!-- Filled from JS based on filtered issues -->
              </select>
              <span class="muted" style="font-size:11px;">
                Use the filters and search above to narrow the scope, then select
                ticket(s) to include in the release risk evaluation.
              </span>
            </div>

            <div class="filter-row">
              <span class="muted">Target Release event (from calendar)</span>
              <select
                id="plannerReleasePlan"
                class="select"
                aria-label="Release event to assign tickets to"
              >
                <option value="">No Release events in horizon</option>
              </select>
              <button
                type="button"
                id="plannerAssignBtn"
                class="btn sm"
                style="margin-top:6px;"
              >
                Assign selected tickets to Release
              </button>
              <span class="muted" style="font-size:11px;">
                Assignment is written back to the calendar (issue IDs on the event),
                and will increase the risk score for overlapping windows.
              </span>
            </div>

            <div class="filter-row">
              <span class="muted">Release notes / description</span>
              <textarea
                id="plannerDescription"
                class="input"
                rows="3"
                placeholder="Optional: high-level scope, rollout strategy, comms notes, etc."
              ></textarea>
            </div>
          </div>

          <div class="divider"></div>

          <div
            id="plannerResults"
            class="muted"
            style="font-size:13px;min-height:40px;"
          >
            Run the planner to see recommended windows.
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button
              type="button"
              id="plannerAddEvent"
              class="btn sm"
              disabled
            >
              âž• Add top suggestion as Release event
            </button>
          </div>
        </div>
      </section>

      <!-- Calendar view -->
      <section
        id="calendarView"
        class="view"
        role="tabpanel"
        aria-labelledby="calendarTab"
      >
        <div class="card">
          <div class="summary-bar">
            <div>
              <div class="label">Change calendar</div>
              <div class="muted" style="font-size:13px;">
                Deployments, releases, maintenance and holidays â€” enriched with
                linked ticket risk, change collisions and freeze windows.
              </div>
            </div>
            <button
              type="button"
              id="addEventBtn"
              class="btn sm primary"
            >
              + Add event
            </button>
          </div>
          <div id="calendar"></div>
        </div>
      </section>

      <!-- Insights / AI view -->
      <section
        id="insightsView"
        class="view"
        role="tabpanel"
        aria-labelledby="insightsTab"
      >
        <div class="card">
          <div class="summary-bar">
            <div>
              <div class="label">AI Copilot Â· portfolio signals</div>
              <div class="muted" id="aiScopeText">Loadingâ€¦</div>
            </div>
            <div id="aiAnalyzing" class="muted">Analyzingâ€¦</div>
          </div>
        </div>

        <div class="grid cols-4">
          <div class="card">
            <div class="label">Recent patterns</div>
            <ul id="aiPatternsList" class="muted" style="font-size:13px;"></ul>
          </div>
          <div class="card">
            <div class="label">Suggested categories</div>
            <ul id="aiLabelsList" class="muted" style="font-size:13px;"></ul>
          </div>
          <div class="card">
            <div class="label">Trends &amp; emerging risks</div>
            <ul id="aiTrendsList" class="muted" style="font-size:13px;"></ul>
            <ul
              id="aiEmergingStable"
              class="muted"
              style="font-size:12px;margin-top:6px;"
            ></ul>
          </div>
          <div class="card">
            <div class="label">Ops cockpit</div>
            <ul id="aiOpsCockpit" class="muted" style="font-size:13px;"></ul>
          </div>
        </div>

        <!-- Per-module risk insights (special styled table) -->
        <div class="card">
          <div class="summary-bar">
            <div>
              <div class="label">Per-module risk insights</div>
              <div class="muted">
                Open load, high-risk density and top recurring term per module.
              </div>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th scope="col">Module</th>
                <th scope="col">Open</th>
                <th scope="col">High</th>
                <th scope="col">Risk Î£</th>
                <th scope="col">Top term</th>
              </tr>
            </thead>
            <tbody id="aiModulesTableBody"></tbody>
          </table>
        </div>

        <div class="grid cols-4">
          <div class="card">
            <div class="label">Top risks (recent)</div>
            <ul id="aiRisksList" class="muted" style="font-size:13px;"></ul>
          </div>
          <div class="card">
            <div class="label">Incident-like issues</div>
            <ul id="aiIncidentsList" class="muted" style="font-size:13px;"></ul>
          </div>
          <div class="card">
            <div class="label">Similar-issue clusters</div>
            <div id="aiClusters" class="muted" style="font-size:13px;"></div>
          </div>
          <div class="card">
            <div class="label">Upcoming risky events</div>
            <ul id="aiEventsList" class="muted" style="font-size:13px;"></ul>
          </div>
        </div>

        <!-- DSL / AI query box -->
        <div class="card">
          <div class="summary-bar">
            <div>
              <div class="label">AI / DSL query</div>
              <div class="muted" id="aiSignalsText">
                Type commands like: <code>status:open risk>=10 last:7d module:payments</code>
              </div>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button type="button" id="aiQueryExport" class="btn sm">
                Export result
              </button>
              <button
                type="button"
                id="aiQueryApplyFilters"
                class="btn sm ghost"
              >
                Apply as filters
              </button>
            </div>
          </div>
          <div class="filter-group">
            <div class="filter-row">
              <input
                id="aiQueryInput"
                class="input"
                type="text"
                placeholder="risk>=10 status:open last:14d module:auth;age>30d;severity>=4â€¦"
              />
            </div>
            <div class="filter-row">
              <button type="button" id="aiQueryRun" class="btn primary sm">
                Run query
              </button>
            </div>
          </div>
          <div
            id="aiQueryResults"
            class="muted"
            style="font-size:13px;margin-top:8px;"
          ></div>
        </div>
      </section>
    </section>
  </main>

  <!-- Issue modal -->
  <div
    id="issueModal"
    class="modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modalTitle"
  >
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle">Issue</h2>
        <div class="actions">
          <button type="button" id="copyId" class="btn sm">Copy ID</button>
          <button type="button" id="copyLink" class="btn sm ghost">
            Copy summary
          </button>
          <button
            type="button"
            id="modalClose"
            class="modal-close"
            aria-label="Close"
          >
            âœ•
          </button>
        </div>
      </div>
      <div id="modalBody" class="muted" style="font-size:13px;"></div>
    </div>
  </div>

  <!-- Event modal -->
  <div
    id="eventModal"
    class="modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="eventModalTitle"
  >
    <div class="modal-content">
      <div class="header">
        <h2 id="eventModalTitle">Event</h2>
        <button
          type="button"
          id="eventModalClose"
          class="modal-close"
          aria-label="Close"
        >
          âœ•
        </button>
      </div>
      <form id="eventForm">
        <div class="filter-group">
          <div class="filter-row">
            <span class="muted">Title</span>
            <input
              id="eventTitle"
              class="input"
              type="text"
              required
              placeholder="Release â€“ Payments v2"
            />
          </div>
          <div class="filter-row">
            <span class="muted">Type</span>
            <select id="eventType" class="select">
              <option value="Deployment">Deployment</option>
              <option value="Maintenance">Maintenance</option>
              <option value="Release">Release</option>
              <option value="Holiday">Holiday</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="filter-row">
            <label class="muted">
              <input type="checkbox" id="eventAllDay" />
              All day
            </label>
          </div>
          <div class="filter-row">
            <span class="muted">Start</span>
            <input id="eventStart" class="input" type="datetime-local" />
          </div>
          <div class="filter-row">
            <span class="muted">End</span>
            <input id="eventEnd" class="input" type="datetime-local" />
          </div>
          <div class="filter-row">
            <span class="muted">Environment</span>
            <select id="eventEnv" class="select">
              <option value="Prod">Production</option>
              <option value="Staging">Staging</option>
              <option value="Dev">Dev / QA</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="filter-row">
            <span class="muted">Owner</span>
            <input id="eventOwner" class="input" type="text" placeholder="Ops on-call, squadâ€¦" />
          </div>
          <div class="filter-row">
            <span class="muted">Modules</span>
            <input
              id="eventModules"
              class="input"
              type="text"
              placeholder="Payments, Ordering, Loyaltyâ€¦"
            />
          </div>
          <div class="filter-row">
            <span class="muted">Impact</span>
            <select id="eventImpactType" class="select">
              <option value="No downtime expected">No downtime expected</option>
              <option value="Partial downtime">Partial downtime</option>
              <option value="Full downtime">Full downtime</option>
            </select>
          </div>
          <div class="filter-row">
            <span class="muted">Linked ticket IDs (comma-separated)</span>
            <input
              id="eventIssueId"
              class="input"
              type="text"
              placeholder="INC-123, INC-456â€¦"
            />
          </div>
          <div
            id="eventIssueLinkedInfo"
            class="muted"
            style="display:none;font-size:12px;"
          ></div>
          <div class="filter-row">
            <span class="muted">Description / notes</span>
            <textarea
              id="eventDescription"
              class="input"
              rows="3"
              placeholder="Business impact, comms, rollback notesâ€¦"
            ></textarea>
          </div>
        </div>

        <div class="modal-actions" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button type="submit" id="eventSave" class="btn primary sm">
            Save
          </button>
          <button type="button" id="eventCancel" class="btn sm">
            Cancel
          </button>
          <button
            type="button"
            id="eventDelete"
            class="btn sm ghost"
            style="margin-left:auto;display:none;"
          >
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Global spinner + toast -->
  <div id="spinner" class="spinner" aria-hidden="true">
    <div class="ring"></div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js"></script>

  <!-- App script -->
  <script src="app.js"></script>
</body>
</html>
