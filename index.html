<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ======================= CSS LIBS ======================= -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

  <!-- ======================= PAGE STYLES ======================= -->
  <style>
    :root {
      --bg: #fff;
      --fg: #222;
      --muted: #666;
      --card: #ffffff;
      --card-border: #e9ecef;
    }
    body.dark-mode {
      --bg: #181a1f;
      --fg: #eee;
      --muted: #aaa;
      --card: #1f232b;
      --card-border: #2a2f38;
    }
    body { background: var(--bg); color: var(--fg); }
    .card { background: var(--card); border-color: var(--card-border); transition: all 0.3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .filter-bar { position: sticky; top: 0; z-index: 10; background: inherit; padding: 10px; }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
    #loadingOverlay {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5); color:#fff; font-size:2rem;
      display:flex; justify-content:center; align-items:center; z-index:2000;
    }
    .badge-status { font-weight:600; }
    .select2-container--default .select2-selection--multiple {
      background: var(--card); color: var(--fg); border-color: var(--card-border);
    }
    .select2-container--default .select2-results>.select2-results__options { color: #000; }
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay">‚è≥ Loading...</div>

  <!-- ======================= MAIN WRAPPER ======================= -->
  <div class="container-fluid p-4" id="reportArea">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>üìä Attendance Dashboard</h2>
      <div class="d-flex gap-2 align-items-center">
        <span class="text-muted small" id="apiStatus">API: ‚Äî</span>
        <button class="btn btn-outline-secondary" onclick="toggleDark()" aria-label="Toggle dark mode">üåô/‚òÄÔ∏è</button>
        <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="card shadow filter-bar mb-4">
      <div class="card-body row g-3 align-items-end">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" multiple aria-label="Employee filter"></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control" aria-label="Start date"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control" aria-label="End date"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Quick Search</label>
          <input type="text" id="quickSearch" class="form-control" placeholder="Search..." aria-label="Quick search"/>
        </div>
        <div class="col-12 text-end mt-3">
          <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
          <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
        </div>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-4 text-center" id="kpiCards"></div>

    <!-- TABLE -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row">
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
    </div>
  </div>

  <!-- ======================= JS LIBS ======================= -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ======================= APP SCRIPT ======================= -->
  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwyjG0ZS22iohHqM8N78KELf8xWYM2ARBdcGN-vn448eewSbuCSYoyI4MC3adEDcSiVkA/exec";

    let RAW_ATTENDANCE = [];
    let CANON = [];
    let HOLIDAYS = [];
    let LEAVES = [];
    let SETTINGS = { late:"08:15", early:"16:30", half:4, over:9 };
    let DT = null;
    let barChartHandle, pieChartHandle, lineChartHandle;

    function toggleDark(){ document.body.classList.toggle("dark-mode"); }
    function pad(n){ return String(n).padStart(2,"0"); }
    function toLocalISODate(d){ return d instanceof Date ? `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}` : ""; }
    function normalizeDate(str){
      if(!str) return "";
      const s = String(str).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      if (s.includes("/")) { 
        const [dd,mm,yy] = s.split("/");
        const yyyy = yy.length===2 ? (yy > 70 ? "19"+yy : "20"+yy) : yy;
        return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
      }
      return s;
    }
    function parsePunchWithDate(dateISO, hhmm){
      if(!dateISO || !hhmm) return null;
      const s = String(hhmm).trim();
      if(!s || s === "-") return null;
      if (/^\d{1,2}:\d{2}$/.test(s)) {
        const t = s.length===4 ? "0"+s : s;
        const dt = new Date(`${dateISO}T${t}:00`);
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }
    function getField(obj, ...names){
      const keys = Object.keys(obj);
      const lower = keys.reduce((acc,k)=>{acc[k.toLowerCase()] = k; return acc;}, {});
      for (const n of names){
        const m = lower[String(n).toLowerCase()];
        if (m !== undefined) return obj[m];
      }
      return undefined;
    }

    // ‚úÖ FIXED MAP FUNCTION
    function mapAttendanceRow(obj){
      const rawDate = getField(obj, "date");
      const dateISO = normalizeDate(rawDate);
      const employee = String(getField(obj, "employee") || "").trim();
      const siRaw = getField(obj, "sign in");
      const soRaw = getField(obj, "sign out");
      const siDT = dateISO ? parsePunchWithDate(dateISO, siRaw) : null;
      const soDT = dateISO ? parsePunchWithDate(dateISO, soRaw) : null;

      let total = Number(getField(obj, "total hours"));
      if (!Number.isFinite(total) && siDT && soDT) {
        total = (soDT - siDT) / 36e5;
      }

      const month = String(getField(obj, "month") || "").trim();

      return {
        month,
        date: dateISO,
        employee,
        signIn: siRaw || "",
        signOut: soRaw || "",
        signInDT: siDT,
        signOutDT: soDT,
        totalHours: Number.isFinite(total) ? total : 0
      };
    }

    async function apiGet(sheet){
      const url = `${API_BASE}?sheet=${encodeURIComponent(sheet)}`;
      const res = await fetch(url);
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || "API error");
      return json.data || [];
    }

    async function loadData(){
      document.getElementById("loadingOverlay").style.display = "flex";
      try{
        const [attendanceRows] = await Promise.all([
          apiGet("attendance")
        ]);
        RAW_ATTENDANCE = (attendanceRows||[]).map(mapAttendanceRow).filter(r=>r.employee && r.date);
        CANON = RAW_ATTENDANCE;
        applyFilters();
        document.getElementById("apiStatus").textContent = "API: connected ‚úÖ";
      } catch(e){
        alert("Error: " + e.message);
        document.getElementById("apiStatus").textContent = "API: error ‚ùå";
      } finally {
        document.getElementById("loadingOverlay").style.display = "none";
      }
    }

    function renderTable(data){
      const rows = data.map(r=>[
        r.month || "",
        r.date || "",
        r.employee || "",
        r.signIn || "",
        r.signOut || "",
        Number.isFinite(r.totalHours) ? r.totalHours.toFixed(2) : "",
      ]);
      if(!DT){
        DT = $("#attendanceTable").DataTable({
          data: rows,
          columns: [
            {title:"Month"},
            {title:"Date"},
            {title:"Employee"},
            {title:"Sign In"},
            {title:"Sign Out"},
            {title:"Total Hours"}
          ]
        });
      } else {
        DT.clear().rows.add(rows).draw();
      }
    }

    function applyFilters(){
      renderTable(CANON);
    }

    loadData();
  </script>
</body>
</html>
