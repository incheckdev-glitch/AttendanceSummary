<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <!-- pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { background: #f8f9fa; }
    .card { transition: all 0.2s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .holiday-row { background-color: #ffeeba !important; }
    .weekend-row { background-color: #f0f0f0 !important; }
  </style>
</head>
<body>
  <div class="container-fluid p-4" id="reportArea">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>ðŸ“Š Attendance Dashboard</h2>
      <button class="btn btn-success" onclick="downloadFullReport()">Download Report</button>
    </div>

    <!-- Filters -->
    <div class="card shadow mb-4">
      <div class="card-body row g-3">
        <div class="col-lg-3">
          <label class="form-label">Employee</label>
          <select id="employeeFilter" class="form-select"></select>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control"/>
        </div>
        <div class="col-lg-3">
          <label class="form-label">Search</label>
          <input type="text" id="quickSearch" class="form-control" placeholder="Search..."/>
        </div>
      </div>
      <div class="card-footer text-end">
        <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
        <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4 text-center">
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Total Hours</h6><h3 id="totalHours">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Avg Hours</h6><h3 id="avgHours">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Days</h6><h3 id="daysCount">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Late</h6><h3 id="lateCount">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Early Leave</h6><h3 id="earlyCount">0</h3></div></div></div>
      <div class="col-md-2"><div class="card shadow"><div class="card-body"><h6>Absent</h6><h3 id="absentCount">0</h3></div></div></div>
    </div>

    <!-- Attendance Table -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <table id="attendanceTable" class="display nowrap table table-striped" style="width:100%"></table>
      </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours per Day</h5><canvas id="barChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Hours by Employee</h5><canvas id="pieChart"></canvas></div></div>
      <div class="col-lg-4"><div class="card shadow p-3"><h5>Trend</h5><canvas id="lineChart"></canvas></div></div>
    </div>
  </div>

  <script>
    const ATTENDANCE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=697198023&single=true&output=csv";
    const LEAVES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTw_QmgTO1onutiMdiVyThLtl7omNOqpDH-NNSoMwbGcpU4RfRjKO4pPJXbQrsHn5_ZuK4HEhkJ_SJZ/pub?gid=33718844&single=true&output=csv";

    let ATTENDANCE = [];
    let LEAVES = [];
    let DT = null;
    let barChart, pieChart, lineChart;

    const settings = { late:"08:15", early:"16:30", half:4, over:9 };

    // Parse and normalize headers
    function normalizeRow(r) {
      const out = {};
      Object.keys(r).forEach(k=>{
        if (!k) return;
        out[k.trim().toLowerCase()] = r[k];
      });
      return out;
    }

    function mapAttendance(r) {
      const row = normalizeRow(r);
      return {
        month: row["month"] || "",
        date: row["date"] || "",
        employee: row["employee name"] || row["employee"] || row["name"] || "",
        signIn: row["sign in time"] || "",
        signOut: row["sign out time"] || "",
        totalHours: parseFloat(row["total hours"] || "0") || 0
      };
    }

    function mapLeave(r) {
      const row = normalizeRow(r);
      return {
        date: row["date"] || "",
        employee: row["employee"] || row["employee name"] || "",
        type: row["type"] || row["leave type"] || ""
      };
    }

    function toMinutes(hhmm) {
      if(!hhmm) return null;
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    }

    function computeStatus(row) {
      const status=[];
      const d=new Date(row.date);
      const dow=d.getDay();

      // Weekend
      if(dow===0||dow===6) return ["Weekend"];

      // Leave check
      const leave=LEAVES.find(l=>l.date===row.date && l.employee===row.employee);
      if(leave) return [leave.type];

      // Absent
      if(!row.signIn && !row.signOut) return ["Absent"];

      // Needs Correction
      if((row.signIn && !row.signOut)||(!row.signIn && row.signOut)) return ["Needs Correction"];

      // Time-based
      const inM=toMinutes(row.signIn);
      const outM=toMinutes(row.signOut);
      const total=row.totalHours;

      const [lh,lm]=settings.late.split(":").map(Number);
      const [eh,em]=settings.early.split(":").map(Number);

      if(inM && inM>(lh*60+lm)) status.push("Late");
      if(outM && outM<(eh*60+em)) status.push("Early Leave");
      if(total>0 && total<settings.half) status.push("Half-day");
      if(total>=settings.over) status.push("Overtime");

      if(!status.length) status.push("On Time");
      return status;
    }

    function renderTable(data) {
      const rows=data.map(r=>{
        const st=computeStatus(r).map(s=>{
          let cls="bg-secondary";
          if(s==="Late") cls="bg-danger";
          else if(s==="Early Leave") cls="bg-warning text-dark";
          else if(s==="On Time") cls="bg-success";
          else if(s==="Absent") cls="bg-dark";
          else if(s==="Needs Correction") cls="bg-danger text-white";
          else if(s==="Half-day") cls="bg-info text-dark";
          else if(s==="Overtime") cls="bg-primary";
          else if(s==="Weekend") cls="bg-light text-dark";
          else if(s==="SL") cls="bg-info text-dark";
          else if(s==="UL") cls="bg-secondary text-dark";
          return `<span class="badge ${cls}">${s}</span>`;
        }).join(" ");
        return [r.month,r.date,r.employee,r.signIn,r.signOut,r.totalHours.toFixed(2),st];
      });

      if(!DT){
        DT=$("#attendanceTable").DataTable({
          data:rows,
          columns:[
            {title:"Month"},{title:"Date"},{title:"Employee"},
            {title:"Sign In"},{title:"Sign Out"},{title:"Total Hours"},{title:"Status"}
          ],
          dom:"Bfrtip",
          buttons:["csv","excel","pdf","print"],
          pageLength:10
        });
      } else {
        DT.clear().rows.add(rows).draw();
      }

      // KPIs
      let sum=0,late=0,early=0,absent=0;
      const days=new Set();
      data.forEach(r=>{
        const st=computeStatus(r);
        if(st.includes("Late")) late++;
        if(st.includes("Early Leave")) early++;
        if(st.includes("Absent")) absent++;
        sum+=r.totalHours||0;
        if(r.date) days.add(r.date);
      });
      document.getElementById("totalHours").textContent=sum.toFixed(2);
      document.getElementById("avgHours").textContent=days.size?(sum/days.size).toFixed(2):"0";
      document.getElementById("daysCount").textContent=days.size;
      document.getElementById("lateCount").textContent=late;
      document.getElementById("earlyCount").textContent=early;
      document.getElementById("absentCount").textContent=absent;

      renderCharts(data);
    }

    function renderCharts(data){
      if(barChart) barChart.destroy();
      if(pieChart) pieChart.destroy();
      if(lineChart) lineChart.destroy();

      const byDate={},byEmp={};
      data.forEach(r=>{
        if(r.date) byDate[r.date]=(byDate[r.date]||0)+(r.totalHours||0);
        if(r.employee) byEmp[r.employee]=(byEmp[r.employee]||0)+(r.totalHours||0);
      });

      barChart=new Chart(document.getElementById("barChart"),{
        type:"bar",data:{labels:Object.keys(byDate),datasets:[{label:"Hours",data:Object.values(byDate),backgroundColor:"#0d6efd"}]}
      });
      pieChart=new Chart(document.getElementById("pieChart"),{
        type:"pie",data:{labels:Object.keys(byEmp),datasets:[{data:Object.values(byEmp),backgroundColor:["#0d6efd","#ffc107","#28a745","#dc3545","#6f42c1"]}]}
      });
      lineChart=new Chart(document.getElementById("lineChart"),{
        type:"line",data:{labels:Object.keys(byDate),datasets:[{label:"Hours",data:Object.values(byDate),borderColor:"#28a745",fill:false}]}
      });
    }

    function applyFilters(){
      const emp=document.getElementById("employeeFilter").value;
      const start=document.getElementById("startDate").value;
      const end=document.getElementById("endDate").value;
      const q=document.getElementById("quickSearch").value.toLowerCase();

      const filtered=ATTENDANCE.filter(r=>{
        if(emp && r.employee!==emp) return false;
        if(start && r.date<start) return false;
        if(end && r.date>end) return false;
        if(q && !(`${r.employee} ${r.date}`).toLowerCase().includes(q)) return false;
        return true;
      });
      renderTable(filtered);
    }

    function resetFilters(){
      document.getElementById("employeeFilter").value="";
      document.getElementById("startDate").value="";
      document.getElementById("endDate").value="";
      document.getElementById("quickSearch").value="";
      renderTable(ATTENDANCE);
    }

    function populateEmployeeFilter(){
      const sel=document.getElementById("employeeFilter");
      sel.innerHTML=`<option value="">All</option>`;
      [...new Set(ATTENDANCE.map(r=>r.employee))].sort().forEach(emp=>{
        const opt=document.createElement("option");
        opt.value=emp; opt.textContent=emp;
        sel.appendChild(opt);
      });
    }

    async function loadData(){
      const aRes=await fetch(ATTENDANCE_CSV);
      const aCsv=await aRes.text();
      const aParsed=Papa.parse(aCsv,{header:true,skipEmptyLines:true});
      ATTENDANCE=aParsed.data.map(mapAttendance).filter(r=>r.employee && r.date);

      const lRes=await fetch(LEAVES_CSV);
      const lCsv=await lRes.text();
      const lParsed=Papa.parse(lCsv,{header:true,skipEmptyLines:true});
      LEAVES=lParsed.data.map(mapLeave);

      populateEmployeeFilter();
      renderTable(ATTENDANCE);
    }

    async function downloadFullReport(){
      const el=document.getElementById("reportArea");
      const canvas=await html2canvas(el,{scale:2,backgroundColor:"#fff"});
      const img=canvas.toDataURL("image/png");
      pdfMake.createPdf({content:[{image:img,width:500}]}).download("Attendance_Report.pdf");
    }

    loadData();
  </script>
</body>
</html>
