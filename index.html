<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>InCheck ‚Äì Issues ¬∑ Ops ¬∑ Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Libraries -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --danger:#ef4444;
      --warn:#f97316;
      --ok:#22c55e;
      --radius:0.75rem;
      --shadow:0 18px 40px rgba(0,0,0,.55);
    }

    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at 0% 0%,rgba(59,130,246,.18),transparent 55%),
                 radial-gradient(circle at 100% 100%,rgba(139,92,246,.18),transparent 55%),
                 var(--bg);
      color:var(--text);
    }

    header {
      position:sticky;
      top:0;
      z-index:20;
      background:rgba(15,23,42,.96);
      backdrop-filter:blur(16px);
      border-bottom:1px solid var(--border);
      padding:8px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
    }

    .brand-logo {
      width:30px;
      height:30px;
      border-radius:10px;
      background:conic-gradient(from 160deg,var(--accent),#8b5cf6,#22c55e,var(--accent));
      display:grid;
      place-items:center;
      font-weight:800;
      color:white;
      box-shadow:0 10px 30px rgba(37,99,235,.7);
      font-size:15px;
    }

    .brand-text {
      display:flex;
      flex-direction:column;
    }
    .brand-text span:first-child {
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .brand-text span:last-child { font-size:14px; }

    .toolbar {
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn,
    .input,
    .select {
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font:inherit;
      color:inherit;
      background:#020617;
    }
    .input::placeholder { color:var(--muted); }

    .btn {
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      font-weight:500;
    }
    .btn.primary {
      background:linear-gradient(135deg,var(--accent),#8b5cf6);
      border-color:transparent;
      color:white;
      box-shadow:0 10px 26px rgba(37,99,235,.7);
    }
    .btn.ghost {
      background:transparent;
      border-color:transparent;
    }
    .btn.sm { padding:4px 9px; font-size:12px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .icon { font-size:16px; }

    #accentColor {
      padding:0;
      width:36px;
      min-width:36px;
      height:28px;
      border-radius:999px;
    }

    .chip {
      font-size:11px;
      border-radius:999px;
      padding:4px 8px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--muted);
    }
    .chip.online {
      border-color:var(--ok);
      color:var(--ok);
    }
    .chip.offline {
      border-color:var(--warn);
      color:var(--warn);
    }

    .dot {
      width:9px;
      height:9px;
      border-radius:50%;
      display:inline-block;
    }
    .dot.ok { background:var(--ok); }
    .dot.err { background:var(--danger); }

    .wrap {
      max-width:1400px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:16px;
    }
    @media (max-width:960px){
      .wrap { grid-template-columns:1fr; }
      .sidebar { order:2; }
      .content { order:1; }
    }

    .sidebar {
      background:rgba(15,23,42,.95);
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:12px;
      box-shadow:var(--shadow);
      max-height:calc(100vh - 80px);
      overflow:auto;
    }
    .sidebar h3 {
      margin:0 0 8px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .filter-group {
      display:grid;
      gap:8px;
      margin-bottom:12px;
    }
    .filter-row {
      display:grid;
      gap:4px;
    }
    .muted { color:var(--muted); font-size:12px; }
    .divider { height:1px; background:var(--border); margin:8px 0 10px; opacity:.8; }

    .content {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .view-tabs {
      display:inline-flex;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      padding:3px;
    }
    .view-tab {
      border:none;
      background:transparent;
      color:var(--muted);
      border-radius:999px;
      padding:5px 12px;
      cursor:pointer;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .view-tab.active {
      background:linear-gradient(135deg,var(--accent),#8b5cf6);
      color:white;
    }

    .view { display:none; }
    .view.active { display:block; }

    .card {
      background:var(--card-soft);
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:12px;
      box-shadow:var(--shadow);
    }

    .summary-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
    }

    .grid {
      display:grid;
      gap:12px;
    }
    .grid.cols-4 { grid-template-columns:repeat(4,minmax(0,1fr)); }
    .grid.cols-2 { grid-template-columns:repeat(2,minmax(0,1fr)); }

    @media (max-width:1000px){ .grid.cols-4 { grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:640px){ .grid.cols-4, .grid.cols-2 { grid-template-columns:1fr; } }

    .kpi {
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .kpi-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .kpi-value {
      font-size:22px;
      font-weight:700;
      margin-top:4px;
    }
    .kpi-sub { font-size:12px; color:var(--muted); margin-top:2px; }

    .charts { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    @media (max-width:960px){ .charts { grid-template-columns:1fr; } }

    .table-wrap {
      border-radius:var(--radius);
      border:1px solid var(--border);
      overflow:auto;
      max-height:420px;
    }

    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
    }

    thead th {
      position:sticky;
      top:0;
      background:#020617;
      text-align:left;
      padding:8px 8px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      color:var(--muted);
    }
    tbody td {
      padding:7px 8px;
      border-bottom:1px solid rgba(31,41,55,.7);
    }
    tbody tr:hover {
      background:rgba(15,23,42,.9);
      cursor:pointer;
    }

    th.sortable::after {
      content:"";
      border:4px solid transparent;
      border-top-color:var(--muted);
      margin-left:4px;
      display:inline-block;
      transform:translateY(1px);
    }
    th.sorted-asc::after {
      border-bottom-color:var(--accent);
      border-top-color:transparent;
      transform:translateY(-1px);
    }
    th.sorted-desc::after {
      border-top-color:var(--accent);
      border-bottom-color:transparent;
      transform:translateY(1px);
    }

    .pill {
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
      font-weight:600;
    }

    .status-Resolved { background:#16a34a; color:white; }
    .status-Under\ Development { background:#3b82f6; color:white; }
    .status-Rejected { background:#ef4444; color:white; }
    .status-On\ Hold { background:#f97316; color:white; }
    .status-Not\ Started\ Yet { background:#6b7280; color:white; }
    .status-Sent { background:#6366f1; color:white; }
    .status-On\ Stage { background:#0ea5e9; color:white; }

    .priority-High { background:#ef4444; color:white; }
    .priority-Medium { background:#f97316; color:white; }
    .priority-Low { background:#22c55e; color:white; }

    .filter-chips {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:6px 0 4px;
    }
    .filter-chip {
      font-size:11px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 7px;
      background:#020617;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      color:var(--muted);
    }

    .table-actions {
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
    }

    .pagination {
      display:flex;
      align-items:center;
      gap:4px;
      font-size:12px;
    }
    .chip-btn {
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:inherit;
      font-size:12px;
      padding:4px 8px;
      cursor:pointer;
    }
    .chip-btn[disabled] { opacity:.4; cursor:not-allowed; }

    .select.sm,
    .input.sm { padding:4px 8px; font-size:12px; }

    /* Calendar */
    #calendar { margin-top:4px; min-height:420px; }
    .fc { font-size:12px; }
    .fc .fc-toolbar-title { font-size:15px; }
    .fc-theme-standard .fc-scrollgrid,
    .fc-theme-standard td,
    .fc-theme-standard th { border-color:var(--border); }
    .fc .fc-col-header-cell-cushion,
    .fc .fc-daygrid-day-number { color:var(--muted); }
    .fc .fc-daygrid-day.fc-day-today { background:rgba(59,130,246,.12); }

    .fc .fc-button {
      background:#020617;
      border-radius:999px;
      border-color:var(--border);
      padding:3px 8px;
      font-size:11px;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):hover {
      background:var(--accent);
      border-color:var(--accent);
    }

    .fc-event.event-type-deployment { background:var(--accent); border-color:var(--accent); }
    .fc-event.event-type-maintenance { background:var(--warn); border-color:var(--warn); }
    .fc-event.event-type-release { background:var(--ok); border-color:var(--ok); }
    .fc-event.event-type-other { background:#8b5cf6; border-color:#8b5cf6; }

    .fc-event.event-env-prod .fc-event-main { border-left:3px solid var(--ok); }
    .fc-event.event-env-staging .fc-event-main { border-left:3px solid var(--accent); }
    .fc-event.event-env-dev .fc-event-main { border-left:3px solid var(--muted); }
    .fc-event.event-env-other .fc-event-main { border-left:3px solid #8b5cf6; }

    /* Modals */
    .modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      z-index:50;
      align-items:center;
      justify-content:center;
    }
    .modal-content {
      background:#020617;
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:14px;
      max-width:720px;
      width:94%;
      max-height:90vh;
      overflow:auto;
      box-shadow:var(--shadow);
    }
    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .spinner {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.45);
      z-index:60;
    }
    .spinner-ring {
      width:48px;
      height:48px;
      border-radius:999px;
      border:4px solid var(--border);
      border-top-color:var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .toast {
      position:fixed;
      right:16px;
      bottom:16px;
      background:#020617;
      border-radius:var(--radius);
      border:1px solid var(--accent);
      padding:8px 10px;
      font-size:12px;
      display:none;
      z-index:61;
    }

    .sr-only {
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
      white-space:nowrap;
    }

    @media (prefers-reduced-motion:reduce){
      *{ animation-duration:0.001ms!important; animation-iteration-count:1!important; transition-duration:0.001ms!important; scroll-behavior:auto!important; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-logo">IC</div>
      <div class="brand-text">
        <span>INCHECK</span>
        <span>Issues ¬∑ Ops ¬∑ Calendar</span>
      </div>
    </div>

    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search issues ( / )" />

      <select id="themeSelect" class="select">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>

      <input id="accentColor" class="input" type="color" />

      <button id="refreshNow" class="btn" type="button">
        <span class="icon">üîÑ</span> Refresh
      </button>
      <button id="exportCsv" class="btn" type="button">
        <span class="icon">üì•</span> Export
      </button>
      <button id="createTicketBtn" class="btn primary" type="button">
        <span class="icon">‚ûï</span> Create Ticket
      </button>

      <button id="shortcutsHelp" class="btn ghost sm" type="button" title="Keyboard shortcuts">
        <span class="icon">‚å®Ô∏è</span>
      </button>

      <span id="onlineStatusChip" class="chip online">Online</span>

      <span class="chip" id="syncIssuesText">Issues: not loaded</span>
      <span class="dot err" id="syncIssuesDot"></span>
      <span class="chip" id="syncEventsText">Events: not loaded</span>
      <span class="dot err" id="syncEventsDot"></span>
    </div>
  </header>

  <div id="loadingStatus" class="sr-only" aria-live="polite"></div>

  <div class="wrap">
    <aside class="sidebar" aria-label="Filters">
      <h3>Filters</h3>

      <div class="filter-group">
        <div class="filter-row">
          <label class="muted" for="moduleFilter">Module</label>
          <select id="moduleFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="priorityFilter">Priority</label>
          <select id="priorityFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="statusFilter">Status</label>
          <select id="statusFilter" class="select"></select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="filter-group">
        <div class="filter-row">
          <label class="muted" for="startDateFilter">Start Date</label>
          <input id="startDateFilter" class="input" type="date" />
        </div>
        <div class="filter-row">
          <label class="muted" for="endDateFilter">End Date</label>
          <input id="endDateFilter" class="input" type="date" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="filter-group">
        <button id="resetBtn" class="btn ghost" type="button">Reset filters</button>
        <span class="muted">
          Tip: click a KPI pill to change filters. Export follows the current tab.
        </span>
      </div>
    </aside>

    <main class="content">
      <div class="view-tabs" role="tablist">
        <button id="issuesTab" class="view-tab active" data-view="issues" role="tab"
                aria-selected="true" aria-controls="issuesView">
          <span class="icon">üìã</span> Issues
        </button>
        <button id="calendarTab" class="view-tab" data-view="calendar" role="tab"
                aria-selected="false" aria-controls="calendarView">
          <span class="icon">üìÖ</span> Calendar
        </button>
        <button id="insightsTab" class="view-tab" data-view="insights" role="tab"
                aria-selected="false" aria-controls="insightsView">
          <span class="icon">ü§ñ</span> AI Insights
        </button>
      </div>

      <!-- Issues view -->
      <section id="issuesView" class="view active" role="tabpanel" aria-labelledby="issuesTab">
        <div class="card summary-bar">
          <span id="issuesSummaryText">Loading issues‚Ä¶</span>
          <span class="muted">Shortcuts: 1/2/3 tabs ¬∑ / search</span>
        </div>

        <div id="kpis" class="grid cols-4"></div>

        <div class="charts">
          <div class="card"><canvas id="byModule" height="130"></canvas></div>
          <div class="card"><canvas id="byPriority" height="130"></canvas></div>
          <div class="card"><canvas id="byStatus" height="130"></canvas></div>
          <div class="card"><canvas id="byType" height="130"></canvas></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:6px;">
            <div>
              <strong>Issues</strong>
              <div class="muted">Pulled from the InCheck issues sheet.</div>
            </div>
            <span id="rowCount" class="muted"></span>
          </div>

          <div id="activeFiltersChips" class="filter-chips"></div>

          <div class="table-wrap">
            <table id="issuesTable">
              <thead>
                <tr>
                  <th class="sortable" data-key="id">ID</th>
                  <th class="sortable" data-key="module">Module</th>
                  <th class="sortable" data-key="title">Title</th>
                  <th class="sortable" data-key="priority">Priority</th>
                  <th class="sortable" data-key="status">Status</th>
                  <th class="sortable" data-key="date">Date</th>
                  <th class="sortable" data-key="log">Log</th>
                  <th>Link</th>
                </tr>
              </thead>
              <tbody id="tbodySkeleton">
                <tr><td colspan="8" style="text-align:center;padding:20px;color:var(--muted);">Loading‚Ä¶</td></tr>
              </tbody>
              <tbody id="issuesTbody" style="display:none;"></tbody>
            </table>
          </div>

          <div class="table-actions">
            <div class="pagination">
              <button id="firstPage" class="chip-btn">&laquo; First</button>
              <button id="prevPage" class="chip-btn">‚Äπ Prev</button>
              <span id="pageInfo" class="muted"></span>
              <button id="nextPage" class="chip-btn">Next ‚Ä∫</button>
              <button id="lastPage" class="chip-btn">Last &raquo;</button>
            </div>

            <div style="display:flex;align-items:center;gap:6px;">
              <span class="muted">Rows</span>
              <select id="pageSize" class="select sm">
                <option>10</option>
                <option selected>20</option>
                <option>50</option>
                <option>100</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Calendar view -->
      <section id="calendarView" class="view" role="tabpanel" aria-labelledby="calendarTab">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap;">
            <div>
              <strong>Deployments & Maintenance Calendar</strong>
              <div class="muted">Plan deployments, releases, maintenance and other changes.</div>
              <div id="calendarTz" class="muted" style="font-size:11px;margin-top:4px;"></div>

              <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:12px;">
                <label class="muted" style="display:inline-flex;align-items:center;gap:4px;">
                  <input type="checkbox" id="eventFilterDeployment" checked /> Deployment
                </label>
                <label class="muted" style="display:inline-flex;align-items:center;gap:4px;">
                  <input type="checkbox" id="eventFilterMaintenance" checked /> Maintenance
                </label>
                <label class="muted" style="display:inline-flex;align-items:center;gap:4px;">
                  <input type="checkbox" id="eventFilterRelease" checked /> Release
                </label>
                <label class="muted" style="display:inline-flex;align-items:center;gap:4px;">
                  <input type="checkbox" id="eventFilterOther" checked /> Other
                </label>
              </div>
            </div>

            <button id="addEventBtn" class="btn primary sm" type="button">
              <span class="icon">‚ûï</span> Add Event
            </button>
          </div>

          <div id="calendar"></div>
        </div>
      </section>

      <!-- AI view ‚Äì simple, no external AI calls -->
      <section id="insightsView" class="view" role="tabpanel" aria-labelledby="insightsTab">
        <div class="card">
          <strong>AI Insights (local-only)</strong>
          <div class="muted" style="margin-top:4px;">
            This tab gives simple heuristic insights from issue text ‚Äì no external AI calls.
            It‚Äôs deliberately lightweight and private.
          </div>
        </div>

        <div class="grid cols-2">
          <div class="card">
            <strong>Top terms</strong>
            <ul id="aiTopTerms" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>High-risk issues</strong>
            <ul id="aiHighRisk" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Issue modal -->
  <div id="issueModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" style="margin:0;font-size:18px;">Issue</h2>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button id="copyId" class="btn sm" type="button">üÜî Copy ID</button>
          <button id="copyLink" class="btn sm" type="button">üîó Copy link</button>
          <button id="modalClose" class="btn ghost sm" type="button">‚úï</button>
        </div>
      </div>
      <div id="modalBody" style="font-size:13px;"></div>
    </div>
  </div>

  <!-- Event modal -->
  <div id="eventModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="eventModalTitle" style="margin:0;font-size:18px;">Event</h2>
        <button id="eventModalClose" class="btn ghost sm" type="button">‚úï</button>
      </div>

      <form id="eventForm">
        <div class="grid cols-2">
          <div class="filter-group">
            <div class="filter-row">
              <label class="muted" for="eventTitle">Title</label>
              <input id="eventTitle" class="input" type="text" required />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventType">Type</label>
              <select id="eventType" class="select">
                <option value="Deployment">Deployment</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Release">Release</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventEnv">Environment</label>
              <select id="eventEnv" class="select">
                <option value="Prod">Prod</option>
                <option value="Staging">Staging</option>
                <option value="Dev">Dev</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventStatus">Change status</label>
              <select id="eventStatus" class="select">
                <option value="Planned">Planned</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventOwner">Owner</label>
              <input id="eventOwner" class="input" type="text" />
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-row">
              <label class="muted" for="eventModules">Modules</label>
              <input id="eventModules" class="input" type="text"
                     placeholder="Comma separated e.g. Payments, Auth" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventImpactType">Impact</label>
              <select id="eventImpactType" class="select">
                <option value="No downtime expected">No downtime expected</option>
                <option value="Customer visible">Customer visible</option>
                <option value="Internal only">Internal only</option>
                <option value="High risk change">High risk change</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventIssueId">Issue ID (optional)</label>
              <input id="eventIssueId" class="input" type="text" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventStart">Start</label>
              <input id="eventStart" class="input" type="datetime-local" required />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventEnd">End (optional)</label>
              <input id="eventEnd" class="input" type="datetime-local" />
            </div>
            <div class="filter-row">
              <label class="muted" style="display:inline-flex;align-items:center;gap:4px;">
                <input id="eventAllDay" type="checkbox" /> All day
              </label>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-row">
            <label class="muted" for="eventDescription">Notes</label>
            <textarea id="eventDescription" class="input" rows="3"
                      style="border-radius:0.75rem;resize:vertical;"></textarea>
          </div>
          <div id="eventIssueLinkedInfo" class="muted" style="display:none;font-size:12px;"></div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px;">
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button id="eventSave" class="btn primary sm" type="submit">üíæ Save</button>
            <button id="eventCancel" class="btn ghost sm" type="button">Cancel</button>
          </div>
          <button id="eventDelete" class="btn sm" type="button"
                  style="border-color:var(--danger);color:var(--danger);display:none;">
            üóë Delete
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="spinner" class="spinner" aria-hidden="true">
    <div class="spinner-ring"></div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
    // --- Config & storage keys -------------------------------------------------

    const CONFIG = {
      SHEET_CSV_URL:
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv",
      CALENDAR_API_URL:
        "https://corsproxy.io/?" +
        encodeURIComponent("https://script.google.com/macros/s/AKfycbwRcF-CbJY3dNfU9QQWixGL82a5BqCxVII4sGJSKunJ_fhDLLezL90kUXoqMrHuYytV/exec"),
      TREND_RECENT_DAYS: 7
    };

    const LS_KEYS = {
      filters: "incheck_filters",
      theme: "incheck_theme",
      accent: "incheck_accent",
      pageSize: "incheck_pageSize",
      view: "incheck_view"
    };

    // --- State -----------------------------------------------------------------

    let E = {};                     // DOM cache
    const DataStore = { issues: [], events: [] };
    const Filters = {
      search: "",
      module: "All",
      priority: "All",
      status: "All",
      startDate: "",
      endDate: ""
    };

    let currentView = "issues";
    let currentRows = [];
    let currentSort = { key: "date", dir: "desc" };
    let currentPage = 1;

    let charts = {
      byModule: null,
      byPriority: null,
      byStatus: null,
      byType: null
    };

    let calendarObj = null;
    let currentIssueId = null;
    let currentEventId = null;

    // --- Utilities -------------------------------------------------------------

    function cacheDom() {
      E = {
        // header / toolbar
        searchInput: document.getElementById("searchInput"),
        themeSelect: document.getElementById("themeSelect"),
        accentColor: document.getElementById("accentColor"),
        refreshNow: document.getElementById("refreshNow"),
        exportCsv: document.getElementById("exportCsv"),
        createTicketBtn: document.getElementById("createTicketBtn"),
        shortcutsHelp: document.getElementById("shortcutsHelp"),
        onlineStatusChip: document.getElementById("onlineStatusChip"),
        syncIssuesText: document.getElementById("syncIssuesText"),
        syncIssuesDot: document.getElementById("syncIssuesDot"),
        syncEventsText: document.getElementById("syncEventsText"),
        syncEventsDot: document.getElementById("syncEventsDot"),
        loadingStatus: document.getElementById("loadingStatus"),

        // sidebar
        moduleFilter: document.getElementById("moduleFilter"),
        priorityFilter: document.getElementById("priorityFilter"),
        statusFilter: document.getElementById("statusFilter"),
        startDateFilter: document.getElementById("startDateFilter"),
        endDateFilter: document.getElementById("endDateFilter"),
        resetBtn: document.getElementById("resetBtn"),

        // tabs
        issuesTab: document.getElementById("issuesTab"),
        calendarTab: document.getElementById("calendarTab"),
        insightsTab: document.getElementById("insightsTab"),

        issuesView: document.getElementById("issuesView"),
        calendarView: document.getElementById("calendarView"),
        insightsView: document.getElementById("insightsView"),

        // issues view
        issuesSummaryText: document.getElementById("issuesSummaryText"),
        kpis: document.getElementById("kpis"),
        byModule: document.getElementById("byModule"),
        byPriority: document.getElementById("byPriority"),
        byStatus: document.getElementById("byStatus"),
        byType: document.getElementById("byType"),
        rowCount: document.getElementById("rowCount"),
        activeFiltersChips: document.getElementById("activeFiltersChips"),
        issuesTable: document.getElementById("issuesTable"),
        tbodySkeleton: document.getElementById("tbodySkeleton"),
        issuesTbody: document.getElementById("issuesTbody"),
        firstPage: document.getElementById("firstPage"),
        prevPage: document.getElementById("prevPage"),
        nextPage: document.getElementById("nextPage"),
        lastPage: document.getElementById("lastPage"),
        pageInfo: document.getElementById("pageInfo"),
        pageSize: document.getElementById("pageSize"),

        // calendar
        calendar: document.getElementById("calendar"),
        calendarTz: document.getElementById("calendarTz"),
        addEventBtn: document.getElementById("addEventBtn"),
        eventFilterDeployment: document.getElementById("eventFilterDeployment"),
        eventFilterMaintenance: document.getElementById("eventFilterMaintenance"),
        eventFilterRelease: document.getElementById("eventFilterRelease"),
        eventFilterOther: document.getElementById("eventFilterOther"),

        // AI
        aiTopTerms: document.getElementById("aiTopTerms"),
        aiHighRisk: document.getElementById("aiHighRisk"),

        // issue modal
        issueModal: document.getElementById("issueModal"),
        modalTitle: document.getElementById("modalTitle"),
        modalBody: document.getElementById("modalBody"),
        modalClose: document.getElementById("modalClose"),
        copyId: document.getElementById("copyId"),
        copyLink: document.getElementById("copyLink"),

        // event modal
        eventModal: document.getElementById("eventModal"),
        eventModalTitle: document.getElementById("eventModalTitle"),
        eventModalClose: document.getElementById("eventModalClose"),
        eventForm: document.getElementById("eventForm"),
        eventTitle: document.getElementById("eventTitle"),
        eventType: document.getElementById("eventType"),
        eventEnv: document.getElementById("eventEnv"),
        eventStatus: document.getElementById("eventStatus"),
        eventOwner: document.getElementById("eventOwner"),
        eventModules: document.getElementById("eventModules"),
        eventImpactType: document.getElementById("eventImpactType"),
        eventIssueId: document.getElementById("eventIssueId"),
        eventStart: document.getElementById("eventStart"),
        eventEnd: document.getElementById("eventEnd"),
        eventAllDay: document.getElementById("eventAllDay"),
        eventDescription: document.getElementById("eventDescription"),
        eventIssueLinkedInfo: document.getElementById("eventIssueLinkedInfo"),
        eventSave: document.getElementById("eventSave"),
        eventCancel: document.getElementById("eventCancel"),
        eventDelete: document.getElementById("eventDelete"),

        // misc
        spinner: document.getElementById("spinner"),
        toast: document.getElementById("toast")
      };
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      })[c]);
    }
    function escapeAttr(str) {
      return String(str ?? "").replace(/&/g,"&amp;").replace(/"/g,"&quot;");
    }

    function parseDateLoose(str) {
      if (!str) return null;
      const d1 = new Date(str);
      if (!Number.isNaN(d1.getTime())) return d1;
      const p = String(str).split(/[\/\-]/);
      if (p.length === 3) {
        let [a,b,c] = p;
        if (a.length === 4) {
          return new Date(+a, +b-1, +c);
        } else if (c.length === 4) {
          return new Date(+c, +b-1, +a);
        }
      }
      return null;
    }

    function toLocalInput(dateLike) {
      if (!dateLike) return "";
      const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
      if (Number.isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const h = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${day}T${h}:${mi}`;
    }

    function csvEscape(v) {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }

    function updateOnlineStatus() {
      if (!E.onlineStatusChip) return;
      const on = navigator.onLine;
      E.onlineStatusChip.textContent = on ? "Online" : "Offline";
      E.onlineStatusChip.className = "chip " + (on ? "online" : "offline");
    }

    // --- Risk scoring (simple, heuristic) -------------------------------------

    function normalizePriority(p) {
      const v = String(p || "").trim().toLowerCase();
      if (!v) return "";
      if (v.startsWith("h")) return "High";
      if (v.startsWith("m")) return "Medium";
      if (v.startsWith("l")) return "Low";
      return p || "";
    }

    function normalizeStatus(s) {
      const v = String(s || "").trim().toLowerCase();
      if (!v) return "Not Started Yet";
      if (v.startsWith("resolved")) return "Resolved";
      if (v.startsWith("under")) return "Under Development";
      if (v.startsWith("rejected")) return "Rejected";
      if (v.startsWith("on hold")) return "On Hold";
      if (v.startsWith("not started")) return "Not Started Yet";
      if (v.startsWith("sent")) return "Sent";
      if (v.startsWith("on stage")) return "On Stage";
      return s || "Not Started Yet";
    }

    function computeRisk(issue) {
      const text = (issue.title + " " + issue.desc + " " + issue.log).toLowerCase();
      const prioWeight = { High:3, Medium:2, Low:1 }[issue.priority] || 1;
      let score = prioWeight;

      const add = (kw,val)=>{ if (text.includes(kw)) score += val; };

      ["timeout","time out","latency","slow","slowness","crash","exception","error","down"].forEach(k=>add(k,2));
      ["payment","billing","invoice","checkout","refund","revenue","subscription"].forEach(k=>add(k,2));
      ["prod","production","deploy","deployment","rollback","incident","sla"].forEach(k=>add(k,2));

      let severity = prioWeight;
      if (/p0|sev0|outage|data loss|breach/i.test(text)) severity += 3;
      else if (/p1|sev1|incident/i.test(text)) severity += 2;
      else if (/p2|degraded/i.test(text)) severity += 1;

      let impact = 1;
      if (/payment|billing|checkout|revenue|signup|login|authentication/i.test(text)) impact += 2;

      let urgency = 1;
      if (/today|now|immediately|urgent|asap/i.test(text)) urgency += 2;

      const total = score + severity + impact + urgency;

      return { total, severity, impact, urgency };
    }

    function normalizeIssueRow(raw) {
      const get = (...names) => {
        for (const n of names) {
          if (raw[n] != null && String(raw[n]).trim() !== "") return String(raw[n]).trim();
        }
        return "";
      };

      const row = {
        id: get("Ticket ID","ID","Issue ID"),
        module: get("Impacted Module","Module","Issue location") || "Unspecified",
        title: get("Title","Summary"),
        desc: get("Description","Details"),
        priority: normalizePriority(get("Priority")),
        status: normalizeStatus(get("Status")),
        type: get("Category","Type"),
        date: get("Timestamp","Created at","Date"),
        log: get("Log","Notes","Comments"),
        file: get("File upload","Link","URL")
      };
      row.risk = computeRisk(row);
      return row;
    }

    // --- UI helpers -----------------------------------------------------------

    const UI = {
      spinner(show) {
        if (!E.spinner) return;
        E.spinner.style.display = show ? "flex" : "none";
        E.spinner.setAttribute("aria-hidden", show ? "false" : "true");
      },
      toast(msg) {
        if (!E.toast) return;
        E.toast.textContent = msg;
        E.toast.style.display = "block";
        setTimeout(()=>{ E.toast.style.display = "none"; }, 2600);
      },
      setSync(kind, ok, when) {
        if (kind === "issues") {
          if (E.syncIssuesDot) E.syncIssuesDot.className = "dot " + (ok ? "ok" : "err");
          if (E.syncIssuesText) {
            E.syncIssuesText.textContent = ok && when
              ? "Issues: " + when.toLocaleString()
              : "Issues: not loaded";
          }
        } else if (kind === "events") {
          if (E.syncEventsDot) E.syncEventsDot.className = "dot " + (ok ? "ok" : "err");
          if (E.syncEventsText) {
            E.syncEventsText.textContent = ok && when
              ? "Events: " + when.toLocaleString()
              : "Events: not loaded";
          }
        }
      },
      Issues: {},
      Calendar: {},
      AI: {}
    };

    // --- Issues UI ------------------------------------------------------------

    UI.Issues.applyFilters = function() {
      const rows = DataStore.issues || [];
      const search = (Filters.search || "").toLowerCase();
      const mod = Filters.module;
      const prio = Filters.priority;
      const stat = Filters.status;
      const start = Filters.startDate ? parseDateLoose(Filters.startDate) : null;
      const end = Filters.endDate ? parseDateLoose(Filters.endDate) : null;

      return rows.filter(r => {
        if (search) {
          const blob = (r.id + " " + r.module + " " + r.title + " " + r.desc + " " + r.log).toLowerCase();
          if (!blob.includes(search)) return false;
        }
        if (mod && mod !== "All" && r.module !== mod) return false;
        if (prio && prio !== "All" && r.priority !== prio) return false;
        if (stat && stat !== "All" && r.status !== stat) return false;

        if (start || end) {
          const d = parseDateLoose(r.date);
          if (d) {
            if (start && d < start) return false;
            if (end) {
              const endPlus = new Date(end.getFullYear(), end.getMonth(), end.getDate()+1);
              if (d >= endPlus) return false;
            }
          }
        }
        return true;
      });
    };

    UI.Issues.renderSummary = function(rows) {
      if (!E.issuesSummaryText) return;
      const total = (DataStore.issues || []).length;
      const visible = rows.length;
      const highOpen = rows.filter(r =>
        r.priority === "High" &&
        r.status !== "Resolved" &&
        r.status !== "Rejected"
      ).length;
      E.issuesSummaryText.textContent =
        `${visible} of ${total} issues visible ¬∑ ${highOpen} open high-priority.`;
    };

    UI.Issues.populateFilterOptions = function() {
      const rows = DataStore.issues || [];
      const modules = new Set();
      const prios = new Set();
      const statuses = new Set();

      rows.forEach(r => {
        if (r.module) modules.add(r.module);
        if (r.priority) prios.add(r.priority);
        if (r.status) statuses.add(r.status);
      });

      function fillSelect(el, list) {
        if (!el) return;
        el.innerHTML = "";
        const allOpt = document.createElement("option");
        allOpt.value = "All";
        allOpt.textContent = "All";
        el.appendChild(allOpt);
        list.sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          el.appendChild(opt);
        });
      }

      fillSelect(E.moduleFilter, Array.from(modules));
      fillSelect(E.priorityFilter, Array.from(prios));
      fillSelect(E.statusFilter, Array.from(statuses));

      // restore persisted filters
      if (Filters.module && E.moduleFilter) E.moduleFilter.value = Filters.module;
      if (Filters.priority && E.priorityFilter) E.priorityFilter.value = Filters.priority;
      if (Filters.status && E.statusFilter) E.statusFilter.value = Filters.status;
    };

    UI.Issues.renderKPIs = function(rows) {
      if (!E.kpis) return;
      const all = DataStore.issues || [];
      const container = E.kpis;
      container.innerHTML = "";

      const statusCounts = {};
      all.forEach(r => { statusCounts[r.status] = (statusCounts[r.status] || 0) + 1; });
      const highCount = all.filter(r => r.priority === "High").length;
      const resolvedCount = statusCounts["Resolved"] || 0;

      function makeCard(label, value, sub, onClick) {
        const div = document.createElement("div");
        div.className = "card kpi";
        div.innerHTML =
          `<div class="kpi-label">${escapeHtml(label)}</div>` +
          `<div class="kpi-value">${value}</div>` +
          (sub ? `<div class="kpi-sub">${escapeHtml(sub)}</div>` : "");
        if (onClick) {
          div.addEventListener("click", onClick);
        }
        container.appendChild(div);
      }

      makeCard("All issues", all.length, "Click to clear filters", () => {
        resetFilters();
      });

      makeCard("High priority", highCount, "Priority = High", () => {
        Filters.priority = "High";
        if (E.priorityFilter) E.priorityFilter.value = "High";
        saveFilters();
        refreshAll();
      });

      makeCard("Resolved", resolvedCount, "Status = Resolved", () => {
        Filters.status = "Resolved";
        if (E.statusFilter) E.statusFilter.value = "Resolved";
        saveFilters();
        refreshAll();
      });

      const recentSince = Date.now() - CONFIG.TREND_RECENT_DAYS*86400000;
      const recentCount = all.filter(r => {
        const d = parseDateLoose(r.date);
        return d && d.getTime() >= recentSince;
      }).length;
      makeCard(`Last ${CONFIG.TREND_RECENT_DAYS} days`, recentCount, "Recent issues", () => {
        const d = new Date();
        d.setDate(d.getDate() - CONFIG.TREND_RECENT_DAYS);
        Filters.startDate = d.toISOString().slice(0,10);
        if (E.startDateFilter) E.startDateFilter.value = Filters.startDate;
        saveFilters();
        refreshAll();
      });
    };

    UI.Issues.renderFilterChips = function() {
      if (!E.activeFiltersChips) return;
      const chips = [];
      if (Filters.search) chips.push({ key:"search", label:`Search: "${Filters.search}"` });
      if (Filters.module !== "All") chips.push({ key:"module", label:`Module: ${Filters.module}` });
      if (Filters.priority !== "All") chips.push({ key:"priority", label:`Priority: ${Filters.priority}` });
      if (Filters.status !== "All") chips.push({ key:"status", label:`Status: ${Filters.status}` });
      if (Filters.startDate) chips.push({ key:"startDate", label:`From: ${Filters.startDate}` });
      if (Filters.endDate) chips.push({ key:"endDate", label:`To: ${Filters.endDate}` });

      const c = E.activeFiltersChips;
      c.innerHTML = "";
      chips.forEach(ch => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "filter-chip";
        btn.textContent = ch.label + " √ó";
        btn.addEventListener("click", () => {
          Filters[ch.key] = ch.key === "search" ? "" : (ch.key === "module" || ch.key === "priority" || ch.key === "status" ? "All" : "");
          if (ch.key === "module" && E.moduleFilter) E.moduleFilter.value = "All";
          if (ch.key === "priority" && E.priorityFilter) E.priorityFilter.value = "All";
          if (ch.key === "status" && E.statusFilter) E.statusFilter.value = "All";
          if (ch.key === "startDate" && E.startDateFilter) E.startDateFilter.value = "";
          if (ch.key === "endDate" && E.endDateFilter) E.endDateFilter.value = "";
          if (ch.key === "search" && E.searchInput) E.searchInput.value = "";
          saveFilters();
          refreshAll();
        });
        c.appendChild(btn);
      });
    };

    function makeChart(base, ctx, type, labels, data) {
      if (!ctx) return null;
      if (base) {
        base.data.labels = labels;
        base.data.datasets[0].data = data;
        base.update();
        return base;
      }
      return new Chart(ctx, {
        type,
        data: {
          labels,
          datasets: [{
            data,
            borderWidth:1
          }]
        },
        options: {
          plugins: { legend:{ labels:{ color:"#9ca3af", font:{ size:11 } } } },
          scales: type === "bar" ? {
            x:{ ticks:{ color:"#9ca3af", font:{ size:10 } }, grid:{ display:false } },
            y:{ ticks:{ color:"#9ca3af", font:{ size:10 } }, grid:{ color:"#111827" } }
          } : {}
        }
      });
    }

    UI.Issues.renderCharts = function(rows) {
      const by = {
        module:{}, priority:{}, status:{}, type:{}
      };
      rows.forEach(r => {
        by.module[r.module] = (by.module[r.module] || 0) + 1;
        by.priority[r.priority || "Unspecified"] =
          (by.priority[r.priority || "Unspecified"] || 0) + 1;
        by.status[r.status] = (by.status[r.status] || 0) + 1;
        by.type[r.type || "Unspecified"] =
          (by.type[r.type || "Unspecified"] || 0) + 1;
      });

      function topN(obj, n) {
        const arr = Object.entries(obj);
        arr.sort((a,b)=>b[1]-a[1]);
        return arr.slice(0,n);
      }

      const m = topN(by.module, 10);
      const p = Object.entries(by.priority);
      const s = Object.entries(by.status);
      const t = Object.entries(by.type);

      charts.byModule = makeChart(
        charts.byModule,
        E.byModule?.getContext("2d"),
        "bar",
        m.map(x=>x[0]),
        m.map(x=>x[1])
      );
      charts.byPriority = makeChart(
        charts.byPriority,
        E.byPriority?.getContext("2d"),
        "doughnut",
        p.map(x=>x[0]),
        p.map(x=>x[1])
      );
      charts.byStatus = makeChart(
        charts.byStatus,
        E.byStatus?.getContext("2d"),
        "doughnut",
        s.map(x=>x[0]),
        s.map(x=>x[1])
      );
      charts.byType = makeChart(
        charts.byType,
        E.byType?.getContext("2d"),
        "doughnut",
        t.map(x=>x[0]),
        t.map(x=>x[1])
      );
    };

    UI.Issues.renderTable = function(rows) {
      if (!E.issuesTbody) return;
      const tbody = E.issuesTbody;

      const rowsSorted = rows.slice();
      const key = currentSort.key;
      const dir = currentSort.dir === "asc" ? 1 : -1;

      rowsSorted.sort((a,b) => {
        let av, bv;
        if (key === "date") {
          const ad = parseDateLoose(a.date);
          const bd = parseDateLoose(b.date);
          av = ad ? ad.getTime() : 0;
          bv = bd ? bd.getTime() : 0;
        } else {
          av = (a[key] ?? "").toString().toLowerCase();
          bv = (b[key] ?? "").toString().toLowerCase();
        }
        if (av < bv) return -1 * dir;
        if (av > bv) return 1 * dir;
        return 0;
      });

      const pageSize = E.pageSize ? parseInt(E.pageSize.value || "20", 10) : 20;
      const totalPages = Math.max(1, Math.ceil(rowsSorted.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const startIndex = (currentPage - 1) * pageSize;
      const pageRows = rowsSorted.slice(startIndex, startIndex + pageSize);

      if (E.tbodySkeleton) E.tbodySkeleton.style.display = "none";
      tbody.style.display = "table-row-group";

      if (pageRows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:18px;">No issues match filters.</td></tr>`;
      } else {
        tbody.innerHTML = pageRows.map(r => {
          const prioClass = r.priority ? ` priority-${r.priority}` : "";
          const statusClass = r.status ? ` status-${r.status.replace(/\s/g," ")}` : "";
          const fileLink = r.file
            ? `<a href="${escapeAttr(r.file)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">Open</a>`
            : "";
          return `<tr data-id="${escapeAttr(r.id)}">
              <td>${escapeHtml(r.id)}</td>
              <td>${escapeHtml(r.module)}</td>
              <td>${escapeHtml(r.title)}</td>
              <td><span class="pill${prioClass}">${escapeHtml(r.priority || "")}</span></td>
              <td><span class="pill${statusClass}">${escapeHtml(r.status || "")}</span></td>
              <td>${escapeHtml(r.date || "")}</td>
              <td>${escapeHtml((r.log || "").slice(0,80))}${r.log && r.log.length>80?"‚Ä¶":""}</td>
              <td>${fileLink}</td>
            </tr>`;
        }).join("");
      }

      if (E.rowCount) {
        E.rowCount.textContent = `${rows.length} issue(s)`;
      }
      if (E.pageInfo) {
        E.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      }
      if (E.firstPage) E.firstPage.disabled = currentPage <= 1;
      if (E.prevPage) E.prevPage.disabled = currentPage <= 1;
      if (E.nextPage) E.nextPage.disabled = currentPage >= totalPages;
      if (E.lastPage) E.lastPage.disabled = currentPage >= totalPages;

      // sorting indicators
      const ths = E.issuesTable ? E.issuesTable.querySelectorAll("thead th.sortable") : [];
      ths.forEach(th => {
        th.classList.remove("sorted-asc","sorted-desc");
        if (th.dataset.key === currentSort.key) {
          th.classList.add(currentSort.dir === "asc" ? "sorted-asc" : "sorted-desc");
        }
      });
    };

    // --- Calendar UI ----------------------------------------------------------

    UI.Calendar.ensure = function() {
      if (calendarObj || !E.calendar) return;
      calendarObj = new FullCalendar.Calendar(E.calendar, {
        initialView: "dayGridMonth",
        height: "auto",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
        },
        eventClick(info) {
          const data = info.event.extendedProps?.full ||
            DataStore.events.find(ev => ev.id === info.event.id);
          if (data) openEventModal(data);
        },
        dateClick(info) {
          openEventModal({
            id: null,
            title: "",
            type: "Deployment",
            env: "Prod",
            status: "Planned",
            owner: "",
            modules: [],
            impactType: "No downtime expected",
            issueId: "",
            start: info.dateStr,
            end: "",
            allDay: true,
            description: "",
            notificationStatus: ""
          });
        }
      });
      calendarObj.render();
    };

    UI.Calendar.refresh = function() {
      UI.Calendar.ensure();
      if (!calendarObj) return;

      calendarObj.removeAllEvents();

      const visible = {
        Deployment: !!E.eventFilterDeployment?.checked,
        Maintenance: !!E.eventFilterMaintenance?.checked,
        Release: !!E.eventFilterRelease?.checked,
        Other: !!E.eventFilterOther?.checked
      };

      (DataStore.events || []).forEach(ev => {
        const type = ev.type || "Other";
        if (!visible[type]) return;

        const classes = [];
        const tClass = "event-type-" + type.toLowerCase();
        classes.push(tClass);

        const env = (ev.env || "").toLowerCase();
        if (env === "prod") classes.push("event-env-prod");
        else if (env === "staging") classes.push("event-env-staging");
        else if (env === "dev") classes.push("event-env-dev");
        else classes.push("event-env-other");

        calendarObj.addEvent({
          id: ev.id,
          title: ev.title || "(no title)",
          start: ev.start || ev.startDate,
          end: ev.end || ev.endDate || null,
          allDay: !!ev.allDay,
          classNames: classes,
          extendedProps: { full: ev }
        });
      });
    };

    // --- AI (simple insights) -------------------------------------------------

    UI.AI.refresh = function(rows) {
      if (!E.aiTopTerms || !E.aiHighRisk) return;
      const text = rows.map(r => (r.title + " " + r.desc + " " + r.log).toLowerCase()).join(" ");
      const tokens = text.replace(/[^a-z0-9]+/g," ").split(/\s+/).filter(w => w.length > 3);

      const counts = {};
      tokens.forEach(t => { counts[t] = (counts[t] || 0) + 1; });

      const sorted = Object.entries(counts)
        .filter(([w]) => !["this","that","with","from","issue","ticket","user","have","into"].includes(w))
        .sort((a,b)=>b[1]-a[1])
        .slice(0,10);

      E.aiTopTerms.innerHTML = sorted.map(([w,c]) => `<li>${escapeHtml(w)} ‚Äì ${c}</li>`).join("") ||
        "<li>No strong terms yet.</li>";

      const highRisk = rows
        .filter(r => (r.risk?.total || 0) >= 12)
        .slice(0,10);

      E.aiHighRisk.innerHTML = highRisk.map(r =>
        `<li><strong>${escapeHtml(r.id)}</strong> ¬∑ ${escapeHtml(r.title)} (risk ${r.risk.total})</li>`
      ).join("") || "<li>No high risk issues found.</li>";
    };

    // --- CSV export -----------------------------------------------------------

    function exportIssuesToCsv(rows, suffix) {
      if (!rows.length) return UI.toast("No issues to export.");
      const headers = [
        "ID","Module","Title","Description","Priority","Status","Type",
        "Date","Log","Link","RiskTotal","RiskSeverity","RiskImpact","RiskUrgency"
      ];
      const lines = [headers.join(",")];

      rows.forEach(r => {
        const risk = r.risk || {};
        const arr = [
          r.id, r.module, r.title, r.desc, r.priority, r.status, r.type,
          r.date, r.log, r.file,
          risk.total ?? "", risk.severity ?? "", risk.impact ?? "", risk.urgency ?? ""
        ].map(csvEscape);
        lines.push(arr.join(","));
      });

      const blob = new Blob([lines.join("\r\n")], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `incheck_issues_${suffix || "filtered"}_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      UI.toast("Exported issues CSV");
    }

    // üî∏ Events CSV with EXACT requested columns
    function exportEventsToCsv(events, suffix) {
      if (!events || !events.length) return UI.toast("No events to export.");

      const headers = [
        "ID",
        "Title",
        "Type",
        "Environment",
        "Change status",
        "Owner",
        "Modules",
        "Impact",
        "Issue ID (optional)",
        "Start",
        "End",
        "Description",
        "Notification Status"
      ];

      const lines = [headers.join(",")];

      events.forEach(ev => {
        const arr = [
          ev.id || "",
          ev.title || "",
          ev.type || "",
          ev.env || "",
          ev.status || "",
          ev.owner || "",
          Array.isArray(ev.modules) ? ev.modules.join("; ") : (ev.modules || ""),
          ev.impactType || "",
          ev.issueId || "",
          ev.start || ev.startDate || "",
          ev.end || ev.endDate || "",
          (ev.description || "").replace(/\r?\n/g," "),
          ev.notificationStatus || ""
        ].map(csvEscape);
        lines.push(arr.join(","));
      });

      const blob = new Blob([lines.join("\r\n")], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `incheck_events_${suffix || "all"}_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      UI.toast("Exported events CSV");
    }

    // --- Data loading ---------------------------------------------------------

    async function loadIssues(force) {
      if (!CONFIG.SHEET_CSV_URL) return;
      try {
        UI.spinner(true);
        if (E.loadingStatus) E.loadingStatus.textContent = "Loading issues‚Ä¶";

        const res = await fetch(CONFIG.SHEET_CSV_URL, { cache: force ? "reload" : "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const text = await res.text();
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        const rows = (parsed.data || [])
          .map(normalizeIssueRow)
          .filter(r => r.id);

        DataStore.issues = rows;
        UI.Issues.populateFilterOptions();
        UI.setSync("issues", true, new Date());
        refreshAll();
      } catch (e) {
        console.error(e);
        UI.toast("Error loading issues");
        UI.setSync("issues", false);
      } finally {
        UI.spinner(false);
        if (E.loadingStatus) E.loadingStatus.textContent = "";
      }
    }

    async function loadEvents(force) {
      if (!CONFIG.CALENDAR_API_URL) return;
      try {
        UI.spinner(true);
        const res = await fetch(CONFIG.CALENDAR_API_URL, { cache: force ? "reload" : "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json().catch(()=>({}));
        const events = Array.isArray(data.events) ? data.events : [];

        DataStore.events = events.map(ev => {
          const modulesArr = Array.isArray(ev.modules)
            ? ev.modules
            : (typeof ev.modules === "string"
               ? ev.modules.split(",").map(s => s.trim()).filter(Boolean)
               : []);
          return {
            id: ev.id || ("ev_" + Date.now() + "_" + Math.random().toString(36).slice(2)),
            title: ev.title || "",
            type: ev.type || "Other",
            env: ev.env || ev.environment || "Prod",
            status: ev.status || "Planned",
            owner: ev.owner || "",
            modules: modulesArr,
            impactType: ev.impactType || "No downtime expected",
            issueId: ev.issueId || "",
            start: ev.start || ev.startDate || "",
            end: ev.end || ev.endDate || "",
            allDay: !!ev.allDay,
            description: ev.description || "",
            notificationStatus: ev.notificationStatus || ""
          };
        });

        UI.Calendar.refresh();
        UI.setSync("events", true, new Date());
        refreshAll();
      } catch (e) {
        console.error(e);
        UI.toast("Error loading events");
        UI.setSync("events", false);
      } finally {
        UI.spinner(false);
      }
    }

    async function saveEventToBackend(ev) {
      if (!CONFIG.CALENDAR_API_URL) return ev;
      try {
        UI.spinner(true);
        const res = await fetch(CONFIG.CALENDAR_API_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ action:"save", event:ev })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json().catch(()=>null);
        if (data && data.ok && data.event) return data.event;
        UI.toast("Backend did not confirm save; using local event");
        return ev;
      } catch (e) {
        console.error(e);
        UI.toast("Network error saving event; using local event");
        return ev;
      } finally {
        UI.spinner(false);
      }
    }

    async function deleteEventFromBackend(id) {
      if (!CONFIG.CALENDAR_API_URL) return true;
      try {
        UI.spinner(true);
        const res = await fetch(CONFIG.CALENDAR_API_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ action:"delete", event:{ id } })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json().catch(()=>null);
        if (data && data.ok) return true;
        UI.toast("Backend delete failed; removing locally");
        return true;
      } catch (e) {
        console.error(e);
        UI.toast("Network error deleting; removing locally");
        return true;
      } finally {
        UI.spinner(false);
      }
    }

    // --- Modals ---------------------------------------------------------------

    function openIssueModal(id) {
      const issue = (DataStore.issues || []).find(r => r.id === id);
      if (!issue || !E.issueModal) return;
      currentIssueId = issue.id;

      if (E.modalTitle) {
        E.modalTitle.textContent = `${issue.id} ¬∑ ${issue.title || ""}`;
      }

      const risk = issue.risk || {};
      const body = `
        <p><strong>Module:</strong> ${escapeHtml(issue.module)}</p>
        <p><strong>Status:</strong> ${escapeHtml(issue.status)} ¬∑ <strong>Priority:</strong> ${escapeHtml(issue.priority)}</p>
        <p><strong>Date:</strong> ${escapeHtml(issue.date || "")}</p>
        <p><strong>Description</strong><br>${escapeHtml(issue.desc || "").replace(/\n/g,"<br>")}</p>
        <p><strong>Log</strong><br>${escapeHtml(issue.log || "").replace(/\n/g,"<br>")}</p>
        <p><strong>Risk:</strong> ${risk.total != null ? risk.total : "n/a"}
           (Severity ${risk.severity ?? "-"}, Impact ${risk.impact ?? "-"}, Urgency ${risk.urgency ?? "-"})</p>
        ${issue.file ? `<p><a href="${escapeAttr(issue.file)}" target="_blank" rel="noopener noreferrer">Open linked file</a></p>` : ""}
      `;
      if (E.modalBody) E.modalBody.innerHTML = body;

      E.issueModal.style.display = "flex";
    }

    function closeIssueModal() {
      if (!E.issueModal) return;
      E.issueModal.style.display = "none";
      currentIssueId = null;
    }

    function openEventModal(ev) {
      if (!E.eventModal) return;
      currentEventId = ev.id || null;

      E.eventModalTitle.textContent = ev.id ? "Edit event" : "New event";

      E.eventTitle.value = ev.title || "";
      E.eventType.value = ev.type || "Deployment";
      E.eventEnv.value = ev.env || "Prod";
      E.eventStatus.value = ev.status || "Planned";
      E.eventOwner.value = ev.owner || "";
      E.eventModules.value = Array.isArray(ev.modules) ? ev.modules.join(", ") : (ev.modules || "");
      E.eventImpactType.value = ev.impactType || "No downtime expected";
      E.eventIssueId.value = ev.issueId || "";
      E.eventAllDay.checked = !!ev.allDay;
      E.eventStart.value = toLocalInput(ev.start || ev.startDate || new Date());
      E.eventEnd.value = toLocalInput(ev.end || ev.endDate || "");

      E.eventDescription.value = ev.description || "";

      if (ev.issueId) {
        const issue = (DataStore.issues || []).find(r => r.id === ev.issueId);
        E.eventIssueLinkedInfo.style.display = "block";
        if (issue) {
          E.eventIssueLinkedInfo.innerHTML =
            `Linked to <strong>${escapeHtml(issue.id)}</strong>: ${escapeHtml(issue.title)}`;
        } else {
          E.eventIssueLinkedInfo.textContent = "Linked issue: " + ev.issueId;
        }
      } else {
        E.eventIssueLinkedInfo.style.display = "none";
        E.eventIssueLinkedInfo.textContent = "";
      }

      E.eventDelete.style.display = ev.id ? "inline-flex" : "none";

      E.eventModal.style.display = "flex";
    }

    function closeEventModal() {
      if (!E.eventModal) return;
      E.eventModal.style.display = "none";
      currentEventId = null;
    }

    // --- Filters persistence --------------------------------------------------

    function saveFilters() {
      try { localStorage.setItem(LS_KEYS.filters, JSON.stringify(Filters)); } catch {}
    }

    function loadFilters() {
      try {
        const raw = localStorage.getItem(LS_KEYS.filters);
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (obj && typeof obj === "object") {
          Object.assign(Filters, obj);
        }
      } catch {}
    }

    // --- Theme & accent -------------------------------------------------------

    function applyTheme(mode) {
      let theme = mode;
      if (mode === "system") {
        const prefersDark = window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        theme = prefersDark ? "dark" : "light";
      }
      document.documentElement.setAttribute("data-theme", theme);
    }

    function wireTheme() {
      const savedTheme = localStorage.getItem(LS_KEYS.theme) || "system";
      if (E.themeSelect) E.themeSelect.value = savedTheme;
      applyTheme(savedTheme);
      if (E.themeSelect) {
        E.themeSelect.addEventListener("change", () => {
          const v = E.themeSelect.value;
          localStorage.setItem(LS_KEYS.theme, v);
          applyTheme(v);
        });
      }

      const savedAccent = localStorage.getItem(LS_KEYS.accent);
      if (savedAccent && E.accentColor) {
        E.accentColor.value = savedAccent;
        document.documentElement.style.setProperty("--accent", savedAccent);
      }
      if (E.accentColor) {
        E.accentColor.addEventListener("input", () => {
          const col = E.accentColor.value;
          localStorage.setItem(LS_KEYS.accent, col);
          document.documentElement.style.setProperty("--accent", col);
        });
      }
    }

    // --- Wiring ---------------------------------------------------------------

    function setActiveView(view) {
      currentView = view;
      if (E.issuesView) E.issuesView.classList.toggle("active", view === "issues");
      if (E.calendarView) E.calendarView.classList.toggle("active", view === "calendar");
      if (E.insightsView) E.insightsView.classList.toggle("active", view === "insights");

      if (E.issuesTab) E.issuesTab.classList.toggle("active", view === "issues");
      if (E.calendarTab) E.calendarTab.classList.toggle("active", view === "calendar");
      if (E.insightsTab) E.insightsTab.classList.toggle("active", view === "insights");

      try { localStorage.setItem(LS_KEYS.view, view); } catch {}

      if (view === "calendar") UI.Calendar.refresh();
      if (view === "insights") UI.AI.refresh(currentRows);
    }

    function resetFilters() {
      Filters.search = "";
      Filters.module = "All";
      Filters.priority = "All";
      Filters.status = "All";
      Filters.startDate = "";
      Filters.endDate = "";
      if (E.searchInput) E.searchInput.value = "";
      if (E.moduleFilter) E.moduleFilter.value = "All";
      if (E.priorityFilter) E.priorityFilter.value = "All";
      if (E.statusFilter) E.statusFilter.value = "All";
      if (E.startDateFilter) E.startDateFilter.value = "";
      if (E.endDateFilter) E.endDateFilter.value = "";
      saveFilters();
      refreshAll();
    }

    function wireCore() {
      if (E.issuesTab) E.issuesTab.addEventListener("click", () => setActiveView("issues"));
      if (E.calendarTab) E.calendarTab.addEventListener("click", () => setActiveView("calendar"));
      if (E.insightsTab) E.insightsTab.addEventListener("click", () => setActiveView("insights"));

      if (E.refreshNow) {
        E.refreshNow.addEventListener("click", () => { loadIssues(true); loadEvents(true); });
      }

      if (E.exportCsv) {
        E.exportCsv.addEventListener("click", () => {
          if (currentView === "calendar") {
            exportEventsToCsv(DataStore.events || [], "events");
          } else {
            exportIssuesToCsv(currentRows || [], "filtered");
          }
        });
      }

      if (E.createTicketBtn) {
        E.createTicketBtn.addEventListener("click", () => {
          window.open("https://forms.gle/PPnEP1AQneoBT79s5", "_blank", "noopener,noreferrer");
        });
      }

      if (E.shortcutsHelp) {
        E.shortcutsHelp.addEventListener("click", () => {
          UI.toast("Shortcuts: 1/2/3 tabs ¬∑ / search");
        });
      }

      if (E.searchInput) {
        E.searchInput.value = Filters.search || "";
        E.searchInput.addEventListener("input", () => {
          Filters.search = E.searchInput.value || "";
          saveFilters();
          currentPage = 1;
          refreshAll();
        });
      }
    }

    function wireFilters() {
      if (E.moduleFilter) {
        E.moduleFilter.addEventListener("change", () => {
          Filters.module = E.moduleFilter.value;
          saveFilters();
          currentPage = 1;
          refreshAll();
        });
      }
      if (E.priorityFilter) {
        E.priorityFilter.addEventListener("change", () => {
          Filters.priority = E.priorityFilter.value;
          saveFilters();
          currentPage = 1;
          refreshAll();
        });
      }
      if (E.statusFilter) {
        E.statusFilter.addEventListener("change", () => {
          Filters.status = E.statusFilter.value;
          saveFilters();
          currentPage = 1;
          refreshAll();
        });
      }
      if (E.startDateFilter) {
        if (Filters.startDate) E.startDateFilter.value = Filters.startDate;
        E.startDateFilter.addEventListener("change", () => {
          Filters.startDate = E.startDateFilter.value || "";
          saveFilters();
          currentPage = 1;
          refreshAll();
        });
      }
      if (E.endDateFilter) {
        if (Filters.endDate) E.endDateFilter.value = Filters.endDate;
        E.endDateFilter.addEventListener("change", () => {
          Filters.endDate = E.endDateFilter.value || "";
          saveFilters();
          currentPage = 1;
          refreshAll();
        });
      }
      if (E.resetBtn) {
        E.resetBtn.addEventListener("click", resetFilters);
      }
    }

    function wireSorting() {
      if (!E.issuesTable) return;
      const ths = E.issuesTable.querySelectorAll("thead th.sortable");
      ths.forEach(th => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;
          if (!key) return;
          if (currentSort.key === key) {
            currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
          } else {
            currentSort.key = key;
            currentSort.dir = "asc";
          }
          currentPage = 1;
          refreshAll();
        });
      });
    }

    function wirePaging() {
      if (E.pageSize) {
        const saved = localStorage.getItem(LS_KEYS.pageSize);
        if (saved) E.pageSize.value = saved;
        E.pageSize.addEventListener("change", () => {
          try { localStorage.setItem(LS_KEYS.pageSize, E.pageSize.value); } catch {}
          currentPage = 1;
          refreshAll();
        });
      }
      if (E.firstPage) E.firstPage.addEventListener("click", () => { currentPage = 1; refreshAll(); });
      if (E.prevPage) E.prevPage.addEventListener("click", () => { currentPage--; refreshAll(); });
      if (E.nextPage) E.nextPage.addEventListener("click", () => { currentPage++; refreshAll(); });
      if (E.lastPage) E.lastPage.addEventListener("click", () => {
        const rows = currentRows || [];
        const pageSize = E.pageSize ? parseInt(E.pageSize.value || "20", 10) : 20;
        currentPage = Math.max(1, Math.ceil(rows.length / pageSize));
        refreshAll();
      });
    }

    function wireModals() {
      if (E.issuesTbody) {
        E.issuesTbody.addEventListener("click", e => {
          const tr = e.target.closest("tr");
          if (!tr) return;
          const id = tr.getAttribute("data-id");
          if (!id) return;
          openIssueModal(id);
        });
      }
      if (E.modalClose && E.issueModal) {
        E.modalClose.addEventListener("click", closeIssueModal);
        E.issueModal.addEventListener("click", e => {
          if (e.target === E.issueModal) closeIssueModal();
        });
      }
      if (E.copyId) {
        E.copyId.addEventListener("click", async () => {
          if (!currentIssueId) return;
          try {
            await navigator.clipboard.writeText(currentIssueId);
            UI.toast("Issue ID copied");
          } catch {}
        });
      }
      if (E.copyLink) {
        E.copyLink.addEventListener("click", async () => {
          if (!currentIssueId) return;
          const url = window.location.href.split("#")[0] + "#issue-" + encodeURIComponent(currentIssueId);
          try {
            await navigator.clipboard.writeText(url);
            UI.toast("Issue link copied");
          } catch {}
        });
      }

      if (E.eventModalClose && E.eventModal) {
        E.eventModalClose.addEventListener("click", closeEventModal);
        E.eventModal.addEventListener("click", e => {
          if (e.target === E.eventModal) closeEventModal();
        });
      }
      if (E.eventCancel) {
        E.eventCancel.addEventListener("click", closeEventModal);
      }
      if (E.eventForm) {
        E.eventForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
            id: currentEventId || ("ev_" + Date.now() + "_" + Math.random().toString(36).slice(2)),
            title: E.eventTitle.value.trim(),
            type: E.eventType.value,
            env: E.eventEnv.value,
            status: E.eventStatus.value,
            owner: E.eventOwner.value.trim(),
            modules: E.eventModules.value
              ? E.eventModules.value.split(",").map(s => s.trim()).filter(Boolean)
              : [],
            impactType: E.eventImpactType.value,
            issueId: E.eventIssueId.value.trim(),
            start: E.eventStart.value,
            end: E.eventEnd.value || "",
            allDay: !!E.eventAllDay.checked,
            description: E.eventDescription.value.trim(),
            notificationStatus: ""  // will be preserved if backend returns one
          };
          const saved = await saveEventToBackend(payload);
          if (!saved) return;

          // keep notificationStatus if backend returned it
          payload.notificationStatus = saved.notificationStatus || payload.notificationStatus;
          payload.id = saved.id || payload.id;

          const idx = (DataStore.events || []).findIndex(ev => ev.id === payload.id);
          if (idx >= 0) DataStore.events[idx] = payload;
          else DataStore.events.push(payload);

          UI.Calendar.refresh();
          closeEventModal();
          UI.toast("Event saved");
          UI.setSync("events", true, new Date());
        });
      }
      if (E.eventDelete) {
        E.eventDelete.addEventListener("click", async () => {
          if (!currentEventId) return;
          const ok = await deleteEventFromBackend(currentEventId);
          if (!ok) return;
          DataStore.events = (DataStore.events || []).filter(ev => ev.id !== currentEventId);
          UI.Calendar.refresh();
          closeEventModal();
          UI.toast("Event deleted");
        });
      }
      if (E.addEventBtn) {
        E.addEventBtn.addEventListener("click", () => {
          openEventModal({
            id:null,
            title:"",
            type:"Deployment",
            env:"Prod",
            status:"Planned",
            owner:"",
            modules:[],
            impactType:"No downtime expected",
            issueId:"",
            start:new Date(),
            end:"",
            allDay:false,
            description:"",
            notificationStatus:""
          });
        });
      }
    }

    function wireCalendarFilters() {
      ["eventFilterDeployment","eventFilterMaintenance","eventFilterRelease","eventFilterOther"]
        .forEach(id => {
          const el = E[id];
          if (el) el.addEventListener("change", () => UI.Calendar.refresh());
        });
    }

    function wireKeyboard() {
      document.addEventListener("keydown", (e) => {
        const tag = (e.target && e.target.tagName) || "";
        const isInput = ["INPUT","TEXTAREA","SELECT"].includes(tag);
        if (e.key === "/" && !isInput) {
          e.preventDefault();
          if (E.searchInput) E.searchInput.focus();
        }
        if (!isInput) {
          if (e.key === "1") setActiveView("issues");
          if (e.key === "2") setActiveView("calendar");
          if (e.key === "3") setActiveView("insights");
        }
      });

      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);
    }

    // --- Refresh --------------------------------------------------------------

    function refreshAll() {
      const rows = UI.Issues.applyFilters();
      currentRows = rows;
      UI.Issues.renderSummary(rows);
      UI.Issues.renderFilterChips();
      UI.Issues.renderKPIs(rows);
      UI.Issues.renderCharts(rows);
      UI.Issues.renderTable(rows);

      if (currentView === "insights") {
        UI.AI.refresh(rows);
      }
    }

    // --- Init -----------------------------------------------------------------

    function initApp() {
      cacheDom();
      updateOnlineStatus();
      loadFilters();
      wireTheme();
      wireCore();
      wireFilters();
      wireSorting();
      wirePaging();
      wireModals();
      wireCalendarFilters();
      wireKeyboard();

      if (E.calendarTz) {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        E.calendarTz.textContent = "Times shown in " + tz;
      }

      const savedView = localStorage.getItem(LS_KEYS.view) || "issues";
      setActiveView(savedView);

      loadIssues(true);
      loadEvents(true);

      // refresh events every 5 minutes
      setInterval(() => loadEvents(true), 5 * 60 * 1000);
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
