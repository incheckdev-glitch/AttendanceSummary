<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>InCheck 360 Chat â€“ Corporate Edition</title>
<style>
:root {
  --brand: #0078d7;
  --brand-dark: #005bb5;
  --bg: #f5f7fb;
  --panel: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --muted: #64748b;
  --sent: var(--brand);
  --recv: #edf2f7;
  --radius: 14px;
  --shadow: 0 2px 8px rgba(0,0,0,0.05);
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  display:flex;
  flex-direction:column;
}
.app{
  flex:1;
  display:grid;
  grid-template-columns:280px 1fr;
  grid-template-rows:64px 1fr 72px;
  grid-template-areas:
    "sidebar header"
    "sidebar chat"
    "sidebar composer";
  height:100vh;
}

/* Sidebar */
.sidebar{
  grid-area:sidebar;
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.sidebar-header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:#f9fafb;
  box-shadow:var(--shadow);
}
.sidebar-header img{
  width:40px;height:40px;border-radius:8px;flex-shrink:0;
}
.sidebar-header h1{
  font-size:1.1em;
  margin:0;
  color:var(--brand-dark);
}
.section{
  padding:8px 16px;
  border-bottom:1px solid var(--border);
}
.section input, .section select{
  width:100%;
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:8px;
  font-size:0.9em;
}
.people,.rooms{
  flex:1;
  overflow:auto;
  padding:8px 0;
}
.person,.room{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 16px;
  cursor:pointer;
  transition:background 0.2s;
}
.person:hover,.room:hover{background:#f2f4f7;}
.person.active,.room.active{background:rgba(0,120,215,0.15);}
.status-dot{
  width:8px;height:8px;border-radius:50%;margin-left:auto;
}
.online{background:#22c55e;}
.offline{background:#9ca3af;}

/* Header */
.header{
  grid-area:header;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
}

/* Chat */
.chat{
  grid-area:chat;
  background:#f9fafc;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
}
.message{
  margin:8px 0;
  display:flex;
  align-items:flex-end;
  gap:8px;
}
.bubble{
  padding:10px 14px;
  border-radius:var(--radius);
  max-width:70%;
  line-height:1.4;
  word-wrap:break-word;
  box-shadow:var(--shadow);
}
.mine{justify-content:flex-end;}
.mine .bubble{background:var(--sent);color:#fff;border-bottom-right-radius:4px;}
.theirs .bubble{background:var(--recv);color:var(--text);border-bottom-left-radius:4px;}
.meta{
  font-size:0.75em;color:var(--muted);margin-top:4px;text-align:right;
}

/* Composer */
.composer{
  grid-area:composer;
  background:var(--panel);
  border-top:1px solid var(--border);
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 16px;
}
.composer input[type=text]{
  flex:1;
  padding:10px;
  border:1px solid var(--border);
  border-radius:20px;
  font-size:0.95em;
}
.composer button{
  background:var(--brand);
  color:#fff;
  border:none;
  border-radius:50%;
  width:44px;height:44px;
  font-size:1.1em;
  cursor:pointer;
  transition:background 0.2s;
}
.composer button:hover{background:var(--brand-dark);}
.file-upload{position:relative;overflow:hidden;}
.file-upload input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;}

/* Toast */
.toast{
  position:fixed;
  bottom:20px;right:20px;
  background:var(--brand);
  color:#fff;
  padding:10px 16px;
  border-radius:8px;
  box-shadow:var(--shadow);
  opacity:0;transform:translateY(20px);
  transition:all .3s ease;
  z-index:999;
}
.toast.show{opacity:1;transform:translateY(0);}

@media(max-width:900px){
  .app{grid-template-columns:1fr;grid-template-areas:"header" "chat" "composer";}
  .sidebar{position:absolute;z-index:100;background:#fff;width:260px;height:100%;left:-260px;transition:left .3s;}
  .sidebar.open{left:0;}
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="data:image/png;base64,REPLACE_WITH_LOGO" alt="InCheck logo"/>
      <h1>InCheck 360</h1>
    </div>
    <div class="section">
      <label for="meSelect" style="font-size:.85em;">You:</label>
      <select id="meSelect"></select>
    </div>
    <div class="section"><input id="userSearch" type="text" placeholder="Search usersâ€¦"></div>
    <div class="people" id="peopleList"></div>
    <div class="section" style="border-top:1px solid var(--border);"><strong style="font-size:.9em;">Rooms</strong></div>
    <div class="rooms" id="roomsList"></div>
  </aside>

  <header class="header">
    <button id="toggleSidebar" style="background:none;border:none;font-size:1.3em;color:var(--brand);cursor:pointer;">â˜°</button>
    <strong id="chatTitle">Select chat</strong>
    <input id="msgSearch" type="text" placeholder="Search messagesâ€¦" style="padding:6px 10px;border:1px solid var(--border);border-radius:8px;">
  </header>

  <main class="chat" id="chatBox">
    <p style="text-align:center;color:var(--muted);margin-top:20px;">Select a person or room to start chatting.</p>
  </main>

  <div class="composer">
    <div class="file-upload">
      <button title="Attach file">ðŸ“Ž</button>
      <input type="file" id="fileInput"/>
    </div>
    <input type="text" id="messageInput" placeholder="Type a messageâ€¦"/>
    <button id="sendBtn" title="Send">âž¤</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzKpLMouySKF0CvWay77649xDXWLzKcrbJcrc88SKXBIBKhHBoONTkmZT1-jxvm7h04Qw/exec";
const TOKEN = "YOUR_SECRET_TOKEN"; // optional if added in backend
const $ = id => document.getElementById(id);

let me="", peer="", room="", lastMsgId=0, users=[], rooms=[];

async function get(q){return(await fetch(`${API_URL}?${q}&token=${TOKEN}`)).json();}
async function post(b){b.token=TOKEN;return(await fetch(API_URL,{method:"POST",body:JSON.stringify(b)})).json();}
function toast(msg){const t=$("toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2500);}
function beep(){new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play().catch(()=>{});}

async function loadUsers(){
 const res=await get("action=getUsers");
 users=res; $("meSelect").innerHTML='<option value="">Select you</option>'+users.map(u=>`<option value="${u.user_id}">${u.name}</option>`).join("");
 renderUsers();
}
async function loadRooms(){
 const res=await get("action=getRooms");
 rooms=res; renderRooms();
}
function renderUsers(f=""){f=f.toLowerCase();$("peopleList").innerHTML=users.filter(u=>u.name.toLowerCase().includes(f)&&u.user_id!=me).map(u=>`<div class="person" onclick="openChat('${u.user_id}')">${u.name}<span class="status-dot ${u.status==='online'?'online':'offline'}"></span></div>`).join("");}
function renderRooms(){$("roomsList").innerHTML=rooms.map(r=>`<div class="room" onclick="openRoom('${r.room_id}')">${r.room_name}</div>`).join("");}

async function openChat(id){peer=id;room="";$("chatTitle").textContent=(users.find(u=>u.user_id==id)||{}).name||"Chat";await loadMessages(false);closeSidebar();}
async function openRoom(id){room=id;peer="";$("chatTitle").textContent=(rooms.find(r=>r.room_id==id)||{}).room_name||"Room";await loadMessages(false);closeSidebar();}
async function loadMessages(notify=true){
 if(!me)return;
 let q=room?`action=getMessages&room_id=${room}`:`action=getMessages&user1=${me}&user2=${peer}`;
 const res=await get(q);
 if(!Array.isArray(res))return;
 $("chatBox").innerHTML=res.map(m=>`<div class="message ${m.sender_id==me?'mine':'theirs'}"><div class="bubble">${m.message||""}${m.file_link?`<br><a href='${m.file_link}' target='_blank'>ðŸ“Ž File</a>`:""}</div><div class="meta">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}${m.sender_id==me?(m.read_status=="read"?" âœ“âœ“":" âœ“"):""}</div></div>`).join("");
 $("chatBox").scrollTop=$("chatBox").scrollHeight;
 if(res.length){const last=res[res.length-1];if(last.msg_id!=lastMsgId&&last.sender_id!=me&&notify){beep();toast("New message!");}lastMsgId=last.msg_id;}
}
async function sendMessage(){
 const msg=$("messageInput").value.trim();const f=$("fileInput").files[0];
 if(!msg&&!f)return;
 const data={action:"sendMessage",sender_id:me,message:msg};
 if(peer)data.receiver_id=peer;if(room)data.room_id=room;
 if(f){const base64=await toBase64(f);const up=await post({action:"uploadFile",file_name:f.name,mimeType:f.type,file_base64:base64.split(",")[1]});if(up.success)data.file_link=up.file_url;$("fileInput").value="";}
 const res=await post(data);if(res.success){$("messageInput").value="";loadMessages(false);}else toast("Send failed");
}
const toBase64=file=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});
function closeSidebar(){$("sidebar").classList.remove("open");}
$("toggleSidebar").onclick=()=>$("sidebar").classList.toggle("open");
$("sendBtn").onclick=sendMessage;
$("messageInput").onkeypress=e=>{if(e.key==="Enter")sendMessage();}
$("fileInput").onchange=()=>toast("File attached");
$("meSelect").onchange=()=>{me=$("meSelect").value;localStorage.setItem("chat_me",me);renderUsers();}
$("userSearch").oninput=()=>renderUsers($("userSearch").value);
setInterval(()=>{if(me)post({action:"heartbeat",user_id:me});},60000);
setInterval(()=>loadMessages(true),3000);

(async()=>{me=localStorage.getItem("chat_me")||"";await loadUsers();await loadRooms();})();
</script>
</body>
</html>
