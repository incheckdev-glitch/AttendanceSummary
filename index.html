<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck ‚Äî Issues ¬∑ Ops ¬∑ AI Copilot</title>

  <!-- Fonts & Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root {
      /* Status colors */
      --status-resolved:#10b981;
      --status-underdev:#3b82f6;
      --status-rejected:#ef4444;
      --status-onhold:#f59e0b;
      --status-notstarted:#6b7280;
      --status-sent:#8b5cf6;
      --status-onstage:#0ea5e9;

      /* Priority colors */
      --priority-high:#ef4444;
      --priority-medium:#f59e0b;
      --priority-low:#10b981;

      /* Theme */
      --bg:#050816;
      --card:rgba(11,22,45,0.96);
      --muted:#9aa6d1;
      --text:#e8edff;
      --accent:#4f8cff;
      --danger:#ef4444;
      --ok:#10b981;
      --warn:#f59e0b;
      --info:#3b82f6;
      --purple:#8b5cf6;
      --neutral:#6b7280;
      --border:#1b2645;
      --shadow:0 18px 40px rgba(0,0,0,.55);
      --focus:0 0 0 3px rgba(79,140,255,.5);

      /* Extra */
      --chip:#0c142b;
      --skeleton:#0f1a38;
      --shimmer:linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
    }
    :root[data-theme="light"] {
      --bg:#f4f6ff;
      --card:#ffffff;
      --muted:#5a678c;
      --text:#0b1022;
      --accent:#2563eb;
      --danger:#dc2626;
      --ok:#059669;
      --warn:#d97706;
      --info:#1d4ed8;
      --purple:#7c3aed;
      --neutral:#374151;
      --border:#e0e4f3;
      --shadow:0 16px 32px rgba(15,23,42,.12);
      --focus:0 0 0 3px rgba(37,99,235,.35);
      --chip:#eef2ff;
      --skeleton:#eef2ff;
      --shimmer:linear-gradient(90deg, transparent, rgba(0,0,0,.06), transparent);
    }

    * { box-sizing:border-box }
    html,body { height:100% }
    body {
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 0% 0%, rgba(79,140,255,.22), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(139,92,246,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      transition:background .3s,color .3s;
    }
    :focus-visible { outline:none; box-shadow:var(--focus); border-radius:8px; }

    .sr-only{
      position:absolute;width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* Header */
    header {
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg, rgba(11,22,45,.98), rgba(24,35,70,.96));
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px; padding:10px 16px;
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{
      width:30px;height:30px;border-radius:10px;
      display:grid;place-items:center;
      background:conic-gradient(from 160deg, var(--accent), #9b8cff, #22c55e, var(--accent));
      color:#fff;font-weight:800;
      box-shadow:0 10px 30px rgba(79,140,255,.55);
    }
    .brand-text{display:flex;flex-direction:column}
    .brand-text span:first-child{font-size:14px;text-transform:uppercase;letter-spacing:.16em;color:var(--muted)}
    .brand-text span:last-child{font-size:16px}

    .toolbar{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn,.select,.input{
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(8,16,32,.92);color:inherit;font:inherit;
    }
    .btn{
      cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:6px;
      box-shadow:0 8px 20px rgba(15,23,42,.25);
    }
    .btn.primary{background:linear-gradient(135deg,var(--accent),#7c3aed);border-color:transparent;color:#fff}
    .btn.ghost{border-color:transparent;background:transparent;box-shadow:none}
    .btn.sm{padding:6px 10px;border-radius:999px;font-size:13px}
    .btn:hover{opacity:.95;transform:translateY(-1px)}
    .btn:active{transform:translateY(0);opacity:.9}
    .input,.select{background:rgba(5,10,24,.85);box-shadow:inset 0 0 0 1px rgba(15,23,42,.35)}
    .input::placeholder{color:var(--muted)}
    .icon{font-size:18px;line-height:1}

    #accentColor{
      padding:4px;
      width:40px;
      min-width:40px;
      border-radius:999px;
    }

    .statusline{display:flex;gap:10px;align-items:center;margin-left:8px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--danger)}
    .chip{
      padding:4px 8px;border-radius:999px;background:var(--chip);
      border:1px solid var(--border);font-size:12px;color:var(--muted)
    }
    .chip.online{border-color:var(--ok);color:var(--ok)}
    .chip.offline{border-color:var(--warn);color:var(--warn)}

    /* Layout */
    .wrap{
      display:grid;grid-template-columns:300px minmax(0,1fr);
      gap:18px;padding:18px;max-width:1440px;margin:0 auto;
    }
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}

    /* Sidebar */
    .sidebar{
      background:linear-gradient(145deg, rgba(11,23,45,.96), rgba(13,28,60,.98));
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px;padding:16px;
      position:sticky;top:82px;height:fit-content;
      max-height:calc(100vh - 102px);overflow:auto;box-shadow:var(--shadow);
    }
    :root[data-theme="light"] .sidebar{background:var(--card);border-color:var(--border)}
    .sidebar h3{
      margin:0 0 10px;font-size:13px;color:var(--muted);
      text-transform:uppercase;letter-spacing:.12em;
    }
    .filter-group{display:grid;gap:10px;margin-bottom:16px}
    .filter-row{display:grid;gap:6px}
    .muted{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--border);margin:8px 0 14px;opacity:.7}

    /* Content & tabs */
    .content{display:flex;flex-direction:column;gap:16px}
    .view-tabs{
      display:inline-flex;align-self:flex-start;
      background:rgba(10,18,40,.98);border-radius:999px;
      border:1px solid var(--border);box-shadow:0 16px 40px rgba(15,23,42,.45);padding:4px;
    }
    .view-tab{
      border:none;background:transparent;color:var(--muted);
      padding:6px 14px;border-radius:999px;font-size:13px;cursor:pointer;
      display:flex;align-items:center;gap:6px;
    }
    .view-tab .icon{font-size:16px}
    .view-tab.active{
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      color:#fff;box-shadow:0 10px 26px rgba(79,140,255,.6);
    }

    .view{display:none}
    .view.active{display:block}
    .view>*+*{margin-top:16px}

    .grid{display:grid;gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:980px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.grid.cols-4{grid-template-columns:1fr}}

    /* Cards */
    .card{
      background:radial-gradient(circle at 0 0, rgba(79,140,255,.16), transparent 55%),var(--card);
      border:1px solid rgba(148,163,184,.35);
      border-radius:18px;padding:16px;
      box-shadow:var(--shadow);
      transition:transform .2s, box-shadow .2s, border-color .2s, background .2s;
    }
    :root[data-theme="light"] .card{background:var(--card);border-color:var(--border)}
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 20px 50px rgba(15,23,42,.4);
      border-color:rgba(99,102,241,.9);
    }

    .summary-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:13px;
      flex-wrap:wrap;
    }
    .shortcut-chip{font-size:11px;color:var(--muted)}

    /* KPIs */
    .kpi{cursor:pointer;text-align:left;position:relative;overflow:hidden}
    .kpi::before{
      content:"";position:absolute;inset:auto -40% 0;height:60%;
      background:radial-gradient(circle at 20% 0, rgba(79,140,255,.45), transparent 55%);
      opacity:0;transition:.25s;transform:translateY(16px);
    }
    .kpi:hover::before{opacity:1;transform:translateY(0)}
    .kpi .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .kpi .value{font-size:26px;font-weight:800;margin-top:6px}
    .kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}

    /* Charts */
    .charts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media(max-width:980px){.charts{grid-template-columns:1fr}}

    /* Table & skeleton */
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    thead th{
      position:sticky;top:0;z-index:5;
      background:rgba(9,15,32,.98);
      text-align:left;padding:10px 9px;
      border-bottom:1px solid var(--border);
      user-select:none;cursor:pointer;
      font-size:12px;color:var(--muted);
    }
    :root[data-theme="light"] thead th{background:var(--card)}
    tbody td{padding:10px 9px;border-bottom:1px solid rgba(148,163,184,.22)}
    tr:hover{background:rgba(255,255,255,.03)}
    .table-wrap{
      max-height:460px;overflow:auto;border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:radial-gradient(circle at 0 0, rgba(79,140,255,.08), transparent 55%);
    }
    th.sortable::after{
      content:"";margin-left:6px;border:4px solid transparent;
      border-top-color:var(--muted);display:inline-block;transform:translateY(1px);
    }
    th.sorted-asc::after{border-bottom-color:var(--accent);border-top-color:transparent;transform:translateY(-1px)}
    th.sorted-desc::after{border-top-color:var(--accent);border-bottom-color:transparent;transform:translateY(1px)}

    .skeleton{position:relative;overflow:hidden;background:var(--skeleton)}
    .skeleton::after{
      content:"";position:absolute;inset:0;
      animation:shimmer 1.2s infinite;
      background:var(--shimmer);
    }
    @keyframes shimmer{
      0%{transform:translateX(-100%)}100%{transform:translateX(100%)}
    }

    .pill{
      padding:3px 9px;border-radius:999px;font-size:11px;font-weight:700;
      display:inline-block;letter-spacing:.04em;text-transform:uppercase;
    }
    .status-Resolved{background:var(--status-resolved);color:#fff}
    .status-Under\ Development{background:var(--status-underdev);color:#fff}
    .status-Rejected{background:var(--status-rejected);color:#fff}
    .status-On\ Hold{background:var(--status-onhold);color:#fff}
    .status-Not\ Started\ Yet{background:var(--status-notstarted);color:#fff}
    .status-Sent{background:var(--status-sent);color:#fff}
    .status-On\ Stage{background:var(--status-onstage);color:#fff}

    .priority-High{background:var(--priority-high);color:#fff}
    .priority-Medium{background:var(--priority-medium);color:#fff}
    .priority-Low{background:var(--priority-low);color:#fff}

    .filter-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .filter-chip{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chip);
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      color:var(--muted);
    }
    .filter-chip:hover{
      border-color:var(--accent);
      color:var(--text);
    }

    .risk-bar-wrap{
      width:100%;
      height:6px;
      border-radius:999px;
      background:rgba(148,163,184,.25);
      overflow:hidden;
      margin-top:4px;
    }
    .risk-bar{
      height:100%;
      transform-origin:left center;
      background:linear-gradient(90deg,var(--accent),var(--danger));
    }

    /* Modal */
    .modal{
      display:none;position:fixed;inset:0;
      background:rgba(0,0,0,.58);align-items:center;justify-content:center;z-index:100;
    }
    .modal-content{
      background:var(--card);color:var(--text);
      border:1px solid rgba(148,163,184,.35);
      padding:18px;border-radius:18px;
      max-width:760px;width:92%;max-height:90%;overflow:auto;
      box-shadow:var(--shadow);
    }
    .modal .header{
      display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px;
    }
    .modal .actions{display:flex;gap:8px;flex-wrap:wrap}
    .modal-close{cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:20px}

    /* Pagination */
    .table-actions{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      margin-top:10px;flex-wrap:wrap;
    }
    .pagination{display:flex;gap:6px;align-items:center}
    .chip-btn{
      padding:6px 10px;border-radius:999px;background:rgba(9,14,30,.95);
      border:1px solid(var(--border));cursor:pointer;font-size:12px;
    }
    .chip-btn[disabled]{opacity:.45;cursor:not-allowed}
    .chip-btn.active{background:var(--accent);color:#fff;border-color:transparent}
    .select.sm,.input.sm{padding:6px 8px;border-radius:999px;font-size:13px}

    /* Drawer */
    .drawer-toggle{display:none}
    @media(max-width:980px){
      .drawer-toggle{display:inline-flex}
      .sidebar{
        position:fixed;inset:82px 0 0 auto;width:88%;max-width:360px;
        transform:translateX(110%);transition:transform .25s;
      }
      .sidebar.open{transform:translateX(0)}
    }

    /* Spinner & Toast */
    .spinner{
      display:none;position:fixed;inset:0;
      background:rgba(5,10,25,.65);z-index:120;
      align-items:center;justify-content:center;
    }
    .spinner .ring{
      width:56px;height:56px;border:5px solid var(--border);
      border-top-color:var(--accent);border-radius:50%;
      animation:spin 1s linear infinite;background:transparent;
      box-shadow:0 0 0 1px rgba(15,23,42,.4);
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{
      position:fixed;right:16px;bottom:16px;
      background:var(--card);border:1px solid var(--accent);color:#fff;
      padding:10px 12px;border-radius:12px;z-index:130;
      box-shadow:var(--shadow);display:none;font-size:13px;
    }

    /* Calendar */
    #calendar{margin-top:8px;min-height:520px}
    .fc{font-size:13px}
    .fc .fc-toolbar-title{font-size:16px}
    .fc-theme-standard .fc-scrollgrid,
    .fc-theme-standard td,
    .fc-theme-standard th{border-color:var(--border)}
    .fc .fc-col-header-cell-cushion,
    .fc .fc-daygrid-day-number{color:var(--muted)}
    .fc .fc-daygrid-day.fc-day-today{background:rgba(79,140,255,.09)}
    .fc .fc-button{
      background:rgba(9,14,30,.98);border-color:var(--border);
      color:var(--text);border-radius:999px;padding:4px 10px;font-size:12px;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active,
    .fc .fc-button-primary:not(:disabled):focus,
    .fc .fc-button-primary:not(:disabled):hover{
      background:var(--accent);border-color:var(--accent);
    }
    .fc .fc-toolbar.fc-header-toolbar{margin-bottom:12px}
    .fc-event.event-type-deployment{background-color:var(--info);border-color:var(--info)}
    .fc-event.event-type-maintenance{background-color:var(--warn);border-color:var(--warn)}
    .fc-event.event-type-release{background-color:var(--ok);border-color:var(--ok)}
    .fc-event.event-type-other{background-color:var(--purple);border-color:var(--purple)}

    /* Calendar env & risk signals */
    .fc-event.event-env-prod .fc-event-main{border-left:3px solid var(--ok);}
    .fc-event.event-env-staging .fc-event-main{border-left:3px solid var(--info);}
    .fc-event.event-env-dev .fc-event-main{border-left:3px solid var(--neutral);}
    .fc-event.event-env-other .fc-event-main{border-left:3px solid var(--purple);}
    .fc-event.event-collision .fc-event-main{box-shadow:0 0 0 1px var(--danger) inset;}
    .fc-event.event-freeze .fc-event-main{box-shadow:0 0 0 1px var(--warn) inset;}
    .fc-event.event-hot .fc-event-main{box-shadow:0 0 0 2px var(--danger) inset;}

    .event-risk-badge{
      margin-left:6px;padding:0 6px;border-radius:6px;font-size:10px;
      border:1px solid rgba(255,255,255,.2);
    }
    .risk-low{background:rgba(16,185,129,.18)}
    .risk-med{background:rgba(245,158,11,.2)}
    .risk-high{background:rgba(239,68,68,.22)}
    .risk-crit{background:rgba(239,68,68,.38)}

    /* Hide log col on small screens */
    @media(max-width:768px){
      #issuesTable th:nth-child(7),
      #issuesTable td:nth-child(7){display:none}
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none!important;animation:none!important}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" aria-label="InCheck brand">
      <div class="logo" aria-hidden="true">IC</div>
      <div class="brand-text">
        <span>INCHECK</span>
        <span>Issues ¬∑ Ops ¬∑ Copilot</span>
      </div>
    </div>

    <button id="drawerBtn" class="btn drawer-toggle" aria-expanded="false" aria-controls="sidebar">
      <span class="icon" aria-hidden="true">üß∞</span> Filters
    </button>

    <div class="toolbar">
      <input id="searchInput" class="input" type="search"
             placeholder="Search ID, title, description, log‚Ä¶  ( / to focus )"
             aria-label="Search issues" />

      <select id="themeSelect" class="select" aria-label="Theme">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>

      <input id="accentColor" class="input" type="color" aria-label="Accent color" />

      <button id="refreshNow" class="btn" aria-label="Refresh from source">
        <span class="icon" aria-hidden="true">üîÑ</span> Refresh
      </button>
      <button id="exportCsv" class="btn" aria-label="Export filtered issues as CSV">
        <span class="icon" aria-hidden="true">üì•</span> Export
      </button>
      <button id="createTicketBtn" class="btn primary" aria-label="Create new ticket">
        <span class="icon" aria-hidden="true">‚ûï</span> Create Ticket
      </button>

      <button id="shortcutsHelp" class="btn ghost sm" type="button" title="Keyboard shortcuts">
        <span class="icon" aria-hidden="true">‚å®Ô∏è</span>
      </button>

      <span class="chip online" id="onlineStatusChip" aria-live="polite">Online</span>

      <div class="statusline">
        <span class="chip" id="syncIssuesText">Issues: never</span><span class="dot err" id="syncIssuesDot"></span>
        <span class="chip" id="syncEventsText">Events: never</span><span class="dot err" id="syncEventsDot"></span>
      </div>
    </div>
  </header>

  <div id="loadingStatus" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <div class="wrap">
    <aside class="sidebar" id="sidebar" aria-label="Filters">
      <h3>Filters</h3>
      <div class="filter-group" role="group" aria-label="Field filters">
        <div class="filter-row">
          <label class="muted" for="moduleFilter">Module</label>
          <select id="moduleFilter" class="select" aria-label="Filter by module"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="priorityFilter">Priority</label>
          <select id="priorityFilter" class="select" aria-label="Filter by priority"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="statusFilter">Status</label>
          <select id="statusFilter" class="select" aria-label="Filter by status"></select>
        </div>
      </div>

      <div class="divider" role="separator"></div>

      <div class="filter-group" role="group" aria-label="Date range">
        <div class="filter-row">
          <label class="muted" for="startDateFilter">Start Date</label>
          <input type="date" id="startDateFilter" class="input" aria-label="Start date">
        </div>
        <div class="filter-row">
          <label class="muted" for="endDateFilter">End Date</label>
          <input type="date" id="endDateFilter" class="input" aria-label="End date">
        </div>
      </div>

      <div class="divider" role="separator"></div>

      <div class="filter-group">
        <button id="resetBtn" class="btn ghost" aria-label="Reset all filters">Reset</button>
        <span class="muted">
          Tip: click any KPI to filter by that status. ‚ÄúTotal Issues‚Äù resets everything.
        </span>
      </div>
    </aside>

    <main class="content">
      <div class="view-tabs" role="tablist">
        <button id="issuesTab" class="view-tab active" data-view="issues"
                role="tab" aria-selected="true" aria-controls="issuesView">
          <span class="icon" aria-hidden="true">üìã</span> Issues
        </button>
        <button id="calendarTab" class="view-tab" data-view="calendar"
                role="tab" aria-selected="false" aria-controls="calendarView">
          <span class="icon" aria-hidden="true">üìÖ</span> Calendar
        </button>
        <button id="insightsTab" class="view-tab" data-view="insights"
                role="tab" aria-selected="false" aria-controls="insightsView">
          <span class="icon" aria-hidden="true">ü§ñ</span> AI Insights
        </button>
        <!-- NEW TAB: Change Copilot -->
        <button id="changeTab" class="view-tab" data-view="change"
                role="tab" aria-selected="false" aria-controls="changeView">
          <span class="icon" aria-hidden="true">‚öôÔ∏è</span> Change Copilot
        </button>
      </div>

      <!-- Issues view -->
      <section id="issuesView" class="view active" role="tabpanel" aria-labelledby="issuesTab">
        <div class="card summary-bar" id="issuesSummaryCard">
          <span id="issuesSummaryText" aria-live="polite">Loading summary‚Ä¶</span>
          <span class="shortcut-chip">Shortcuts: 1/2/3/4 tabs ¬∑ / search ¬∑ Ctrl+K AI</span>
        </div>

        <div class="grid cols-4" id="kpis" aria-live="polite"></div>

        <div class="charts" aria-label="Charts">
          <div class="card"><canvas id="byModule" height="140" aria-label="Issues by module" role="img"></canvas></div>
          <div class="card"><canvas id="byPriority" height="140" aria-label="Issues by priority" role="img"></canvas></div>
          <div class="card"><canvas id="byStatus" height="140" aria-label="Issues by status" role="img"></canvas></div>
          <div class="card"><canvas id="byType" height="140" aria-label="Issues by type" role="img"></canvas></div>
        </div>

        <div class="card" aria-label="Issues table">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <strong>Issues</strong>
              <div class="muted">Live feed from InCheck issues sheet.</div>
            </div>
            <span id="rowCount" class="muted" aria-live="polite"></span>
          </div>

          <div id="activeFiltersChips" class="filter-chips" aria-live="polite"></div>

          <div class="table-wrap" role="region" aria-label="Scrollable issues table">
            <table id="issuesTable">
              <thead><tr>
                <th data-key="id" class="sortable" scope="col" aria-sort="none">ID</th>
                <th data-key="module" class="sortable" scope="col" aria-sort="none">Module</th>
                <th data-key="title" class="sortable" scope="col" aria-sort="none">Title</th>
                <th data-key="priority" class="sortable" scope="col" aria-sort="none">Priority</th>
                <th data-key="status" class="sortable" scope="col" aria-sort="none">Status</th>
                <th data-key="date" class="sortable" scope="col" aria-sort="none">Date</th>
                <th data-key="log" class="sortable" scope="col" aria-sort="none">Log</th>
                <th scope="col">Link</th>
              </tr></thead>
              <tbody id="tbodySkeleton">
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton" style="height:16px;border-radius:6px"></div></td></tr>
              </tbody>
              <tbody id="issuesTbody" style="display:none"></tbody>
            </table>
          </div>

          <div class="table-actions">
            <div class="pagination" role="group" aria-label="Table pagination">
              <button id="firstPage" class="chip-btn" aria-label="First page">¬´ First</button>
              <button id="prevPage" class="chip-btn" aria-label="Previous page">‚Äπ Prev</button>
              <span id="pageInfo" class="muted" aria-live="polite"></span>
              <button id="nextPage" class="chip-btn" aria-label="Next page">Next ‚Ä∫</button>
              <button id="lastPage" class="chip-btn" aria-label="Last page">Last ¬ª</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <label for="pageSize" class="muted">Rows</label>
              <select id="pageSize" class="select sm" aria-label="Rows per page">
                <option>10</option><option selected>20</option><option>50</option><option>100</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Calendar view -->
      <section id="calendarView" class="view" role="tabpanel" aria-labelledby="calendarTab">
        <div class="card" aria-label="Calendar">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px">
            <div>
              <strong>Deployments & Maintenance Calendar</strong>
              <div class="muted">
                Plan deployments, maintenance windows, releases, and other operational events.
              </div>
              <div id="calendarTz" class="muted" style="font-size:11px;margin-top:4px;"></div>
              <div id="eventTypeFilters" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                <label class="muted" style="display:flex;align-items:center;gap:4px;font-size:12px">
                  <input type="checkbox" id="eventFilterDeployment" checked /> Deployment
                </label>
                <label class="muted" style="display:flex;align-items:center;gap:4px;font-size:12px">
                  <input type="checkbox" id="eventFilterMaintenance" checked /> Maintenance
                </label>
                <label class="muted" style="display:flex;align-items:center;gap:4px;font-size:12px">
                  <input type="checkbox" id="eventFilterRelease" checked /> Release
                </label>
                <label class="muted" style="display:flex;align-items:center;gap:4px;font-size:12px">
                  <input type="checkbox" id="eventFilterOther" checked /> Other
                </label>
              </div>
            </div>
            <button id="addEventBtn" class="btn primary sm" type="button">
              <span class="icon" aria-hidden="true">‚ûï</span> Add Event
            </button>
          </div>
          <div id="calendar" aria-label="Deployment & maintenance calendar"></div>
        </div>
      </section>

      <!-- AI Insights view -->
      <section id="insightsView" class="view" role="tabpanel" aria-labelledby="insightsTab">
        <div class="card">
          <strong>AI Insights / Copilot</strong>
          <div class="muted" style="margin-top:4px;">
            Heuristic, explainable analytics on issues text (no external AI). Risk breakdown, clustering,
            trends, triage & calendar risk.
          </div>
          <div id="aiAnalyzing" class="skeleton" style="height:6px;border-radius:6px;margin-top:10px;display:none"></div>
        </div>

        <div class="grid cols-4">
          <div class="card">
            <strong>Top terms (recent)</strong>
            <ul id="aiPatternsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Suggested categories</strong>
            <ul id="aiLabelsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Dataset used</strong>
            <div id="aiScopeText" class="muted" style="font-size:13px;margin-top:6px;"></div>
          </div>
          <div class="card">
            <strong>Signals</strong>
            <div id="aiSignalsText" class="muted" style="font-size:13px;margin-top:6px;"></div>
          </div>
        </div>

        <div class="grid cols-4">
          <div class="card">
            <strong>Trends & bursts (last 14 days)</strong>
            <ul id="aiTrendsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Incident-like issues</strong>
            <ul id="aiIncidentsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Emerging vs Stable themes</strong>
            <ul id="aiEmergingStable" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Ops Cockpit</strong>
            <ul id="aiOpsCockpit" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
        </div>

        <div class="card">
          <strong>Per-module risk insights</strong>
          <div class="table-wrap" role="region" aria-label="AI per-module insights" style="max-height:320px;">
            <table id="aiModulesTable">
              <thead>
                <tr><th>Module</th><th>Open</th><th>High P</th><th>Risk sum</th><th>Top term</th></tr>
              </thead>
              <tbody id="aiModulesTableBody">
                <tr><td colspan="5" style="text-align:center;color:var(--muted)">Waiting for data‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <strong>Top risks this week</strong>
          <ul id="aiRisksList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>Similar issue clusters</strong>
          <div id="aiClusters" style="margin-top:6px;display:grid;gap:10px;"></div>
        </div>

        <div class="card">
          <strong>Triage queue (issues needing attention)</strong>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            Missing fields, misaligned priority, ordered by risk. Suggestions are heuristic.
          </div>
          <ul id="aiTriageList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>Upcoming risky events (next 7 days)</strong>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            Combines calendar events with open, high-risk issues in related modules and change collision signals.
          </div>
          <ul id="aiEventsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>AI Commands (pro)</strong>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            Filters: <code>module:</code> <code>status:</code> <code>priority:</code> <code>id:</code> <code>type:</code> <code>missing:</code><br/>
            Risk: <code>risk&gt;=9</code> <code>severity&gt;=3</code> <code>impact&gt;=3</code> <code>urgency&gt;=3</code><br/>
            Time: <code>last:7d</code> <code>age&gt;14d</code> ¬∑ Events: <code>event:next7d</code> <code>event:today</code><br/>
            Sort: <code>sort:risk|date|priority</code><br/>
            Examples: <code>payments risk&gt;8 last:7d sort:risk</code> ¬∑ <code>missing:priority module:billing</code> ¬∑ <code>status:open cluster:timeout</code>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
            <input id="aiQueryInput" class="input" type="text"
                   placeholder="Ask or query‚Ä¶  ( Ctrl + K )"
                   style="flex:1;min-width:260px;">
            <button id="aiQueryRun" class="btn sm" type="button">Run</button>
            <button id="aiQueryApplyFilters" class="btn ghost sm" type="button" title="Apply to Issues tab">Apply to Issues</button>
            <button id="aiQueryExport" class="btn ghost sm" type="button" title="Export query results as CSV">Export CSV</button>
          </div>
          <div id="aiQueryResults" class="muted" style="font-size:13px;margin-top:8px;"></div>
        </div>
      </section>

      <!-- NEW: Change Copilot view -->
      <section id="changeView" class="view" role="tabpanel" aria-labelledby="changeTab">
        <div class="card summary-bar">
          <span id="changeSummaryText" aria-live="polite">
            Loading change signals‚Ä¶
          </span>
          <span class="muted" style="font-size:12px;">
            Combines calendar events, freeze windows and high-risk issues to guide safer changes.
          </span>
        </div>

        <div class="grid cols-4">
          <div class="card">
            <strong>Colliding changes</strong>
            <div class="muted" style="font-size:12px;margin-top:4px;">
              Overlapping changes in the same environment.
            </div>
            <ul id="changeCollisionsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>

          <div class="card">
            <strong>Freeze window breaches</strong>
            <div class="muted" style="font-size:12px;margin-top:4px;">
              Changes scheduled inside configured freeze windows.
            </div>
            <ul id="changeFreezeList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>

          <div class="card">
            <strong>Changes near hot issues</strong>
            <div class="muted" style="font-size:12px;margin-top:4px;">
              Events that are close to high-risk, open issues.
            </div>
            <ul id="changeHotList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>

          <div class="card">
            <strong>Safer deployment days (next 7d)</strong>
            <div class="muted" style="font-size:12px;margin-top:4px;">
              Days with no Prod events currently scheduled.
            </div>
            <ul id="changeWindowsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Issue Modal -->
  <div id="issueModal" class="modal" role="dialog" aria-modal="true"
       aria-labelledby="modalTitle" aria-describedby="modalBody">
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle" style="margin:0;font-size:20px">Issue</h2>
        <div class="actions">
          <button id="copyId" class="btn sm" aria-label="Copy issue ID">
            <span class="icon" aria-hidden="true">üÜî</span> Copy ID
          </button>
          <button id="copyLink" class="btn sm" aria-label="Copy issue link">
            <span class="icon" aria-hidden="true">üîó</span> Copy Link
          </button>
          <button class="modal-close" id="modalClose" aria-label="Close">‚úï</button>
        </div>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Event Modal (extended: env / owner / modules / impact) -->
  <div id="eventModal" class="modal" role="dialog" aria-modal="true"
       aria-labelledby="eventModalTitle" aria-describedby="eventModalBody">
    <div class="modal-content">
      <div class="header">
        <h2 id="eventModalTitle" style="margin:0;font-size:20px">Event</h2>
        <div class="actions">
          <button class="modal-close" id="eventModalClose" aria-label="Close event dialog">‚úï</button>
        </div>
      </div>

      <form id="eventForm">
        <div id="eventModalBody">
          <div class="filter-group">
            <div class="filter-row">
              <label class="muted" for="eventTitle">Title</label>
              <input id="eventTitle" class="input" type="text" required
                     placeholder="e.g. Prod deployment v2.3" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventType">Type</label>
              <select id="eventType" class="select">
                <option value="Deployment">Deployment</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Release">Release</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventEnv">Environment</label>
              <select id="eventEnv" class="select">
                <option value="Prod">Prod</option>
                <option value="Staging">Staging</option>
                <option value="Dev">Dev</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventStatus">Change status</label>
              <select id="eventStatus" class="select">
                <option value="Planned">Planned</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventOwner">Owner</label>
              <input id="eventOwner" class="input" type="text"
                     placeholder="On-call / squad / owner" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventModules">Modules</label>
              <input id="eventModules" class="input" type="text"
                     placeholder="Comma-separated e.g. Payments, Auth" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventImpactType">Impact</label>
              <select id="eventImpactType" class="select">
                <option value="No downtime expected">No downtime expected</option>
                <option value="Customer visible">Customer visible</option>
                <option value="Internal only">Internal only</option>
                <option value="High risk change">High risk change</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventIssueId">Issue ID (optional)</label>
              <input id="eventIssueId" class="input" type="text"
                     placeholder="e.g. INC-123 or ticket ID" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventStart">Start</label>
              <input id="eventStart" class="input" type="datetime-local" required />
            </div>
            <div class="filter-row">
              <label class="muted" style="display:flex;align-items:center;gap:6px;">
                <input type="checkbox" id="eventAllDay" />
                All-day event
              </label>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventEnd">End (optional)</label>
              <input id="eventEnd" class="input" type="datetime-local" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventDescription">Notes</label>
              <textarea id="eventDescription" class="input" rows="3"
                        placeholder="Details, impact, owner‚Ä¶"
                        style="border-radius:12px; resize:vertical;"></textarea>
            </div>
          </div>
          <div id="eventIssueLinkedInfo" class="muted"
               style="margin-top:4px;display:none;font-size:12px;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="eventSave" type="submit" class="btn primary sm">
              üíæ Save Event
            </button>
            <button id="eventCancel" type="button" class="btn ghost sm">
              Cancel
            </button>
          </div>
          <button id="eventDelete" type="button" class="btn sm"
                  style="background:transparent;border-color:var(--danger);color:var(--danger);display:none">
            üóë Delete
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="spinner" id="spinner" aria-hidden="true"><div class="ring"></div></div>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
/**
 * InCheck Pro Dashboard ‚Äî Issues ¬∑ Ops ¬∑ AI Copilot
 * + Change Copilot module
 */

const CONFIG = {
  DATA_VERSION: '2',

  SHEET_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv",
  CALENDAR_API_URL:
    "https://corsproxy.io/?" +
    encodeURIComponent("https://script.google.com/macros/s/AKfycbwRcF-CbJY3dNfU9QQWixGL82a5BqCxVII4sGJSKunJ_fhDLLezL90kUXoqMrHuYytV/exec"),

  TREND_DAYS_RECENT: 7,
  TREND_DAYS_WINDOW: 14,

  RISK: {
    priorityWeight: { High: 3, Medium: 2, Low: 1, "": 1 },
    techBoosts: [
      ['timeout',3],['time out',3],['latency',2],['slow',2],['performance',2],
      ['crash',3],['error',2],['exception',2],['down',3]
    ],
    bizBoosts: [
      ['payment',3],['payments',3],['billing',2],['invoice',1],
      ['checkout',2],['refund',2],['revenue',3],['vip',2]
    ],
    opsBoosts: [
      ['prod ',2],['production',2],['deploy',2],['deployment',2],
      ['rollback',2],['incident',3],['p0',3],['p1',2],['sla',2]
    ],
    statusBoosts: { 'on stage':2, 'under':1 },
    misalignedDelta: 1,
    highRisk: 9,
    critRisk: 13,
    staleDays: 10
  },

  LABEL_KEYWORDS: {
    'Authentication / Login': ['login','signin','sign in','password','auth','token','session','otp'],
    'Payments / Billing': ['payment','payments','billing','invoice','card','credit','charge','checkout','refund'],
    'Performance / Latency': ['slow','slowness','latency','performance','perf','timeout','time out','lag'],
    'Reliability / Errors': ['error','errors','exception','500','503','fail','failed','crash','down','unavailable'],
    'UI / UX': ['button','screen','page','layout','css','ui','ux','alignment','typo'],
    'Data / Sync': ['sync','synchron','cache','cached','replica','replication','consistency','out of date']
  },

  CHANGE: {
    overlapLookbackMinutes: 60,
    hotIssueRecentDays: 7,
    freezeWindows: [
      { dow:[5], startHour:16, endHour:23 }, // Friday evening
      { dow:[6], startHour:0, endHour:23 }   // Saturday
    ]
  }
};

const LS_KEYS = {
  filters: 'incheckFilters',
  theme: 'theme',
  events: 'incheckEvents',
  issues: 'incheckIssues',
  issuesLastUpdated: 'incheckIssuesLastUpdated',
  dataVersion: 'incheckDataVersion',
  pageSize: 'pageSize',
  view: 'incheckView',
  accentColor: 'incheckAccent'
};

const STOPWORDS = new Set([
  'the','a','an','and','or','but','for','with','this','that','from','into','onto','when','what','where','how','why',
  'can','could','should','would','will','just','have','has','had','been','are','is','was','were',
  'to','in','on','of','at','by','as','it','its','be','we','you','they','our','your','their',
  'not','no','if','else','then','than','about','after','before','more','less','also','only','very',
  'get','got','see','seen','use','used','using','user','issue','bug','ticket','inc'
]);

const U = {
  q:(s,r=document)=>r.querySelector(s),
  qAll:(s,r=document)=>Array.from(r.querySelectorAll(s)),
  now:()=>Date.now(),
  fmtTS:(d)=>{
    const x=(d instanceof Date)?d:new Date(d);
    if(isNaN(x)) return '‚Äî';
    return x.toISOString().replace('T',' ').slice(0,16);
  },
  escapeHtml:(s)=> String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])),
  escapeAttr:(s)=> String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;'),
  pad:(n)=>String(n).padStart(2,'0'),
  dateAddDays:(d,days)=>{
    const base=(d instanceof Date)? d : new Date(d);
    return new Date(base.getTime()+days*86400000);
  },
  daysAgo:(n)=> new Date(Date.now()-n*86400000),
  isBetween:(d,a,b)=>{
    const x = (d instanceof Date)? d : new Date(d);
    if(isNaN(x)) return false;
    const min = a ? (a instanceof Date ? a : new Date(a)) : null;
    const max = b ? (b instanceof Date ? b : new Date(b)) : null;
    if(min && x < min) return false;
    if(max && x >= max) return false;
    return true;
  }
};

/** Filters persisted */
const Filters = {
  state: { search:'', module:'All', priority:'All', status:'All', start:'', end:'' },
  load(){
    try{
      const raw=localStorage.getItem(LS_KEYS.filters);
      if(raw) this.state=JSON.parse(raw);
    }catch{}
  },
  save(){
    try{ localStorage.setItem(LS_KEYS.filters, JSON.stringify(this.state)); }catch{}
  }
};

function UndefaultCount(arr){
  const m=new Map();
  arr.forEach(t=> m.set(t,(m.get(t)||0)+1));
  return m;
}

/** DataStore */
const DataStore = {
  rows: [],
  computed: new Map(), // id -> { tokens:Set, tf:Map, idf:Map, risk, suggestions }
  byId: new Map(),
  byModule: new Map(),
  byStatus: new Map(),
  byPriority: new Map(),
  df: new Map(),
  N: 0,
  events: [],
  etag: null,

  normalizeStatus(s){
    const i=(s||'').trim().toLowerCase();
    if(!i) return 'Not Started Yet';
    if(i.startsWith('resolved')) return 'Resolved';
    if(i.startsWith('under')) return 'Under Development';
    if(i.startsWith('rejected')) return 'Rejected';
    if(i.startsWith('on hold')) return 'On Hold';
    if(i.startsWith('not started')) return 'Not Started Yet';
    if(i.startsWith('sent')) return 'Sent';
    if(i.startsWith('on stage')) return 'On Stage';
    return s||'Not Started Yet';
  },
  normalizePriority(p){
    const i=(p||'').trim().toLowerCase();
    if(!i) return '';
    if(i.startsWith('h')) return 'High';
    if(i.startsWith('m')) return 'Medium';
    if(i.startsWith('l')) return 'Low';
    return p;
  },
  normalizeRow(raw){
    const lower={};
    for(const k in raw){ if(!k) continue; lower[k.toLowerCase().replace(/\s+/g,' ').trim()]=String(raw[k]??'').trim(); }
    const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
    return {
      id: pick('ticket id','id'),
      module: (pick('impacted module','module','issue location')||'Unspecified'),
      title: pick('title'),
      desc: pick('description'),
      file: pick('file upload','link','url'),
      priority: DataStore.normalizePriority(pick('priority')),
      status: DataStore.normalizeStatus(pick('status') || 'Not Started Yet'),
      type: pick('category','type'),
      date: pick('timestamp','date','created at'),
      log: pick('log','logs','comment','notes')
    };
  },
  tokenize(issue){
    const text = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase();
    return text.replace(/[^a-z0-9]+/g,' ')
      .split(/\s+/)
      .filter(w=>w && w.length>2 && !STOPWORDS.has(w));
  },
  hydrate(csvText){
    const parsed = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data
      .map(DataStore.normalizeRow)
      .filter(r=>r.id && r.id.trim()!=="");
    this.hydrateFromRows(parsed);
  },
  hydrateFromRows(parsed){
    this.rows = parsed || [];
    this.byId.clear(); this.byModule.clear(); this.byStatus.clear(); this.byPriority.clear();
    this.computed.clear(); this.df.clear(); this.N = this.rows.length;

    this.rows.forEach(r=>{
      this.byId.set(r.id,r);
      if(!this.byModule.has(r.module)) this.byModule.set(r.module,[]);
      this.byModule.get(r.module).push(r);
      if(!this.byStatus.has(r.status)) this.byStatus.set(r.status,[]);
      this.byStatus.get(r.status).push(r);
      if(!this.byPriority.has(r.priority)) this.byPriority.set(r.priority,[]);
      this.byPriority.get(r.priority).push(r);

      const toks = DataStore.tokenize(r);
      const uniq = new Set(toks);
      uniq.forEach(t=> this.df.set(t,(this.df.get(t)||0)+1));
      this.computed.set(r.id,{ tokens:new Set(toks), tf:UndefaultCount(toks) });
    });

    const idf = new Map();
    this.df.forEach((df,term)=> idf.set(term, Math.log((this.N+1)/(df+1))+1));
    this.computed.forEach(meta=> meta.idf = idf);

    // risk & suggestions
    this.rows.forEach(r=>{
      const risk = Risk.computeRisk(r);
      const categories = Risk.suggestCategories(r);
      const sPrio = Risk.suggestPriority(r, risk.total);
      const reasons = Risk.explainRisk(r);
      const meta = this.computed.get(r.id);
      meta.risk = {...risk,reasons};
      meta.suggestions = { priority:sPrio, categories };
    });
  }
};

const IssuesCache = {
  load(){
    try{
      const storedVersion = localStorage.getItem(LS_KEYS.dataVersion);
      if(storedVersion && storedVersion !== CONFIG.DATA_VERSION) return null;
      const raw = localStorage.getItem(LS_KEYS.issues);
      if(!raw) return null;
      const data = JSON.parse(raw);
      return Array.isArray(data)? data : null;
    }catch{return null;}
  },
  save(rows){
    try{
      localStorage.setItem(LS_KEYS.issues, JSON.stringify(rows||[]));
      localStorage.setItem(LS_KEYS.issuesLastUpdated, new Date().toISOString());
      localStorage.setItem(LS_KEYS.dataVersion, CONFIG.DATA_VERSION);
    }catch{}
  },
  lastLabel(){
    const iso = localStorage.getItem(LS_KEYS.issuesLastUpdated);
    if(!iso) return '';
    const d = new Date(iso);
    if(isNaN(d)) return '';
    return `Last updated: ${d.toLocaleString()}`;
  }
};

function prioMap(p){ return {High:3,Medium:2,Low:1}[p]||0; }
function prioGap(suggested,current){ return prioMap(suggested)-prioMap(current); }

/** Risk engine (with severity / impact / urgency) */
const Risk = {
  scoreFromBoosts(text,rules){
    let s=0; for(const [kw,val] of rules){ if (text.includes(kw)) s+=val; } return s;
  },
  computeRisk(issue){
    const txt = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase()+' ';
    const basePriority = CONFIG.RISK.priorityWeight[issue.priority||""] || 1;

    const tech = basePriority + this.scoreFromBoosts(txt, CONFIG.RISK.techBoosts);
    const biz  = this.scoreFromBoosts(txt, CONFIG.RISK.bizBoosts);
    const ops  = this.scoreFromBoosts(txt, CONFIG.RISK.opsBoosts);

    let total = tech+biz+ops;

    const st=(issue.status||'').toLowerCase();
    for(const k in CONFIG.RISK.statusBoosts){
      if(st.startsWith(k)) total+=CONFIG.RISK.statusBoosts[k];
    }

    let timeRisk = 0;
    let ageDays = null;
    let isOpen = !(st.startsWith('resolved')||st.startsWith('rejected'));

    if(issue.date){
      const d = new Date(issue.date);
      if(!isNaN(d)){
        ageDays = (Date.now() - d.getTime()) / 86400000;
        if(isOpen && total >= CONFIG.RISK.highRisk){
          if(ageDays <= 14) timeRisk += 2;      // fresh risky
          if(ageDays >= 30) timeRisk += 3;      // stale high-risk
        }
      }
    }
    total += timeRisk;

    // severity: how bad is the scenario
    let severity = basePriority;
    if(/p0|sev0|outage|down|data loss|breach|security/i.test(txt)) severity += 3;
    if(/p1|sev1|incident|sla/i.test(txt)) severity += 2;
    if(/p2|degraded/i.test(txt)) severity += 1;

    // impact: how much money / users
    let impact = 1;
    if(/payment|billing|checkout|revenue|invoice|subscription|signup|onboarding/i.test(txt)) impact += 2;
    if(/login|auth|authentication|token|session/i.test(txt)) impact += 1.5;
    if(/admin|internal|report/i.test(txt)) impact += 0.5;

    // urgency: time sensitivity
    let urgency = 1;
    if(/today|now|immediately|urgent|sla/i.test(txt)) urgency += 1.5;
    if(ageDays!=null){
      if(ageDays <= 1) urgency += 1;
      if(ageDays >= 14 && isOpen) urgency += 0.5;
    }

    const sevScore = Math.round(severity);
    const impScore = Math.round(impact*1.5);
    const urgScore = Math.round(urgency*1.5);

    total += sevScore + impScore + urgScore;

    return {
      technical:tech,
      business:biz,
      operational:ops,
      time:timeRisk,
      total,
      severity:sevScore,
      impact:impScore,
      urgency:urgScore
    };
  },
  suggestCategories(issue){
    const text = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase();
    const res=[];
    Object.entries(CONFIG.LABEL_KEYWORDS).forEach(([label,kws])=>{
      let hits=0; kws.forEach(k=>{ if(text.includes(k)) hits++; });
      if(hits) res.push({label,score:hits});
    });
    res.sort((a,b)=>b.score-a.score);
    return res;
  },
  suggestPriority(issue,totalRisk){
    if (issue.priority) return issue.priority;
    const s = totalRisk!=null? totalRisk : this.computeRisk(issue).total;
    if (s>=CONFIG.RISK.highRisk) return 'High';
    if (s>=6) return 'Medium';
    return 'Low';
  },
  explainRisk(issue){
    const txt = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase()+' ';
    const picks=[];
    const push=(kw)=>{ if(txt.includes(kw)) picks.push(kw); };
    [...CONFIG.RISK.techBoosts,...CONFIG.RISK.bizBoosts,...CONFIG.RISK.opsBoosts].forEach(([kw])=>push(kw));
    if ((issue.status||'').toLowerCase().startsWith('on stage')) picks.push('on stage');
    if ((issue.status||'').toLowerCase().startsWith('under')) picks.push('under development');

    if(issue.date){
      const d = new Date(issue.date);
      if(!isNaN(d)){
        const ageDays = (Date.now() - d.getTime()) / 86400000;
        if(ageDays <= 14) picks.push('recent');
        else if(ageDays >= 30) picks.push('stale');
      }
    }

    return Array.from(new Set(picks)).slice(0,6);
  }
};

/** Command DSL parser */
const DSL = {
  parse(text){
    const lower=(text||'').toLowerCase();
    let w=' '+lower+' ';
    const out={
      module:null,status:null,priority:null,id:null,type:null,missing:null,
      riskOp:null,riskVal:null,
      severityOp:null,severityVal:null,
      impactOp:null,impactVal:null,
      urgencyOp:null,urgencyVal:null,
      ageOp:null,ageVal:null,
      lastDays:null,cluster:null,sort:null,
      eventScope:null,
      words:[]
    };
    const eat=(re,key,fn=v=>v)=>{
      const m=w.match(re); if(m){ out[key]=fn(m[1].trim()); w=w.replace(m[0],' '); }
    };
    eat(/\bmodule:([^\s]+)/,'module');
    eat(/\bstatus:([^\s]+)/,'status');
    eat(/\bpriority:([^\s]+)/,'priority');
    eat(/\bid:([^\s]+)/,'id');
    eat(/\btype:([^\s]+)/,'type');
    eat(/\bmissing:([^\s]+)/,'missing');

    const rv=lower.match(/\brisk([><=]{1,2})(\d+)/);
    if(rv){ out.riskOp=rv[1]; out.riskVal=+rv[2]; w=w.replace(rv[0],' '); }

    const sv=lower.match(/\bseverity([><=]{1,2})(\d+)/);
    if(sv){ out.severityOp=sv[1]; out.severityVal=+sv[2]; w=w.replace(sv[0],' '); }
    const iv=lower.match(/\bimpact([><=]{1,2})(\d+)/);
    if(iv){ out.impactOp=iv[1]; out.impactVal=+iv[2]; w=w.replace(iv[0],' '); }
    const uv=lower.match(/\burgency([><=]{1,2})(\d+)/);
    if(uv){ out.urgencyOp=uv[1]; out.urgencyVal=+uv[2]; w=w.replace(uv[0],' '); }

    eat(/\blast:(\d+)d/,'lastDays',n=>+n);
    const av=lower.match(/\bage([><=]{1,2})(\d+)d/);
    if(av){ out.ageOp=av[1]; out.ageVal=+av[2]; w=w.replace(av[0],' '); }

    eat(/\bcluster:([^\s]+)/,'cluster');
    eat(/\bsort:(risk|date|priority)/,'sort');
    eat(/\bevent:(\S+)/,'eventScope');

    out.words = w.split(/\s+/).filter(Boolean).filter(t=>t.length>2 && !STOPWORDS.has(t));
    return out;
  },
  matches(issue,meta,q){
    if (q.module && !(issue.module||'').toLowerCase().includes(q.module)) return false;
    if (q.priority){
      const p=q.priority[0].toUpperCase();
      if(['H','M','L'].includes(p)){ if((issue.priority||'')[0]!==p) return false; }
      else if(!(issue.priority||'').toLowerCase().includes(q.priority)) return false;
    }
    if (q.status){
      const st=(issue.status||'').toLowerCase();
      if(q.status==='open'){
        const closed = st.startsWith('resolved')||st.startsWith('rejected');
        if(closed) return false;
      }else if(q.status==='closed'){
        const closed = st.startsWith('resolved')||st.startsWith('rejected');
        if(!closed) return false;
      }else if(!st.includes(q.status)) return false;
    }
    if (q.id && !((issue.id||'').toLowerCase().includes(q.id))) return false;
    if (q.type && !((issue.type||'').toLowerCase().includes(q.type))) return false;
    if (q.missing){
      const m=q.missing;
      if(m==='priority' && issue.priority) return false;
      if(m==='module' && issue.module && issue.module!=='Unspecified') return false;
      if(m==='type' && issue.type) return false;
    }
    if (q.lastDays){
      const after=U.daysAgo(q.lastDays);
      if(!U.isBetween(issue.date,after,null)) return false;
    }
    if (q.ageOp && q.ageVal!=null){
      if(!issue.date) return false;
      const d=new Date(issue.date); if(isNaN(d)) return false;
      const ageDays=(Date.now()-d.getTime())/86400000;
      const op=q.ageOp, b=q.ageVal;
      let pass=false;
      if(op==='>') pass=ageDays>b;
      else if(op==='>=') pass=ageDays>=b;
      else if(op==='<') pass=ageDays<b;
      else if(op==='<=') pass=ageDays<=b;
      else if(op==='='||op==='==') pass=Math.round(ageDays)===b;
      if(!pass) return false;
    }
    if (q.cluster){
      const t=q.cluster.toLowerCase();
      if(!meta.tokens || !Array.from(meta.tokens).some(x=>x.includes(t))) return false;
    }
    const risk = meta.risk || {};
    if (q.riskOp){
      const rv=risk.total||0;
      const op=q.riskOp, b=q.riskVal;
      let pass=false;
      if(op==='>') pass=rv>b;
      else if(op==='>=') pass=rv>=b;
      else if(op==='<') pass=rv<b;
      else if(op==='<=') pass=rv<=b;
      else if(op==='='||op==='==') pass=rv===b;
      if(!pass) return false;
    }
    const cmpNum = (val,op,b)=>{
      const v=val||0;
      if(op==='>') return v>b;
      if(op==='>=') return v>=b;
      if(op==='<') return v<b;
      if(op==='<=') return v<=b;
      if(op==='='||op==='==') return v===b;
      return true;
    };
    if(q.severityOp && !cmpNum(risk.severity,q.severityOp,q.severityVal)) return false;
    if(q.impactOp && !cmpNum(risk.impact,q.impactOp,q.impactVal)) return false;
    if(q.urgencyOp && !cmpNum(risk.urgency,q.urgencyOp,q.urgencyVal)) return false;

    if (q.words && q.words.length){
      const txt=[issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase();
      for(const w of q.words){ if(!txt.includes(w)) return false; }
    }
    return true;
  }
};
/**
 * InCheck Pro Dashboard ‚Äî Issues ¬∑ Ops ¬∑ AI Copilot
 * + Change Copilot module
 */

const CONFIG = {
  DATA_VERSION: '2',

  SHEET_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv",
  CALENDAR_API_URL:
    "https://corsproxy.io/?" +
    encodeURIComponent("https://script.google.com/macros/s/AKfycbwRcF-CbJY3dNfU9QQWixGL82a5BqCxVII4sGJSKunJ_fhDLLezL90kUXoqMrHuYytV/exec"),

  TREND_DAYS_RECENT: 7,
  TREND_DAYS_WINDOW: 14,

  RISK: {
    priorityWeight: { High: 3, Medium: 2, Low: 1, "": 1 },
    techBoosts: [
      ['timeout',3],['time out',3],['latency',2],['slow',2],['performance',2],
      ['crash',3],['error',2],['exception',2],['down',3]
    ],
    bizBoosts: [
      ['payment',3],['payments',3],['billing',2],['invoice',1],
      ['checkout',2],['refund',2],['revenue',3],['vip',2]
    ],
    opsBoosts: [
      ['prod ',2],['production',2],['deploy',2],['deployment',2],
      ['rollback',2],['incident',3],['p0',3],['p1',2],['sla',2]
    ],
    statusBoosts: { 'on stage':2, 'under':1 },
    misalignedDelta: 1,
    highRisk: 9,
    critRisk: 13,
    staleDays: 10
  },

  LABEL_KEYWORDS: {
    'Authentication / Login': ['login','signin','sign in','password','auth','token','session','otp'],
    'Payments / Billing': ['payment','payments','billing','invoice','card','credit','charge','checkout','refund'],
    'Performance / Latency': ['slow','slowness','latency','performance','perf','timeout','time out','lag'],
    'Reliability / Errors': ['error','errors','exception','500','503','fail','failed','crash','down','unavailable'],
    'UI / UX': ['button','screen','page','layout','css','ui','ux','alignment','typo'],
    'Data / Sync': ['sync','synchron','cache','cached','replica','replication','consistency','out of date']
  },

  CHANGE: {
    overlapLookbackMinutes: 60,
    hotIssueRecentDays: 7,
    freezeWindows: [
      { dow:[5], startHour:16, endHour:23 }, // Friday evening
      { dow:[6], startHour:0, endHour:23 }   // Saturday
    ]
  }
};

const LS_KEYS = {
  filters: 'incheckFilters',
  theme: 'theme',
  events: 'incheckEvents',
  issues: 'incheckIssues',
  issuesLastUpdated: 'incheckIssuesLastUpdated',
  dataVersion: 'incheckDataVersion',
  pageSize: 'pageSize',
  view: 'incheckView',
  accentColor: 'incheckAccent'
};

const STOPWORDS = new Set([
  'the','a','an','and','or','but','for','with','this','that','from','into','onto','when','what','where','how','why',
  'can','could','should','would','will','just','have','has','had','been','are','is','was','were',
  'to','in','on','of','at','by','as','it','its','be','we','you','they','our','your','their',
  'not','no','if','else','then','than','about','after','before','more','less','also','only','very',
  'get','got','see','seen','use','used','using','user','issue','bug','ticket','inc'
]);

const U = {
  q:(s,r=document)=>r.querySelector(s),
  qAll:(s,r=document)=>Array.from(r.querySelectorAll(s)),
  now:()=>Date.now(),
  fmtTS:(d)=>{
    const x=(d instanceof Date)?d:new Date(d);
    if(isNaN(x)) return '‚Äî';
    return x.toISOString().replace('T',' ').slice(0,16);
  },
  escapeHtml:(s)=> String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])),
  escapeAttr:(s)=> String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;'),
  pad:(n)=>String(n).padStart(2,'0'),
  dateAddDays:(d,days)=>{
    const base=(d instanceof Date)? d : new Date(d);
    return new Date(base.getTime()+days*86400000);
  },
  daysAgo:(n)=> new Date(Date.now()-n*86400000),
  isBetween:(d,a,b)=>{
    const x = (d instanceof Date)? d : new Date(d);
    if(isNaN(x)) return false;
    const min = a ? (a instanceof Date ? a : new Date(a)) : null;
    const max = b ? (b instanceof Date ? b : new Date(b)) : null;
    if(min && x < min) return false;
    if(max && x >= max) return false;
    return true;
  }
};

/** Filters persisted */
const Filters = {
  state: { search:'', module:'All', priority:'All', status:'All', start:'', end:'' },
  load(){
    try{
      const raw=localStorage.getItem(LS_KEYS.filters);
      if(raw) this.state=JSON.parse(raw);
    }catch{}
  },
  save(){
    try{ localStorage.setItem(LS_KEYS.filters, JSON.stringify(this.state)); }catch{}
  }
};

function UndefaultCount(arr){
  const m=new Map();
  arr.forEach(t=> m.set(t,(m.get(t)||0)+1));
  return m;
}

/** DataStore */
const DataStore = {
  rows: [],
  computed: new Map(), // id -> { tokens:Set, tf:Map, idf:Map, risk, suggestions }
  byId: new Map(),
  byModule: new Map(),
  byStatus: new Map(),
  byPriority: new Map(),
  df: new Map(),
  N: 0,
  events: [],
  etag: null,

  normalizeStatus(s){
    const i=(s||'').trim().toLowerCase();
    if(!i) return 'Not Started Yet';
    if(i.startsWith('resolved')) return 'Resolved';
    if(i.startsWith('under')) return 'Under Development';
    if(i.startsWith('rejected')) return 'Rejected';
    if(i.startsWith('on hold')) return 'On Hold';
    if(i.startsWith('not started')) return 'Not Started Yet';
    if(i.startsWith('sent')) return 'Sent';
    if(i.startsWith('on stage')) return 'On Stage';
    return s||'Not Started Yet';
  },
  normalizePriority(p){
    const i=(p||'').trim().toLowerCase();
    if(!i) return '';
    if(i.startsWith('h')) return 'High';
    if(i.startsWith('m')) return 'Medium';
    if(i.startsWith('l')) return 'Low';
    return p;
  },
  normalizeRow(raw){
    const lower={};
    for(const k in raw){ if(!k) continue; lower[k.toLowerCase().replace(/\s+/g,' ').trim()]=String(raw[k]??'').trim(); }
    const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
    return {
      id: pick('ticket id','id'),
      module: (pick('impacted module','module','issue location')||'Unspecified'),
      title: pick('title'),
      desc: pick('description'),
      file: pick('file upload','link','url'),
      priority: DataStore.normalizePriority(pick('priority')),
      status: DataStore.normalizeStatus(pick('status') || 'Not Started Yet'),
      type: pick('category','type'),
      date: pick('timestamp','date','created at'),
      log: pick('log','logs','comment','notes')
    };
  },
  tokenize(issue){
    const text = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase();
    return text.replace(/[^a-z0-9]+/g,' ')
      .split(/\s+/)
      .filter(w=>w && w.length>2 && !STOPWORDS.has(w));
  },
  hydrate(csvText){
    const parsed = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data
      .map(DataStore.normalizeRow)
      .filter(r=>r.id && r.id.trim()!=="");
    this.hydrateFromRows(parsed);
  },
  hydrateFromRows(parsed){
    this.rows = parsed || [];
    this.byId.clear(); this.byModule.clear(); this.byStatus.clear(); this.byPriority.clear();
    this.computed.clear(); this.df.clear(); this.N = this.rows.length;

    this.rows.forEach(r=>{
      this.byId.set(r.id,r);
      if(!this.byModule.has(r.module)) this.byModule.set(r.module,[]);
      this.byModule.get(r.module).push(r);
      if(!this.byStatus.has(r.status)) this.byStatus.set(r.status,[]);
      this.byStatus.get(r.status).push(r);
      if(!this.byPriority.has(r.priority)) this.byPriority.set(r.priority,[]);
      this.byPriority.get(r.priority).push(r);

      const toks = DataStore.tokenize(r);
      const uniq = new Set(toks);
      uniq.forEach(t=> this.df.set(t,(this.df.get(t)||0)+1));
      this.computed.set(r.id,{ tokens:new Set(toks), tf:UndefaultCount(toks) });
    });

    const idf = new Map();
    this.df.forEach((df,term)=> idf.set(term, Math.log((this.N+1)/(df+1))+1));
    this.computed.forEach(meta=> meta.idf = idf);

    // risk & suggestions
    this.rows.forEach(r=>{
      const risk = Risk.computeRisk(r);
      const categories = Risk.suggestCategories(r);
      const sPrio = Risk.suggestPriority(r, risk.total);
      const reasons = Risk.explainRisk(r);
      const meta = this.computed.get(r.id);
      meta.risk = {...risk,reasons};
      meta.suggestions = { priority:sPrio, categories };
    });
  }
};

const IssuesCache = {
  load(){
    try{
      const storedVersion = localStorage.getItem(LS_KEYS.dataVersion);
      if(storedVersion && storedVersion !== CONFIG.DATA_VERSION) return null;
      const raw = localStorage.getItem(LS_KEYS.issues);
      if(!raw) return null;
      const data = JSON.parse(raw);
      return Array.isArray(data)? data : null;
    }catch{return null;}
  },
  save(rows){
    try{
      localStorage.setItem(LS_KEYS.issues, JSON.stringify(rows||[]));
      localStorage.setItem(LS_KEYS.issuesLastUpdated, new Date().toISOString());
      localStorage.setItem(LS_KEYS.dataVersion, CONFIG.DATA_VERSION);
    }catch{}
  },
  lastLabel(){
    const iso = localStorage.getItem(LS_KEYS.issuesLastUpdated);
    if(!iso) return '';
    const d = new Date(iso);
    if(isNaN(d)) return '';
    return `Last updated: ${d.toLocaleString()}`;
  }
};

function prioMap(p){ return {High:3,Medium:2,Low:1}[p]||0; }
function prioGap(suggested,current){ return prioMap(suggested)-prioMap(current); }

/** Risk engine (with severity / impact / urgency) */
const Risk = {
  scoreFromBoosts(text,rules){
    let s=0; for(const [kw,val] of rules){ if (text.includes(kw)) s+=val; } return s;
  },
  computeRisk(issue){
    const txt = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase()+' ';
    const basePriority = CONFIG.RISK.priorityWeight[issue.priority||""] || 1;

    const tech = basePriority + this.scoreFromBoosts(txt, CONFIG.RISK.techBoosts);
    const biz  = this.scoreFromBoosts(txt, CONFIG.RISK.bizBoosts);
    const ops  = this.scoreFromBoosts(txt, CONFIG.RISK.opsBoosts);

    let total = tech+biz+ops;

    const st=(issue.status||'').toLowerCase();
    for(const k in CONFIG.RISK.statusBoosts){
      if(st.startsWith(k)) total+=CONFIG.RISK.statusBoosts[k];
    }

    let timeRisk = 0;
    let ageDays = null;
    let isOpen = !(st.startsWith('resolved')||st.startsWith('rejected'));

    if(issue.date){
      const d = new Date(issue.date);
      if(!isNaN(d)){
        ageDays = (Date.now() - d.getTime()) / 86400000;
        if(isOpen && total >= CONFIG.RISK.highRisk){
          if(ageDays <= 14) timeRisk += 2;      // fresh risky
          if(ageDays >= 30) timeRisk += 3;      // stale high-risk
        }
      }
    }
    total += timeRisk;

    // severity: how bad is the scenario
    let severity = basePriority;
    if(/p0|sev0|outage|down|data loss|breach|security/i.test(txt)) severity += 3;
    if(/p1|sev1|incident|sla/i.test(txt)) severity += 2;
    if(/p2|degraded/i.test(txt)) severity += 1;

    // impact: how much money / users
    let impact = 1;
    if(/payment|billing|checkout|revenue|invoice|subscription|signup|onboarding/i.test(txt)) impact += 2;
    if(/login|auth|authentication|token|session/i.test(txt)) impact += 1.5;
    if(/admin|internal|report/i.test(txt)) impact += 0.5;

    // urgency: time sensitivity
    let urgency = 1;
    if(/today|now|immediately|urgent|sla/i.test(txt)) urgency += 1.5;
    if(ageDays!=null){
      if(ageDays <= 1) urgency += 1;
      if(ageDays >= 14 && isOpen) urgency += 0.5;
    }

    const sevScore = Math.round(severity);
    const impScore = Math.round(impact*1.5);
    const urgScore = Math.round(urgency*1.5);

    total += sevScore + impScore + urgScore;

    return {
      technical:tech,
      business:biz,
      operational:ops,
      time:timeRisk,
      total,
      severity:sevScore,
      impact:impScore,
      urgency:urgScore
    };
  },
  suggestCategories(issue){
    const text = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase();
    const res=[];
    Object.entries(CONFIG.LABEL_KEYWORDS).forEach(([label,kws])=>{
      let hits=0; kws.forEach(k=>{ if(text.includes(k)) hits++; });
      if(hits) res.push({label,score:hits});
    });
    res.sort((a,b)=>b.score-a.score);
    return res;
  },
  suggestPriority(issue,totalRisk){
    if (issue.priority) return issue.priority;
    const s = totalRisk!=null? totalRisk : this.computeRisk(issue).total;
    if (s>=CONFIG.RISK.highRisk) return 'High';
    if (s>=6) return 'Medium';
    return 'Low';
  },
  explainRisk(issue){
    const txt = [issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase()+' ';
    const picks=[];
    const push=(kw)=>{ if(txt.includes(kw)) picks.push(kw); };
    [...CONFIG.RISK.techBoosts,...CONFIG.RISK.bizBoosts,...CONFIG.RISK.opsBoosts].forEach(([kw])=>push(kw));
    if ((issue.status||'').toLowerCase().startsWith('on stage')) picks.push('on stage');
    if ((issue.status||'').toLowerCase().startsWith('under')) picks.push('under development');

    if(issue.date){
      const d = new Date(issue.date);
      if(!isNaN(d)){
        const ageDays = (Date.now() - d.getTime()) / 86400000;
        if(ageDays <= 14) picks.push('recent');
        else if(ageDays >= 30) picks.push('stale');
      }
    }

    return Array.from(new Set(picks)).slice(0,6);
  }
};

/** Command DSL parser */
const DSL = {
  parse(text){
    const lower=(text||'').toLowerCase();
    let w=' '+lower+' ';
    const out={
      module:null,status:null,priority:null,id:null,type:null,missing:null,
      riskOp:null,riskVal:null,
      severityOp:null,severityVal:null,
      impactOp:null,impactVal:null,
      urgencyOp:null,urgencyVal:null,
      ageOp:null,ageVal:null,
      lastDays:null,cluster:null,sort:null,
      eventScope:null,
      words:[]
    };
    const eat=(re,key,fn=v=>v)=>{
      const m=w.match(re); if(m){ out[key]=fn(m[1].trim()); w=w.replace(m[0],' '); }
    };
    eat(/\bmodule:([^\s]+)/,'module');
    eat(/\bstatus:([^\s]+)/,'status');
    eat(/\bpriority:([^\s]+)/,'priority');
    eat(/\bid:([^\s]+)/,'id');
    eat(/\btype:([^\s]+)/,'type');
    eat(/\bmissing:([^\s]+)/,'missing');

    const rv=lower.match(/\brisk([><=]{1,2})(\d+)/);
    if(rv){ out.riskOp=rv[1]; out.riskVal=+rv[2]; w=w.replace(rv[0],' '); }

    const sv=lower.match(/\bseverity([><=]{1,2})(\d+)/);
    if(sv){ out.severityOp=sv[1]; out.severityVal=+sv[2]; w=w.replace(sv[0],' '); }
    const iv=lower.match(/\bimpact([><=]{1,2})(\d+)/);
    if(iv){ out.impactOp=iv[1]; out.impactVal=+iv[2]; w=w.replace(iv[0],' '); }
    const uv=lower.match(/\burgency([><=]{1,2})(\d+)/);
    if(uv){ out.urgencyOp=uv[1]; out.urgencyVal=+uv[2]; w=w.replace(uv[0],' '); }

    eat(/\blast:(\d+)d/,'lastDays',n=>+n);
    const av=lower.match(/\bage([><=]{1,2})(\d+)d/);
    if(av){ out.ageOp=av[1]; out.ageVal=+av[2]; w=w.replace(av[0],' '); }

    eat(/\bcluster:([^\s]+)/,'cluster');
    eat(/\bsort:(risk|date|priority)/,'sort');
    eat(/\bevent:(\S+)/,'eventScope');

    out.words = w.split(/\s+/).filter(Boolean).filter(t=>t.length>2 && !STOPWORDS.has(t));
    return out;
  },
  matches(issue,meta,q){
    if (q.module && !(issue.module||'').toLowerCase().includes(q.module)) return false;
    if (q.priority){
      const p=q.priority[0].toUpperCase();
      if(['H','M','L'].includes(p)){ if((issue.priority||'')[0]!==p) return false; }
      else if(!(issue.priority||'').toLowerCase().includes(q.priority)) return false;
    }
    if (q.status){
      const st=(issue.status||'').toLowerCase();
      if(q.status==='open'){
        const closed = st.startsWith('resolved')||st.startsWith('rejected');
        if(closed) return false;
      }else if(q.status==='closed'){
        const closed = st.startsWith('resolved')||st.startsWith('rejected');
        if(!closed) return false;
      }else if(!st.includes(q.status)) return false;
    }
    if (q.id && !((issue.id||'').toLowerCase().includes(q.id))) return false;
    if (q.type && !((issue.type||'').toLowerCase().includes(q.type))) return false;
    if (q.missing){
      const m=q.missing;
      if(m==='priority' && issue.priority) return false;
      if(m==='module' && issue.module && issue.module!=='Unspecified') return false;
      if(m==='type' && issue.type) return false;
    }
    if (q.lastDays){
      const after=U.daysAgo(q.lastDays);
      if(!U.isBetween(issue.date,after,null)) return false;
    }
    if (q.ageOp && q.ageVal!=null){
      if(!issue.date) return false;
      const d=new Date(issue.date); if(isNaN(d)) return false;
      const ageDays=(Date.now()-d.getTime())/86400000;
      const op=q.ageOp, b=q.ageVal;
      let pass=false;
      if(op==='>') pass=ageDays>b;
      else if(op==='>=') pass=ageDays>=b;
      else if(op==='<') pass=ageDays<b;
      else if(op==='<=') pass=ageDays<=b;
      else if(op==='='||op==='==') pass=Math.round(ageDays)===b;
      if(!pass) return false;
    }
    if (q.cluster){
      const t=q.cluster.toLowerCase();
      if(!meta.tokens || !Array.from(meta.tokens).some(x=>x.includes(t))) return false;
    }
    const risk = meta.risk || {};
    if (q.riskOp){
      const rv=risk.total||0;
      const op=q.riskOp, b=q.riskVal;
      let pass=false;
      if(op==='>') pass=rv>b;
      else if(op==='>=') pass=rv>=b;
      else if(op==='<') pass=rv<b;
      else if(op==='<=') pass=rv<=b;
      else if(op==='='||op==='==') pass=rv===b;
      if(!pass) return false;
    }
    const cmpNum = (val,op,b)=>{
      const v=val||0;
      if(op==='>') return v>b;
      if(op==='>=') return v>=b;
      if(op==='<') return v<b;
      if(op==='<=') return v<=b;
      if(op==='='||op==='==') return v===b;
      return true;
    };
    if(q.severityOp && !cmpNum(risk.severity,q.severityOp,q.severityVal)) return false;
    if(q.impactOp && !cmpNum(risk.impact,q.impactOp,q.impactVal)) return false;
    if(q.urgencyOp && !cmpNum(risk.urgency,q.urgencyOp,q.urgencyVal)) return false;

    if (q.words && q.words.length){
      const txt=[issue.title,issue.desc,issue.log].filter(Boolean).join(' ').toLowerCase();
      for(const w of q.words){ if(!txt.includes(w)) return false; }
    }
    return true;
  }
};
    if(E.eventAllDay){
      E.eventAllDay.addEventListener('change', () => {
        const isAllDay = E.eventAllDay.checked;
        const startVal = E.eventStart ? E.eventStart.value : '';
        const endVal   = E.eventEnd ? E.eventEnd.value   : '';

        if (isAllDay) {
          if (E.eventStart) {
            E.eventStart.type = 'date';
            if (startVal.includes('T')) E.eventStart.value = startVal.split('T')[0];
          }
          if (E.eventEnd) {
            E.eventEnd.type = 'date';
            if (endVal.includes('T')) E.eventEnd.value = endVal.split('T')[0];
          }
        } else {
          if (E.eventStart) {
            E.eventStart.type = 'datetime-local';
            if (startVal && !startVal.includes('T')) E.eventStart.value = startVal + 'T09:00';
          }
          if (E.eventEnd) {
            E.eventEnd.type = 'datetime-local';
            if (endVal && !endVal.includes('T')) E.eventEnd.value = endVal + 'T10:00';
          }
        }
      });
    }
  }
}

/* ---------- Calendar wiring ---------- */
let calendar = null;
let calendarReady = false;

function wireCalendar(){
  if(E.addEventBtn){
    E.addEventBtn.addEventListener('click', () => {
      const now = new Date();
      UI.Modals.openEvent({
        start: now,
        end: new Date(now.getTime() + 60*60*1000),
        allDay: false,
        env: 'Prod',
        status: 'Planned'
      });
    });
  }

  [E.eventFilterDeployment, E.eventFilterMaintenance, E.eventFilterRelease, E.eventFilterOther]
    .forEach(input => {
      if (input) input.addEventListener('change', renderCalendarEvents);
    });

  if (E.calendarTz) {
    try {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local time';
      E.calendarTz.textContent = `Times shown in: ${tz}`;
    } catch {
      E.calendarTz.textContent = '';
    }
  }
}

function ensureCalendar(){
  if (calendarReady) return;
  const el = document.getElementById('calendar');
  if (!el || typeof FullCalendar === 'undefined') {
    UI.toast('Calendar library failed to load');
    return;
  }

  calendar = new FullCalendar.Calendar(el, {
    initialView: 'dayGridMonth',
    selectable: true,
    editable: true,
    height: 'auto',
    headerToolbar: {
      left: 'title',
      center: '',
      right: 'dayGridMonth,timeGridWeek,listWeek today prev,next'
    },
    select(info){
      UI.Modals.openEvent({
        start: info.start,
        end: info.end,
        allDay: info.allDay,
        env: 'Prod',
        status: 'Planned'
      });
    },
    eventClick(info){
      const existing = DataStore.events.find(e => e.id === info.event.id);
      const ev = existing || {
        id: info.event.id,
        title: info.event.title,
        type: info.event.extendedProps.type || 'Other',
        start: info.event.start,
        end: info.event.end,
        description: info.event.extendedProps.description || '',
        issueId: info.event.extendedProps.issueId || '',
        allDay: info.event.allDay,
        env: info.event.extendedProps.env || 'Prod',
        status: info.event.extendedProps.status || 'Planned',
        owner: info.event.extendedProps.owner || '',
        modules: info.event.extendedProps.modules || [],
        impactType: info.event.extendedProps.impactType || 'No downtime expected'
      };
      UI.Modals.openEvent(ev);
    },
    eventDrop: async (info) => {
      const ev = DataStore.events.find(e => e.id === info.event.id);
      if (!ev) { info.revert(); return; }

      const updated = {
        ...ev,
        start: info.event.start,
        end: info.event.end,
        allDay: info.event.allDay
      };

      const saved = await saveEventToSheet(updated);
      if (!saved) { info.revert(); return; }

      const idx = DataStore.events.findIndex(e => e.id === saved.id);
      if (idx > -1) DataStore.events[idx] = saved;
      saveEventsCache();
      Analytics.refresh(UI.Issues.applyFilters());
      ChangeCopilot.refresh();
    },
    eventDidMount(info){
      const ext = info.event.extendedProps || {};
      const riskSum = ext.risk || 0;
      if (riskSum) {
        const badge = document.createElement('span');
        badge.className = 'event-risk-badge ' + CalendarLink.riskBadgeClass(riskSum);
        badge.textContent = `RISK ${riskSum}`;
        const titleEl = info.el.querySelector('.fc-event-title');
        if (titleEl) titleEl.appendChild(badge);
      }

      const env    = ext.env    || 'Prod';
      const status = ext.status || 'Planned';
      let tooltip  = ext.description || '';

      if (ext.issueId) {
        const issue = DataStore.byId.get(ext.issueId);
        if (issue) {
          const meta = DataStore.computed.get(issue.id) || {};
          const r    = meta.risk?.total || 0;
          tooltip = `${issue.id} ‚Äì ${issue.title || ''}\nStatus: ${issue.status || '-'} ¬∑ Priority: ${issue.priority || '-'} ¬∑ Risk: ${r}` +
                    (tooltip ? `\n\n${tooltip}` : '');
        } else {
          tooltip = `Linked issue: ${ext.issueId}` + (tooltip ? `\n\n${tooltip}` : '');
        }
      }

      tooltip += `\nEnvironment: ${env} ¬∑ Change status: ${status}`;
      if (ext.collision || ext.freeze || ext.hotIssues) {
        tooltip += `\n‚ö†Ô∏è Change risk signals:`;
        if (ext.collision) tooltip += ` overlaps with other change(s)`;
        if (ext.freeze) tooltip += ` ¬∑ in freeze window`;
        if (ext.hotIssues) tooltip += ` ¬∑ high-risk open issues`;
      }

      if (tooltip.trim()) info.el.setAttribute('title', tooltip);
    }
  });

  calendarReady = true;
  renderCalendarEvents();
  calendar.render();
}

function renderCalendarEvents(){
  if (!calendar) return;

  const activeTypes = new Set();
  if (E.eventFilterDeployment && E.eventFilterDeployment.checked) activeTypes.add('Deployment');
  if (E.eventFilterMaintenance && E.eventFilterMaintenance.checked) activeTypes.add('Maintenance');
  if (E.eventFilterRelease && E.eventFilterRelease.checked) activeTypes.add('Release');
  if (E.eventFilterOther && E.eventFilterOther.checked) activeTypes.add('Other');

  const links = computeEventsRisk(DataStore.rows, DataStore.events);
  const riskMap = new Map(links.map(r => [r.event.id, r.risk]));
  const { flagsById } = computeChangeCollisions(DataStore.rows, DataStore.events);

  calendar.removeAllEvents();

  DataStore.events.forEach(ev => {
    const type = ev.type || 'Other';
    if (activeTypes.size && !activeTypes.has(type)) return;

    const risk = riskMap.get(ev.id) || 0;
    const env   = ev.env || 'Prod';
    const status= ev.status || 'Planned';
    const owner = ev.owner || '';
    const modules = Array.isArray(ev.modules)
      ? ev.modules
      : (typeof ev.modules === 'string'
         ? ev.modules.split(',').map(s => s.trim()).filter(Boolean)
         : []);
    const impactType = ev.impactType || '';

    const flags = flagsById.get(ev.id) || {};
    const classNames = [
      'event-type-' + type.toLowerCase().replace(/\s+/g,'-'),
      'event-env-' + env.toLowerCase()
    ];
    if (flags.collision) classNames.push('event-collision');
    if (flags.freeze)    classNames.push('event-freeze');
    if (flags.hotIssues) classNames.push('event-hot');

    calendar.addEvent({
      id: ev.id,
      title: ev.title,
      start: ev.start,
      end: ev.end || null,
      allDay: !!ev.allDay,
      extendedProps: {
        type,
        description: ev.description,
        issueId: ev.issueId || '',
        risk,
        env,
        status,
        owner,
        modules,
        impactType,
        collision: !!flags.collision,
        freeze: !!flags.freeze,
        hotIssues: !!flags.hotIssues
      },
      classNames
    });
  });
}

/* ---------- Networking & data loading ---------- */
async function safeFetchText(url, opts = {}){
  const res = await fetch(url, { cache:'no-store', ...opts });
  if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status} ${res.statusText}`);
  return await res.text();
}

function loadEventsCache(){
  try{
    const raw = localStorage.getItem(LS_KEYS.events);
    if (!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  }catch{
    return [];
  }
}

function saveEventsCache(){
  try{
    localStorage.setItem(LS_KEYS.events, JSON.stringify(DataStore.events || []));
  }catch{}
}

async function loadIssues(force=false){
  if (!force && !DataStore.rows.length) {
    const cached = IssuesCache.load();
    if (cached && cached.length) {
      DataStore.hydrateFromRows(cached);
      UI.Issues.renderFilters();
      setIfOptionExists(E.moduleFilter, Filters.state.module);
      setIfOptionExists(E.priorityFilter, Filters.state.priority);
      setIfOptionExists(E.statusFilter, Filters.state.status);
      UI.skeleton(false);
      UI.refreshAll();
    }
  }

  try{
    UI.spinner(true);
    UI.skeleton(true);

    const text = await safeFetchText(CONFIG.SHEET_URL);
    DataStore.hydrate(text);
    IssuesCache.save(DataStore.rows);

    UI.Issues.renderFilters();
    setIfOptionExists(E.moduleFilter, Filters.state.module);
    setIfOptionExists(E.priorityFilter, Filters.state.priority);
    setIfOptionExists(E.statusFilter, Filters.state.status);

    UI.refreshAll();
    UI.setSync('issues', true, new Date());
  }catch(e){
    if (!DataStore.rows.length && E.issuesTbody) {
      E.issuesTbody.innerHTML = `
        <tr>
          <td colspan="8" style="color:#ffb4b4;text-align:center">
            Error loading data and no cached data found.
            <button type="button" id="retryLoad" class="btn sm" style="margin-left:8px">Retry</button>
          </td>
        </tr>`;
      const retryBtn = document.getElementById('retryLoad');
      if (retryBtn) retryBtn.addEventListener('click', () => loadIssues(true));
    }
    UI.toast('Error loading issues: ' + e.message);
    UI.setSync('issues', !!DataStore.rows.length, null);
  }finally{
    UI.spinner(false);
    UI.skeleton(false);
  }
}

async function loadEvents(force=false){
  const cached = loadEventsCache();
  if (cached && cached.length && !force) {
    DataStore.events = cached;
    ensureCalendar();
    renderCalendarEvents();
    Analytics.refresh(UI.Issues.applyFilters());
    ChangeCopilot.refresh();
    UI.setSync('events', true, new Date());
  }

  if (!CONFIG.CALENDAR_API_URL) return;

  try{
    UI.spinner(true);
    const res = await fetch(CONFIG.CALENDAR_API_URL, { cache:'no-store' });
    if (!res.ok) throw new Error(`Events API failed: ${res.status}`);
    const data = await res.json().catch(() => ({}));
    const events = Array.isArray(data.events) ? data.events : [];

    const normalized = events.map(ev => {
      const modulesArr = Array.isArray(ev.modules)
        ? ev.modules
        : (typeof ev.modules === 'string'
           ? ev.modules.split(',').map(s => s.trim()).filter(Boolean)
           : []);
      return {
        id:   ev.id || ('ev_' + Date.now() + '_' + Math.random().toString(36).slice(2)),
        title: ev.title || '',
        type:  ev.type  || 'Other',
        start: ev.start || ev.startDate || '',
        end:   ev.end   || ev.endDate   || '',
        allDay: !!ev.allDay,
        description: ev.description || '',
        issueId: ev.issueId || '',
        env: ev.env || ev.environment || 'Prod',
        status: ev.status || 'Planned',
        owner: ev.owner || '',
        modules: modulesArr,
        impactType: ev.impactType || 'No downtime expected'
      };
    });

    DataStore.events = normalized;
    saveEventsCache();
    ensureCalendar();
    renderCalendarEvents();
    Analytics.refresh(UI.Issues.applyFilters());
    ChangeCopilot.refresh();
    UI.setSync('events', true, new Date());
  }catch(e){
    DataStore.events = cached || [];
    ensureCalendar();
    renderCalendarEvents();
    UI.setSync('events', !!DataStore.events.length, null);
    UI.toast(DataStore.events.length ? 'Using cached events (API error)' : 'Unable to load calendar events');
  }finally{
    UI.spinner(false);
  }
}

/* ---------- Save/Delete to Apps Script ---------- */
async function saveEventToSheet(event){
  UI.spinner(true);
  try{
    const evId = event.id || ('ev_' + Date.now() + '_' + Math.random().toString(36).slice(2));
    const payload = { ...event, id: evId };

    const res = await fetch(CONFIG.CALENDAR_API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'save', event: payload })
    });

    let data;
    try{
      data = await res.json();
    }catch(jsonErr){
      console.error('Invalid JSON from calendar backend', jsonErr);
      const text = await res.text();
      console.error('Raw response:', text);
      UI.toast('Calendar: invalid JSON from backend, using local event');
      return payload;
    }

    if (data.ok) {
      UI.toast('Event saved');
      return data.event || payload;
    } else {
      UI.toast('Error saving event: ' + (data.error || 'Unknown error'));
      return null;
    }
  }catch(e){
    UI.toast('Network error saving event: ' + e.message);
    return null;
  }finally{
    UI.spinner(false);
  }
}

async function deleteEventFromSheet(id){
  UI.spinner(true);
  try{
    const res = await fetch(CONFIG.CALENDAR_API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'delete', event:{ id } })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Delete failed');
    UI.toast('Event deleted');
    return true;
  }catch(e){
    UI.toast('Error deleting event: ' + e.message);
    return false;
  }finally{
    UI.spinner(false);
  }
}

/* ---------- CSV export ---------- */
function csvEscape(v){
  const s = String(v == null ? '' : v);
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function exportIssuesToCsv(rows, suffix){
  if (!rows.length) return UI.toast('Nothing to export (no rows).');

  const headers = [
    'ID','Module','Title','Description','Priority','Status','Type','Date','Log','Link',
    'RiskTotal','RiskSeverity','RiskImpact','RiskUrgency'
  ];
  const lines = [headers.join(',')];

  rows.forEach(r => {
    const meta = DataStore.computed.get(r.id) || {};
    const risk = meta.risk || {};
    const arr = [
      r.id, r.module, r.title, r.desc, r.priority, r.status, r.type, r.date, r.log, r.file,
      risk.total ?? '', risk.severity ?? '', risk.impact ?? '', risk.urgency ?? ''
    ].map(csvEscape);
    lines.push(arr.join(','));
  });

  const blob = new Blob([lines.join('\r\n')], { type:'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const ts   = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = `incheck_issues_${suffix || 'filtered'}_${ts}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  UI.toast('Exported CSV');
}

function exportFilteredCsv(){
  const rows = UI.Issues.applyFilters();
  exportIssuesToCsv(rows, 'filtered');
}

/* ---------- Misc wiring ---------- */
function setIfOptionExists(select, value){
  if (!select || !value) return;
  const options = Array.from(select.options || []);
  if (options.some(o => o.value === value)) select.value = value;
}

function wireCore(){
  [E.issuesTab, E.calendarTab, E.insightsTab, E.changeTab].forEach(btn => {
    if (!btn) return;
    btn.addEventListener('click', () => setActiveView(btn.dataset.view));
  });

  if (E.drawerBtn){
    E.drawerBtn.addEventListener('click', () => {
      const open = !E.sidebar.classList.contains('open');
      E.sidebar.classList.toggle('open');
      E.drawerBtn.setAttribute('aria-expanded', String(open));
    });
  }

  if (E.searchInput){
    E.searchInput.addEventListener('input', debounce(() => {
      Filters.state.search = E.searchInput.value || '';
      Filters.save();
      UI.refreshAll();
    }, 250));
  }

  if (E.refreshNow) E.refreshNow.addEventListener('click', () => { loadIssues(true); loadEvents(true); });
  if (E.exportCsv)  E.exportCsv.addEventListener('click', exportFilteredCsv);

  if (E.createTicketBtn){
    E.createTicketBtn.addEventListener('click', () => {
      window.open("https://forms.gle/PPnEP1AQneoBT79s5", "_blank", "noopener,noreferrer");
    });
  }

  if (E.shortcutsHelp){
    E.shortcutsHelp.addEventListener('click', () => {
      UI.toast('Shortcuts: 1/2/3/4 switch tabs ¬∑ / focus search ¬∑ Ctrl+K AI query');
    });
  }

  UI.refreshAll = () => {
    const list = UI.Issues.applyFilters();
    UI.Issues.renderSummary(list);
    UI.Issues.renderFilterChips();
    UI.Issues.renderKPIs(list);
    UI.Issues.renderTable(list);
    UI.Issues.renderCharts(list);

    if (E.insightsView && E.insightsView.classList.contains('active')) Analytics.refresh(list);
    if (E.changeView && E.changeView.classList.contains('active')) ChangeCopilot.refresh();
  };
}

function wireSorting(){
  U.qAll('#issuesTable thead th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      if (GridState.sortKey === key) GridState.sortAsc = !GridState.sortAsc;
      else { GridState.sortKey = key; GridState.sortAsc = true; }
      UI.refreshAll();
    });
    th.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        th.click();
      }
    });
    th.tabIndex = 0;
    th.setAttribute('role','button');
    th.setAttribute('aria-label',`Sort by ${th.textContent}`);
  });
}

function wirePaging(){
  if (E.pageSize){
    E.pageSize.value = String(GridState.pageSize);
    E.pageSize.addEventListener('change', () => {
      GridState.pageSize = +E.pageSize.value;
      localStorage.setItem(LS_KEYS.pageSize, GridState.pageSize);
      GridState.page = 1;
      UI.refreshAll();
    });
  }

  if (E.firstPage) E.firstPage.addEventListener('click', () => { GridState.page = 1; UI.refreshAll(); });
  if (E.prevPage)  E.prevPage.addEventListener('click', () => {
    if (GridState.page > 1) { GridState.page--; UI.refreshAll(); }
  });
  if (E.nextPage)  E.nextPage.addEventListener('click', () => {
    const list  = UI.Issues.applyFilters();
    const pages = Math.max(1, Math.ceil(list.length / GridState.pageSize));
    if (GridState.page < pages) { GridState.page++; UI.refreshAll(); }
  });
  if (E.lastPage)  E.lastPage.addEventListener('click', () => {
    const list  = UI.Issues.applyFilters();
    GridState.page = Math.max(1, Math.ceil(list.length / GridState.pageSize));
    UI.refreshAll();
  });
}

function wireFilters(){
  if (E.moduleFilter){
    E.moduleFilter.addEventListener('change', () => {
      Filters.state.module = E.moduleFilter.value;
      Filters.save();
      UI.refreshAll();
    });
  }

  if (E.priorityFilter){
    E.priorityFilter.addEventListener('change', () => {
      Filters.state.priority = E.priorityFilter.value;
      Filters.save();
      UI.refreshAll();
    });
  }

  if (E.statusFilter){
    E.statusFilter.addEventListener('change', () => {
      Filters.state.status = E.statusFilter.value;
      Filters.save();
      UI.refreshAll();
    });
  }

  if (E.startDateFilter){
    E.startDateFilter.value = Filters.state.start || '';
    E.startDateFilter.addEventListener('change', () => {
      Filters.state.start = E.startDateFilter.value;
      Filters.save();
      UI.refreshAll();
    });
  }

  if (E.endDateFilter){
    E.endDateFilter.value = Filters.state.end || '';
    E.endDateFilter.addEventListener('change', () => {
      Filters.state.end = E.endDateFilter.value;
      Filters.save();
      UI.refreshAll();
    });
  }

  if (E.searchInput) E.searchInput.value = Filters.state.search || '';

  if (E.resetBtn){
    E.resetBtn.addEventListener('click', () => {
      Filters.state = { search:'', module:'All', priority:'All', status:'All', start:'', end:'' };
      Filters.save();
      if (E.searchInput)      E.searchInput.value      = '';
      if (E.startDateFilter)  E.startDateFilter.value  = '';
      if (E.endDateFilter)    E.endDateFilter.value    = '';
      UI.Issues.renderFilters();
      UI.refreshAll();
    });
  }
}

function wireTheme(){
  const media = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

  const applySystem = () => {
    if (media?.matches) document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme','light');
  };

  const saved = localStorage.getItem(LS_KEYS.theme) || 'system';
  if (E.themeSelect) E.themeSelect.value = saved;

  if (saved === 'system') applySystem();
  else if (saved === 'dark') document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme','light');

  media?.addEventListener('change', () => {
    if ((localStorage.getItem(LS_KEYS.theme) || 'system') === 'system') applySystem();
  });

  if (E.themeSelect){
    E.themeSelect.addEventListener('change', () => {
      const v = E.themeSelect.value;
      localStorage.setItem(LS_KEYS.theme, v);
      if (v === 'system') applySystem();
      else if (v === 'dark') document.documentElement.removeAttribute('data-theme');
      else document.documentElement.setAttribute('data-theme','light');
    });
  }

  if (E.accentColor){
    const rootStyle = getComputedStyle(document.documentElement);
    const defaultAccent = rootStyle.getPropertyValue('--accent').trim() || '#4f8cff';
    const savedAccent   = localStorage.getItem(LS_KEYS.accentColor) || defaultAccent;

    E.accentColor.value = savedAccent;
    document.documentElement.style.setProperty('--accent', savedAccent);

    E.accentColor.addEventListener('input', () => {
      const val = E.accentColor.value || defaultAccent;
      document.documentElement.style.setProperty('--accent', val);
      try{ localStorage.setItem(LS_KEYS.accentColor, val); }catch{}
      UI.Issues.renderCharts(UI.Issues.applyFilters());
    });
  }
}

function wireConnectivity(){
  if (!E.onlineStatusChip) return;
  const update = () => {
    const online = navigator.onLine !== false;
    E.onlineStatusChip.textContent = online ? 'Online' : 'Offline ¬∑ using cache';
    E.onlineStatusChip.classList.toggle('online', online);
    E.onlineStatusChip.classList.toggle('offline', !online);
  };
  window.addEventListener('online', update);
  window.addEventListener('offline', update);
  update();
}

/* ---------- AI Query wiring ---------- */
let lastAiQueryRows = [];

function wireAIQuery(){
  if (!E.aiQueryInput || !E.aiQueryRun || !E.aiQueryResults) return;

  function runQuery(){
    const text = E.aiQueryInput.value.trim();
    if (!text) { UI.toast('Type a query first.'); return; }
    if (!DataStore.rows.length) { UI.toast('No issues loaded yet.'); return; }

    const parsed = DSL.parse(text);
    const rows = DataStore.rows.filter(r => DSL.matches(r, DataStore.computed.get(r.id) || {}, parsed));
    lastAiQueryRows = rows;

    if (!rows.length){
      E.aiQueryResults.innerHTML = '<div class="muted">No issues match this query.</div>';
      return;
    }

    const top = rows.slice(0, 20);
    const html = `
      <div>Results: <strong>${rows.length}</strong> issue${rows.length===1?'':'s'} (showing ${top.length})</div>
      <ul style="margin-top:6px;padding-left:18px;font-size:13px;">
        ${top.map(r => {
          const meta = DataStore.computed.get(r.id) || {};
          const risk = meta.risk?.total || 0;
          const badge = risk ? `<span class="event-risk-badge ${CalendarLink.riskBadgeClass(risk)}">RISK ${risk}</span>` : '';
          return `
            <li style="margin-bottom:4px;">
              <button class="btn sm" data-open="${U.escapeAttr(r.id)}">${U.escapeHtml(r.id)}</button>
              [${U.escapeHtml(r.priority || '-')} ¬∑ ${U.escapeHtml(r.status || '-')}]
              ${badge}
              <br><span class="muted">${U.escapeHtml(r.module || '-')}</span> ‚Äî ${U.escapeHtml(r.title || '')}
            </li>`;
        }).join('')}
        ${rows.length > top.length ? `<li class="muted">+ ${rows.length - top.length} more not shown‚Ä¶</li>`:''}
      </ul>
    `;
    E.aiQueryResults.innerHTML = html;

    U.qAll('#aiQueryResults [data-open]').forEach(btn => {
      btn.addEventListener('click', () => UI.Modals.openIssue(btn.getAttribute('data-open')));
    });
  }

  E.aiQueryRun.addEventListener('click', runQuery);
  E.aiQueryInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      runQuery();
    }
  });

  if (E.aiQueryApplyFilters){
    E.aiQueryApplyFilters.addEventListener('click', () => {
      const text = E.aiQueryInput.value.trim();
      if (!text) return;
      const parsed = DSL.parse(text);

      if (parsed.module)   Filters.state.module   = parsed.module;
      if (parsed.priority) Filters.state.priority = parsed.priority[0].toUpperCase() === 'H' ? 'High'
                               : parsed.priority[0].toUpperCase() === 'M' ? 'Medium'
                               : parsed.priority[0].toUpperCase() === 'L' ? 'Low'
                               : Filters.state.priority;
      if (parsed.status)   Filters.state.status   = parsed.status === 'open' ? 'Not Started Yet' : Filters.state.status;

      if (parsed.words && parsed.words.length){
        Filters.state.search = parsed.words.join(' ');
      }

      Filters.save();
      if (E.moduleFilter)   setIfOptionExists(E.moduleFilter, Filters.state.module);
      if (E.priorityFilter) setIfOptionExists(E.priorityFilter, Filters.state.priority);
      if (E.statusFilter)   setIfOptionExists(E.statusFilter, Filters.state.status);
      if (E.searchInput)    E.searchInput.value = Filters.state.search || '';

      setActiveView('issues');
      UI.refreshAll();
      UI.toast('Applied query filters to Issues tab');
    });
  }

  if (E.aiQueryExport){
    E.aiQueryExport.addEventListener('click', () => {
      if (!lastAiQueryRows.length) {
        UI.toast('Run a query first.');
        return;
      }
      exportIssuesToCsv(lastAiQueryRows, 'query');
    });
  }
}

/* ---------- Keyboard shortcuts ---------- */
function wireKeyboardShortcuts(){
  document.addEventListener('keydown', e => {
    const target = e.target;
    const inInput = target && (
      target.tagName === 'INPUT' ||
      target.tagName === 'TEXTAREA' ||
      target.isContentEditable
    );

    // / to focus search (when not typing in field)
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      if (!inInput) {
        e.preventDefault();
        if (E.searchInput) {
          E.searchInput.focus();
          E.searchInput.select();
        }
      }
      return;
    }

    // Ctrl+K / Cmd+K => AI query
    if ((e.key === 'k' || e.key === 'K') && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      if (E.aiQueryInput) {
        setActiveView('insights');
        E.aiQueryInput.focus();
        E.aiQueryInput.select();
      }
      return;
    }

    // 1/2/3/4 switch tabs (when not in input)
    if (!inInput && !e.ctrlKey && !e.metaKey && !e.altKey){
      if (e.key === '1') { setActiveView('issues'); return; }
      if (e.key === '2') { setActiveView('calendar'); return; }
      if (e.key === '3') { setActiveView('insights'); return; }
      if (e.key === '4') { setActiveView('change'); return; }
    }
  });
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', () => {
  cacheEls();
  Filters.load();

  wireCore();
  wireSorting();
  wirePaging();
  wireFilters();
  wireTheme();
  wireConnectivity();
  wireModals();
  wireCalendar();
  wireAIQuery();
  wireKeyboardShortcuts();

  // initial view
  const savedView = localStorage.getItem(LS_KEYS.view) || 'issues';
  setActiveView(savedView);

  // kick off data loading
  loadIssues(false);
  loadEvents(false);
});
  </script>
</body>
</html>
