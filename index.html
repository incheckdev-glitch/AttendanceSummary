<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>InCheck 360 Chat â€“ v5.1 (Full UI)</title>
<style>
:root {
  --brand: #0078d7;
  --brand-dark: #005bb5;
  --bg: #f4f6fb;
  --panel: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --muted: #64748b;
  --sent: var(--brand);
  --recv: #edf2f7;
  --radius: 16px;
  --shadow: 0 2px 8px rgba(0,0,0,0.05);
}
body.dark { --bg:#0f172a; --panel:#1e293b; --border:#334155; --text:#f1f5f9; --muted:#94a3b8; --recv:#2d3748; }
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
.app{flex:1;display:grid;grid-template-columns:300px 1fr;grid-template-rows:64px 1fr 80px;grid-template-areas:"sidebar header" "sidebar chat" "sidebar composer";height:100vh}
/* Sidebar */
.sidebar{grid-area:sidebar;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
.sidebar-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:#f9fafb;box-shadow:var(--shadow)}
.sidebar-header img{width:40px;height:40px;border-radius:8px}
.sidebar-header h1{font-size:1.05em;margin:0;color:var(--brand-dark)}
.section{padding:10px 16px;border-bottom:1px solid var(--border)}
.section input,.section select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;font-size:.92em;background:var(--panel);color:var(--text)}
.people,.rooms{flex:1;overflow:auto;padding:8px 0}
.person,.room{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;border-radius:10px;transition:background .2s}
.person:hover,.room:hover{background:rgba(0,0,0,.05)}
.person.active,.room.active{background:rgba(0,120,215,.15)}
.avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#c7d2fe;color:#1e293b;font-weight:600;font-size:.8em}
.status-dot{width:8px;height:8px;border-radius:50%;margin-left:auto}
.online{background:#22c55e}.offline{background:#9ca3af}
/* Header */
.header{grid-area:header;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
.header-left{display:flex;align-items:center;gap:12px}
#presenceDot{width:10px;height:10px;border-radius:50%}
.toggle-btn{background:none;border:none;font-size:1.4em;color:var(--brand);cursor:pointer}
/* Chat */
.chat{grid-area:chat;background:var(--bg);overflow-y:auto;padding:16px;display:flex;flex-direction:column}
.day-sep{align-self:center;background:var(--panel);border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-size:.75em;color:var(--muted);margin:8px 0}
.message{margin:8px 0;display:flex;align-items:flex-end;gap:8px}
.bubble{padding:10px 14px;border-radius:var(--radius);max-width:72%;line-height:1.4;word-wrap:break-word;box-shadow:var(--shadow)}
.mine{justify-content:flex-end}
.mine .bubble{background:var(--sent);color:#fff;border-bottom-right-radius:4px}
.theirs .bubble{background:var(--recv);color:var(--text);border-bottom-left-radius:4px}
.meta{font-size:.75em;color:var(--muted);margin-top:4px;text-align:right}
.preview{margin-top:6px;display:block;max-width:260px;border-radius:10px;border:1px solid var(--border)}
.typing{display:none;align-self:flex-start;background:transparent;color:var(--muted);font-size:.85em;margin:6px 10px}
.typing.show{display:block}
/* Composer */
.composer{grid-area:composer;background:var(--panel);border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:10px 16px}
.composer input[type=text]{flex:1;padding:12px;border:1px solid var(--border);border-radius:20px;font-size:.98em;background:var(--bg);color:var(--text)}
.icon-btn{background:var(--panel);border:1px solid var(--border);border-radius:10px;width:40px;height:40px;display:grid;place-items:center;cursor:pointer}
.send-btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
.send-btn:hover{background:var(--brand-dark)}
.file-upload{position:relative;overflow:hidden}
.file-upload input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--brand);color:#fff;padding:10px 16px;border-radius:8px;box-shadow:var(--shadow);opacity:0;transform:translateY(20px);transition:all .3s ease;z-index:999}
.toast.show{opacity:1;transform:translateY(0)}
/* Mobile */
@media(max-width:900px){.app{grid-template-columns:1fr;grid-template-areas:"header" "chat" "composer"}.sidebar{position:absolute;z-index:100;background:var(--panel);width:280px;height:100%;left:-280px;transition:left .3s}.sidebar.open{left:0}}
</style>
</head>
<body>
<!-- PIN Login Modal -->
<div id="loginModal" class="modal" style="
  position:fixed;inset:0;background:rgba(2,6,23,.6);
  display:none;align-items:center;justify-content:center;z-index:1000">
  <div class="card" style="
    background:#fff;border:1px solid #e2e8f0;border-radius:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.05);padding:20px;max-width:380px;width:92%">
    <h2 style="margin:0 0 8px 0">Sign in</h2>
    <small style="color:#64748b">Use your User ID and PIN</small>
    <input id="pinUser" placeholder="User ID (e.g., U001)" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin:8px 0"/>
    <input id="pinCode" placeholder="PIN" type="password" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin:8px 0"/>
    <button id="pinBtn" style="width:100%;padding:10px;border:none;border-radius:10px;background:#0078d7;color:#fff;font-weight:600;cursor:pointer;margin-top:8px">Sign in</button>
  </div>
</div>
<div id="app" class="app" style="display:none">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      
      <h1>InCheck 360</h1>
    </div>
    <div class="section">
      <label for="meSelect" style="font-size:.85em;">You:</label>
      <select id="meSelect"></select>
    </div>
    <div class="section"><input id="userSearch" type="text" placeholder="Search usersâ€¦"></div>
    <div class="people" id="peopleList"></div>
    <div class="section" style="border-top:1px solid var(--border);"><strong style="font-size:.9em;">Rooms</strong></div>
    <div class="rooms" id="roomsList"></div>
  </aside>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button id="toggleSidebar" class="toggle-btn">â˜°</button>
      <div style="display:flex;align-items:center;gap:10px">
        <strong id="chatTitle">Select chat</strong>
        <span id="presenceDot" title="presence"></span>
        <span id="lastSeen" style="font-size:.8em;color:var(--muted)"></span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <input id="msgSearch" type="text" placeholder="Search messagesâ€¦" style="padding:6px 10px;border:1px solid var(--border);border-radius:8px">
      <button id="toggleTheme" class="toggle-btn" title="Toggle Dark Mode">ðŸŒ™</button>
      <button id="notifyBtn" class="toggle-btn" title="Enable notifications">ðŸ””</button>
    </div>
  </header>

  <!-- Chat Area -->
  <main class="chat" id="chatBox" aria-live="polite">
    <p style="text-align:center;color:var(--muted);margin-top:20px;">Select a person or room to start chatting.</p>
  </main>

  <!-- Typing indicator -->
  <div id="typing" class="typing">Someone is typingâ€¦</div>

  <!-- Composer -->
  <div class="composer" ondragover="event.preventDefault();" ondrop="handleDrop(event)">
    <button class="icon-btn" id="attachBtn" title="Attach file">ðŸ“Ž</button>
    <input type="file" id="fileInput" style="display:none"/>
    <input type="text" id="messageInput" placeholder="Type a messageâ€¦" autocomplete="off" />
    <button id="sendBtn" class="send-btn" title="Send">Send âž¤</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/********************* CONFIG *********************/
const API_URL = "https://script.google.com/macros/s/AKfycbzKpLMouySKF0CvWay77649xDXWLzKcrbJcrc88SKXBIBKhHBoONTkmZT1-jxvm7h04Qw/exec";
const TOKEN   = "YOUR_SECRET_TOKEN"; // optional: if you added token auth in backend
const ENABLE_TYPING_API = false; // set true if you add a typing endpoint

/********************* DOM *********************/
const $ = id => document.getElementById(id);
const sidebar = $("sidebar"), chatBox = $("chatBox"), meSelect = $("meSelect"), peopleList=$("peopleList"), roomsList=$("roomsList");
const userSearch=$("userSearch"), msgSearch=$("msgSearch"), messageInput=$("messageInput"), sendBtn=$("sendBtn"), fileInput=$("fileInput"), toast=$("toast");
const toggleSidebar=$("toggleSidebar"), chatTitle=$("chatTitle"), presenceDot=$("presenceDot"), lastSeen=$("lastSeen"), typingEl=$("typing");
const attachBtn=$("attachBtn"), toggleTheme=$("toggleTheme"), notifyBtn=$("notifyBtn");

/********************* STATE *********************/
let me="", peer="", room="", lastMsgId=0, users=[], rooms=[], soundEnabled=false, typingTimer=null, peerTyping=false;

/********************* NET UTILS *********************/
async function get(q){const url=`${API_URL}?${q}${TOKEN?`&token=${TOKEN}`:""}`; const r=await fetch(url); return r.json();}
async function post(b){if(TOKEN) b.token=TOKEN; const r=await fetch(API_URL,{method:"POST",body:JSON.stringify(b)}); return r.json();}

/********************* HELPERS *********************/
function showToast(msg){toast.textContent=msg;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),2200)}
function beep(){ if(!soundEnabled) return; const a=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); a.volume=.6; a.play().catch(()=>{}); }
document.body.addEventListener("click",()=>{soundEnabled=true;},{once:true});
function escapeHtml(s){return (s||"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
function isImage(url){return /\.(png|jpe?g|gif|webp|bmp|svg)(\?|#|$)/i.test(url||"")}
function initials(name){return (name||"").split(/\s+/).map(x=>x[0]||"").join("").slice(0,2).toUpperCase()||"?"}
function formatDay(d){return d.toLocaleDateString(undefined,{weekday:"short",year:"numeric",month:"short",day:"numeric"})}

/********************* LOADERS *********************/
async function loadUsers(){ const res=await get("action=getUsers"); users=res; meSelect.innerHTML='<option value="">Select you</option>'+users.map(u=>`<option value="${u.user_id}">${escapeHtml(u.name)}</option>`).join(""); renderUsers(); }
async function loadRooms(){ const res=await get("action=getRooms"); rooms=res; renderRooms(); }

/********************* RENDER *********************/
function renderUsers(filter=""){ const f=filter.toLowerCase(); peopleList.innerHTML = users.filter(u=>u.name.toLowerCase().includes(f)&&u.user_id!=me).map(u=>{
  return `<div class="person" onclick="openChat('${u.user_id}')">
    <div class="avatar">${initials(u.name)}</div>
    <div>${escapeHtml(u.name)}</div>
    <span class="status-dot ${u.status==='online'?'online':'offline'}"></span>
  </div>`; }).join(""); }
function renderRooms(){ roomsList.innerHTML = rooms.map(r=>`<div class="room" onclick="openRoom('${r.room_id}')"><div class="avatar">#</div><div>${escapeHtml(r.room_name)}</div></div>`).join(""); }

function renderPresence(user){ if(!user){presenceDot.style.background="transparent"; lastSeen.textContent=""; return;} const on=user.status==="online"; presenceDot.style.background= on?"#22c55e":"#9ca3af"; lastSeen.textContent = on?"online":"last active: "+(user.last_active||""); }

function insertDaySeparators(msgs){ if(!msgs.length) return ""; let html=""; let lastDay=""; msgs.forEach(m=>{ const dayStr = formatDay(new Date(m.timestamp)); if(dayStr!==lastDay){ html+=`<div class="day-sep">${dayStr}</div>`; lastDay=dayStr; } html+=messageHtml(m); }); return html; }

function messageHtml(m){ const mine = m.sender_id==me; const safe = escapeHtml(m.message||""); const time = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const fileLink = m.file_link?`<br><a href="${m.file_link}" target="_blank" rel="noopener noreferrer" style="color:var(--brand);font-size:.85em;">ðŸ“Ž File</a>${isImage(m.file_link)?`<img class='preview' src='${m.file_link}' alt='attachment'/>`:''}`:'';
  const ticks = mine ? (m.read_status=="read"?" âœ“âœ“":" âœ“") : "";
  return `<div class="message ${mine?'mine':'theirs'}"><div class="bubble">${safe}${fileLink}</div><div class="meta">${time}${ticks}</div></div>`; }

/********************* OPEN CHAT/ROOM *********************/
async function openChat(id){ peer=id; room=""; const u=users.find(x=>x.user_id==id); chatTitle.textContent=u?u.name:"Chat"; renderPresence(u); await loadMessages(false); closeSidebar(); }
async function openRoom(id){ room=id; peer=""; const r=rooms.find(x=>x.room_id==id); chatTitle.textContent=r?r.room_name:"Room"; renderPresence(null); await loadMessages(false); closeSidebar(); }

/********************* MESSAGES *********************/
async function loadMessages(notify=true){ if(!me) return; let q = room?`action=getMessages&room_id=${room}`:`action=getMessages&user1=${me}&user2=${peer}`; const res=await get(q); if(!Array.isArray(res)) return;
  chatBox.innerHTML = insertDaySeparators(res); chatBox.scrollTop = chatBox.scrollHeight;
  if(res.length){ const last=res[res.length-1]; if(last.msg_id!=lastMsgId && last.sender_id!=me && notify){ beep(); showToast("New message!"); if(Notification.permission==="granted"){new Notification("ðŸ’¬ New message",{body:last.message||"Attachment",icon:"https://cdn-icons-png.flaticon.com/512/1827/1827504.png"});}} lastMsgId=last.msg_id; }
}

async function sendMessage(){ const msg = messageInput.value.trim(); const f=fileInput.files[0]; if(!msg && !f) return; const payload={action:"sendMessage", sender_id:me, message:msg}; if(peer) payload.receiver_id=peer; if(room) payload.room_id=room;
  if(f){ const base64=await toBase64(f); const up=await post({action:"uploadFile", file_name:f.name, mimeType:f.type, file_base64:base64.split(",")[1]}); if(up.success) payload.file_link=up.file_url; fileInput.value=""; }
  const res=await post(payload); if(res.success){ messageInput.value=""; loadMessages(false);} else showToast("Send failed"); }

/********************* SEARCH *********************/
msgSearch.addEventListener('keypress', async e=>{ if(e.key!=="Enter") return; const q=msgSearch.value.trim(); if(!q) return; const res=await get(`action=searchMessages&query=${encodeURIComponent(q)}`); if(!Array.isArray(res)||!res.length){ chatBox.innerHTML = `<p style='text-align:center;color:var(--muted);'>No results.</p>`; return; } chatBox.innerHTML = res.map(m=> messageHtml(m)).join(""); chatBox.scrollTop=0; });

/********************* TYPING (optional) *********************/
messageInput.addEventListener('input', ()=>{ showTypingLocal(); if(ENABLE_TYPING_API) sendTyping(); resetTypingDebounce(); });
function showTypingLocal(){ typingEl.textContent = peer? `${(users.find(u=>u.user_id==peer)||{}).name||'They'} is typingâ€¦` : 'Someone is typingâ€¦'; typingEl.classList.add('show'); }
function hideTypingLocal(){ typingEl.classList.remove('show'); }
function resetTypingDebounce(){ clearTimeout(typingTimer); typingTimer = setTimeout(hideTypingLocal, 1500); }
async function sendTyping(){ try{ const body = peer? {action:'typing', from:me, to:peer} : {action:'typing', from:me, room_id:room}; await post(body); }catch(_){} }

/********************* FILE: drag & drop *********************/
function handleDrop(e){ e.preventDefault(); if(!e.dataTransfer.files.length) return; fileInput.files = e.dataTransfer.files; showToast(`${e.dataTransfer.files[0].name} attached`); }
attachBtn.addEventListener('click', ()=> fileInput.click());

/********************* EVENTS *********************/
sendBtn.onclick=sendMessage; messageInput.onkeypress=e=>{ if(e.key==="Enter") sendMessage(); };
userSearch.oninput=()=>renderUsers(userSearch.value);
meSelect.onchange=()=>{ me=meSelect.value; localStorage.setItem("chat_me", me); renderUsers(); };
toggleSidebar.onclick=()=>sidebar.classList.toggle("open");
toggleTheme.onclick=()=>{ document.body.classList.toggle('dark'); localStorage.setItem('theme', document.body.classList.contains('dark')? 'dark':'light'); };
if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
notifyBtn.onclick=()=>{ if(Notification.permission!=="granted") Notification.requestPermission().then(p=>showToast(p==="granted"?"Notifications on":"Notifications blocked")); else showToast("Notifications already on"); };

/********************* HEARTBEAT & POLL *********************/
setInterval(()=>{ if(me) post({action:"heartbeat", user_id:me}); }, 60000);
setInterval(()=>loadMessages(true), 3000);

/********************* INIT *********************/
const toBase64 = file => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
(async()=>{ const appEl=document.getElementById('app'); const loginEl=document.getElementById('loginModal'); if(appEl){ appEl.style.display='grid'; } if(loginEl){ loginEl.style.display='none'; } me = localStorage.getItem("chat_me")||""; await loadUsers(); await loadRooms(); })();
</script>
</body>
</html>
