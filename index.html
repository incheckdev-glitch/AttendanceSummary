  <script>
    /* ======================= CONFIG ======================= */
    const API_BASE = "https://script.google.com/macros/s/AKfycbwyjG0ZS22iohHqM8N78KELf8xWYM2ARBdcGN-vn448eewSbuCSYoyI4MC3adEDcSiVkA/exec";

    /* ======================= STATE ======================= */
    let RAW_ATT = [];
    let CANON = [];
    let HOLIDAYS = [];
    let LEAVES = [];
    let SETTINGS = { late:"08:15", early:"16:30", half:4, over:9 };
    let DT = null;
    let barChartHandle, pieChartHandle, lineChartHandle;

    /* ======================= UTIL ======================= */
    const toggleDark = () => document.body.classList.toggle("dark-mode");
    const pad = n => String(n).padStart(2,"0");
    const toLocalISODate = d => d instanceof Date ? `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}` : "";
    function normalizeDate(str){
      if(!str) return "";
      const s = String(str).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      if (s.includes("/")) { const [dd,mm,yy]=s.split("/"); const yyyy=yy.length===2?(yy>70?`19${yy}`:`20${yy}`):yy; return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`; }
      return s;
    }
    function parsePunchWithDate(dateISO, hhmm){
      if(!dateISO || !hhmm) return null;
      const s = String(hhmm).trim();
      if(!s || s === "-") return null;
      if (/^\d{1,2}:\d{2}$/.test(s)) { const t=s.length===4?`0${s}`:s; const dt=new Date(`${dateISO}T${t}:00`); return isNaN(dt)?null:dt; }
      const dt=new Date(s); return isNaN(dt)?null:dt;
    }
    function getField(obj, ...names){
      const lower = Object.keys(obj).reduce((acc,k)=>{acc[k.toLowerCase()]=k;return acc;}, {});
      for(const n of names){ const m = lower[String(n).toLowerCase()]; if(m!==undefined) return obj[m]; }
      return undefined;
    }
    const mapLeaveType = t => ({ AL:"Annual Leave", SL:"Sick Leave", UL:"Unpaid Leave" }[String(t||"").trim().toUpperCase()] || (t||"Other"));

    /* ======================= API (GET-only to avoid CORS preflight) ======================= */
    async function apiCall(paramsObj){
      const qs = new URLSearchParams(Object.entries(paramsObj).reduce((a,[k,v])=>{
        a[k] = typeof v === "object" ? JSON.stringify(v) : v; return a;
      }, {}));
      const res = await fetch(`${API_BASE}?${qs.toString()}`); // GET only
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || "API error");
      return json.data ?? json; // some sheets return data, some return object
    }
    const apiGetSheet = (sheet) => apiCall({ sheet, action:"get" });
    const apiMutate   = (sheet, action, payload) => apiCall({ sheet, action, payload });

    /* ======================= SETTINGS ======================= */
    async function loadSettings(){
      try{
        const d = await apiGetSheet("settings");
        // accept {late,early,half,over} OR rows table
        if (Array.isArray(d)) {
          const row = d[0] || {};
          SETTINGS = { late:String(row.late||row.Late||"08:15"), early:String(row.early||row.Early||"16:30"), half:Number(row.half||row.Half||4), over:Number(row.over||row.Over||9) };
        } else {
          SETTINGS = { late:String(d.late||"08:15"), early:String(d.early||"16:30"), half:Number(d.half??4), over:Number(d.over??9) };
        }
        lateThreshold.value = SETTINGS.late;
        earlyThreshold.value = SETTINGS.early;
        halfDayHours.value = SETTINGS.half;
        overtimeHours.value = SETTINGS.over;
      }catch(e){ console.warn("Settings load failed:", e.message); }
    }
    async function saveSettings(){
      const payload = {
        late: lateThreshold.value || "08:15",
        early: earlyThreshold.value || "16:30",
        half : parseFloat(halfDayHours.value) || 4,
        over : parseFloat(overtimeHours.value) || 9
      };
      try{ await apiMutate("settings","update",payload); SETTINGS = payload; alert("Settings saved ✅"); applyFilters(); }
      catch(e){ alert("Failed to save settings: " + e.message); }
    }

    /* ======================= HOLIDAYS ======================= */
    function renderHolidayList(){
      holidayList.innerHTML = "";
      [...HOLIDAYS].sort((a,b)=>a.date.localeCompare(b.date)).forEach(h=>{
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${h.date}${h.name ? " - "+h.name : ""}</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-warning" onclick="editHoliday('${h.date}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="removeHoliday('${h.date}')">Remove</button>
          </div>`;
        holidayList.appendChild(li);
      });
    }
    async function addHoliday(){
      const d = holidayDate.value; const n = holidayName.value;
      if(!d) return alert("Please choose a date");
      try{ await apiMutate("holidays","add",{ Date:d, "Holiday Name":n||"" }); await refreshHolidays(); alert("Holiday added ✅"); applyFilters(); }
      catch(e){ alert("Failed to add holiday: " + e.message); }
    }
    async function editHoliday(date){
      const h = HOLIDAYS.find(x=>x.date===date);
      const newName = prompt("Edit holiday name:", (h && h.name) || "");
      if(newName===null) return;
      try{
        await apiMutate("holidays","remove",{ Date:date });
        await apiMutate("holidays","add",{ Date:date, "Holiday Name":newName });
        await refreshHolidays(); applyFilters();
      }catch(e){ alert("Failed to edit holiday: " + e.message); }
    }
    async function removeHoliday(date){
      if(!confirm("Remove this holiday?")) return;
      try{ await apiMutate("holidays","remove",{ Date:date }); await refreshHolidays(); alert("Holiday removed ✅"); applyFilters(); }
      catch(e){ alert("Failed to remove holiday: " + e.message); }
    }
    async function refreshHolidays(){
      const rows = await apiGetSheet("holidays");
      HOLIDAYS = (rows||[]).map(r=>({ date: normalizeDate(getField(r,"date","Date")), name: getField(r,"Holiday Name","name","holiday") || "" })).filter(x=>x.date);
      renderHolidayList();
    }

    /* ======================= LEAVES ======================= */
    function renderLeaveList(){
      leaveList.innerHTML = "";
      [...LEAVES].sort((a,b)=> (a.date+a.employee).localeCompare(b.date+b.employee)).forEach(l=>{
        const li = document.createElement("li");
        li.className="list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${l.date} - ${l.employee} (${l.type})${l.reason ? " - "+l.reason : ""}</span>
                        <div><button class="btn btn-sm btn-danger" onclick="removeLeave('${l.date}','${encodeURIComponent(l.employee)}')">Remove</button></div>`;
        leaveList.appendChild(li);
      });
    }
    async function addLeave(){
      const d=leaveDate.value; const emp=leaveEmployee.value; const t=leaveType.value; const r=leaveReason.value;
      if(!d || !emp) return alert("Please select date and employee");
      try{ await apiMutate("leaves","add",{ Date:d, "Employee Name":emp, Type:t, Reason:r||"" }); await refreshLeaves(); alert("Leave added ✅"); applyFilters(); }
      catch(e){ alert("Failed to add leave: " + e.message); }
    }
    async function removeLeave(date, empEnc){
      const emp = decodeURIComponent(empEnc);
      if(!confirm(`Remove leave for ${emp} on ${date}?`)) return;
      try{ await apiMutate("leaves","remove",{ Date:date, "Employee Name":emp }); await refreshLeaves(); alert("Leave removed ✅"); applyFilters(); }
      catch(e){ alert("Failed to remove leave: " + e.message); }
    }
    async function refreshLeaves(){
      const rows = await apiGetSheet("leaves");
      LEAVES = (rows||[]).map(r=>({
        date: normalizeDate(getField(r,"date","Date")),
        employee: String(getField(r,"employee","Employee Name")||"").trim(),
        type: mapLeaveType(getField(r,"type","Type")),
        reason: getField(r,"reason","Reason") || ""
      })).filter(x=>x.date && x.employee);
      renderLeaveList();
    }

    /* ======================= ATTENDANCE ======================= */
    function mapAttendanceRow(obj){
      // EXACT headers from your sheet:
      // month | date | employee | sign in | sign out | total hours
      const rawDate = getField(obj,"date");
      const dateISO = normalizeDate(rawDate);
      const employee = String(getField(obj,"employee")||"").trim();
      const siRaw = getField(obj,"sign in");
      const soRaw = getField(obj,"sign out");
      const siDT = dateISO ? parsePunchWithDate(dateISO, siRaw) : null;
      const soDT = dateISO ? parsePunchWithDate(dateISO, soRaw) : null;

      let total = Number(getField(obj,"total hours"));
      if(!Number.isFinite(total) && siDT && soDT) total = (soDT - siDT) / 36e5;

      return {
        month: String(getField(obj,"month")||"").trim(),
        date: dateISO,
        employee,
        signIn: siRaw || "",
        signOut: soRaw || "",
        signInDT: siDT,
        signOutDT: soDT,
        totalHours: Number.isFinite(total)? total : 0
      };
    }

    function computeStatus(row){
      if (row.status && Array.isArray(row.status) && row.status.length) return row.status;
      const lateParts  = String(SETTINGS.late||"08:15").split(":").map(Number);
      const earlyParts = String(SETTINGS.early||"16:30").split(":").map(Number);
      const half = Number(SETTINGS.half??4), over = Number(SETTINGS.over??9);

      if(!row.signInDT && !row.signOutDT) return ["Absent"];
      if((row.signInDT && !row.signOutDT) || (!row.signInDT && row.signOutDT)) return ["Needs Correction"];

      const inMin  = row.signInDT  ? row.signInDT.getHours()*60 + row.signInDT.getMinutes()   : null;
      const outMin = row.signOutDT ? row.signOutDT.getHours()*60 + row.signOutDT.getMinutes() : null;

      const tags=[];
      if (inMin!==null && inMin > (lateParts[0]*60 + lateParts[1])) tags.push("Late");
      if (outMin!==null && outMin < (earlyParts[0]*60 + earlyParts[1])) tags.push("Early Leave");
      if (row.totalHours > 0 && row.totalHours < half) tags.push("Half-day");
      if (row.totalHours >= over) tags.push("Overtime");
      if (!tags.length) tags.push("On Time");
      return tags;
    }

    function renderTable(data){
      const rows = data.map(r=>{
        const st = computeStatus(r);
        const badge = st.map(label=>{
          let c="bg-secondary";
          if(label==="Late") c="bg-danger";
          else if(label==="Early Leave") c="bg-warning text-dark";
          else if(label==="On Time") c="bg-success";
          else if(label==="Absent") c="bg-dark";
          else if(label==="Needs Correction") c="bg-danger text-white";
          else if(label==="Half-day") c="bg-info text-dark";
          else if(label==="Overtime") c="bg-primary";
          else if(label==="Holiday") c="bg-secondary";
          else if(label==="Weekend") c="bg-light text-dark";
          else if(label==="Annual Leave") c="bg-success";
          else if(label==="Sick Leave") c="bg-info text-dark";
          else if(label==="Unpaid Leave") c="bg-danger";
          else if(label==="Other") c="bg-secondary";
          return `<span class="badge badge-status ${c}">${label}</span>`;
        }).join(" ");
        return [
          r.month || "",
          r.date || "",
          r.employee || "",
          r.signIn || "",
          r.signOut || "",
          Number.isFinite(r.totalHours) ? r.totalHours.toFixed(2) : "0.00",
          badge
        ];
      });

      if(!DT){
        DT = $("#attendanceTable").DataTable({
          data: rows,
          columns: [
            {title:"Month"},
            {title:"Date"},
            {title:"Employee"},
            {title:"Sign In"},
            {title:"Sign Out"},
            {title:"Total Hours"},
            {title:"Status"}
          ],
          dom:"Bfrtip",
          buttons:[{extend:"csv"}, {extend:"pdf"}, {extend:"print"}],
          pageLength:10,
          order:[[1,"asc"]],
          createdRow: (row, rowData)=>{
            if (rowData[6].includes("Holiday")) $(row).addClass("holiday-row");
            if (rowData[6].includes("Weekend")) $(row).addClass("weekend-row");
          }
        });
      } else {
        DT.clear().rows.add(rows).draw();
      }

      // KPIs
      let sum=0; const workingDays=new Set();
      let late=0, early=0, abs=0, annual=0, sick=0, unpaid=0, other=0;
      data.forEach(r=>{
        const st = computeStatus(r);
        if(st.includes("Late")) late++;
        if(st.includes("Early Leave")) early++;
        if(st.includes("Absent")) abs++;
        if(st.includes("Annual Leave")) annual++;
        if(st.includes("Sick Leave")) sick++;
        if(st.includes("Unpaid Leave")) unpaid++;
        if(st.includes("Other")) other++;
        if(r.totalHours) sum += r.totalHours;
        if(r.date){
          const d = new Date(r.date);
          const dow = d.getDay();
          const isHoliday = HOLIDAYS.some(h=>h.date===r.date);
          const isLeave = LEAVES.some(l=>l.date===r.date && l.employee===r.employee);
          if(dow!==0 && dow!==6 && !isHoliday && !isLeave){ workingDays.add(r.date); }
        }
      });

      const kpi = [
        {id:"totalHours",label:"Total Hours",val:sum.toFixed(2)},
        {id:"avgHours",label:"Avg Hours",val:(workingDays.size?(sum/workingDays.size):0).toFixed(2)},
        {id:"daysCount",label:"Working Days Count",val:workingDays.size},
        {id:"lateCount",label:"Late Count",val:late},
        {id:"earlyCount",label:"Early Leaves",val:early},
        {id:"absentCount",label:"Absent",val:abs},
        {id:"annualLeave",label:"Annual Leave",val:annual},
        {id:"sickLeave",label:"Sick Leave",val:sick},
        {id:"unpaidLeave",label:"Unpaid Leave",val:unpaid},
        {id:"otherLeave",label:"Other Leave",val:other}
      ];
      kpiCards.innerHTML = kpi.map(k=>`
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
          <div class="card shadow h-100" title="${k.label}">
            <div class="card-body">
              <div class="text-muted small">${k.label}</div>
              <div class="fs-4 fw-bold" id="${k.id}">${k.val}</div>
            </div>
          </div>
        </div>`).join("");

      renderCharts(data);
    }

    function renderCharts(data){
      if(barChartHandle)barChartHandle.destroy();
      if(pieChartHandle)pieChartHandle.destroy();
      if(lineChartHandle)lineChartHandle.destroy();

      const byDate={}, byEmp={};
      data.forEach(r=>{
        if(r.date){
          const d=new Date(r.date); const dow=d.getDay();
          const isHoliday=HOLIDAYS.some(h=>h.date===r.date);
          const isLeave=LEAVES.some(l=>l.date===r.date && l.employee===r.employee);
          if(dow!==0 && dow!==6 && !isHoliday && !isLeave){
            byDate[r.date]=(byDate[r.date]||0)+(r.totalHours||0);
          }
        }
        if(r.employee){ byEmp[r.employee]=(byEmp[r.employee]||0)+(r.totalHours||0); }
      });

      barChartHandle = new Chart(barChart.getContext("2d"),{
        type:"bar", data:{ labels:Object.keys(byDate), datasets:[{label:"Hours", data:Object.values(byDate)}] },
        options:{ scales:{ x:{ ticks:{ autoSkip:true }}}}
      });
      pieChartHandle = new Chart(pieChart.getContext("2d"),{
        type:"pie", data:{ labels:Object.keys(byEmp), datasets:[{ data:Object.values(byEmp)}] }
      });
      lineChartHandle = new Chart(lineChart.getContext("2d"),{
        type:"line", data:{ labels:Object.keys(byDate), datasets:[{ label:"Hours", data:Object.values(byDate) }]}
      });
    }

    /* ======================= FILTERS ======================= */
    function getCriteria(){
      return {
        employees: $("#employeeFilter").val()||[],
        start: startDate.value,
        end: endDate.value,
        q: (quickSearch.value||"").toLowerCase()
      };
    }
    function applyFilters(){
      const c = getCriteria();
      const filtered = CANON.filter(r=>{
        if (c.employees.length && !c.employees.includes(r.employee)) return false;
        if (c.start && r.date < c.start) return false;
        if (c.end && r.date > c.end) return false;
        if (c.q && !`${r.employee} ${r.date}`.toLowerCase().includes(c.q)) return false;
        return true;
      });
      renderTable(filtered);
    }
    function resetFilters(){
      $("#employeeFilter").val(null).trigger("change");
      startDate.value=""; endDate.value=""; quickSearch.value="";
      applyFilters();
    }
    function populateEmployeeFilter(){
      const sel = document.getElementById("employeeFilter");
      const leaveSel = document.getElementById("leaveEmployee");
      sel.innerHTML = ""; leaveSel.innerHTML = "";
      [...new Set(CANON.map(r=>r.employee).filter(Boolean))].sort().forEach(emp=>{
        const o=document.createElement("option"); o.value=emp; o.textContent=emp; sel.appendChild(o);
        const l=document.createElement("option"); l.value=emp; l.textContent=emp; leaveSel.appendChild(l);
      });
      $("#employeeFilter").select2({ placeholder:"Select employees...", allowClear:true, width:"100%" });
    }

    /* ======================= PDF ======================= */
    async function downloadFullReport(){
      const el = document.getElementById("reportArea");
      const canvas = await html2canvas(el,{ scale:2, backgroundColor:document.body.classList.contains("dark-mode")?"#181a1f":"#fff" });
      const img = canvas.toDataURL("image/png");
      const doc = { content:[{ image: img, width: 500 }] };
      pdfMake.createPdf(doc).download("Attendance_Report.pdf");
    }

    /* ======================= LOAD ======================= */
    async function loadData(){
      loadingOverlay.style.display = "flex";
      apiStatus.textContent = "API: loading…";
      try{
        await loadSettings();
        const [attendanceRows, holidaysRows, leavesRows] = await Promise.all([
          apiGetSheet("attendance"),
          apiGetSheet("holidays"),
          apiGetSheet("leaves")
        ]);

        HOLIDAYS = (holidaysRows||[]).map(r=>({ date: normalizeDate(getField(r,"date","Date")), name: getField(r,"Holiday Name","name","holiday") || "" })).filter(h=>h.date);
        LEAVES   = (leavesRows||[]).map(r=>({
          date: normalizeDate(getField(r,"date","Date")),
          employee: String(getField(r,"employee","Employee Name")||"").trim(),
          type: mapLeaveType(getField(r,"type","Type")),
          reason: getField(r,"reason","Reason") || ""
        })).filter(l=>l.date && l.employee);

        // Attendance base rows
        RAW_ATT = (attendanceRows||[]).map(mapAttendanceRow).filter(r=>r.employee && r.date);

        // Expand to canonical rows: fill missing days with Holiday/Weekend/Leave/Absent
        CANON = (function generateFullRows(data){
          const emps = [...new Set(data.map(r=>r.employee).filter(Boolean))];
          const dates = data.map(r=>r.date).filter(Boolean).sort();
          if(!emps.length || !dates.length) return data;
          const min = new Date(dates[0]), max = new Date(dates[dates.length-1]);
          const all = [];
          for(let d=new Date(min); d<=max; d.setDate(d.getDate()+1)){
            const dayISO = toLocalISODate(d); const dow = d.getDay();
            emps.forEach(emp=>{
              const match = data.find(r=>r.date===dayISO && r.employee===emp);
              if (match) { all.push(match); return; }
              if (HOLIDAYS.some(h=>h.date===dayISO)) {
                all.push({ month: dayISO.slice(0,7), date: dayISO, employee: emp, totalHours:0, status:["Holiday"] });
              } else {
                const leave = LEAVES.find(l=>l.date===dayISO && l.employee===emp);
                if (leave) {
                  all.push({ month: dayISO.slice(0,7), date: dayISO, employee: emp, totalHours:0, status:[mapLeaveType(leave.type)] });
                } else if (dow===0 || dow===6) {
                  all.push({ month: dayISO.slice(0,7), date: dayISO, employee: emp, totalHours:0, status:["Weekend"] });
                } else {
                  all.push({ month: dayISO.slice(0,7), date: dayISO, employee: emp, totalHours:0, status:["Absent"] });
                }
              }
            });
          }
          return all;
        })(RAW_ATT);

        populateEmployeeFilter();
        applyFilters();

        apiStatus.textContent = "API: connected ✅";
      } catch(e){
        console.error(e);
        alert("Error: " + e.message);
        apiStatus.textContent = "API: error ❌";
      } finally {
        loadingOverlay.style.display = "none";
      }
    }

    // Init
    loadData();
  </script>
</body>
</html>
