<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <!-- DataTables + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; padding: 20px; }
    h1 { margin-bottom: 20px; text-align: center; }
    .card { margin-bottom: 20px; }
    .metrics { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .metrics .card { flex: 1 1 180px; text-align: center; padding: 15px; }
    canvas { background: #fff; border-radius: 8px; padding: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Attendance Dashboard</h1>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col-md-3">
      <label>Employee</label>
      <input type="text" id="employeeFilter" class="form-control" placeholder="Search employee">
    </div>
    <div class="col-md-3">
      <label>Start Date</label>
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-md-3">
      <label>End Date</label>
      <input type="date" id="endDate" class="form-control">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary me-2" onclick="applyFilters()">Apply Filters</button>
      <button class="btn btn-warning" onclick="resetFilters()">Reset</button>
    </div>
  </div>

  <!-- Metrics -->
  <div class="metrics" id="metrics"></div>

  <!-- Attendance Table -->
  <div class="card">
    <div class="card-body">
      <table id="attendanceTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Month</th>
            <th>Date</th>
            <th>Employee</th>
            <th>Sign In</th>
            <th>Sign Out</th>
            <th>Total Hours</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Charts -->
  <div class="row">
    <div class="col-md-4">
      <canvas id="hoursPerDay"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="hoursByEmployee"></canvas>
    </div>
    <div class="col-md-4">
      <canvas id="trendChart"></canvas>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwyjG0ZS22iohHqM8N78KELf8xWYM2ARBdcGN-vn448eewSbuCSYoyI4MC3adEDcSiVkA/exec";
    let rawAttendance = [];

    // Normalize sheet headers
    function normalizeKeys(obj) {
      const map = {
        "month": "Month",
        "date": "Date",
        "employee": "Employee",
        "sign in": "Sign In",
        "sign out": "Sign Out",
        "total hours": "Total Hours",
        "status": "Status"
      };
      let normalized = {};
      for (let key in obj) {
        let clean = key.toLowerCase().trim();
        normalized[map[clean] || key] = obj[key];
      }
      return normalized;
    }

    async function loadData() {
      try {
        const res = await fetch(`${API_BASE}?sheet=attendance`);
        const json = await res.json();
        if (!json.ok) throw new Error(json.error);

        rawAttendance = json.data.map(normalizeKeys);
        populateTable(rawAttendance);
        updateMetrics(rawAttendance);
        updateCharts(rawAttendance);
      } catch (err) {
        console.error("Load error:", err);
      }
    }

    // DataTable
    function populateTable(data) {
      if ($.fn.dataTable.isDataTable("#attendanceTable")) {
        $("#attendanceTable").DataTable().clear().rows.add(data).draw();
        return;
      }
      $("#attendanceTable").DataTable({
        data,
        columns: [
          { data: "Month" },
          { data: "Date" },
          { data: "Employee" },
          { data: "Sign In" },
          { data: "Sign Out" },
          { data: "Total Hours" },
          { data: "Status",
            render: d => `<span class="badge bg-${d==="Absent"?"danger":"success"}">${d||""}</span>` }
        ],
        dom: "Bfrtip",
        buttons: ["csv", "pdf", "print"],
        responsive: true
      });
    }

    // Metrics
    function updateMetrics(data) {
      const totalHours = data.reduce((s,r)=>s+(parseFloat(r["Total Hours"])||0),0);
      const avgHours = (totalHours / data.length).toFixed(2);
      const absent = data.filter(r=>r.Status==="Absent").length;

      document.getElementById("metrics").innerHTML = `
        <div class="card"><h5>Total Hours</h5><p>${totalHours.toFixed(2)}</p></div>
        <div class="card"><h5>Avg Hours</h5><p>${avgHours}</p></div>
        <div class="card"><h5>Records</h5><p>${data.length}</p></div>
        <div class="card"><h5>Absent</h5><p>${absent}</p></div>
      `;
    }

    // Charts
    function updateCharts(data) {
      const ctx1 = document.getElementById("hoursPerDay").getContext("2d");
      const ctx2 = document.getElementById("hoursByEmployee").getContext("2d");
      const ctx3 = document.getElementById("trendChart").getContext("2d");

      const perDay = {};
      const perEmployee = {};
      data.forEach(r=>{
        perDay[r.Date] = (perDay[r.Date]||0) + (parseFloat(r["Total Hours"])||0);
        perEmployee[r.Employee] = (perEmployee[r.Employee]||0) + (parseFloat(r["Total Hours"])||0);
      });

      new Chart(ctx1, {
        type: "bar",
        data: { labels: Object.keys(perDay),
                datasets:[{ label:"Hours", data:Object.values(perDay) }] }
      });

      new Chart(ctx2, {
        type: "bar",
        data: { labels: Object.keys(perEmployee),
                datasets:[{ label:"Hours", data:Object.values(perEmployee) }] }
      });

      new Chart(ctx3, {
        type: "line",
        data: { labels: Object.keys(perDay),
                datasets:[{ label:"Trend", data:Object.values(perDay) }] }
      });
    }

    // Filters
    function applyFilters() {
      const emp = document.getElementById("employeeFilter").value.toLowerCase();
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;

      let filtered = rawAttendance;
      if (emp) filtered = filtered.filter(r => r.Employee?.toLowerCase().includes(emp));
      if (start) filtered = filtered.filter(r => r.Date >= start);
      if (end) filtered = filtered.filter(r => r.Date <= end);

      populateTable(filtered);
      updateMetrics(filtered);
      updateCharts(filtered);
    }

    function resetFilters() {
      document.getElementById("employeeFilter").value="";
      document.getElementById("startDate").value="";
      document.getElementById("endDate").value="";
      populateTable(rawAttendance);
      updateMetrics(rawAttendance);
      updateCharts(rawAttendance);
    }

    loadData();
  </script>
</body>
</html>
