<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- CSS LIBS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  
  <style>
    :root {
      --primary-color:#4e73df; --success-color:#1cc88a;
      --danger-color:#e74a3b; --dark-bg:#1a1d23;
      --dark-card:#242831; --dark-text:#e4e6eb;
    }
    body { background:linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; }
    body.dark-mode { background:var(--dark-bg); color:var(--dark-text); }
    .main-container { background:rgba(255,255,255,0.95); border-radius:20px; padding:30px; margin:20px auto; max-width:1400px; }
    body.dark-mode .main-container { background:rgba(36,40,49,0.95); }
    .header-section { display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary-color); margin-bottom:20px; }
    .header-title { font-size:2rem; font-weight:700; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    body.dark-mode .header-title { background:linear-gradient(135deg,#4facfe,#00f2fe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    #loadingOverlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; }
    .spinner { border:5px solid #f3f3f3; border-top:5px solid var(--primary-color); border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .toast-container { position:fixed; top:20px; right:20px; z-index:10000; }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay"><div class="spinner"></div></div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="header-section">
      <h1 class="header-title"><i class="fas fa-chart-line"></i> Attendance Dashboard Pro</h1>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="toggleDark()"><i class="fas fa-moon" id="themeIcon"></i></button>
        <button class="btn btn-success me-2" onclick="syncWithServer()"><i class="fas fa-sync-alt"></i> Sync</button>
        <button class="btn btn-primary" onclick="downloadFullReport()"><i class="fas fa-download"></i> Download</button>
      </div>
    </div>

    <!-- Attendance Table -->
    <div class="card mb-4"><div class="card-body">
      <h5><i class="fas fa-table"></i> Attendance Records</h5>
      <table id="attendanceTable" class="display nowrap" style="width:100%"></table>
    </div></div>

    <!-- Charts -->
    <div class="row mb-4">
      <div class="col-lg-4"><canvas id="barChart"></canvas></div>
      <div class="col-lg-4"><canvas id="pieChart"></canvas></div>
      <div class="col-lg-4"><canvas id="lineChart"></canvas></div>
    </div>

    <!-- Holiday Manager -->
    <div class="card mb-4"><div class="card-body">
      <h5><i class="fas fa-calendar-day"></i> Holiday Manager</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-5"><input type="date" id="holidayDate" class="form-control"/></div>
        <div class="col-md-5"><input type="text" id="holidayName" class="form-control" placeholder="Holiday Name"/></div>
        <div class="col-md-2"><button class="btn btn-primary w-100" onclick="addHoliday()"><i class="fas fa-plus"></i> Add</button></div>
      </div>
      <ul id="holidayList" class="list-group"></ul>
    </div></div>

    <!-- Leave Manager -->
    <div class="card mb-4"><div class="card-body">
      <h5><i class="fas fa-umbrella-beach"></i> Leave Manager</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><input type="date" id="leaveDate" class="form-control"/></div>
        <div class="col-md-3"><input type="text" id="leaveEmployee" class="form-control" placeholder="Employee"/></div>
        <div class="col-md-3">
          <select id="leaveType" class="form-control">
            <option value="Annual">Annual</option>
            <option value="Sick">Sick</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </div>
        <div class="col-md-2"><input type="text" id="leaveReason" class="form-control" placeholder="Reason"/></div>
        <div class="col-md-1"><button class="btn btn-primary w-100" onclick="addLeave()"><i class="fas fa-plus"></i></button></div>
      </div>
      <ul id="leaveList" class="list-group"></ul>
    </div></div>

    <!-- Balances -->
    <div class="card mb-4"><div class="card-body">
      <h5><i class="fas fa-balance-scale"></i> Balances</h5>
      <table id="balancesTable" class="table table-striped">
        <thead><tr><th>Employee</th><th>AL</th><th>SL</th><th>UL</th><th>Other</th></tr></thead>
        <tbody></tbody>
      </table>
    </div></div>

    <!-- Settings -->
    <div class="card"><div class="card-body">
      <h5><i class="fas fa-cogs"></i> Settings</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><label>Late After</label><input type="time" id="setLate" class="form-control"/></div>
        <div class="col-md-3"><label>Early Leave Before</label><input type="time" id="setEarly" class="form-control"/></div>
        <div class="col-md-3"><label>Half-day Max Hours</label><input type="number" id="setHalf" class="form-control"/></div>
        <div class="col-md-3"><label>Overtime Min Hours</label><input type="number" id="setOvertime" class="form-control"/></div>
      </div>
      <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Save Settings</button>
    </div></div>

  </div>

  <!-- JS LIBS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpTXfKm6S0b-syTyAQCs5VvvBzV0Za2zkNafTquI6PK2_oNXPjY-x38vwQ09Dt-Vur0A/exec"; // replace with your Apps Script Web App URL

    // Toast helper
    function showToast(msg, type="info") {
      const id = "toast" + Date.now();
      const toast = `<div id="${id}" class="toast align-items-center text-bg-${type} p-2 fade show">
        <div class="d-flex"><div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
      document.getElementById("toastContainer").insertAdjacentHTML("beforeend", toast);
      setTimeout(()=>document.getElementById(id)?.remove(), 4000);
    }

    // Dark mode
    function toggleDark() {
      document.body.classList.toggle("dark-mode");
      document.getElementById("themeIcon").classList.toggle("fa-sun");
      document.getElementById("themeIcon").classList.toggle("fa-moon");
    }

    // Sync
    function syncWithServer() {
      document.getElementById("loadingOverlay").style.display="flex";
      fetch(SCRIPT_URL + "?action=updateSummary")
        .then(r=>r.json()).then(()=>{ showToast("Attendance synced!","success"); loadAll(); })
        .catch(()=>showToast("Sync failed","danger"))
        .finally(()=>document.getElementById("loadingOverlay").style.display="none");
    }

    function downloadFullReport() {
      $('#attendanceTable').DataTable().button('.buttons-csv').trigger();
    }

    // Attendance
    function loadAttendance() {
      fetch(SCRIPT_URL + "?action=getAttendance")
        .then(r=>r.json())
        .then(data=>{
          if ($.fn.DataTable.isDataTable('#attendanceTable')) {
            $('#attendanceTable').DataTable().clear().rows.add(data).draw();
          } else {
            $('#attendanceTable').DataTable({
              data:data,
              columns:[
                {title:"Name", data:"Name"},
                {title:"Date", data:"Date"},
                {title:"SignIn", data:"SignIn"},
                {title:"SignOut", data:"SignOut"},
                {title:"Hours", data:"Hours"},
                {title:"Status", data:"Status"}
              ],
              dom:'Bfrtip', buttons:['copy','csv','excel','print']
            });
          }
          renderCharts(data);
        }).catch(()=>showToast("Failed to load attendance","danger"));
    }

    function renderCharts(data){
      const dates=data.map(r=>r.Date);
      const hours=data.map(r=>parseFloat(r.Hours||0));
      const byEmp={}; data.forEach(r=>{byEmp[r.Name]=(byEmp[r.Name]||0)+parseFloat(r.Hours||0);});
      new Chart(document.getElementById("barChart"),{type:'bar',data:{labels:dates,datasets:[{label:"Hours",data:hours,backgroundColor:"#4e73df"}]}});
      new Chart(document.getElementById("pieChart"),{type:'pie',data:{labels:Object.keys(byEmp),datasets:[{data:Object.values(byEmp),backgroundColor:["#4e73df","#1cc88a","#e74a3b","#f6c23e","#36b9cc"]}] }});
      new Chart(document.getElementById("lineChart"),{type:'line',data:{labels:dates,datasets:[{label:"Trend",data:hours,borderColor:"#1cc88a",fill:false}] }});
    }

    // Holidays
    function loadHolidays(){
      fetch(SCRIPT_URL+"?action=getHolidays").then(r=>r.json()).then(data=>{
        const list=document.getElementById("holidayList"); list.innerHTML="";
        data.forEach(row=>{
          const li=document.createElement("li");
          li.className="list-group-item d-flex justify-content-between align-items-center";
          li.textContent=row.Date+" - "+row.Name;
          const btn=document.createElement("button");
          btn.className="btn btn-sm btn-danger"; btn.innerHTML="<i class='fas fa-trash'></i>";
          btn.onclick=()=>removeHoliday(row.Date);
          li.appendChild(btn); list.appendChild(li);
        });
      });
    }
    function addHoliday(){
      const date=document.getElementById("holidayDate").value;
      const name=document.getElementById("holidayName").value;
      fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:"addHoliday",date,name}),headers:{"Content-Type":"application/json"}})
        .then(r=>r.json()).then(()=>{showToast("Holiday added","success");loadHolidays();});
    }
    function removeHoliday(date){
      fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:"removeHoliday",date}),headers:{"Content-Type":"application/json"}})
        .then(r=>r.json()).then(()=>{showToast("Holiday removed","success");loadHolidays();});
    }

    // Leaves
    function loadLeaves(){
      fetch(SCRIPT_URL+"?action=getLeaves").then(r=>r.json()).then(data=>{
        const list=document.getElementById("leaveList"); list.innerHTML="";
        data.forEach(row=>{
          const li=document.createElement("li");
          li.className="list-group-item d-flex justify-content-between align-items-center";
          li.textContent=row.Date+" - "+row.Employee+" ("+row.Type+") "+row.Reason;
          const btn=document.createElement("button");
          btn.className="btn btn-sm btn-danger"; btn.innerHTML="<i class='fas fa-trash'></i>";
          btn.onclick=()=>removeLeave(row.Date,row.Employee);
          li.appendChild(btn); list.appendChild(li);
        });
      });
    }
    function addLeave(){
      const date=document.getElementById("leaveDate").value;
      const employee=document.getElementById("leaveEmployee").value;
      const type=document.getElementById("leaveType").value;
      const reason=document.getElementById("leaveReason").value;
      fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:"addLeave",date,employee,type,reason}),headers:{"Content-Type":"application/json"}})
        .then(r=>r.json()).then(()=>{showToast("Leave added","success");loadLeaves();});
    }
    function removeLeave(date,employee){
      fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:"removeLeave",date,employee}),headers:{"Content-Type":"application/json"}})
        .then(r=>r.json()).then(()=>{showToast("Leave removed","success");loadLeaves();});
    }

    // Balances
    function loadBalances(){
      fetch(SCRIPT_URL+"?action=getBalances").then(r=>r.json()).then(data=>{
        const tbody=document.querySelector("#balancesTable tbody"); tbody.innerHTML="";
        data.forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${r.Employee}</td><td>${r.AL}</td><td>${r.SL}</td><td>${r.UL}</td><td>${r.Other}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    // Settings
    function loadSettings(){
      fetch(SCRIPT_URL+"?action=getSettings").then(r=>r.json()).then(s=>{
        document.getElementById("setLate").value=s.lateAfter||"";
        document.getElementById("setEarly").value=s.earlyLeaveBefore||"";
        document.getElementById("setHalf").value=s.halfDayMaxHours||"";
        document.getElementById("setOvertime").value=s.overtimeMinHours||"";
      });
    }
    function saveSettings(){
      const late=document.getElementById("setLate").value;
      const early=document.getElementById("setEarly").value;
      const half=document.getElementById("setHalf").value;
      const overtime=document.getElementById("setOvertime").value;
      fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:"updateSettings",lateAfter:late,earlyLeaveBefore:early,halfDayMaxHours:half,overtimeMinHours:overtime}),headers:{"Content-Type":"application/json"}})
        .then(r=>r.json()).then(()=>{showToast("Settings updated","success");loadSettings();});
    }

    // Init
    function loadAll(){ loadAttendance(); loadHolidays(); loadLeaves(); loadBalances(); loadSettings(); }
    loadAll();
  </script>
</body>
</html>
