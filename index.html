<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>InCheck Pro Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
    />

    <!-- Libraries -->
    <script
      src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"
      defer
    ></script>

    <!-- App code -->
    <script src="app.js" defer></script>
  </head>
  <body>
    <!-- Global spinner -->
    <div id="spinner">
      <div class="spinner-inner"></div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <div class="app-shell">
      <!-- Header -->
      <header class="app-header">
        <div class="app-header-left">
          <button id="drawerBtn" class="btn ghost sm" aria-expanded="false">
            â˜° Menu
          </button>
          <div>
            <div class="app-title">InCheck Pro â€” Issues Â· Ops Â· AI Copilot</div>
            <div class="app-subtitle" id="issuesSummaryText">
              Loading issuesâ€¦
            </div>
          </div>
        </div>
        <div class="app-header-right">
          <div id="onlineStatusChip">Online</div>

          <div style="display:flex;align-items:center;gap:4px;font-size:11px;">
            <span class="dot" id="syncIssuesDot"></span>
            <span id="syncIssuesText">Issues: never</span>
          </div>

          <div style="display:flex;align-items:center;gap:4px;font-size:11px;">
            <span class="dot" id="syncEventsDot"></span>
            <span id="syncEventsText">Events: never</span>
          </div>

          <select id="themeSelect" aria-label="Theme">
            <option value="system">System</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>

          <input
            type="color"
            id="accentColor"
            aria-label="Accent color"
          />

          <button id="shortcutsHelp" class="btn ghost sm" type="button">
            âŒ¨ï¸Ž Shortcuts
          </button>
        </div>
      </header>

      <!-- Sidebar -->
      <aside id="sidebar">
        <!-- Filters -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);">
              Filters
            </span>
            <button id="resetBtn" class="btn ghost sm" type="button">
              Reset
            </button>
          </div>

          <div class="search-input-wrap" style="margin-bottom:6px;">
            <input
              type="search"
              id="searchInput"
              placeholder="Search issues ( / )"
              autocomplete="off"
            />
          </div>

          <div style="display:flex;flex-direction:column;gap:6px;font-size:11px;">
            <label>
              Module
              <select id="moduleFilter"></select>
            </label>

            <label>
              Priority
              <select id="priorityFilter"></select>
            </label>

            <label>
              Status
              <select id="statusFilter"></select>
            </label>

            <div style="display:flex;gap:6px;">
              <label style="flex:1;">
                From
                <input type="date" id="startDateFilter" />
              </label>
              <label style="flex:1;">
                To
                <input type="date" id="endDateFilter" />
              </label>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
            <button id="createTicketBtn" class="btn sm" type="button">
              + New ticket
            </button>
          </div>
        </div>

        <!-- Sync / export -->
        <div class="card">
          <div style="display:flex;flex-direction:column;gap:6px;font-size:11px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="color:var(--muted);">Data</span>
              <span id="loadingStatus"></span>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button id="refreshNow" class="btn sm" type="button">
                âŸ³ Sync now
              </button>
              <button id="exportCsv" class="btn ghost sm" type="button">
                â¬‡ Export CSV
              </button>
            </div>
          </div>
        </div>

        <!-- AI query -->
        <div class="card">
          <div style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:4px;">
            AI Query DSL
          </div>
          <textarea
            id="aiQueryInput"
            rows="3"
            placeholder="Example: status:open risk>=9 payments last:7d"
          ></textarea>
          <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;">
            <button id="aiQueryRun" class="btn sm" type="button">
              Run
            </button>
            <button id="aiQueryApplyFilters" class="btn ghost sm" type="button">
              Apply filters
            </button>
            <button id="aiQueryExport" class="btn ghost sm" type="button">
              Export result
            </button>
          </div>
          <div
            id="aiAnalyzing"
            style="display:none;margin-top:4px;font-size:11px;"
          >
            Analyzingâ€¦
          </div>
          <div
            id="aiQueryResults"
            class="muted"
            style="margin-top:4px;font-size:11px;"
          ></div>
        </div>
      </aside>

      <!-- Main -->
      <main class="app-main">
        <!-- Top bar: tabs + paging / actions -->
        <div
          style="display:flex;align-items:center;justify-content:space-between;gap:8px;"
        >
          <div class="tabs" role="tablist" aria-label="Main views">
            <button
              id="issuesTab"
              class="tab active"
              data-view="issues"
              role="tab"
              aria-selected="true"
            >
              Issues
            </button>
            <button
              id="calendarTab"
              class="tab"
              data-view="calendar"
              role="tab"
              aria-selected="false"
            >
              Calendar
            </button>
            <button
              id="insightsTab"
              class="tab"
              data-view="insights"
              role="tab"
              aria-selected="false"
            >
              Insights &amp; Planner
            </button>
          </div>

          <div style="display:flex;align-items:center;gap:6px;font-size:11px;">
            <span>Rows per page:</span>
            <select id="pageSize">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <!-- Active filter chips -->
        <div id="activeFiltersChips" style="min-height:22px;"></div>

        <!-- KPI row -->
        <section id="kpis"></section>

        <!-- Issues view -->
        <section
          id="issuesView"
          class="view-panel active"
          role="tabpanel"
          aria-labelledby="issuesTab"
        >
          <div class="table-wrap">
            <table id="issuesTable" aria-label="Issues table">
              <thead>
                <tr>
                  <th
                    class="sortable"
                    data-key="id"
                    scope="col"
                    aria-sort="none"
                  >
                    ID
                  </th>
                  <th
                    class="sortable"
                    data-key="module"
                    scope="col"
                    aria-sort="none"
                  >
                    Module
                  </th>
                  <th
                    class="sortable"
                    data-key="title"
                    scope="col"
                    aria-sort="none"
                  >
                    Title
                  </th>
                  <th
                    class="sortable"
                    data-key="priority"
                    scope="col"
                    aria-sort="none"
                  >
                    Priority
                  </th>
                  <th
                    class="sortable"
                    data-key="status"
                    scope="col"
                    aria-sort="none"
                  >
                    Status
                  </th>
                  <th
                    class="sortable"
                    data-key="date"
                    scope="col"
                    aria-sort="none"
                  >
                    Date
                  </th>
                  <th scope="col">Log</th>
                  <th scope="col">Attachment</th>
                </tr>
              </thead>
              <tbody id="tbodySkeleton">
                <!-- Skeleton rows shown while loading -->
                <tr><td colspan="8"></td></tr>
                <tr><td colspan="8"></td></tr>
                <tr><td colspan="8"></td></tr>
              </tbody>
              <tbody id="issuesTbody"></tbody>
            </table>

            <div class="table-footer">
              <div id="rowCount">No rows</div>
              <div style="display:flex;align-items:center;gap:4px;">
                <button id="firstPage" class="btn ghost sm" type="button">
                  Â« First
                </button>
                <button id="prevPage" class="btn ghost sm" type="button">
                  â€¹ Prev
                </button>
                <span id="pageInfo">Page 1 / 1</span>
                <button id="nextPage" class="btn ghost sm" type="button">
                  Next â€º
                </button>
                <button id="lastPage" class="btn ghost sm" type="button">
                  Last Â»
                </button>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:8px;"
          >
            <div class="card">
              <div
                style="font-size:11px;color:var(--muted);margin-bottom:4px;"
              >
                Issues by module
              </div>
              <div style="height:160px;">
                <canvas id="byModule"></canvas>
              </div>
            </div>
            <div class="card">
              <div
                style="font-size:11px;color:var(--muted);margin-bottom:4px;"
              >
                By priority
              </div>
              <div style="height:160px;">
                <canvas id="byPriority"></canvas>
              </div>
            </div>
            <div class="card">
              <div
                style="font-size:11px;color:var(--muted);margin-bottom:4px;"
              >
                By status
              </div>
              <div style="height:160px;">
                <canvas id="byStatus"></canvas>
              </div>
            </div>
            <div class="card">
              <div
                style="font-size:11px;color:var(--muted);margin-bottom:4px;"
              >
                By category / type
              </div>
              <div style="height:160px;">
                <canvas id="byType"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Calendar view -->
        <section
          id="calendarView"
          class="view-panel"
          role="tabpanel"
          aria-labelledby="calendarTab"
        >
          <div class="card">
            <div
              style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;"
            >
              <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                <button id="addEventBtn" class="btn sm" type="button">
                  + Add event
                </button>
                <label style="font-size:11px;">
                  <input
                    type="checkbox"
                    id="eventFilterDeployment"
                    checked
                  />
                  Deployments
                </label>
                <label style="font-size:11px;">
                  <input
                    type="checkbox"
                    id="eventFilterMaintenance"
                    checked
                  />
                  Maintenance
                </label>
                <label style="font-size:11px;">
                  <input
                    type="checkbox"
                    id="eventFilterRelease"
                    checked
                  />
                  Releases
                </label>
                <label style="font-size:11px;">
                  <input
                    type="checkbox"
                    id="eventFilterOther"
                    checked
                  />
                  Other
                </label>
              </div>
              <div
                id="calendarTz"
                class="muted"
                style="font-size:11px;text-align:right;"
              ></div>
            </div>

            <div id="calendar"></div>
          </div>
        </section>

        <!-- Insights view -->
        <section
          id="insightsView"
          class="view-panel"
          role="tabpanel"
          aria-labelledby="insightsTab"
        >
          <div
            style="display:grid;grid-template-columns:2fr 2fr 1.8fr;gap:8px;align-items:start;"
          >
            <!-- Left column: patterns, labels, trends -->
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Scope &amp; signals
                </div>
                <div
                  id="aiScopeText"
                  style="font-size:12px;margin-bottom:4px;"
                >
                  â€“
                </div>
                <div
                  id="aiSignalsText"
                  style="font-size:12px;color:var(--muted);"
                >
                  â€“
                </div>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Recent patterns
                </div>
                <ul id="aiPatternsList"></ul>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Suggested categories
                </div>
                <ul id="aiLabelsList"></ul>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Term trends
                </div>
                <ul id="aiTrendsList"></ul>
              </div>
            </div>

            <!-- Middle column: risks, clusters, modules -->
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Top recent risks
                </div>
                <ul id="aiRisksList"></ul>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Similar-issue clusters
                </div>
                <div id="aiClusters"></div>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Module health
                </div>
                <div style="max-height:200px;overflow:auto;">
                  <table
                    style="width:100%;border-collapse:collapse;font-size:12px;"
                  >
                    <thead>
                      <tr>
                        <th style="text-align:left;">Module</th>
                        <th style="text-align:right;">Open</th>
                        <th style="text-align:right;">High</th>
                        <th style="text-align:right;">Risk</th>
                        <th style="text-align:left;">Top term</th>
                      </tr>
                    </thead>
                    <tbody id="aiModulesTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Right column: ops cockpit, triage, events, incidents -->
            <div style="display:flex;flex-direction:column;gap:8px;">
              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Ops cockpit
                </div>
                <ul id="aiOpsCockpit"></ul>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Triage queue
                </div>
                <ul id="aiTriageList"></ul>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Upcoming risky events
                </div>
                <ul id="aiEventsList"></ul>
              </div>

              <div class="card">
                <div
                  style="font-size:11px;color:var(--muted);margin-bottom:4px;"
                >
                  Incidents &amp; stability
                </div>
                <ul id="aiIncidentsList"></ul>
                <ul
                  id="aiEmergingStable"
                  style="margin-top:4px;border-top:1px solid var(--border-subtle);padding-top:4px;"
                ></ul>
              </div>
            </div>
          </div>

          <!-- Release Planner -->
          <div
            class="card"
            style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"
          >
            <div
              style="display:flex;justify-content:space-between;align-items:center;gap:8px;"
            >
              <div>
                <div
                  style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;"
                >
                  Release Planner â€” F&amp;B / Middle East
                </div>
              </div>
            </div>

            <div
              style="display:flex;flex-wrap:wrap;gap:8px;font-size:11px;align-items:flex-end;"
            >
              <label>
                Region
                <select id="plannerRegion">
                  <option value="gulf" selected>Gulf (KSA / UAE / Qatar)</option>
                  <option value="levant">Levant</option>
                  <option value="northafrica">North Africa</option>
                </select>
              </label>

              <label>
                Env
                <select id="plannerEnv">
                  <option value="Prod" selected>Prod</option>
                  <option value="Staging">Staging</option>
                  <option value="Dev">Dev</option>
                  <option value="Other">Other</option>
                </select>
              </label>

              <label style="flex:1;min-width:140px;">
                Modules (comma-separated)
                <input
                  type="text"
                  id="plannerModules"
                  placeholder="e.g. Ordering, Payments"
                />
              </label>

              <label>
                Horizon (days)
                <input
                  type="number"
                  id="plannerHorizon"
                  min="1"
                  max="30"
                  value="7"
                />
              </label>

              <label>
                Release type
                <select id="plannerReleaseType">
                  <option value="minor">Minor</option>
                  <option value="feature" selected>Feature</option>
                  <option value="major">Major</option>
                </select>
              </label>

              <label>
                Slots / day
                <input
                  type="number"
                  id="plannerSlotsPerDay"
                  min="1"
                  max="6"
                  value="4"
                />
              </label>

              <button
                id="plannerRun"
                class="btn sm"
                type="button"
                style="margin-left:auto;"
              >
                Run planner
              </button>
            </div>

            <label style="font-size:11px;">
              Release notes / description
              <textarea
                id="plannerDescription"
                rows="2"
                placeholder="Short description; used in Release event description."
              ></textarea>
            </label>

            <div id="plannerResults" style="font-size:12px;">
              No planner results yet. Run planner to see suggested windows.
            </div>

            <div
              style="border-top:1px solid var(--border-subtle);padding-top:8px;font-size:11px;display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;"
            >
              <label style="flex:1;min-width:200px;">
                Existing Release plan
                <select id="plannerReleasePlan"></select>
              </label>

              <label style="flex:1;min-width:200px;">
                Tickets to assign
                <select
                  id="plannerTickets"
                  multiple
                  size="4"
                  style="width:100%;"
                ></select>
              </label>

              <div style="display:flex;flex-direction:column;gap:6px;">
                <button
                  id="plannerAssignBtn"
                  class="btn sm"
                  type="button"
                >
                  Assign tickets
                </button>
                <button
                  id="plannerAddEvent"
                  class="btn ghost sm"
                  type="button"
                >
                  Add top suggestion as Release
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Issue modal -->
    <div id="issueModal" class="modal" aria-modal="true" role="dialog">
      <div class="modal-panel">
        <div class="modal-header">
          <div id="modalTitle" class="modal-title">Issue</div>
          <button
            id="modalClose"
            class="btn ghost sm"
            type="button"
            aria-label="Close"
          >
            âœ•
          </button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-footer">
          <button id="copyId" class="btn ghost sm" type="button">
            Copy ID
          </button>
          <button id="copyLink" class="btn ghost sm" type="button">
            Copy summary
          </button>
          <button
            class="btn sm"
            type="button"
            onclick="document.getElementById('modalClose').click();"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Event modal -->
    <div id="eventModal" class="modal" aria-modal="true" role="dialog">
      <div class="modal-panel">
        <div class="modal-header">
          <div id="eventModalTitle" class="modal-title">Event</div>
          <button
            id="eventModalClose"
            class="btn ghost sm"
            type="button"
            aria-label="Close"
          >
            âœ•
          </button>
        </div>
        <form id="eventForm">
          <div class="modal-body">
            <div
              style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;margin-bottom:6px;"
            >
              <label style="flex:1;min-width:180px;">
                Title
                <input type="text" id="eventTitle" required />
              </label>

              <label>
                Type
                <select id="eventType">
                  <option value="Deployment">Deployment</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Release">Release</option>
                  <option value="Other">Other</option>
                </select>
              </label>

              <label>
                Env
                <select id="eventEnv">
                  <option value="Prod">Prod</option>
                  <option value="Staging">Staging</option>
                  <option value="Dev">Dev</option>
                  <option value="Other">Other</option>
                </select>
              </label>

              <label>
                Change status
                <select id="eventStatus">
                  <option value="Planned">Planned</option>
                  <option value="In progress">In progress</option>
                  <option value="Completed">Completed</option>
                  <option value="Canceled">Canceled</option>
                </select>
              </label>

              <label style="flex:1;min-width:160px;">
                Owner
                <input type="text" id="eventOwner" />
              </label>
            </div>

            <div
              style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;margin-bottom:6px;"
            >
              <label style="flex:1;min-width:180px;">
                Modules (comma-separated)
                <input type="text" id="eventModules" />
              </label>

              <label style="flex:1;min-width:180px;">
                Impact
                <select id="eventImpactType">
                  <option value="No downtime expected" selected>
                    No downtime expected
                  </option>
                  <option value="Minor visible impact">
                    Minor visible impact
                  </option>
                  <option value="High risk change">High risk change</option>
                  <option value="Maintenance / infra">
                    Maintenance / infra
                  </option>
                </select>
              </label>
            </div>

            <div
              style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;margin-bottom:6px;"
            >
              <label style="flex:1;min-width:160px;">
                Linked ticket ID(s)
                <input
                  type="text"
                  id="eventIssueId"
                  placeholder="e.g. INC-123, INC-456"
                />
              </label>

              <label style="display:flex;align-items:flex-end;gap:4px;">
                <input type="checkbox" id="eventAllDay" />
                All day
              </label>
            </div>

            <div
              style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;margin-bottom:6px;"
            >
              <label style="flex:1;min-width:200px;">
                Start
                <input type="datetime-local" id="eventStart" />
              </label>
              <label style="flex:1;min-width:200px;">
                End
                <input type="datetime-local" id="eventEnd" />
              </label>
            </div>

            <div
              id="eventIssueLinkedInfo"
              class="muted"
              style="font-size:11px;display:none;margin-bottom:6px;"
            ></div>

            <label style="font-size:12px;">
              Notes / description
              <textarea id="eventDescription" rows="3"></textarea>
            </label>
          </div>

          <div class="modal-footer">
            <button
              id="eventDelete"
              class="btn ghost sm"
              type="button"
              style="margin-right:auto;"
            >
              ðŸ—‘ Delete
            </button>
            <button
              id="eventCancel"
              class="btn ghost sm"
              type="button"
            >
              Cancel
            </button>
            <button id="eventSave" class="btn sm" type="submit">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
