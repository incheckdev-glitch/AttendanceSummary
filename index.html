<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Dashboard Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- CSS LIBS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  
  <style>
    :root { --primary-color:#4e73df; --success-color:#1cc88a; --danger-color:#e74a3b; --dark-bg:#1a1d23; --dark-card:#242831; --dark-text:#e4e6eb; }
    body { background:linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; }
    body.dark-mode { background:var(--dark-bg); color:var(--dark-text); }
    .main-container { background:rgba(255,255,255,0.95); border-radius:20px; padding:30px; margin:20px auto; max-width:1400px; }
    body.dark-mode .main-container { background:rgba(36,40,49,0.95); }
    .header-section { display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary-color); margin-bottom:20px; }
    .header-title { font-size:2rem; font-weight:700; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    body.dark-mode .header-title { background:linear-gradient(135deg,#4facfe,#00f2fe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    #loadingOverlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; }
    .spinner { border:5px solid #f3f3f3; border-top:5px solid var(--primary-color); border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .toast-container { position:fixed; top:20px; right:20px; z-index:10000; }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay"><div class="spinner"></div></div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="header-section">
      <h1 class="header-title"><i class="fas fa-chart-line"></i> Attendance Dashboard Pro</h1>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="toggleDark()" title="Toggle theme">
          <i class="fas fa-moon" id="themeIcon"></i>
        </button>
        <button class="btn btn-success me-2" onclick="syncWithServer()"><i class="fas fa-sync-alt"></i> Sync</button>
        <button class="btn btn-primary" onclick="downloadFullReport()"><i class="fas fa-download"></i> Download</button>
      </div>
    </div>

    <!-- Filters + KPI Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <label>Employee</label>
        <select id="filterEmployee" class="form-control"></select>
      </div>
      <div class="col-md-3">
        <label>From Date</label>
        <input type="date" id="filterFrom" class="form-control"/>
      </div>
      <div class="col-md-3">
        <label>To Date</label>
        <input type="date" id="filterTo" class="form-control"/>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="applyFilters()"><i class="fas fa-filter"></i> Apply</button>
      </div>
    </div>

    <div class="row mb-4" id="summaryCards">
      <div class="col-md-2"><div class="card text-center"><div class="card-body"><h6>Total Hours</h6><h4 id="cardHours">0</h4></div></div></div>
      <div class="col-md-2"><div class="card text-center"><div class="card-body"><h6>Holidays</h6><h4 id="cardHolidays">0</h4></div></div></div>
      <div class="col-md-2"><div class="card text-center"><div class="card-body"><h6>Leaves</h6><h4 id="cardLeaves">0</h4></div></div></div>
      <div class="col-md-2"><div class="card text-center"><div class="card-body"><h6>Annual</h6><h4 id="cardAnnual">0</h4></div></div></div>
      <div class="col-md-2"><div class="card text-center"><div class="card-body"><h6>Sick</h6><h4 id="cardSick">0</h4></div></div></div>
      <div class="col-md-2"><div class="card text-center"><div class="card-body"><h6>Unpaid</h6><h4 id="cardUnpaid">0</h4></div></div></div>
    </div>

    <!-- Attendance Table -->
    <div class="card mb-4"><div class="card-body">
      <h5><i class="fas fa-table"></i> Attendance Records</h5>
      <table id="attendanceTable" class="display nowrap" style="width:100%"></table>
    </div></div>

    <!-- Charts -->
    <div class="row mb-4">
      <div class="col-lg-4"><canvas id="barChart"></canvas></div>
      <div class="col-lg-4"><canvas id="pieChart"></canvas></div>
      <div class="col-lg-4"><canvas id="lineChart"></canvas></div>
    </div>

    <!-- Leave Manager -->
    <div class="card mb-4"><div class="card-body">
      <h5><i class="fas fa-umbrella-beach"></i> Leave Manager</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><input type="date" id="leaveDate" class="form-control"/></div>
        <div class="col-md-3"><input type="text" id="leaveEmployee" class="form-control" placeholder="Employee"/></div>
        <div class="col-md-3">
          <select id="leaveType" class="form-control">
            <option value="Annual">Annual</option>
            <option value="Sick">Sick</option>
            <option value="Unpaid">Unpaid</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-2"><input type="text" id="leaveReason" class="form-control" placeholder="Reason"/></div>
        <div class="col-md-1"><button class="btn btn-primary w-100" onclick="addLeave()"><i class="fas fa-plus"></i></button></div>
      </div>
      <ul id="leaveList" class="list-group"></ul>
    </div></div>

    <!-- Holiday Manager -->
    <div class="card"><div class="card-body">
      <h5><i class="fas fa-calendar-day"></i> Holiday Manager</h5>
      <div class="row g-3 mb-3">
        <div class="col-md-5"><input type="date" id="holidayDate" class="form-control"/></div>
        <div class="col-md-5"><input type="text" id="holidayName" class="form-control" placeholder="Holiday Name"/></div>
        <div class="col-md-2"><button class="btn btn-primary w-100" onclick="addHoliday()"><i class="fas fa-plus"></i> Add</button></div>
      </div>
      <ul id="holidayList" class="list-group"></ul>
    </div></div>
  </div>

  <!-- JS LIBS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* =======================
       CONFIG
       ======================= */
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhioxuidkEd-nWb6UkeM6s3x7coq2cYsip5aIWRAVhlViqlwcnr6mA_42cQqD09bSY4Q/exec";
    // Set TOKEN if backend requires it (recommended). Leave "" to disable.
    const TOKEN = ""; // e.g., "YOUR_LONG_RANDOM_SECRET"
    // Optional CORS proxy (used only if direct fetch fails)
    const CORS_PROXY = "https://corsproxy.io/?";

    // UI <-> API leave type mapping
    const UI_TO_API_LEAVE = { Annual: "AL", Sick: "SL", Unpaid: "UL", Other: "Other" };
    const API_TO_UI_LEAVE = { AL: "Annual", SL: "Sick", UL: "Unpaid", Other: "Other" };

    /* =======================
       STATE
       ======================= */
    let attendanceData = [];
    let holidaysData = [];
    let leavesData = [];

    let barChartInstance;
    let pieChartInstance;
    let lineChartInstance;

    /* =======================
       UTILITIES
       ======================= */
    function showToast(msg, type="info") {
      const id = "toast" + Date.now();
      const toast = `<div id="${id}" class="toast align-items-center text-bg-${type} p-2 fade show">
        <div class="d-flex"><div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
      document.getElementById("toastContainer").insertAdjacentHTML("beforeend", toast);
      setTimeout(()=>document.getElementById(id)?.remove(), 4000);
    }

    function toggleDark() {
      const isDark = document.body.classList.toggle("dark-mode");
      const icon = document.getElementById("themeIcon");
      icon.classList.toggle("fa-sun", isDark);
      icon.classList.toggle("fa-moon", !isDark);
      try { localStorage.setItem("adp_theme", isDark ? "dark" : "light"); } catch(e){}
    }

    (function initTheme(){
      try {
        const saved = localStorage.getItem("adp_theme");
        if (saved === "dark") {
          document.body.classList.add("dark-mode");
          document.getElementById("themeIcon")?.classList.add("fa-sun");
          document.getElementById("themeIcon")?.classList.remove("fa-moon");
        }
      } catch(e){}
    })();

    // Querystring builder (auto-adds token if present)
    function qs(obj) {
      const p = { ...obj };
      if (TOKEN) p.token = TOKEN;
      return Object.entries(p)
        .filter(([,v]) => v !== undefined && v !== null && v !== "")
        .map(([k,v]) => encodeURIComponent(k) + "=" + encodeURIComponent(v))
        .join("&");
    }

    // Unwrap { ok:true, data:[...] } or return [] safely
    function unwrapData(raw) {
      if (Array.isArray(raw)) return raw;
      if (raw && Array.isArray(raw.data)) return raw.data;
      return [];
    }

    // Robust local Y-M-D -> Date at local midnight (no timezone shift)
    function parseYmdLocal(s) {
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s || ""));
      if (!m) return null;
      return new Date(+m[1], +m[2] - 1, +m[3]);
    }
    // Normalize to YYYY-MM-DD if possible
    function toYmd(val) {
      const s = String(val || "");
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(val);
      if (isNaN(d)) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function dateInRange(d, from, to) {
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    // Wrapper for fetch JSON with optional CORS proxy fallback
    async function fetchJSON(url, options={}, attempt=0) {
      const target = attempt === 0 || !CORS_PROXY ? url : `${CORS_PROXY}${url}`;
      try {
        const res = await fetch(target, options);
        if (!res.ok) {
          const body = await res.text().catch(() => "");
          throw new Error(`Request failed (${res.status} ${res.statusText}) ${body}`.trim());
        }
        const text = await res.text();
        try { return JSON.parse(text); }
        catch(e) {
          console.error("Invalid JSON", text);
          throw new Error("Invalid JSON response");
        }
      } catch (err) {
        if (attempt === 0 && CORS_PROXY) {
          console.warn("Falling back to CORS proxy", err);
          return fetchJSON(url, options, attempt + 1);
        }
        console.error("fetchJSON error", err);
        throw err;
      }
    }

    /* =======================
       STATUS BADGES
       ======================= */
    const STATUS_BADGES = {
      "on time":                { cls: "badge bg-success",            label: "On Time" },
      "on time + overtime":     { cls: "badge bg-success",            label: "On Time + OT" },
      "late":                   { cls: "badge bg-warning text-dark",  label: "Late" },
      "left early":             { cls: "badge bg-info text-dark",     label: "Left Early" },
      "late & left early":      { cls: "badge bg-warning text-dark",  label: "Late & Left Early" },
      "half day":               { cls: "badge bg-secondary",          label: "Half Day" },
      "no sign-out":            { cls: "badge bg-dark",               label: "No Sign-Out" },
      "no sign-in":             { cls: "badge bg-dark",               label: "No Sign-In" },
      "holiday":                { cls: "badge bg-primary",            label: "Holiday" },
      "weekend":                { cls: "badge bg-secondary",          label: "Weekend" },
      "absent":                 { cls: "badge bg-danger",             label: "Absent" },
      "leave (sick)":           { cls: "badge bg-info text-dark",     label: "Leave (Sick)" },
      "leave (annual)":         { cls: "badge bg-primary",            label: "Leave (Annual)" },
      "leave (unpaid)":         { cls: "badge bg-danger",             label: "Leave (Unpaid)" },
      "leave (other)":          { cls: "badge bg-secondary",          label: "Leave (Other)" }
    };
    function renderStatusBadge(rawStatus="") {
      const normalized = String(rawStatus).trim().toLowerCase();
      const entry = STATUS_BADGES[normalized];
      if (entry) return `<span class="${entry.cls}">${entry.label}</span>`;
      if (!rawStatus) return "";
      return `<span class="badge bg-secondary">${rawStatus}</span>`;
    }

    /* =======================
       SYNC / REPORT
       ======================= */
    function syncWithServer() {
      document.getElementById("loadingOverlay").style.display="flex";
      const url = `${SCRIPT_URL}?${qs({ action: "updateSummary" })}`;
      fetchJSON(url)
        .then(()=>{ showToast("Attendance synced!","success"); loadAll(); })
        .catch(err=>{ console.error(err); showToast("Sync failed","danger"); })
        .finally(()=>document.getElementById("loadingOverlay").style.display="none");
    }

    function downloadFullReport() {
      if (!$.fn.DataTable.isDataTable('#attendanceTable')) {
        showToast("Please wait for the data to finish loading.", "warning");
        return;
      }
      $('#attendanceTable').DataTable().button('.buttons-excel').trigger();
    }

    /* =======================
       LOADERS
       ======================= */
    function loadAttendance() {
      const url = `${SCRIPT_URL}?${qs({ action:"getAttendance" })}`;
      return fetchJSON(url)
        .then(raw => {
          const rows = unwrapData(raw);
          const data = rows.map(normalizeAttendanceRecord);
          attendanceData = data;
          populateEmployeeFilter(data);
          renderAttendanceTable(data);
          renderCharts(data);
        }).catch(err => {
          showToast("Failed to load attendance","danger");
          console.error(err);
        });
    }

    function loadHolidays(){
      const url = `${SCRIPT_URL}?${qs({ action:"getHolidays" })}`;
      return fetchJSON(url).then(raw => {
        holidaysData = unwrapData(raw).map(h => ({ Date: toYmd(h.Date), Name: h.Name }));
        renderHolidays(holidaysData);
      }).catch(err => {
        console.error(err); showToast("Failed to load holidays","danger");
      });
    }

    function loadLeaves(){
      const url = `${SCRIPT_URL}?${qs({ action:"getLeaves" })}`;
      return fetchJSON(url).then(raw => {
        // Ensure Type is what server returns (AL/SL/UL/Other) and keep Date normalized
        leavesData = unwrapData(raw).map(l => ({
          Date: toYmd(l.Date),
          Employee: l.Employee || l.Name || "",
          Type: l.Type, // server gives AL/SL/UL/Other in the upgraded backend
          Reason: l.Reason || ""
        }));
        renderLeaves(leavesData);
      }).catch(err => {
        console.error(err); showToast("Failed to load leaves","danger");
      });
    }

    /* =======================
       NORMALIZERS
       ======================= */
    function normalizeAttendanceRecord(row={}){
      const firstIn = row.FirstIn ?? row["First In"] ?? row.SignIn ?? "";
      const lastOut = row.LastOut ?? row["Last Out"] ?? row.SignOut ?? "";
      const hours = Number(row.Hours ?? row.TotalHours ?? row["Total Hours"] ?? 0) || 0;
      return {
        Name: row.Name ?? row.Employee ?? "",
        Date: toYmd(row.Date ?? row.Day ?? ""),
        FirstIn: firstIn,
        LastOut: lastOut,
        Hours: hours,
        Status: row.Status ?? row.Attendance ?? ""
      };
    }

    /* =======================
       TABLE
       ======================= */
    function renderAttendanceTable(data){
      if ($.fn.DataTable.isDataTable('#attendanceTable')) {
        $('#attendanceTable').DataTable().clear().rows.add(data).draw();
      } else {
        $('#attendanceTable').DataTable({
          data:data,
          columns:[
            {title:"Name", data:"Name"},
            {title:"Date", data:"Date"},
            {title:"First In", data:"FirstIn"},
            {title:"Last Out", data:"LastOut"},
            {title:"Hours", data:"Hours"},
            {title:"Status", data:"Status", render:renderStatusBadge }
          ],
          responsive:true,
          scrollX:true,
          order:[[1,'asc'],[0,'asc']],
          dom:'Bfrtip',
          buttons:['copy','csv','excel','print']
        });
      }
    }

    /* =======================
       CHARTS
       ======================= */
    function renderCharts(data){
      // Aggregate hours by date
      const byDate = {};
      const byEmp = {};
      data.forEach(r => {
        const d = r.Date;
        const h = Number(r.Hours) || 0;
        byDate[d] = (byDate[d] || 0) + h;
        byEmp[r.Name] = (byEmp[r.Name] || 0) + h;
      });

      const dates = Object.keys(byDate).sort();
      const hours = dates.map(d => +byDate[d].toFixed(2));
      // Cumulative trend for line chart
      const trend = [];
      let sum = 0;
      for (const h of hours) { sum += h; trend.push(+sum.toFixed(2)); }

      const empLabels = Object.keys(byEmp);
      const empValues = empLabels.map(k => +byEmp[k].toFixed(2));

      const barCanvas=document.getElementById("barChart");
      const pieCanvas=document.getElementById("pieChart");
      const lineCanvas=document.getElementById("lineChart");

      Chart.getChart(barCanvas)?.destroy();
      Chart.getChart(pieCanvas)?.destroy();
      Chart.getChart(lineCanvas)?.destroy();

      barChartInstance = new Chart(barCanvas,{
        type:'bar',
        data:{ labels:dates, datasets:[{ label:"Hours by Date", data:hours, backgroundColor:"#4e73df" }] },
        options:{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ maxRotation:45, minRotation:45 }}}}
      });

      pieChartInstance = new Chart(pieCanvas,{
        type:'pie',
        data:{
          labels:empLabels,
          datasets:[{ data:empValues, backgroundColor:["#4e73df","#1cc88a","#e74a3b","#f6c23e","#36b9cc","#858796","#5a5c69","#2e59d9"] }]
        }
      });

      lineChartInstance = new Chart(lineCanvas,{
        type:'line',
        data:{ labels:dates, datasets:[{ label:"Cumulative Hours", data:trend, borderColor:"#1cc88a", fill:false, tension:0.2 }] }
      });
    }

    /* =======================
       FILTERS + CARDS
       ======================= */
    function populateEmployeeFilter(data){
      const sel=document.getElementById("filterEmployee");
      const unique=[...new Set(data.map(r=>r.Name).filter(Boolean))].sort();
      sel.innerHTML="<option value=''>All</option>"+unique.map(n=>`<option value="${n}">${n}</option>`).join("");
    }

    function applyFilters(){
      const emp=document.getElementById("filterEmployee").value;
      const fromInput=document.getElementById("filterFrom").value;
      const toInput=document.getElementById("filterTo").value;
      const from = fromInput ? parseYmdLocal(fromInput) : null;
      const to   = toInput ? parseYmdLocal(toInput) : null;

      const filtered = attendanceData.filter(r=>{
        let ok = true;
        if (emp && r.Name !== emp) ok = false;
        const d = parseYmdLocal(r.Date) || new Date(r.Date);
        if (from && d < from) ok = false;
        if (to   && d > to)   ok = false;
        return ok;
      });

      renderAttendanceTable(filtered);
      renderCharts(filtered);
      updateCards(filtered, emp, from, to);
    }

    function updateCards(filtered, emp, from, to){
      const totalHours = filtered.reduce((sum,r)=>sum+(Number(r.Hours)||0),0);

      const holCount = holidaysData.filter(h=>{
        const d = parseYmdLocal(h.Date) || new Date(h.Date);
        return dateInRange(d, from, to);
      }).length;

      const leaveFiltered = leavesData.filter(l=>{
        if(emp && l.Employee !== emp) return false;
        const d = parseYmdLocal(l.Date) || new Date(l.Date);
        return dateInRange(d, from, to);
      });

      const toUI = t => API_TO_UI_LEAVE[t] || t; // AL->Annual, or passthrough
      const totalLeaves = leaveFiltered.length;
      const annual = leaveFiltered.filter(l=>toUI(l.Type)==="Annual").length;
      const sick   = leaveFiltered.filter(l=>toUI(l.Type)==="Sick").length;
      const unpaid = leaveFiltered.filter(l=>toUI(l.Type)==="Unpaid").length;

      document.getElementById("cardHours").textContent = totalHours.toFixed(2);
      document.getElementById("cardHolidays").textContent = holCount;
      document.getElementById("cardLeaves").textContent = totalLeaves;
      document.getElementById("cardAnnual").textContent = annual;
      document.getElementById("cardSick").textContent = sick;
      document.getElementById("cardUnpaid").textContent = unpaid;
    }

    /* =======================
       HOLIDAYS
       ======================= */
    function renderHolidays(data){
      const list=document.getElementById("holidayList"); list.innerHTML="";
      data.forEach(row=>{
        const li=document.createElement("li");
        li.className="list-group-item d-flex justify-content-between align-items-center";
        li.textContent=`${row.Date} - ${row.Name}`;
        const btn=document.createElement("button");
        btn.className="btn btn-sm btn-danger"; btn.innerHTML="<i class='fas fa-trash'></i>";
        btn.onclick=()=>removeHoliday(row.Date);
        li.appendChild(btn); list.appendChild(li);
      });
    }

    function addHoliday(){
      const date=document.getElementById("holidayDate").value;
      const name=document.getElementById("holidayName").value;
      if(!date||!name) return showToast("Date & Name required","danger");
      const payload = { action:"addHoliday", date, name };
      if (TOKEN) payload.token = TOKEN;
      fetchJSON(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
        .then(()=>{showToast("Holiday added","success");loadHolidays();})
        .catch(err=>{console.error(err);showToast("Failed to add holiday","danger");});
    }

    function removeHoliday(date){
      const payload = { action:"removeHoliday", date };
      if (TOKEN) payload.token = TOKEN;
      fetchJSON(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
        .then(()=>{showToast("Holiday removed","success");loadHolidays();})
        .catch(err=>{console.error(err);showToast("Failed to remove holiday","danger");});
    }

    /* =======================
       LEAVES
       ======================= */
    function renderLeaves(data){
      const list=document.getElementById("leaveList"); list.innerHTML="";
      data.forEach(row=>{
        const uiType = API_TO_UI_LEAVE[row.Type] || row.Type;
        const li=document.createElement("li");
        li.className="list-group-item d-flex justify-content-between align-items-center";
        li.textContent=`${row.Date} - ${row.Employee} (${uiType}) ${row.Reason||""}`;
        const btn=document.createElement("button");
        btn.className="btn btn-sm btn-danger"; btn.innerHTML="<i class='fas fa-trash'></i>";
        btn.onclick=()=>removeLeave(row.Date,row.Employee);
        li.appendChild(btn); list.appendChild(li);
      });
    }

    function addLeave(){
      const date=document.getElementById("leaveDate").value;
      const employee=document.getElementById("leaveEmployee").value;
      const uiType=document.getElementById("leaveType").value;
      const type=UI_TO_API_LEAVE[uiType] || uiType; // Convert to AL/SL/UL for API
      const reason=document.getElementById("leaveReason").value;
      if(!date||!employee) return showToast("Date & Employee required","danger");

      const payload = { action:"addLeave", date, employee, type, reason };
      if (TOKEN) payload.token = TOKEN;

      fetchJSON(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
        .then(()=>{showToast("Leave added","success");loadLeaves();})
        .catch(err=>{console.error(err);showToast("Failed to add leave","danger");});
    }

    function removeLeave(date,employee){
      const payload = { action:"removeLeave", date, employee };
      if (TOKEN) payload.token = TOKEN;
      fetchJSON(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})
        .then(()=>{showToast("Leave removed","success");loadLeaves();})
        .catch(err=>{console.error(err);showToast("Failed to remove leave","danger");});
    }

    /* =======================
       INIT
       ======================= */
    function loadAll(){ Promise.all([loadAttendance(),loadHolidays(),loadLeaves()]).then(()=>applyFilters()); }
    loadAll();
  </script>
</body>
</html>
