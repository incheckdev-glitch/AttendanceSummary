<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues & Operations Dashboard</title>

  <!-- Fonts & Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root {
      /* Status colors */
      --status-resolved:#10b981;
      --status-underdev:#3b82f6;
      --status-rejected:#ef4444;
      --status-onhold:#f59e0b;
      --status-notstarted:#6b7280;
      --status-sent:#8b5cf6;
      --status-onstage:#0ea5e9;

      /* Priority colors */
      --priority-high:#ef4444;
      --priority-medium:#f59e0b;
      --priority-low:#10b981;

      /* Theme colors */
      --bg:#050816;
      --card:rgba(11,22,45,0.96);
      --muted:#9aa6d1;
      --text:#e8edff;
      --accent:#4f8cff;
      --danger:#ef4444;
      --ok:#10b981;
      --warn:#f59e0b;
      --info:#3b82f6;
      --purple:#8b5cf6;
      --neutral:#6b7280;
      --border:#1b2645;
      --shadow:0 18px 40px rgba(0,0,0,.55);
      --focus:0 0 0 3px rgba(79,140,255,.5);
    }
    :root[data-theme="light"] {
      --bg:#f4f6ff;
      --card:#ffffff;
      --muted:#5a678c;
      --text:#0d1326;
      --accent:#2563eb;
      --danger:#dc2626;
      --ok:#059669;
      --warn:#d97706;
      --info:#1d4ed8;
      --purple:#7c3aed;
      --neutral:#374151;
      --border:#e0e4f3;
      --shadow:0 16px 32px rgba(15,23,42,.12);
      --focus:0 0 0 3px rgba(37,99,235,.35);
    }

    * { box-sizing:border-box }
    html,body { height:100% }
    body {
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 0% 0%, rgba(79,140,255,.22), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(139,92,246,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      transition:background .3s,color .3s;
    }
    :focus-visible { outline:none; box-shadow:var(--focus); border-radius:8px; }

    .sr-only {
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    /* Topbar */
    header {
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg, rgba(11,22,45,.98), rgba(24,35,70,.96));
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px; padding:10px 16px;
      box-shadow:var(--shadow);
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand .logo {
      width:30px; height:30px; border-radius:10px;
      display:grid; place-items:center;
      background:conic-gradient(from 160deg, var(--accent), #9b8cff, #22c55e, var(--accent));
      color:#fff; font-weight:800;
      box-shadow:0 10px 30px rgba(79,140,255,.55);
    }
    .brand-text { display:flex; flex-direction:column; }
    .brand-text span:first-child { font-size:14px; text-transform:uppercase; letter-spacing:.16em; color:var(--muted); }
    .brand-text span:last-child { font-size:16px; }

    .toolbar { margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn, .select, .input {
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(8,16,32,.92);
      color:inherit;
      font:inherit;
    }
    .btn {
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 20px rgba(15,23,42,.25);
    }
    .btn.primary {
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      border-color:transparent;
      color:#fff;
    }
    .btn.ghost {
      border-color:transparent;
      background:transparent;
      box-shadow:none;
    }
    .btn.sm { padding:6px 10px; border-radius:999px; font-size:13px }
    .btn:hover { opacity:.95; transform:translateY(-1px); }
    .btn:active { transform:translateY(0); opacity:.9; }
    .input, .select {
      background:rgba(5,10,24,.85);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.35);
    }
    .input::placeholder { color:var(--muted); }
    .icon { font-size:18px; line-height:1 }

    /* Layout */
    .wrap {
      display:grid; grid-template-columns:280px minmax(0,1fr);
      gap:18px; padding:18px;
      max-width:1440px; margin:0 auto;
    }
    @media(max-width:980px){ .wrap { grid-template-columns:1fr } }

    /* Sidebar */
    .sidebar {
      background:linear-gradient(145deg, rgba(11,23,45,.96), rgba(13,28,60,.98));
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px;
      padding:16px;
      position:sticky; top:82px;
      height:fit-content;
      max-height:calc(100vh - 102px);
      overflow:auto;
      box-shadow:var(--shadow);
    }
    :root[data-theme="light"] .sidebar {
      background:var(--card);
      border-color:var(--border);
    }
    .sidebar h3 {
      margin:0 0 10px 0;
      font-size:13px; color:var(--muted);
      text-transform:uppercase; letter-spacing:.12em;
    }
    .filter-group { display:grid; gap:10px; margin-bottom:16px }
    .filter-row { display:grid; gap:6px }
    .muted { color:var(--muted); font-size:12px }
    .divider { height:1px; background:var(--border); margin:8px 0 14px; opacity:.7 }

    /* Content */
    .content { display:flex; flex-direction:column; gap:16px }

    .view-tabs {
      display:inline-flex;
      align-self:flex-start;
      background:rgba(10,18,40,.98);
      border-radius:999px;
      border:1px solid var(--border);
      box-shadow:0 16px 40px rgba(15,23,42,.45);
      padding:4px;
    }
    .view-tab {
      border:none;
      background:transparent;
      color:var(--muted);
      padding:6px 14px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      display:flex; align-items:center; gap:6px;
    }
    .view-tab .icon { font-size:16px; }
    .view-tab.active {
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      color:#fff;
      box-shadow:0 10px 26px rgba(79,140,255,.6);
    }

    .view { display:none; }
    .view.active { display:block; }
    .view > * + * { margin-top:16px; }

    .grid { display:grid; gap:16px }
    .grid.cols-4 { grid-template-columns:repeat(4, minmax(0,1fr)) }
    @media(max-width:980px){ .grid.cols-4{ grid-template-columns:repeat(2, minmax(0,1fr)) } }
    @media(max-width:600px){ .grid.cols-4{ grid-template-columns:1fr } }

    /* Cards */
    .card {
      background:radial-gradient(circle at 0 0, rgba(79,140,255,.16), transparent 55%), var(--card);
      border:1px solid rgba(148,163,184,.35);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
      transition:transform .2s, box-shadow .2s, border-color .2s, background .2s;
    }
    :root[data-theme="light"] .card {
      background:var(--card);
      border-color:var(--border);
    }
    .card:hover {
      transform:translateY(-2px);
      box-shadow:0 20px 50px rgba(15,23,42,.4);
      border-color:rgba(99,102,241,.9);
    }

    /* KPIs */
    .kpi {
      cursor:pointer;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .kpi::before {
      content:"";
      position:absolute;
      inset:auto -40% 0;
      height:60%;
      background:radial-gradient(circle at 20% 0, rgba(79,140,255,.45), transparent 55%);
      opacity:0;
      transition:opacity .25s, transform .25s;
      transform:translateY(16px);
    }
    .kpi:hover::before {
      opacity:1;
      transform:translateY(0);
    }
    .kpi .label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em }
    .kpi .value { font-size:26px; font-weight:800; margin-top:6px }
    .kpi .sub { font-size:12px; color:var(--muted); margin-top:4px }

    /* Charts */
    .charts { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:16px }
    @media(max-width:980px){ .charts{ grid-template-columns:1fr } }

    /* Table */
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    thead th {
      position:sticky; top:0; z-index:5;
      background:rgba(9,15,32,.98);
      text-align:left; padding:10px 9px;
      border-bottom:1px solid var(--border);
      user-select:none; cursor:pointer;
      font-size:12px; color:var(--muted);
    }
    :root[data-theme="light"] thead th { background:var(--card); }
    tbody td { padding:10px 9px; border-bottom:1px solid rgba(148,163,184,.22); }
    tr:hover { background:rgba(255,255,255,.03) }
    .table-wrap {
      max-height:460px;
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:radial-gradient(circle at 0 0, rgba(79,140,255,.08), transparent 55%);
    }
    th.sortable::after { content:""; margin-left:6px; border:4px solid transparent; border-top-color:var(--muted); display:inline-block; transform:translateY(1px); }
    th.sorted-asc::after { border-bottom-color:var(--accent); border-top-color:transparent; transform:translateY(-1px); }
    th.sorted-desc::after { border-top-color:var(--accent); border-bottom-color:transparent; transform:translateY(1px); }

    .pill {
      padding:3px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      display:inline-block;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .status-Resolved { background: var(--status-resolved); color:#fff }
    .status-Under\ Development { background: var(--status-underdev); color:#fff }
    .status-Rejected { background: var(--status-rejected); color:#fff }
    .status-On\ Hold { background: var(--status-onhold); color:#fff }
    .status-Not\ Started\ Yet { background: var(--status-notstarted); color:#fff }
    .status-Sent { background: var(--status-sent); color:#fff }
    .status-On\ Stage { background: var(--status-onstage); color:#fff }

    .priority-High { background: var(--priority-high); color:#fff }
    .priority-Medium { background: var(--priority-medium); color:#fff }
    .priority-Low { background: var(--priority-low); color:#fff }

    /* Modal */
    .modal {
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.58);
      align-items:center; justify-content:center;
      z-index:100;
    }
    .modal-content {
      background:var(--card); color:var(--text);
      border:1px solid rgba(148,163,184,.35);
      padding:18px; border-radius:18px;
      max-width:760px; width:92%;
      max-height:90%; overflow:auto;
      box-shadow:var(--shadow);
    }
    .modal .header {
      display:flex; align-items:center;
      gap:10px; justify-content:space-between;
      margin-bottom:8px;
    }
    .modal .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .modal-close {
      cursor:pointer;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:20px;
    }

    /* Pagination */
    .table-actions {
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
      margin-top:10px; flex-wrap:wrap;
    }
    .pagination { display:flex; gap:6px; align-items:center }
    .chip {
      padding:6px 10px;
      border-radius:999px;
      background:rgba(9,14,30,.95);
      border:1px solid(var(--border));
      cursor:pointer;
      font-size:12px;
    }
    .chip[disabled] { opacity:.45; cursor:not-allowed }
    .chip.active { background:var(--accent); color:#fff; border-color:transparent }
    .select.sm, .input.sm { padding:6px 8px; border-radius:999px; font-size:13px }

    /* Drawer */
    .drawer-toggle { display:none }
    @media(max-width:980px){
      .drawer-toggle { display:inline-flex }
      .sidebar {
        position:fixed; inset:82px 0 0 auto;
        width:88%; max-width:360px;
        transform:translateX(110%);
        transition:transform .25s;
      }
      .sidebar.open { transform:translateX(0) }
    }

    /* Spinner & Toast */
    .spinner {
      display:none;
      position:fixed; inset:0;
      background:rgba(5,10,25,.65);
      z-index:120;
      align-items:center; justify-content:center;
    }
    .spinner .ring {
      width:56px; height:56px;
      border:5px solid var(--border);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      background:transparent;
      box-shadow:0 0 0 1px rgba(15,23,42,.4);
    }
    @keyframes spin { to { transform:rotate(360deg) } }

    .toast {
      position:fixed; right:16px; bottom:16px;
      background:var(--card);
      border:1px solid var(--accent);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      z-index:130;
      box-shadow:var(--shadow);
      display:none;
      font-size:13px;
    }

    /* Calendar styling */
    #calendar { margin-top:8px; min-height:520px; }
    .fc { font-size:13px; }
    .fc .fc-toolbar-title { font-size:16px; }
    .fc-theme-standard .fc-scrollgrid,
    .fc-theme-standard td,
    .fc-theme-standard th {
      border-color:var(--border);
    }
    .fc .fc-col-header-cell-cushion,
    .fc .fc-daygrid-day-number {
      color:var(--muted);
    }
    .fc .fc-daygrid-day.fc-day-today {
      background:rgba(79,140,255,.09);
    }
    .fc .fc-button {
      background:rgba(9,14,30,.98);
      border-color:var(--border);
      color:var(--text);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active,
    .fc .fc-button-primary:not(:disabled):focus,
    .fc .fc-button-primary:not(:disabled):hover {
      background:var(--accent);
      border-color:var(--accent);
    }
    .fc .fc-toolbar.fc-header-toolbar { margin-bottom:12px; }

    .fc-event.event-type-deployment { background-color:var(--info); border-color:var(--info); }
    .fc-event.event-type-maintenance { background-color:var(--warn); border-color:var(--warn); }
    .fc-event.event-type-release { background-color:var(--ok); border-color:var(--ok); }
    .fc-event.event-type-other { background-color:var(--purple); border-color:var(--purple); }

    /* Hide log column on narrow screens (optional) */
    @media(max-width:768px){
      td:nth-child(7), th:nth-child(7){ display:none; }
    }

    @media (prefers-reduced-motion: reduce){
      * { transition:none !important; animation:none !important }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" aria-label="InCheck brand">
      <div class="logo" aria-hidden="true">IC</div>
      <div class="brand-text">
        <span>INCHECK</span>
        <span>Issues & Ops</span>
      </div>
    </div>

    <button id="drawerBtn" class="btn drawer-toggle" aria-expanded="false" aria-controls="sidebar">
      <span class="icon" aria-hidden="true">üß∞</span> Filters
    </button>

    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search ID, title, description, log‚Ä¶" aria-label="Search issues" />
      <select id="themeSelect" class="select" aria-label="Theme">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
      <button id="refreshNow" class="btn" aria-label="Refresh from source">
        <span class="icon" aria-hidden="true">üîÑ</span> Refresh
      </button>
      <button id="exportCsv" class="btn" aria-label="Export filtered issues as CSV">
        <span class="icon" aria-hidden="true">üì•</span> Export CSV
      </button>
      <button id="createTicketBtn" class="btn primary" aria-label="Create new ticket">
        <span class="icon" aria-hidden="true">‚ûï</span> Create Ticket
      </button>
    </div>
  </header>

  <div id="loadingStatus" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <div class="wrap">
    <aside class="sidebar" id="sidebar" aria-label="Filters">
      <h3>Filters</h3>
      <div class="filter-group" role="group" aria-label="Field filters">
        <div class="filter-row">
          <label class="muted" for="moduleFilter">Module</label>
          <select id="moduleFilter" class="select" aria-label="Filter by module"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="priorityFilter">Priority</label>
          <select id="priorityFilter" class="select" aria-label="Filter by priority"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="statusFilter">Status</label>
          <select id="statusFilter" class="select" aria-label="Filter by status"></select>
        </div>
      </div>

      <div class="divider" role="separator" aria-hidden="true"></div>

      <div class="filter-group" role="group" aria-label="Date range">
        <div class="filter-row">
          <label class="muted" for="startDateFilter">Start Date</label>
          <input type="date" id="startDateFilter" class="input" aria-label="Start date">
        </div>
        <div class="filter-row">
          <label class="muted" for="endDateFilter">End Date</label>
          <input type="date" id="endDateFilter" class="input" aria-label="End date">
        </div>
      </div>

      <div class="divider" role="separator" aria-hidden="true"></div>

      <div class="filter-group">
        <button id="resetBtn" class="btn ghost" aria-label="Reset all filters">Reset</button>
        <span class="muted">
          Tip: click any KPI to filter by that status. ‚ÄúTotal Issues‚Äù resets everything.
        </span>
      </div>
    </aside>

    <main class="content">
      <div class="view-tabs" role="tablist">
        <button id="issuesTab" class="view-tab active" data-view="issues"
                role="tab" aria-selected="true" aria-controls="issuesView">
          <span class="icon" aria-hidden="true">üìã</span> Issues
        </button>
        <button id="calendarTab" class="view-tab" data-view="calendar"
                role="tab" aria-selected="false" aria-controls="calendarView">
          <span class="icon" aria-hidden="true">üìÖ</span> Calendar
        </button>
        <button id="insightsTab" class="view-tab" data-view="insights"
                role="tab" aria-selected="false" aria-controls="insightsView">
          <span class="icon" aria-hidden="true">ü§ñ</span> AI Insights
        </button>
      </div>

      <!-- Issues view -->
      <section id="issuesView" class="view active" role="tabpanel" aria-labelledby="issuesTab">
        <div class="grid cols-4" id="kpis" aria-live="polite"></div>

        <div class="charts" aria-label="Charts">
          <div class="card"><canvas id="byModule" height="140" aria-label="Issues by module" role="img"></canvas></div>
          <div class="card"><canvas id="byPriority" height="140" aria-label="Issues by priority" role="img"></canvas></div>
          <div class="card"><canvas id="byStatus" height="140" aria-label="Issues by status" role="img"></canvas></div>
          <div class="card"><canvas id="byType" height="140" aria-label="Issues by type" role="img"></canvas></div>
        </div>

        <div class="card" aria-label="Issues table">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <strong>Issues</strong>
              <div class="muted">Live feed from InCheck issues sheet.</div>
            </div>
            <span id="rowCount" class="muted" aria-live="polite"></span>
          </div>

          <div class="table-wrap" role="region" aria-label="Scrollable issues table">
            <table id="issuesTable">
              <thead><tr>
                <th data-key="id" class="sortable" scope="col" aria-sort="none">ID</th>
                <th data-key="module" class="sortable" scope="col" aria-sort="none">Module</th>
                <th data-key="title" class="sortable" scope="col" aria-sort="none">Title</th>
                <th data-key="priority" class="sortable" scope="col" aria-sort="none">Priority</th>
                <th data-key="status" class="sortable" scope="col" aria-sort="none">Status</th>
                <th data-key="date" class="sortable" scope="col" aria-sort="none">Date</th>
                <th data-key="log" class="sortable" scope="col" aria-sort="none">Log</th>
                <th scope="col">Link</th>
              </tr></thead>
              <tbody>
                <tr><td colspan="8" style="text-align:center;color:var(--muted)">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div class="table-actions">
            <div class="pagination" role="group" aria-label="Table pagination">
              <button id="firstPage" class="chip" aria-label="First page">¬´ First</button>
              <button id="prevPage" class="chip" aria-label="Previous page">‚Äπ Prev</button>
              <span id="pageInfo" class="muted" aria-live="polite"></span>
              <button id="nextPage" class="chip" aria-label="Next page">Next ‚Ä∫</button>
              <button id="lastPage" class="chip" aria-label="Last page">Last ¬ª</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <label for="pageSize" class="muted">Rows per page</label>
              <select id="pageSize" class="select sm" aria-label="Rows per page">
                <option>10</option><option selected>20</option><option>50</option><option>100</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Calendar view -->
      <section id="calendarView" class="view" role="tabpanel" aria-labelledby="calendarTab">
        <div class="card" aria-label="Calendar">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <strong>Deployments & Maintenance Calendar</strong>
              <div class="muted">
                Plan deployments, maintenance windows, releases, and other operational events.
              </div>
            </div>
            <button id="addEventBtn" class="btn primary sm" type="button">
              <span class="icon" aria-hidden="true">‚ûï</span> Add Event
            </button>
          </div>
          <div id="calendar" aria-label="Deployment & maintenance calendar"></div>
        </div>
      </section>

      <!-- AI Insights / Copilot view -->
      <section id="insightsView" class="view" role="tabpanel" aria-labelledby="insightsTab">
        <div class="card" aria-label="AI Insights summary">
          <strong>AI Insights / Copilot</strong>
          <div class="muted" style="margin-top:4px;">
            Analyses issues text (title, description, log) to surface patterns, suggested categories, clusters, trends,
            triage suggestions, and deployment risk. Runs fully in the browser (heuristics, no external AI calls).
          </div>
        </div>

        <div class="grid cols-4" aria-label="AI summary cards">
          <div class="card">
            <strong>Top terms (recent)</strong>
            <ul id="aiPatternsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Suggested categories</strong>
            <ul id="aiLabelsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
          </div>
          <div class="card">
            <strong>Dataset used</strong>
            <div id="aiScopeText" class="muted" style="font-size:13px;margin-top:6px;"></div>
          </div>
          <div class="card">
            <strong>Signals</strong>
            <div id="aiSignalsText" class="muted" style="font-size:13px;margin-top:6px;"></div>
          </div>
        </div>

        <div class="card">
          <strong>Trends & bursts (last 14 days)</strong>
          <ul id="aiTrendsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>Per-module risk insights</strong>
          <div class="table-wrap" role="region" aria-label="AI per-module insights" style="max-height:320px;">
            <table id="aiModulesTable">
              <thead>
                <tr>
                  <th scope="col">Module</th>
                  <th scope="col">Open</th>
                  <th scope="col">High P</th>
                  <th scope="col">Risk sum</th>
                  <th scope="col">Top term</th>
                </tr>
              </thead>
              <tbody id="aiModulesTableBody">
                <tr><td colspan="5" style="text-align:center;color:var(--muted)">Waiting for data‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <strong>Top risks this week</strong>
          <ul id="aiRisksList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>Similar issue clusters</strong>
          <div id="aiClusters" style="margin-top:6px;display:grid;gap:10px;"></div>
        </div>

        <div class="card">
          <strong>Triage queue (issues needing attention)</strong>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            Focus on issues missing module / priority / type, ordered by risk. Suggestions are heuristic.
          </div>
          <ul id="aiTriageList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>Upcoming risky events (next 7 days)</strong>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            Combines calendar events with open, high-risk issues in related modules (by title matching).
          </div>
          <ul id="aiEventsList" class="muted" style="font-size:13px;margin-top:6px;padding-left:18px;"></ul>
        </div>

        <div class="card">
          <strong>AI Commands (experimental)</strong>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            Example queries: <br>
            <code>payments high prod timeout</code> ‚Ä¢
            <code>module:billing priority:high</code> ‚Ä¢
            <code>status:open login error</code>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
            <input id="aiQueryInput" class="input" type="text" placeholder="Ask about issues (filters & keywords)‚Ä¶"
                   style="flex:1;min-width:220px;">
            <button id="aiQueryRun" class="btn sm" type="button">Run</button>
          </div>
          <div id="aiQueryResults" class="muted" style="font-size:13px;margin-top:8px;"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Issue Modal -->
  <div id="issueModal" class="modal" role="dialog" aria-modal="true"
       aria-labelledby="modalTitle" aria-describedby="modalBody">
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle" style="margin:0;font-size:20px">Issue</h2>
        <div class="actions">
          <button id="copyId" class="btn sm" aria-label="Copy issue ID">
            <span class="icon" aria-hidden="true">üÜî</span> Copy ID
          </button>
          <button id="copyLink" class="btn sm" aria-label="Copy issue link">
            <span class="icon" aria-hidden="true">üîó</span> Copy Link
          </button>
          <button class="modal-close" id="modalClose" aria-label="Close">‚úï</button>
        </div>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="eventModal" class="modal" role="dialog" aria-modal="true"
       aria-labelledby="eventModalTitle" aria-describedby="eventModalBody">
    <div class="modal-content">
      <div class="header">
        <h2 id="eventModalTitle" style="margin:0;font-size:20px">Event</h2>
        <div class="actions">
          <button class="modal-close" id="eventModalClose" aria-label="Close event dialog">‚úï</button>
        </div>
      </div>

      <form id="eventForm">
        <div id="eventModalBody">
          <div class="filter-group">
            <div class="filter-row">
              <label class="muted" for="eventTitle">Title</label>
              <input id="eventTitle" class="input" type="text" required
                     placeholder="e.g. Prod deployment v2.3" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventType">Type</label>
              <select id="eventType" class="select">
                <option value="Deployment">Deployment</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Release">Release</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-row">
              <label class="muted" for="eventStart">Start</label>
              <input id="eventStart" class="input" type="datetime-local" required />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventEnd">End (optional)</label>
              <input id="eventEnd" class="input" type="datetime-local" />
            </div>
            <div class="filter-row">
              <label class="muted" for="eventDescription">Notes</label>
              <textarea id="eventDescription" class="input" rows="3"
                        placeholder="Details, impact, owner‚Ä¶"
                        style="border-radius:12px; resize:vertical;"></textarea>
            </div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="eventSave" type="submit" class="btn primary sm">
              üíæ Save Event
            </button>
            <button id="eventCancel" type="button" class="btn ghost sm">
              Cancel
            </button>
          </div>
          <button id="eventDelete" type="button" class="btn sm"
                  style="background:transparent;border-color:var(--danger);color:var(--danger);display:none">
            üóë Delete
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="spinner" id="spinner" aria-hidden="true"><div class="ring"></div></div>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";

  // Google Apps Script Web App for calendar events (wrapped via CORS proxy)
  const CALENDAR_API_URL =
    "https://corsproxy.io/?" +
    encodeURIComponent("https://script.google.com/macros/s/AKfycbwRcF-CbJY3dNfU9QQWixGL82a5BqCxVII4sGJSKunJ_fhDLLezL90kUXoqMrHuYytV/exec");

  function q(sel, root = document) { return root.querySelector(sel); }
  function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }

  const els = {
    table: q('#issuesTable'),
    tableBody: q('#issuesTable tbody'),
    rowCount: q('#rowCount'),
    moduleFilter: q('#moduleFilter'),
    priorityFilter: q('#priorityFilter'),
    statusFilter: q('#statusFilter'),
    reset: q('#resetBtn'),
    refresh: q('#refreshNow'),
    exportCsv: q('#exportCsv'),
    kpis: q('#kpis'),
    modal: q('#issueModal'),
    modalBody: q('#modalBody'),
    modalTitle: q('#modalTitle'),
    copyId: q('#copyId'),
    copyLink: q('#copyLink'),
    closeModalBtn: q('#modalClose'),
    drawerBtn: q('#drawerBtn'),
    sidebar: q('#sidebar'),
    spinner: q('#spinner'),
    toast: q('#toast'),
    search: q('#searchInput'),
    themeSelect: q('#themeSelect'),
    firstPage: q('#firstPage'),
    prevPage: q('#prevPage'),
    nextPage: q('#nextPage'),
    lastPage: q('#lastPage'),
    pageInfo: q('#pageInfo'),
    pageSize: q('#pageSize'),
    createTicket: q('#createTicketBtn'),
    startDateFilter: q('#startDateFilter'),
    endDateFilter: q('#endDateFilter'),
    loadingStatus: q('#loadingStatus'),
    viewTabs: qAll('.view-tab'),
    issuesView: q('#issuesView'),
    calendarView: q('#calendarView'),
    insightsView: q('#insightsView'),
    addEventBtn: q('#addEventBtn'),
    eventModal: q('#eventModal'),
    eventModalTitle: q('#eventModalTitle'),
    eventModalClose: q('#eventModalClose'),
    eventForm: q('#eventForm'),
    eventTitle: q('#eventTitle'),
    eventType: q('#eventType'),
    eventStart: q('#eventStart'),
    eventEnd: q('#eventEnd'),
    eventDescription: q('#eventDescription'),
    eventSave: q('#eventSave'),
    eventCancel: q('#eventCancel'),
    eventDelete: q('#eventDelete'),
    aiPatternsList: q('#aiPatternsList'),
    aiLabelsList: q('#aiLabelsList'),
    aiRisksList: q('#aiRisksList'),
    aiClusters: q('#aiClusters'),
    aiScopeText: q('#aiScopeText'),
    aiSignalsText: q('#aiSignalsText'),
    aiTrendsList: q('#aiTrendsList'),
    aiModulesTableBody: q('#aiModulesTableBody'),
    aiTriageList: q('#aiTriageList'),
    aiEventsList: q('#aiEventsList'),
    aiQueryInput: q('#aiQueryInput'),
    aiQueryRun: q('#aiQueryRun'),
    aiQueryResults: q('#aiQueryResults')
  };

  let rows = [], filtered = [], charts = {};
  let sortKey = null, sortAsc = true;
  let currentPage = 1;
  let rowsPerPage = +(localStorage.getItem('pageSize') || (els.pageSize ? els.pageSize.value : 20));
  if (els.pageSize) els.pageSize.value = String(rowsPerPage);
  let selectedIssue = null;
  let lastFocusedBeforeIssueModal = null;
  let lastFocusedBeforeEventModal = null;

  let eventsData = [];
  let calendar = null;
  let calendarInitialized = false;
  let editingEventId = null;

  // ----- AI / Copilot helpers -----
  const STOPWORDS = new Set([
    'the','a','an','and','or','but','for','with','this','that','from','into','onto',
    'when','what','where','how','why','can','could','should','would','will','just',
    'have','has','had','been','are','is','was','were','to','in','on','of','at','by',
    'as','it','its','be','we','you','they','our','your','their','not','no','if','else',
    'then','than','about','after','before','more','less','also','only','very','get',
    'got','see','seen','use','used','using','user','issue','bug','ticket','inc'
  ]);

  const LABEL_KEYWORDS = {
    'Authentication / Login': ['login','signin','sign in','password','auth','token','session','otp'],
    'Payments / Billing': ['payment','payments','billing','invoice','card','credit','charge','checkout','refund'],
    'Performance / Latency': ['slow','slowness','latency','performance','perf','timeout','time out','lag'],
    'Reliability / Errors': ['error','errors','exception','500','503','fail','failed','crash','down','unavailable'],
    'UI / UX': ['button','screen','page','layout','css','ui','ux','alignment','typo'],
    'Data / Sync': ['sync','synchron','cache','cached','replica','replication','consistency','out of date']
  };

  function issueText(issue) {
    return [issue.title, issue.desc, issue.log]
      .filter(Boolean)
      .join(' ')
      .toLowerCase();
  }

  function tokenizeIssue(issue) {
    const text = issueText(issue);
    return text
      .replace(/[^a-z0-9]+/g, ' ')
      .split(/\s+/)
      .filter(w => w && w.length > 2 && !STOPWORDS.has(w));
  }

  function getRecentIssues(base, days = 7) {
    const now = Date.now();
    const cutoff = now - days * 24 * 60 * 60 * 1000;
    const recent = base.filter(r => {
      if (!r.date) return false;
      const d = new Date(r.date);
      if (isNaN(d)) return false;
      return d.getTime() >= cutoff;
    });
    if (recent.length) return recent;
    return base.slice(-50);
  }

  function computeRiskScore(issue) {
    const priorityWeight = { High: 3, Medium: 2, Low: 1 };
    let score = priorityWeight[issue.priority] || 1;
    const text = issueText(issue);

    const boosts = [
      { kw: 'prod ', val: 2 },
      { kw: 'production', val: 2 },
      { kw: 'timeout', val: 3 },
      { kw: 'time out', val: 3 },
      { kw: 'error', val: 2 },
      { kw: 'errors', val: 2 },
      { kw: 'exception', val: 2 },
      { kw: 'fail', val: 2 },
      { kw: 'failed', val: 2 },
      { kw: 'crash', val: 3 },
      { kw: 'down', val: 3 },
      { kw: 'payment', val: 3 },
      { kw: 'payments', val: 3 },
      { kw: 'billing', val: 2 },
      { kw: 'checkout', val: 2 },
      { kw: 'refund', val: 2 },
      { kw: 'login', val: 2 },
      { kw: 'auth', val: 2 },
      { kw: 'vip', val: 2 },
      { kw: 'all users', val: 3 },
      { kw: 'cannot', val: 2 },
      { kw: 'blocked', val: 2 }
    ];

    boosts.forEach(b => {
      if (text.includes(b.kw)) score += b.val;
    });

    const st = (issue.status || '').toLowerCase();
    if (st.startsWith('on stage')) score += 2;
    if (st.startsWith('under')) score += 1;

    return score;
  }

  function suggestCategories(issue) {
    const text = issueText(issue);
    const res = [];
    Object.entries(LABEL_KEYWORDS).forEach(([label, keywords]) => {
      let hits = 0;
      keywords.forEach(k => { if (text.includes(k)) hits++; });
      if (hits > 0) res.push({ label, score: hits });
    });
    res.sort((a,b) => b.score - a.score);
    return res;
  }

  function suggestPriority(issue) {
    if (issue.priority) return issue.priority;
    const score = computeRiskScore(issue);
    if (score >= 10) return 'High';
    if (score >= 6) return 'Medium';
    return 'Low';
  }

  function needsTriage(issue) {
    const missingPriority = !issue.priority;
    const missingModule = !issue.module || issue.module === 'Unspecified';
    const missingType = !issue.type;
    return missingPriority || missingModule || missingType;
  }

  function computeTriageQueue(base, maxItems = 15) {
    const items = [];
    base.forEach(issue => {
      if (!needsTriage(issue)) return;
      const cats = suggestCategories(issue);
      const prio = suggestPriority(issue);
      items.push({ issue, suggestedCategories: cats, suggestedPriority: prio });
    });
    items.sort((a,b) => computeRiskScore(b.issue) - computeRiskScore(a.issue));
    return items.slice(0, maxItems);
  }

  function computeTermTrends(base) {
    const windowDays = 14;
    const recent = getRecentIssues(base, windowDays);
    if (!recent.length) return [];
    const now = Date.now();
    const midCutoff = now - 7 * 24 * 60 * 60 * 1000;

    const oldCounts = new Map();
    const newCounts = new Map();

    recent.forEach(issue => {
      if (!issue.date) return;
      const d = new Date(issue.date);
      if (isNaN(d)) return;
      const isNew = d.getTime() >= midCutoff;
      const target = isNew ? newCounts : oldCounts;
      const toks = tokenizeIssue(issue);
      const uniq = new Set(toks);
      uniq.forEach(t => {
        target.set(t, (target.get(t) || 0) + 1);
      });
    });

    const terms = new Set([...oldCounts.keys(), ...newCounts.keys()]);
    const results = [];
    terms.forEach(term => {
      const oldC = oldCounts.get(term) || 0;
      const newC = newCounts.get(term) || 0;
      const total = oldC + newC;
      if (total < 2) return;
      const delta = newC - oldC;
      const ratio = oldC === 0 ? (newC >= 2 ? Infinity : 0) : newC / oldC;
      if ((newC >= 2 && ratio >= 2) || delta >= 2) {
        results.push({ term, old: oldC, recent: newC, delta, ratio });
      }
    });

    results.sort((a,b) => {
      if (a.ratio === Infinity && b.ratio !== Infinity) return -1;
      if (b.ratio === Infinity && a.ratio !== Infinity) return 1;
      if (b.delta !== a.delta) return b.delta - a.delta;
      return b.recent - a.recent;
    });

    return results.slice(0, 8);
  }

  function computeModuleInsights(base) {
    const map = new Map();
    base.forEach(issue => {
      const moduleName = issue.module || 'Unspecified';
      let entry = map.get(moduleName);
      if (!entry) {
        entry = {
          module: moduleName,
          total: 0,
          open: 0,
          high: 0,
          riskSum: 0,
          tokens: new Map()
        };
        map.set(moduleName, entry);
      }
      entry.total++;
      const st = (issue.status || '').toLowerCase();
      const isResolved = st.startsWith('resolved');
      if (!isResolved) {
        entry.open++;
        if (issue.priority === 'High') entry.high++;
      }
      const rs = computeRiskScore(issue);
      entry.riskSum += rs;

      const toks = tokenizeIssue(issue);
      const uniq = new Set(toks);
      uniq.forEach(t => {
        entry.tokens.set(t, (entry.tokens.get(t) || 0) + 1);
      });
    });

    return Array.from(map.values()).map(entry => {
      let topTerm = '';
      if (entry.tokens.size) {
        topTerm = Array.from(entry.tokens.entries())
          .sort((a,b) => b[1] - a[1])[0][0];
      }
      return {
        module: entry.module,
        total: entry.total,
        open: entry.open,
        high: entry.high,
        risk: entry.riskSum,
        topTerm
      };
    }).sort((a,b) => {
      if (b.risk !== a.risk) return b.risk - a.risk;
      return b.open - a.open;
    }).slice(0, 8);
  }

  function buildSimilarClusters(base) {
    const clusters = [];
    const maxDocs = 400; // safety limit
    const docs = base.slice(-maxDocs).map(issue => {
      const toks = tokenizeIssue(issue);
      const set = new Set(toks);
      return { issue, tokens: set };
    });

    const visited = new Set();

    function jaccard(a, b) {
      if (!a.size || !b.size) return 0;
      let inter = 0;
      a.forEach(v => { if (b.has(v)) inter++; });
      const union = a.size + b.size - inter;
      return union === 0 ? 0 : inter / union;
    }

    for (let i = 0; i < docs.length; i++) {
      if (visited.has(i)) continue;
      const baseDoc = docs[i];
      const cluster = [baseDoc];
      visited.add(i);

      for (let j = i + 1; j < docs.length; j++) {
        if (visited.has(j)) continue;
        const other = docs[j];
        const sim = jaccard(baseDoc.tokens, other.tokens);
        if (sim >= 0.35) {
          visited.add(j);
          cluster.push(other);
        }
      }

      if (cluster.length >= 2) {
        const tokenFreq = new Map();
        cluster.forEach(d => {
          d.tokens.forEach(t => {
            tokenFreq.set(t, (tokenFreq.get(t) || 0) + 1);
          });
        });
        const signatureTokens = Array.from(tokenFreq.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0,3)
          .map(([t]) => t);
        const signature = signatureTokens.join(' ');
        clusters.push({
          signature,
          issues: cluster.map(c => c.issue)
        });
      }
    }

    clusters.sort((a,b) => b.issues.length - a.issues.length);
    return clusters.slice(0, 6);
  }

  function parseAiQuery(text) {
    const lower = text.toLowerCase();
    let working = ' ' + lower + ' ';
    const result = {
      module: null,
      status: null,
      priority: null,
      id: null,
      freeWords: []
    };

    const patterns = [
      { key: 'module',  re: /\bmodule:([^\s]+)/ },
      { key: 'status',  re: /\bstatus:([^\s]+)/ },
      { key: 'priority',re: /\bpriority:([^\s]+)/ },
      { key: 'id',      re: /\bid:([^\s]+)/ }
    ];

    patterns.forEach(p => {
      const m = working.match(p.re);
      if (m) {
        result[p.key] = m[1].trim();
        working = working.replace(m[0], ' ');
      }
    });

    const words = working.split(/\s+/).filter(Boolean);
    result.freeWords = words.filter(w => !STOPWORDS.has(w) && w.length > 2);
    return result;
  }

  function filterIssueByAiQuery(issue, query) {
    const moduleVal = query.module;
    const priorityVal = query.priority;
    const statusVal = query.status;
    const idVal = query.id;
    const freeWords = query.freeWords || [];

    if (moduleVal) {
      const mod = (issue.module || '').toLowerCase();
      if (!mod.includes(moduleVal)) return false;
    }

    if (priorityVal) {
      const p = priorityVal[0].toUpperCase();
      if (['H','M','L'].includes(p)) {
        if ((issue.priority || '').charAt(0) !== p) return false;
      } else {
        if (!(issue.priority || '').toLowerCase().includes(priorityVal.toLowerCase())) return false;
      }
    }

    if (statusVal) {
      const st = (issue.status || '').toLowerCase();
      if (statusVal === 'open') {
        if (st.startsWith('resolved') || st.startsWith('rejected')) return false;
      } else if (statusVal === 'closed') {
        if (!st.startsWith('resolved') && !st.startsWith('rejected')) return false;
      } else {
        if (!st.includes(statusVal)) return false;
      }
    }

    if (idVal) {
      const idTxt = (issue.id || '').toLowerCase();
      if (!idTxt.includes(idVal)) return false;
    }

    if (freeWords.length) {
      const text = issueText(issue);
      for (const w of freeWords) {
        if (!text.includes(w)) return false;
      }
    }

    return true;
  }

  function runAiQuery() {
    if (!els.aiQueryResults) return;
    const input = (els.aiQueryInput && els.aiQueryInput.value || '').trim();
    if (!input) {
      els.aiQueryResults.textContent = 'Type a query using keywords and optional filters like module:, status:, priority:.';
      return;
    }

    const base = rows || [];
    if (!base.length) {
      els.aiQueryResults.textContent = 'No issues loaded yet.';
      return;
    }

    const query = parseAiQuery(input);
    const matches = base.filter(issue => filterIssueByAiQuery(issue, query));
    matches.sort((a,b) => computeRiskScore(b) - computeRiskScore(a));

    if (!matches.length) {
      els.aiQueryResults.textContent = 'No issues matched this query.';
      return;
    }

    const limited = matches.slice(0, 20);
    els.aiQueryResults.innerHTML = `
      <div style="margin-bottom:6px;">
        Found <strong>${matches.length}</strong> issue${matches.length>1?'s':''} (showing top ${limited.length} by risk).
      </div>
      <ul style="padding-left:18px;margin:0;">
        ${limited.map(i => `
          <li style="margin-bottom:4px;">
            <button type="button" class="btn sm" style="padding:3px 6px;margin-right:4px;"
                    data-open-issue="${escapeAttr(i.id || '')}">
              ${escapeHtml(i.id || '')}
            </button>
            [${escapeHtml(i.priority || '-')} ¬∑ ${escapeHtml(i.status || '-')}]
            ${escapeHtml(i.title || '(no title)')}
          </li>
        `).join('')}
      </ul>
    `;

    els.aiQueryResults.querySelectorAll('button[data-open-issue]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-open-issue');
        if (id) openIssueModal(id);
      });
    });
  }

  function computeEventsRisk(base, events) {
    if (!events || !events.length) return [];
    const now = new Date();
    const limit = new Date(now.getTime() + 7*24*60*60*1000);

    const openIssues = base.filter(i => {
      const st = (i.status || '').toLowerCase();
      return !st.startsWith('resolved') && !st.startsWith('rejected');
    });

    const moduleNames = Array.from(new Set(openIssues.map(i => i.module).filter(Boolean)));

    const results = [];
    events.forEach(ev => {
      if (!ev.start) return;
      const d = new Date(ev.start);
      if (isNaN(d) || d < now || d > limit) return;

      const title = (ev.title || '').toLowerCase();
      const impactedModules = moduleNames.filter(m => m && title.includes(m.toLowerCase()));

      let issues = [];
      if (impactedModules.length) {
        issues = openIssues.filter(i => impactedModules.includes(i.module));
      } else if ((ev.type || '').toLowerCase() === 'deployment' || (ev.type || '').toLowerCase() === 'release') {
        const recentOpen = getRecentIssues(openIssues, 7);
        issues = recentOpen.filter(i => computeRiskScore(i) >= 8);
      }

      if (!issues.length) return;
      const totalRisk = issues.reduce((sum, iss) => sum + computeRiskScore(iss), 0);

      results.push({ event: ev, modules: impactedModules, issues, risk: totalRisk, date: d });
    });

    results.sort((a,b) => b.risk - a.risk);
    return results.slice(0, 5);
  }

  function renderAiInsights() {
    if (!els.aiPatternsList || !els.aiLabelsList || !els.aiRisksList || !els.aiClusters) return;

    const base = (filtered && filtered.length ? filtered : rows || []);
    const total = base.length;

    if (!total) {
      els.aiPatternsList.innerHTML = '<li>No issues loaded yet.</li>';
      els.aiLabelsList.innerHTML = '<li>No data.</li>';
      els.aiRisksList.innerHTML = '<li>No data.</li>';
      els.aiClusters.innerHTML = '<div class="muted">No data.</div>';
      if (els.aiScopeText) els.aiScopeText.textContent = 'Waiting for issues to load.';
      if (els.aiSignalsText) els.aiSignalsText.textContent = 'No signals yet.';
      if (els.aiTrendsList) els.aiTrendsList.innerHTML = '<li>No data.</li>';
      if (els.aiModulesTableBody) els.aiModulesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No data.</td></tr>';
      if (els.aiTriageList) els.aiTriageList.innerHTML = '<li>No issues requiring triage found.</li>';
      if (els.aiEventsList) els.aiEventsList.innerHTML = '<li>No upcoming events with notable risk (or no events loaded).</li>';
      return;
    }

    const recent = getRecentIssues(base, 7);
    const recentCount = recent.length;

    // Top terms (recent)
    const termCounts = new Map();
    recent.forEach(issue => {
      tokenizeIssue(issue).forEach(t => {
        termCounts.set(t, (termCounts.get(t) || 0) + 1);
      });
    });

    const topTerms = Array.from(termCounts.entries())
      .filter(([,count]) => count >= 2)
      .sort((a,b) => b[1] - a[1])
      .slice(0, 10);

    els.aiPatternsList.innerHTML = topTerms.length
      ? topTerms.map(([t,c]) => `<li><strong>${t}</strong> ‚Äì ${c} mention${c>1?'s':''}</li>`).join('')
      : '<li>No strong repeated terms in recent issues.</li>';

    // Suggested categories
    const labelStats = [];
    Object.entries(LABEL_KEYWORDS).forEach(([label, keywords]) => {
      let matches = 0;
      base.forEach(issue => {
        const text = issueText(issue);
        if (keywords.some(k => text.includes(k))) matches++;
      });
      if (matches > 0) labelStats.push({ label, matches });
    });
    labelStats.sort((a,b) => b.matches - a.matches);

    els.aiLabelsList.innerHTML = labelStats.length
      ? labelStats.slice(0, 8).map(ls =>
          `<li><strong>${ls.label}</strong> ‚Äì ${ls.matches} issue${ls.matches>1?'s':''}</li>`
        ).join('')
      : '<li>No clear category suggestions yet.</li>';

    if (els.aiScopeText) {
      els.aiScopeText.textContent =
        `Analyzing ${total} issues (${recentCount} recent, ~last 7 days) using current filters.`;
    }

    if (els.aiSignalsText) {
      const signals = [];
      const hasTimeout = termCounts.has('timeout');
      const hasPayment = termCounts.has('payment') || termCounts.has('payments') || termCounts.has('billing') || termCounts.has('checkout');
      const hasAuth = termCounts.has('login') || termCounts.has('auth') || termCounts.has('password') || termCounts.has('otp');
      const hasErrors = termCounts.has('error') || termCounts.has('errors') || termCounts.has('exception') || termCounts.has('crash');

      if (hasTimeout) signals.push('timeouts / latency');
      if (hasPayment) signals.push('payments / billing');
      if (hasAuth) signals.push('auth / login flows');
      if (hasErrors) signals.push('errors / exceptions');

      els.aiSignalsText.textContent = signals.length
        ? 'Recent issues frequently mention: ' + signals.join(', ') + '.'
        : 'No strong recurring signals detected in recent issues.';
    }

    // Trends & bursts (last 14 days)
    if (els.aiTrendsList) {
      const trends = computeTermTrends(base);
      els.aiTrendsList.innerHTML = trends.length
        ? trends.map(t => `
            <li>
              <strong>${t.term}</strong> ‚Äì ${t.recent} recent vs ${t.old} earlier
              <span class="muted">(Œî ${t.delta >= 0 ? '+'+t.delta : t.delta})</span>
            </li>
          `).join('')
        : '<li>No strong term increases detected between last and previous week.</li>';
    }

    // Module insights
    if (els.aiModulesTableBody) {
      const mods = computeModuleInsights(base);
      els.aiModulesTableBody.innerHTML = mods.length
        ? mods.map(m => `
            <tr>
              <td>${escapeHtml(m.module)}</td>
              <td>${m.open}</td>
              <td>${m.high}</td>
              <td>${m.risk}</td>
              <td>${escapeHtml(m.topTerm || '-')}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No modules to show.</td></tr>';
    }

    // Top risks this week
    const recentWithScores = recent.map(issue => ({
      issue,
      score: computeRiskScore(issue)
    })).sort((a,b) => b.score - a.score);

    const topRisks = recentWithScores.slice(0, 5).filter(r => r.score > 2);

    els.aiRisksList.innerHTML = topRisks.length
      ? topRisks.map(({issue, score}) => `
          <li style="margin-bottom:4px;">
            <strong>[${issue.priority || '-'}] ${issue.id || '(no ID)'}</strong> ‚Äì ${escapeHtml(issue.title || '(no title)')}
            <br><span class="muted">Risk score: ${score}, status: ${escapeHtml(issue.status || '-')}</span>
          </li>
        `).join('')
      : '<li>No high-risk recent issues detected by the heuristic.</li>';

    // Similar issue clusters
    const clusters = buildSimilarClusters(base);
    if (!clusters.length) {
      els.aiClusters.innerHTML = '<div class="muted">No similar issue groups with at least 2 tickets.</div>';
    } else {
      els.aiClusters.innerHTML = clusters.map(c => `
        <div class="card" style="padding:10px;">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">
            Pattern: <strong>${escapeHtml(c.signature || '(no pattern)')}</strong>
            ‚Ä¢ ${c.issues.length} issue${c.issues.length>1?'s':''}
          </div>
          <ul style="margin:0;padding-left:18px;font-size:13px;">
            ${c.issues.slice(0,5).map(i => `
              <li>
                <button type="button" class="btn sm" style="padding:3px 6px;margin-right:4px;"
                        data-open-issue="${escapeAttr(i.id || '')}">
                  ${escapeHtml(i.id || '')}
                </button>
                ${escapeHtml(i.title || '(no title)')}
              </li>
            `).join('')}
            ${c.issues.length > 5 ? `<li class="muted">+ ${c.issues.length - 5} more‚Ä¶</li>` : ''}
          </ul>
        </div>
      `).join('');

      els.aiClusters.querySelectorAll('button[data-open-issue]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-open-issue');
          if (id) openIssueModal(id);
        });
      });
    }

    // Triage queue
    if (els.aiTriageList) {
      const tri = computeTriageQueue(base);
      els.aiTriageList.innerHTML = tri.length
        ? tri.map(item => {
            const i = item.issue;
            const missing = [];
            if (!i.priority) missing.push('priority');
            if (!i.module || i.module === 'Unspecified') missing.push('module');
            if (!i.type) missing.push('type');
            const cats = item.suggestedCategories.slice(0,2).map(c => c.label).join(', ') || 'n/a';

            return `
              <li style="margin-bottom:6px;">
                <strong>${escapeHtml(i.id || '(no ID)')}</strong> ‚Äì ${escapeHtml(i.title || '(no title)')}<br>
                <span class="muted">
                  Missing: ${missing.join(', ') || '‚Äî'} ¬∑
                  Suggested priority: ${item.suggestedPriority} ¬∑
                  Suggested categories: ${escapeHtml(cats)}
                </span>
              </li>
            `;
          }).join('')
        : '<li>No issues requiring triage found.</li>';
    }

    // Upcoming risky events (calendar + issues)
    if (els.aiEventsList) {
      const evResults = computeEventsRisk(rows || [], eventsData || []);
      els.aiEventsList.innerHTML = evResults.length
        ? evResults.map(r => `
            <li style="margin-bottom:6px;">
              <strong>${escapeHtml(r.event.title || '(no title)')}</strong>
              <span class="muted">
                ‚Ä¢ ${r.date.toISOString().slice(0,16).replace('T',' ')} ‚Ä¢ risk score sum: ${r.risk}
              </span><br>
              <span class="muted">
                Modules: ${r.modules.length ? r.modules.map(m => escapeHtml(m)).join(', ') : 'not inferred'}
                ‚Ä¢ Related issues: ${r.issues.length}
              </span>
            </li>
          `).join('')
        : '<li>No upcoming events with notable risk in the next 7 days.</li>';
    }
  }
  const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

  const showSpinner = (v=true)=> {
    if (!els.spinner) return;
    els.spinner.style.display = v ? 'flex' : 'none';
    if (els.loadingStatus) {
      els.loadingStatus.textContent = v ? 'Loading‚Ä¶' : '';
    }
  };
  const showToast = (msg, ms=3500) => {
    if (!els.toast) return;
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    setTimeout(()=>{ if (els.toast) els.toast.style.display='none'; }, ms);
  };

  function normalizeStatus(rawStatus) {
    const s = (rawStatus || '').trim().toLowerCase();
    if (!s) return 'Not Started Yet';
    if (s.startsWith('resolved')) return 'Resolved';
    if (s.startsWith('under')) return 'Under Development';
    if (s.startsWith('rejected')) return 'Rejected';
    if (s.startsWith('on hold')) return 'On Hold';
    if (s.startsWith('not started')) return 'Not Started Yet';
    if (s.startsWith('sent')) return 'Sent';
    if (s.startsWith('on stage')) return 'On Stage';
    return rawStatus || 'Not Started Yet';
  }
  function normalizePriority(rawPriority) {
    const s = (rawPriority || '').trim().toLowerCase();
    if (!s) return '';
    if (s.startsWith('h')) return 'High';
    if (s.startsWith('m')) return 'Medium';
    if (s.startsWith('l')) return 'Low';
    return rawPriority;
  }

  function normalizeRow(raw){
    const lower={};
    for(const k in raw){
      if(!k) continue;
      lower[k.toLowerCase().replace(/\s+/g,' ').trim()] = String(raw[k] ?? '').trim();
    }
    const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
    return {
      id: pick('ticket id','id'),
      module: (pick('impacted module','module','issue location')||'Unspecified'),
      title: pick('title'),
      desc: pick('description'),
      file: pick('file upload','link','url'),
      priority: normalizePriority(pick('priority')),
      status: normalizeStatus(pick('status') || 'Not Started Yet'),
      type: pick('category','type'),
      date: pick('timestamp','date','created at'),
      log: pick('log','logs','comment','notes')
    };
  }

  function parseCsv(t){
    if (typeof Papa === 'undefined') return [];
    return Papa.parse(t,{header:true,skipEmptyLines:true})
      .data
      .map(normalizeRow)
      .filter(r => r.id && r.id.trim() !== "");
  }

  function pill(text,cls){ return `<span class="pill ${cls}">${text||'-'}</span>`; }
  const statusBadge = s => pill(s,`status-${(s||'').replace(/\s/g,'\\ ')}`);
  const priorityBadge = p => pill(p,`priority-${p||''}`);

  function applySystemThemeFromOS(){
    if (!mediaQuery) return;
    if (mediaQuery.matches) {
      document.documentElement.removeAttribute('data-theme');
    } else {
      document.documentElement.setAttribute('data-theme','light');
    }
  }

  function applyTheme(mode) {
    localStorage.setItem('theme', mode);
    if (mode === 'system') {
      applySystemThemeFromOS();
      return;
    }
    if (mode === 'dark') {
      document.documentElement.removeAttribute('data-theme');
    } else if (mode === 'light') {
      document.documentElement.setAttribute('data-theme','light');
    }
  }

  function initTheme() {
    const saved = localStorage.getItem('theme') || 'system';
    if (els.themeSelect) els.themeSelect.value = saved;
    if (saved === 'system') {
      applySystemThemeFromOS();
    } else {
      applyTheme(saved);
    }
    if (mediaQuery) {
      mediaQuery.addEventListener('change', () => {
        const current = localStorage.getItem('theme') || 'system';
        if (current === 'system') applySystemThemeFromOS();
      });
    }
  }

  function saveFilters(){
    const state = {
      search: els.search ? (els.search.value || '') : '',
      module: els.moduleFilter ? (els.moduleFilter.value || 'All') : 'All',
      priority: els.priorityFilter ? (els.priorityFilter.value || 'All') : 'All',
      status: els.statusFilter ? (els.statusFilter.value || 'All') : 'All',
      start: els.startDateFilter ? (els.startDateFilter.value || '') : '',
      end: els.endDateFilter ? (els.endDateFilter.value || '') : ''
    };
    try {
      localStorage.setItem('incheckFilters', JSON.stringify(state));
    } catch(e){}
  }

  function loadFilters(){
    try {
      const raw = localStorage.getItem('incheckFilters');
      if (!raw) return;
      const s = JSON.parse(raw);
      if (els.search) els.search.value = s.search || '';

      const setIfOptionExists = (select, value) => {
        if (!select || !value) return;
        const options = Array.from(select.options);
        if (options.some(o => o.value === value)) {
          select.value = value;
        }
      };

      setIfOptionExists(els.moduleFilter, s.module);
      setIfOptionExists(els.priorityFilter, s.priority);
      setIfOptionExists(els.statusFilter, s.status);
      if (els.startDateFilter) els.startDateFilter.value = s.start || '';
      if (els.endDateFilter) els.endDateFilter.value = s.end || '';
    } catch(e){
      console.error('Failed to restore filters', e);
    }
  }

  function renderKpis(){
    if (!els.kpis) return;
    const total = filtered.length; const counts = {};
    filtered.forEach(r=>{ counts[r.status]=(counts[r.status]||0)+1; });
    els.kpis.innerHTML='';
    const add=(label,val)=>{
      const pct = total ? Math.round((val*100)/total) : 0;
      const d=document.createElement('div');
      d.className='card kpi';
      d.setAttribute('role','button');
      d.setAttribute('tabindex','0');
      d.setAttribute('aria-label',`${label}: ${val} (${pct} percent)`);
      d.innerHTML=`<div class="label">${label}</div><div class="value">${val}</div><div class="sub">${pct}%</div>`;
      d.onclick=()=>{
        if(label === 'Total Issues'){
          if (els.search) els.search.value = '';
          if (els.startDateFilter) els.startDateFilter.value = '';
          if (els.endDateFilter) els.endDateFilter.value = '';
          if (els.moduleFilter) els.moduleFilter.value = 'All';
          if (els.priorityFilter) els.priorityFilter.value = 'All';
          if (els.statusFilter) els.statusFilter.value = 'All';
        } else {
          if (els.statusFilter) els.statusFilter.value = label;
        }
        saveFilters();
        applyFilters();
      };
      d.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          d.click();
        }
      });
      els.kpis.appendChild(d);
    };
    add('Total Issues', total);
    Object.entries(counts).forEach(([s,v])=> add(s, v));
  }

  function uniqueSorted(arr){ return [...new Set(arr.filter(Boolean).map(v=>v.trim()))].sort((a,b)=>a.localeCompare(b)); }
  function renderFilters(){
    if (els.moduleFilter) els.moduleFilter.innerHTML = ['All',...uniqueSorted(rows.map(r=>r.module))].map(v=>`<option>${v}</option>`).join('');
    if (els.priorityFilter) els.priorityFilter.innerHTML = ['All',...uniqueSorted(rows.map(r=>r.priority))].map(v=>`<option>${v}</option>`).join('');
    if (els.statusFilter) els.statusFilter.innerHTML = ['All',...uniqueSorted(rows.map(r=>r.status))].map(v=>`<option>${v}</option>`).join('');
  }

  function sortData(list){
    if(!sortKey) return list;
    const sorted=[...list].sort((a,b)=>{
      const va=a[sortKey]||"", vb=b[sortKey]||"";
      if(sortKey==='date'){
        const da=new Date(va), db=new Date(vb);
        if(isNaN(da)&&isNaN(db)) return 0;
        if(isNaN(da)) return 1;
        if(isNaN(db)) return -1;
        return da - db;
      }
      return String(va).localeCompare(String(vb), undefined, {numeric:true, sensitivity:'base'});
    });
    return sortAsc ? sorted : sorted.reverse();
  }

  function paginate(list){
    const start=(currentPage-1)*rowsPerPage;
    return list.slice(start, start+rowsPerPage);
  }
  function updatePaginationControls(total){
    if (!els.pageInfo || !els.firstPage) return;
    const totalPages = Math.max(1, Math.ceil(total/rowsPerPage));
    if (currentPage > totalPages) currentPage = totalPages;
    els.pageInfo.textContent = `Page ${Math.min(currentPage,totalPages)} / ${totalPages}`;
    const atFirst = currentPage<=1;
    const atLast = currentPage>=totalPages;
    els.firstPage.disabled = atFirst;
    els.prevPage.disabled = atFirst;
    els.nextPage.disabled = atLast;
    els.lastPage.disabled = atLast;
    [els.firstPage, els.prevPage, els.nextPage, els.lastPage].forEach(btn=>{
      if(!btn) return;
      if(btn.disabled) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled');
    });
  }

  function renderTable(){
    if (!els.tableBody) return;
    const list = sortData(filtered);
    const total = list.length;
    updatePaginationControls(total);
    if (els.rowCount) els.rowCount.textContent = `${total} row${total===1?'':'s'}`;

    if (!total){
      els.tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--muted)">
        No issues found. Try clearing filters or search.
      </td></tr>`;
      updateSortedHeaders();
      return;
    }

    const pageData = paginate(list);
    if (!pageData.length){
      els.tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--muted)">No issues on this page.</td></tr>`;
      updateSortedHeaders();
      return;
    }

    els.tableBody.innerHTML = pageData.map(r=>`
      <tr role="button" tabindex="0" aria-label="Open issue ${r.id||'without ID'}" data-id="${r.id}">
        <td>${r.id||'-'}</td>
        <td>${r.module||'-'}</td>
        <td>${r.title||'-'}</td>
        <td>${priorityBadge(r.priority||'-')}</td>
        <td>${statusBadge(r.status||'-')}</td>
        <td>${r.date||'-'}</td>
        <td>${r.log||'-'}</td>
        <td>${r.file?`<a href="${escapeAttr(r.file)}" target="_blank" rel="noopener noreferrer" aria-label="Open attachment link">üîó</a>`:'-'}</td>
      </tr>
    `).join('');

    els.tableBody.querySelectorAll('tr[data-id]').forEach(tr=>{
      tr.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          openIssueModal(tr.getAttribute('data-id'));
        }
      });
    });

    updateSortedHeaders();
  }

  function updateSortedHeaders(){
    qAll('#issuesTable thead th').forEach(th => {
      th.classList.remove('sorted-asc','sorted-desc');
      th.setAttribute('aria-sort','none');
    });
    if(sortKey){
      const th = q(`#issuesTable thead th[data-key="${sortKey}"]`);
      if(th){
        th.classList.add(sortAsc?'sorted-asc':'sorted-desc');
        th.setAttribute('aria-sort', sortAsc ? 'ascending' : 'descending');
      }
    }
  }

  function groupCount(list,key){
    return list.reduce((acc, r) => {
      const k=r[key]||'Unspecified';
      acc[k]=(acc[k]||0)+1;
      return acc;
    },{});
  }
  function cssVar(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function drawCharts(){
    if (typeof Chart === 'undefined') return;
    const priorityColors = {
      High: cssVar('--priority-high'),
      Medium: cssVar('--priority-medium'),
      Low: cssVar('--priority-low')
    };

    const statusColors = {
      "Resolved": cssVar('--status-resolved'),
      "Under Development": cssVar('--status-underdev'),
      "Rejected": cssVar('--status-rejected'),
      "On Hold": cssVar('--status-onhold'),
      "Not Started Yet": cssVar('--status-notstarted'),
      "Sent": cssVar('--status-sent'),
      "On Stage": cssVar('--status-onstage')
    };

    const make = (id, type, data, colorMap={}) => {
      const canvas = q('#'+id);
      if (!canvas) return;
      if(charts[id]) charts[id].destroy();
      const labels = Object.keys(data);
      const values = Object.values(data);
      charts[id] = new Chart(canvas, {
        type,
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: labels.map(k => colorMap[k] || cssVar('--accent'))
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: type !== 'bar' },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = values.reduce((a,b)=>a+b,0) || 1;
                  const pct = Math.round((ctx.raw*100)/total);
                  return `${ctx.raw} (${pct}%)`;
                }
              }
            }
          },
          scales: type === 'bar' ? {
            x: { grid: { color: 'rgba(128,128,128,.1)' } },
            y: { beginAtZero: true, grid: { color: 'rgba(128,128,128,.12)' } }
          } : {}
        }
      });
    };

    make('byModule', 'bar', groupCount(filtered,'module'));
    make('byPriority', 'doughnut', groupCount(filtered,'priority'), priorityColors);
    make('byStatus', 'bar', groupCount(filtered,'status'), statusColors);
    make('byType', 'bar', groupCount(filtered,'type'));
  }

  function applyFilters(){
    const qstr = els.search ? (els.search.value||'').toLowerCase().trim() : '';
    const m = els.moduleFilter ? els.moduleFilter.value : 'All';
    const p = els.priorityFilter ? els.priorityFilter.value : 'All';
    const s = els.statusFilter ? els.statusFilter.value : 'All';
    const start = els.startDateFilter ? els.startDateFilter.value : '';
    const end = els.endDateFilter ? els.endDateFilter.value : '';
    const startDate = start ? new Date(start) : null;
    const endDate = end ? (()=>{ const d=new Date(end); d.setDate(d.getDate()+1); return d; })() : null;

    filtered = rows.filter(r=>{
      const hay = [r.id,r.module,r.title,r.desc,r.log].filter(Boolean).join(' ').toLowerCase();
      let keepDate = true;
      if(r.date){
        const d = new Date(r.date);
        if(!isNaN(d)){
          if(startDate && d < startDate) keepDate = false;
          if(endDate && d >= endDate) keepDate = false;
        }
      } else if(startDate || endDate){ keepDate = false; }
      return (!qstr || hay.includes(qstr))
        && (!m || m==='All' || r.module===m)
        && (!p || p==='All' || r.priority===p)
        && (!s || s==='All' || r.status===s)
        && keepDate;
    });

    currentPage = 1;
    renderKpis();
    renderTable();
    drawCharts();
    renderAiInsights();
  }

  async function loadSheet(){
    try {
      showSpinner(true);
      const res = await fetch(SHEET_URL, { cache:'no-store' });
      if(!res.ok) throw new Error(`Failed to fetch (${res.status})`);
      const text = await res.text();
      rows = parseCsv(text);
      filtered = [...rows];
      renderFilters();
      loadFilters();
      applyFilters();
    } catch(e) {
      showToast('Error loading data: '+e.message);
      if (els.tableBody) {
        els.tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="color:#ffb4b4;text-align:center">
              Error loading data.
              <button type="button" id="retryLoad" class="btn sm" style="margin-left:8px">Retry</button>
            </td>
          </tr>`;
        const retryBtn = q('#retryLoad');
        if (retryBtn) {
          retryBtn.addEventListener('click', () => {
            loadSheet();
          });
        }
      }
    } finally {
      showSpinner(false);
    }
  }

  function trapFocus(container, e){
    const focusables = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(!focusables.length) return;
    const first = focusables[0], last = focusables[focusables.length-1];
    if(e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
    else if(!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
  }

  function openIssueModal(id){
    const r = rows.find(x=>x.id===id);
    if(!r || !els.modal) return;
    selectedIssue = r;
    lastFocusedBeforeIssueModal = document.activeElement;

    els.modalTitle.textContent = r.title || r.id || 'Issue';
    els.modalBody.innerHTML = `
      <p><b>ID:</b> ${escapeHtml(r.id || '-')}</p>
      <p><b>Module:</b> ${escapeHtml(r.module || '-')}</p>
      <p><b>Priority:</b> ${escapeHtml(r.priority || '-')}</p>
      <p><b>Status:</b> ${escapeHtml(r.status || '-')}</p>
      <p><b>Date:</b> ${escapeHtml(r.date || '-')}</p>
      <p><b>Description:</b><br>${escapeHtml(r.desc || '-')}</p>
      <p><b>Log:</b><br>${escapeHtml(r.log || '-')}</p>
      ${r.file ? `<p><b>Attachment:</b> <a href="${escapeAttr(r.file)}" target="_blank" rel="noopener noreferrer">Open link</a></p>` : ''}
    `;
    els.modal.style.display='flex';
    if (els.copyId) els.copyId.focus();
  }
  function closeIssueModal(){
    if (!els.modal) return;
    els.modal.style.display='none';
    selectedIssue=null;
    if(lastFocusedBeforeIssueModal && typeof lastFocusedBeforeIssueModal.focus==='function'){
      lastFocusedBeforeIssueModal.focus();
    }
  }

  function loadEventsFromStorage(){
    try {
      return JSON.parse(localStorage.getItem('incheckEvents') || '[]');
    } catch(e) {
      return [];
    }
  }
  function saveEventsToStorage(){
    try {
      localStorage.setItem('incheckEvents', JSON.stringify(eventsData));
    } catch(e) {}
  }

  async function fetchEventsFromSheet() {
    try {
      showSpinner(true);
      const res = await fetch(CALENDAR_API_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load events');
      const data = await res.json();
      eventsData = data.events || [];
      saveEventsToStorage();
      showToast('Calendar synced');
    } catch (e) {
      console.error(e);
      eventsData = loadEventsFromStorage();
      if (eventsData.length) {
        showToast('Using cached calendar events (API error).');
      } else {
        showToast('Unable to load calendar events.');
      }
    } finally {
      showSpinner(false);
      renderEventsOnCalendar();
      renderAiInsights();
    }
  }

  async function saveEventToSheet(event) {
    try {
      const res = await fetch(CALENDAR_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "save", event }),
      });

      let data;
      try {
        data = await res.json();
      } catch (jsonErr) {
        console.error("Invalid JSON returned:", jsonErr);
        const text = await res.text();
        console.error(text);
        showToast("Script returned invalid JSON");
        return;
      }

      if (data.ok) {
        showToast("Event saved");
        return data.event;
      } else {
        console.error("Backend error:", data);
        showToast("Backend error saving event");
        return null;
      }
    } catch (err) {
      console.error("Network error:", err);
      showToast("Network error saving event");
    }
  }

  async function deleteEventFromSheet(id) {
    showSpinner(true);
    try {
      const res = await fetch(CALENDAR_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', event: { id } })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Delete failed');
      showToast('Event deleted');
    } catch (err) {
      console.error(err);
      showToast('Error deleting event: ' + err.message);
      throw err;
    } finally {
      showSpinner(false);
    }
  }

  function renderEventsOnCalendar(){
    if (!calendar) return;
    calendar.removeAllEvents();
    eventsData.forEach(ev => {
      const type = (ev.type || 'Other');
      const cls = 'event-type-' + type.toLowerCase().replace(/\s+/g,'-');
      calendar.addEvent({
        id: ev.id,
        title: ev.title,
        start: ev.start,
        end: ev.end || null,
        extendedProps: { type: type, description: ev.description },
        classNames: [cls]
      });
    });
  }

  function initCalendar(){
    const calendarEl = document.getElementById('calendar');
    if(!calendarEl || typeof FullCalendar === 'undefined') {
      showToast('Calendar library failed to load');
      return;
    }
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      selectable: true,
      editable: false,
      height: 'auto',
      headerToolbar: {
        left: 'title',
        center: '',
        right: 'dayGridMonth,timeGridWeek,listWeek today prev,next'
      },
      select: info => {
        openEventModal({ start: info.start, end: info.end });
      },
      eventClick: info => {
        const ev = eventsData.find(e => e.id === info.event.id);
        if(ev) {
          openEventModal(ev);
        } else {
          openEventModal({
            id: info.event.id,
            title: info.event.title,
            type: info.event.extendedProps.type || 'Other',
            start: info.event.start,
            end: info.event.end,
            description: info.event.extendedProps.description || ''
          });
        }
      },
      eventDidMount: info => {
        if(info.event.extendedProps && info.event.extendedProps.description) {
          info.el.setAttribute('title', info.event.extendedProps.description);
        }
      }
    });
    renderEventsOnCalendar();
    calendar.render();
  }
  function ensureCalendar(){
    if (calendarInitialized) return;
    calendarInitialized = true;
    initCalendar();
  }

  function toLocalInputValue(date){
    const d = (date instanceof Date) ? date : new Date(date);
    if (isNaN(d)) return '';
    const pad=n=>String(n).padStart(2,'0');
    const year=d.getFullYear();
    const month=pad(d.getMonth()+1);
    const day=pad(d.getDate());
    const hrs=pad(d.getHours());
    const mins=pad(d.getMinutes());
    return `${year}-${month}-${day}T${hrs}:${mins}`;
  }

  function openEventModal(data){
    if (!els.eventModal) return;
    lastFocusedBeforeEventModal = document.activeElement;

    const isEdit = !!(data && data.id);
    editingEventId = isEdit ? data.id : null;
    if (els.eventModalTitle) els.eventModalTitle.textContent = isEdit ? 'Edit Event' : 'Add Event';
    if (els.eventDelete) els.eventDelete.style.display = isEdit ? 'inline-flex' : 'none';

    if (els.eventTitle) els.eventTitle.value = data && data.title ? data.title : '';
    if (els.eventType) els.eventType.value = data && data.type ? data.type : 'Deployment';
    if (els.eventStart) els.eventStart.value = data && data.start ? toLocalInputValue(data.start) : '';
    if (els.eventEnd) els.eventEnd.value = data && data.end ? toLocalInputValue(data.end) : '';
    if (els.eventDescription) els.eventDescription.value = data && data.description ? data.description : '';

    els.eventModal.style.display = 'flex';
    if (els.eventTitle) els.eventTitle.focus();
  }

  function closeEventModal(){
    if (!els.eventModal) return;
    els.eventModal.style.display = 'none';
    editingEventId = null;
    if(lastFocusedBeforeEventModal && typeof lastFocusedBeforeEventModal.focus === 'function'){
      lastFocusedBeforeEventModal.focus();
    }
  }

  async function handleEventFormSubmit(e){
    e.preventDefault();
    const title = els.eventTitle ? els.eventTitle.value.trim() : '';
    const type = els.eventType ? (els.eventType.value || 'Deployment') : 'Deployment';
    const start = els.eventStart ? els.eventStart.value : '';
    const end = els.eventEnd ? (els.eventEnd.value || null) : null;
    const description = els.eventDescription ? els.eventDescription.value.trim() : '';

    if(!title){
      showToast('Title is required for events');
      return;
    }
    if(!start){
      showToast('Start date/time is required');
      return;
    }

    let eventObj = {
      id: editingEventId || '',
      title,
      type,
      start,
      end,
      description
    };

    try {
      const saved = await saveEventToSheet(eventObj);
      if (!saved) return;
      const idx = eventsData.findIndex(ev => ev.id === saved.id);
      if (idx === -1) {
        eventsData.push(saved);
      } else {
        eventsData[idx] = saved;
      }
      saveEventsToStorage();
      renderEventsOnCalendar();
      renderAiInsights();
      closeEventModal();
    } catch (err) {
      console.error(err);
    }
  }

  async function handleDeleteEvent(){
    if(!editingEventId){
      closeEventModal();
      return;
    }
    try {
      await deleteEventFromSheet(editingEventId);
      const idx = eventsData.findIndex(ev => ev.id === editingEventId);
      if(idx !== -1){
        eventsData.splice(idx,1);
        saveEventsToStorage();
        renderEventsOnCalendar();
        renderAiInsights();
      }
    } catch (err) {
      console.error(err);
    }
    closeEventModal();
  }

  function exportFilteredCsv(){
    if (!filtered.length){
      showToast('Nothing to export (no rows).');
      return;
    }
    const headers = ['ID','Module','Title','Priority','Status','Date','Log','Link','Description'];
    const lines = [headers.join(',')];
    filtered.forEach(r=>{
      const row = [
        r.id, r.module, r.title, r.priority, r.status,
        r.date, r.log, r.file, r.desc
      ].map(v=>{
        const s = String(v ?? '').replace(/"/g,'""');
        return `"${s}"`;
      });
      lines.push(row.join(','));
    });
    const csvBlob = new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(csvBlob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = `incheck_issues_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Exported CSV of current filtered issues');
  }

  if (els.createTicket) {
    els.createTicket.addEventListener('click', () => {
      window.open("https://forms.gle/PPnEP1AQneoBT79s5", "_blank", "noopener,noreferrer");
    });
  }

  if (els.table) {
    els.table.addEventListener('click', (ev)=>{
      if (ev.target.closest('a')) return;
      const tr = ev.target.closest('tr[data-id]');
      if(tr){ openIssueModal(tr.getAttribute('data-id')); }
    });
  }

  if (els.closeModalBtn && els.modal) {
    els.closeModalBtn.addEventListener('click', closeIssueModal);
    els.modal.addEventListener('click', (e)=>{ if(e.target===els.modal) closeIssueModal(); });
  }

  if (els.eventModal) {
    if (els.eventModalClose) els.eventModalClose.addEventListener('click', closeEventModal);
    if (els.eventCancel) els.eventCancel.addEventListener('click', () => closeEventModal());
    if (els.eventForm) els.eventForm.addEventListener('submit', handleEventFormSubmit);
    if (els.eventDelete) els.eventDelete.addEventListener('click', handleDeleteEvent);
    els.eventModal.addEventListener('click', e => {
      if (e.target === els.eventModal) closeEventModal();
    });
  }

  document.addEventListener('keydown', (e)=>{
    const issueOpen = els.modal && els.modal.style.display === 'flex';
    const eventOpen = els.eventModal && els.eventModal.style.display === 'flex';
    if(e.key==='Escape'){
      if(eventOpen){ closeEventModal(); return; }
      if(issueOpen){ closeIssueModal(); return; }
    }
    if(e.key==='Tab'){
      if(eventOpen){ trapFocus(els.eventModal, e); }
      else if(issueOpen){ trapFocus(els.modal, e); }
    }
  });

  if (els.copyId) {
    els.copyId.addEventListener('click', async ()=>{
      if(!selectedIssue) return;
      try{
        await navigator.clipboard.writeText(selectedIssue.id || '');
        showToast('Issue ID copied');
      }catch{
        showToast('Unable to copy (clipboard blocked)');
      }
    });
  }
  if (els.copyLink) {
    els.copyLink.addEventListener('click', async ()=>{
      if(!selectedIssue) return;
      const link = selectedIssue.file || '';
      if(!link){
        showToast('No link on this issue');
        return;
      }
      try{
        await navigator.clipboard.writeText(link);
        showToast('Link copied');
      }catch{
        showToast('Unable to copy (clipboard blocked)');
      }
    });
  }

  qAll('#issuesTable thead th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if(sortKey===key){ sortAsc = !sortAsc; } else { sortKey=key; sortAsc=true; }
      renderTable();
      renderAiInsights();
    });
    th.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        th.click();
      }
    });
    th.setAttribute('tabindex','0');
    th.setAttribute('role','button');
    th.setAttribute('aria-label', `Sort by ${th.textContent}`);
  });

  const updateAndRender = ()=>{ renderTable(); renderAiInsights(); };
  if (els.pageSize) {
    els.pageSize.addEventListener('change', ()=>{
      rowsPerPage = +els.pageSize.value;
      localStorage.setItem('pageSize', rowsPerPage);
      currentPage = 1;
      updateAndRender();
    });
  }
  if (els.firstPage) els.firstPage.addEventListener('click', ()=>{ currentPage=1; updateAndRender(); });
  if (els.prevPage) els.prevPage.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; updateAndRender(); } });
  if (els.nextPage) els.nextPage.addEventListener('click', ()=>{
    const totalPages = Math.max(1, Math.ceil(filtered.length/rowsPerPage));
    if(currentPage<totalPages){ currentPage++; updateAndRender(); }
  });
  if (els.lastPage) els.lastPage.addEventListener('click', ()=>{
    currentPage = Math.max(1, Math.ceil(filtered.length/rowsPerPage));
    updateAndRender();
  });

  if (els.drawerBtn && els.sidebar) {
    els.drawerBtn.addEventListener('click', ()=>{
      const open = !els.sidebar.classList.contains('open');
      els.sidebar.classList.toggle('open');
      els.drawerBtn.setAttribute('aria-expanded', String(open));
    });
  }

  const onFilterChange = ()=>{
    saveFilters();
    applyFilters();
  };
  [els.moduleFilter, els.priorityFilter, els.statusFilter].forEach(el=> el && el.addEventListener('change', onFilterChange));
  if (els.startDateFilter) els.startDateFilter.addEventListener('change', onFilterChange);
  if (els.endDateFilter) els.endDateFilter.addEventListener('change', onFilterChange);
  if (els.reset) {
    els.reset.addEventListener('click', ()=>{
      if (els.search) els.search.value='';
      if (els.startDateFilter) els.startDateFilter.value='';
      if (els.endDateFilter) els.endDateFilter.value='';
      localStorage.removeItem('incheckFilters');
      renderFilters();
      applyFilters();
    });
  }
  if (els.refresh) els.refresh.addEventListener('click', loadSheet);
  if (els.exportCsv) els.exportCsv.addEventListener('click', exportFilteredCsv);
  if (els.search) {
    els.search.addEventListener('input', debounce(()=>{
      saveFilters();
      applyFilters();
    }, 250));
  }

  if (els.themeSelect) els.themeSelect.addEventListener('change', ()=> applyTheme(els.themeSelect.value));
  initTheme();

  // AI query listeners
  if (els.aiQueryRun) els.aiQueryRun.addEventListener('click', runAiQuery);
  if (els.aiQueryInput) {
    els.aiQueryInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        runAiQuery();
      }
    });
  }

  // view switching
  els.viewTabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;

      els.viewTabs.forEach(b => {
        const active = b === btn;
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });

      if (els.issuesView) els.issuesView.classList.toggle('active', view === 'issues');
      if (els.calendarView) els.calendarView.classList.toggle('active', view === 'calendar');
      if (els.insightsView) els.insightsView.classList.toggle('active', view === 'insights');

      if (view === 'calendar') {
        ensureCalendar();
      } else if (view === 'insights') {
        renderAiInsights();
      }
    });
  });

  if (els.addEventBtn) {
    els.addEventBtn.addEventListener('click', () => {
      const now = new Date();
      openEventModal({
        start: now,
        end: new Date(now.getTime() + 60*60*1000)
      });
    });
  }

  eventsData = [];
  fetchEventsFromSheet();

  if(typeof Chart === 'undefined') { showToast('Chart.js failed to load'); }
  if(typeof Papa === 'undefined') { showToast('PapaParse failed to load'); }
  loadSheet();

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;');
  }

  // Auto-refresh events every 5 minutes
  setInterval(fetchEventsFromSheet, 5 * 60 * 1000);
});
</script>
</body>
</html>
