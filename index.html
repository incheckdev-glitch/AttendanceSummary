<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>InCheck — Issues · Ops · AI Copilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <!-- FullCalendar CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css"
    />
  </head>
  <body>
    <!-- Global spinner overlay -->
    <div id="spinner" class="spinner-overlay" aria-hidden="true">
      <div class="spinner"></div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div class="app-shell">
      <!-- Top header / nav -->
      <header class="topbar">
        <button
          id="drawerBtn"
          class="icon-button drawer-toggle"
          aria-label="Toggle filters sidebar"
        >
          ☰
        </button>

        <div class="brand">
          <div class="brand-logo">IC</div>
          <div class="brand-text">
            <div class="brand-title">INCHECK</div>
            <div class="brand-subtitle">Issues · Ops · Copilot</div>
          </div>
        </div>

        <div class="topbar-controls">
          <div class="topbar-group">
            <label class="compact-label" for="themeSelect">System</label>
            <select id="themeSelect" class="select sm">
              <option value="system">System</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>

          <div class="topbar-group">
            <label class="compact-label" for="accentColor">Accent</label>
            <input id="accentColor" type="color" class="accent-picker" />
          </div>

          <button id="refreshNow" class="btn ghost sm" type="button">
            Refresh
          </button>
          <button id="exportCsv" class="btn ghost sm" type="button">
            Export
          </button>
          <button id="createTicketBtn" class="btn primary sm" type="button">
            ➕ Create Ticket
          </button>

          <div class="topbar-status">
            <span
              id="onlineStatusChip"
              class="chip chip-online"
              aria-label="Keyboard shortcuts available"
            >
              ⌨️ Online
            </span>
            <button
              id="shortcutsHelp"
              type="button"
              class="chip chip-ghost"
              aria-label="Show keyboard shortcuts"
            >
              Shortcuts
            </button>
          </div>
        </div>
      </header>

      <!-- Sync status row -->
      <div class="sync-row">
        <div class="sync-item">
          <span id="syncIssuesDot" class="dot"></span>
          <span id="syncIssuesText">Issues: never</span>
        </div>
        <div class="sync-item">
          <span id="syncEventsDot" class="dot"></span>
          <span id="syncEventsText">Events: never</span>
        </div>
        <div id="loadingStatus" class="sync-loading muted"></div>
      </div>

      <!-- Main layout: sidebar + main -->
      <div class="layout">
        <!-- Filters sidebar -->
        <aside id="sidebar" class="sidebar">
          <h3>Filters</h3>

          <div class="filter-section">
            <label for="searchInput">Search</label>
            <input
              id="searchInput"
              type="search"
              class="input"
              placeholder="Search ID, title, log…"
            />
          </div>

          <div class="filter-section">
            <label for="moduleFilter">Module</label>
            <select id="moduleFilter" class="select"></select>
          </div>

          <div class="filter-section">
            <label for="priorityFilter">Priority</label>
            <select id="priorityFilter" class="select"></select>
          </div>

          <div class="filter-section">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" class="select"></select>
          </div>

          <div class="filter-section">
            <label for="startDateFilter">Start Date</label>
            <input id="startDateFilter" class="input" type="date" />
          </div>

          <div class="filter-section">
            <label for="endDateFilter">End Date</label>
            <input id="endDateFilter" class="input" type="date" />
          </div>

          <div class="filter-actions">
            <button id="resetBtn" class="btn ghost" type="button">
              Reset
            </button>
          </div>

          <p class="muted small">
            Tip: click any KPI to filter by that status. “Total Issues” resets
            everything.
          </p>
        </aside>

        <!-- Main content -->
        <main class="main">
          <!-- KPIs + summary -->
          <section class="kpi-strip">
            <div id="kpis" class="kpi-grid"></div>

            <div class="summary-panel">
              <div id="issuesSummaryText" class="muted">
                Loading summary…
              </div>
              <div id="activeFiltersChips" class="filter-chips"></div>
              <div class="muted very-small">
                Shortcuts: 1/2 tabs · / search · Ctrl+K AI
              </div>
            </div>
          </section>

          <!-- Tabs header: ONLY Issues + Calendar (Option A) -->
          <nav class="tabs" role="tablist" aria-label="Main views">
            <button
              id="issuesTab"
              class="tab active"
              type="button"
              role="tab"
              aria-selected="true"
              aria-controls="issuesView"
            >
              Issues
            </button>
            <button
              id="calendarTab"
              class="tab"
              type="button"
              role="tab"
              aria-selected="false"
              aria-controls="calendarView"
            >
              Calendar
            </button>

            <!-- AI tab removed from UI (Option A) 
            <button
              id="insightsTab"
              class="tab"
              type="button"
              role="tab"
              aria-selected="false"
              aria-controls="insightsView"
              style="display:none"
            >
              AI Insights
            </button>
            -->
          </nav>

          <!-- ===== Issues View ===== -->
          <section
            id="issuesView"
            class="view active"
            role="tabpanel"
            aria-labelledby="issuesTab"
          >
            <header class="view-header">
              <h2>Issues</h2>
              <p class="muted">
                Live feed from InCheck issues sheet.
              </p>
            </header>

            <div class="issues-layout">
              <div class="issues-table-wrap">
                <table
                  id="issuesTable"
                  class="table"
                  aria-label="Issues table"
                >
                  <thead>
                    <tr>
                      <th data-key="id" scope="col">ID</th>
                      <th data-key="module" scope="col">Module</th>
                      <th data-key="title" scope="col">Title</th>
                      <th data-key="priority" scope="col">Priority</th>
                      <th data-key="status" scope="col">Status</th>
                      <th data-key="date" scope="col">Date</th>
                      <th data-key="log" scope="col">Log</th>
                      <th scope="col">Link</th>
                    </tr>
                  </thead>

                  <!-- Skeleton placeholder while loading -->
                  <tbody id="tbodySkeleton">
                    <tr>
                      <td colspan="8" class="muted">
                        Loading issues…
                      </td>
                    </tr>
                  </tbody>

                  <!-- Real rows populated by JS -->
                  <tbody id="issuesTbody"></tbody>
                </table>
              </div>

              <footer class="table-footer">
                <div id="rowCount" class="muted">No rows</div>

                <div class="pager">
                  <button
                    id="firstPage"
                    class="btn ghost sm"
                    type="button"
                  >
                    « First
                  </button>
                  <button
                    id="prevPage"
                    class="btn ghost sm"
                    type="button"
                  >
                    ‹ Prev
                  </button>
                  <span id="pageInfo" class="muted small"
                    >Page 1 / 1</span
                  >
                  <button
                    id="nextPage"
                    class="btn ghost sm"
                    type="button"
                  >
                    Next ›
                  </button>
                  <button
                    id="lastPage"
                    class="btn ghost sm"
                    type="button"
                  >
                    Last »
                  </button>
                </div>

                <div class="page-size">
                  <label for="pageSize">Rows</label>
                  <select id="pageSize" class="select sm">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                </div>
              </footer>
            </div>
          </section>

          <!-- ===== Calendar / Release Planner View ===== -->
          <section
            id="calendarView"
            class="view"
            role="tabpanel"
            aria-labelledby="calendarTab"
          >
            <header class="view-header">
              <h2>Deployments &amp; Maintenance Calendar</h2>
              <p class="muted">
                Plan deployments, maintenance windows, releases, and other
                operational events.
              </p>
            </header>

            <section class="calendar-toolbar">
              <div class="calendar-filters">
                <label>
                  <input
                    id="eventFilterDeployment"
                    type="checkbox"
                    checked
                  />
                  Deployment
                </label>
                <label>
                  <input
                    id="eventFilterMaintenance"
                    type="checkbox"
                    checked
                  />
                  Maintenance
                </label>
                <label>
                  <input
                    id="eventFilterRelease"
                    type="checkbox"
                    checked
                  />
                  Release
                </label>
                <label>
                  <input
                    id="eventFilterOther"
                    type="checkbox"
                    checked
                  />
                  Other
                </label>
              </div>

              <div class="calendar-actions">
                <button
                  id="addEventBtn"
                  class="btn primary sm"
                  type="button"
                >
                  ➕ Add Event
                </button>
                <div id="calendarTz" class="muted very-small"></div>
              </div>
            </section>

            <div id="calendar" class="calendar"></div>

            <!-- Release Planner -->
            <section class="planner-section">
              <h3>Release Planner — F&amp;B Middle East</h3>
              <p class="muted">
                Suggests safer deployment windows based on rush hours, open
                high-risk issues and similar past bugs. Lower score = safer
                window.
              </p>

              <div class="planner-grid">
                <!-- Environment -->
                <div class="planner-block">
                  <h4>Environment</h4>
                  <div class="chip-group" id="plannerEnv">
                    <button
                      type="button"
                      class="chip chip-toggle active"
                      data-value="Prod"
                    >
                      Prod
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="Staging"
                    >
                      Staging
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="Dev"
                    >
                      Dev
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="Other"
                    >
                      Other
                    </button>
                  </div>
                </div>

                <!-- Region -->
                <div class="planner-block">
                  <h4>Region profile</h4>
                  <div class="chip-group" id="plannerRegion">
                    <button
                      type="button"
                      class="chip chip-toggle active"
                      data-value="Gulf"
                    >
                      Gulf (KSA / UAE / Qatar)
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="Levant"
                    >
                      Levant
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="NorthAfrica"
                    >
                      North Africa
                    </button>
                  </div>
                </div>

                <!-- Release type -->
                <div class="planner-block">
                  <h4>Release type</h4>
                  <div class="chip-group" id="plannerReleaseType">
                    <button
                      type="button"
                      class="chip chip-toggle active"
                      data-value="minor"
                    >
                      Minor patch
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="feature"
                    >
                      Feature
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="major"
                    >
                      Major release
                    </button>
                  </div>
                </div>

                <!-- Modules -->
                <div class="planner-block">
                  <h4>Modules</h4>
                  <textarea
                    id="plannerModules"
                    class="input"
                    rows="2"
                    placeholder="e.g. POS checkout, reporting, inventory…"
                  ></textarea>
                </div>

                <!-- Description -->
                <div class="planner-block">
                  <h4>Release description (optional)</h4>
                  <textarea
                    id="plannerDescription"
                    class="input"
                    rows="2"
                    placeholder="Short description of what’s changing…"
                  ></textarea>
                </div>

                <!-- Look ahead -->
                <div class="planner-block">
                  <h4>Look ahead</h4>
                  <div class="chip-group" id="plannerHorizon">
                    <button
                      type="button"
                      class="chip chip-toggle active"
                      data-value="1"
                    >
                      Next 24 hours
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="3"
                    >
                      Next 3 days
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="5"
                    >
                      Next 5 days
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="7"
                    >
                      Next 7 days
                    </button>
                  </div>
                </div>

                <!-- Suggestions per day -->
                <div class="planner-block">
                  <h4>Suggestions per day</h4>
                  <div class="chip-group" id="plannerSlotsPerDay">
                    <button
                      type="button"
                      class="chip chip-toggle active"
                      data-value="2"
                    >
                      2
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="4"
                    >
                      4
                    </button>
                    <button
                      type="button"
                      class="chip chip-toggle"
                      data-value="6"
                    >
                      6
                    </button>
                  </div>
                </div>
              </div>

              <div class="planner-actions">
                <button
                  id="plannerRun"
                  class="btn primary"
                  type="button"
                >
                  ✨ Suggest windows
                </button>
                <button
                  id="plannerAddEvent"
                  class="btn ghost"
                  type="button"
                >
                  ➕ Add top suggestion to calendar…
                </button>
                <div class="muted very-small">
                  Scored for F&amp;B rush hours in MENA · lower is safer
                </div>
              </div>

              <div
                id="plannerResults"
                class="planner-results"
                aria-live="polite"
              ></div>

              <!-- Release plan linking -->
              <section class="planner-linking">
                <h4>Link tickets to a release plan</h4>
                <div class="planner-linking-grid">
                  <div class="card">
                    <h5>Release plan (Release events)</h5>
                    <div
                      id="plannerReleasePlan"
                      class="planner-list"
                    ></div>
                  </div>
                  <div class="card">
                    <h5>Tickets (from current filters)</h5>
                    <p class="muted very-small">
                      Uses the same filters as the Issues tab (module,
                      status, dates, etc.).
                    </p>
                    <div
                      id="plannerTickets"
                      class="planner-list"
                    ></div>
                    <button
                      id="plannerAssignBtn"
                      class="btn sm"
                      type="button"
                    >
                      Assign selected tickets
                    </button>
                  </div>
                </div>
              </section>
            </section>
          </section>

          <!-- ===== AI Insights View (kept, but hidden; no tab) ===== -->
          <section
            id="insightsView"
            class="view"
            aria-hidden="true"
            style="display: none"
          >
            <header class="view-header">
              <h2>AI Insights / Copilot</h2>
              <p class="muted">
                Heuristic, explainable analytics on issues text (no external
                AI). Risk breakdown, clustering, trends, triage &amp; calendar
                risk.
              </p>
            </header>

            <div id="aiAnalyzing" class="muted very-small" style="display:none;">
              Analyzing issues…
            </div>

            <div class="ai-grid">
              <section class="card">
                <h3>Top terms (recent)</h3>
                <ul id="aiPatternsList" class="list"></ul>
              </section>

              <section class="card">
                <h3>Suggested categories</h3>
                <ul id="aiLabelsList" class="list"></ul>
              </section>

              <section class="card">
                <h3>Dataset used</h3>
                <p id="aiScopeText" class="muted"></p>
                <h4>Signals</h4>
                <p id="aiSignalsText" class="muted"></p>
              </section>

              <section class="card">
                <h3>Trends &amp; bursts (last 14 days)</h3>
                <ul id="aiTrendsList" class="list"></ul>
              </section>

              <section class="card">
                <h3>Incident-like issues</h3>
                <ul id="aiIncidentsList" class="list"></ul>
              </section>

              <section class="card">
                <h3>Emerging vs Stable themes</h3>
                <ul id="aiEmergingStable" class="list"></ul>
              </section>

              <section class="card">
                <h3>Ops Cockpit</h3>
                <ul id="aiOpsCockpit" class="list"></ul>
              </section>

              <section class="card wide">
                <h3>Per-module risk insights</h3>
                <div class="table-scroll">
                  <table class="table compact">
                    <thead>
                      <tr>
                        <th>Module</th>
                        <th>Open</th>
                        <th>High P</th>
                        <th>Risk sum</th>
                        <th>Top term</th>
                      </tr>
                    </thead>
                    <tbody id="aiModulesTableBody">
                      <tr>
                        <td colspan="5" class="muted">
                          Waiting for data…
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </section>

              <section class="card">
                <h3>Top risks this week</h3>
                <ul id="aiRisksList" class="list"></ul>
              </section>

              <section class="card">
                <h3>Similar issue clusters</h3>
                <div id="aiClusters" class="cluster-list"></div>
              </section>

              <section class="card wide">
                <h3>Triage queue (issues needing attention)</h3>
                <p class="muted very-small">
                  Missing fields, misaligned priority, ordered by risk.
                  Suggestions are heuristic.
                </p>
                <ul id="aiTriageList" class="list"></ul>
              </section>

              <section class="card">
                <h3>Upcoming risky events (next 7 days)</h3>
                <ul id="aiEventsList" class="list"></ul>
              </section>

              <section class="card wide">
                <h3>AI Commands (pro)</h3>
                <p class="muted very-small">
                  Filters: <code>module:</code> <code>status:</code>
                  <code>priority:</code> <code>id:</code> <code>type:</code>
                  <code>missing:</code><br />
                  Risk: <code>risk&gt;=9</code> <code>severity&gt;=3</code>
                  <code>impact&gt;=3</code> <code>urgency&gt;=3</code><br />
                  Time: <code>last:7d</code> <code>age&gt;14d</code> ·
                  Events: <code>event:next7d</code>
                  <code>event:today</code><br />
                  Sort: <code>sort:risk|date|priority</code><br />
                  Examples:
                  <code>payments risk&gt;8 last:7d sort:risk</code> ·
                  <code>missing:priority module:billing</code> ·
                  <code>status:open cluster:timeout</code>
                </p>

                <div class="ai-query">
                  <input
                    id="aiQueryInput"
                    class="input"
                    type="text"
                    placeholder="e.g. payments risk&gt;8 last:7d sort:risk"
                  />
                  <div class="ai-query-buttons">
                    <button
                      id="aiQueryRun"
                      class="btn sm"
                      type="button"
                    >
                      Run
                    </button>
                    <button
                      id="aiQueryApplyFilters"
                      class="btn ghost sm"
                      type="button"
                    >
                      Apply to Issues
                    </button>
                    <button
                      id="aiQueryExport"
                      class="btn ghost sm"
                      type="button"
                    >
                      Export CSV
                    </button>
                  </div>
                </div>

                <div
                  id="aiQueryResults"
                  class="ai-query-results"
                ></div>
              </section>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- Issue modal -->
    <div
      id="issueModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
      style="display: none"
    >
      <div class="modal-content">
        <header class="modal-header">
          <h2 id="modalTitle">Issue</h2>
          <button
            id="modalClose"
            class="icon-button"
            type="button"
            aria-label="Close issue details"
          >
            ✕
          </button>
        </header>
        <div id="modalBody" class="modal-body"></div>
        <footer class="modal-footer">
          <button
            id="copyId"
            class="btn sm"
            type="button"
          >
            Copy ID
          </button>
          <button
            id="copyLink"
            class="btn ghost sm"
            type="button"
          >
            Copy Link
          </button>
        </footer>
      </div>
    </div>

    <!-- Event modal -->
    <div
      id="eventModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="eventModalTitle"
      style="display: none"
    >
      <div class="modal-content modal-event">
        <header class="modal-header">
          <h2 id="eventModalTitle">Event</h2>
          <button
            id="eventModalClose"
            class="icon-button"
            type="button"
            aria-label="Close event editor"
          >
            ✕
          </button>
        </header>

        <form id="eventForm" class="modal-body">
          <div class="form-grid">
            <div class="form-block">
              <label for="eventTitle">Title</label>
              <input id="eventTitle" class="input" type="text" />
            </div>

            <div class="form-block">
              <label for="eventType">Type</label>
              <select id="eventType" class="select">
                <option>Deployment</option>
                <option>Maintenance</option>
                <option>Release</option>
                <option>Other</option>
              </select>
            </div>

            <div class="form-block">
              <label for="eventEnv">Environment</label>
              <select id="eventEnv" class="select">
                <option>Prod</option>
                <option>Staging</option>
                <option>Dev</option>
                <option>Other</option>
              </select>
            </div>

            <div class="form-block">
              <label for="eventStatus">Change status</label>
              <select id="eventStatus" class="select">
                <option>Planned</option>
                <option>In Progress</option>
                <option>Completed</option>
                <option>Cancelled</option>
              </select>
            </div>

            <div class="form-block">
              <label for="eventOwner">Owner</label>
              <input id="eventOwner" class="input" type="text" />
            </div>

            <div class="form-block">
              <label for="eventModules">Modules</label>
              <input
                id="eventModules"
                class="input"
                type="text"
                placeholder="Comma-separated modules"
              />
            </div>

            <div class="form-block">
              <label for="eventImpactType">Impact</label>
              <select id="eventImpactType" class="select">
                <option>No downtime expected</option>
                <option>Customer visible</option>
                <option>Internal only</option>
                <option>High risk change</option>
              </select>
            </div>

            <div class="form-block">
              <label for="eventIssueId">Issue ID (optional)</label>
              <input
                id="eventIssueId"
                class="input"
                type="text"
                placeholder="Single or comma-separated IDs"
              />
              <div
                id="eventIssueLinkedInfo"
                class="muted very-small"
              ></div>
            </div>

            <div class="form-block">
              <label for="eventStart">Start</label>
              <input
                id="eventStart"
                class="input"
                type="datetime-local"
              />
              <label class="checkbox-inline">
                <input id="eventAllDay" type="checkbox" />
                All-day event
              </label>
            </div>

            <div class="form-block">
              <label for="eventEnd">End (optional)</label>
              <input
                id="eventEnd"
                class="input"
                type="datetime-local"
              />
            </div>

            <div class="form-block form-block-wide">
              <label for="eventDescription">Notes</label>
              <textarea
                id="eventDescription"
                class="input"
                rows="3"
              ></textarea>
            </div>
          </div>
        </form>

        <footer class="modal-footer">
          <button
            id="eventSave"
            class="btn primary"
            type="button"
          >
            Save Event
          </button>
          <button
            id="eventCancel"
            class="btn ghost"
            type="button"
          >
            Cancel
          </button>
          <button
            id="eventDelete"
            class="btn danger ghost"
            type="button"
          >
            Delete
          </button>
        </footer>
      </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <!-- Main app script (make sure name/casing matches your file) -->
    <script src="App.js"></script>
  </body>
</html>
